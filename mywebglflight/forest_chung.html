<!DOCTYPE html>
<html>
 forest_chung a program  by NGUYEN.Chung (freeware 2014) <br />
 H key: help 
<head>
<title>forest_chung </title>
<link id="ico" rel="shortcut icon" href="forest_chung.ico">
<!--link rel="shortcut icon" href="https://b3d8783ddc02a86af1ce60266a06c20f1a961f99.googledrive.com/host/0B6GM9ay7ImZLOXpiUkx5bFhacXc/forest_chung.ico"-->
<!--meta http-equiv="content-type" content="text/html; charset=ISO-8859-1"-->
</head>
<body   onunload="close();"  bgcolor="#C0C0FF">
    <br />
	<div id="divmsg" >
    <textarea rows="1" cols="40" id="msg">loading...</textarea>
	</div>
	<div style="position:absolute;top:7910px;left:10px;z-index:10;">
	<input type="text"  onblur="resetkeys();" onKeyUp="keyup(event);" onKeyDown="keydown(event);" id="intext" maxlength="1" size="1" value=""/>
	</div>
	<div id="mydiv2" style="position:absolute;top:7900px;left:0px;z-index:1000;">
    <canvas id="canvas2" style="top:0px;left:0px;" width="330" height="330"></canvas><!--620x430-->
	</div>
	<div id="mydiv" style="position:absolute;top:7900px;left:0px;z-index:100;">
    <canvas id="canvas" style="border: none;top:0px;left:0px;" width="620" height="430"></canvas><!--620x430-->
	<br />
	<button id="fullscreen"  onclick="sizescreen();">fullscreen</button>
    <select id="combo" onChange="subcombo();" onblur="tfocus=1;waitkey=0;" onfocus="tfocus=0;waitkey=0;">
       <option id="initial">initial</option>
       <option id="map1">map1</option>
       <option id="map2">map2</option>
       <option id="map3">map3</option>
       <option id="map4">map4</option>
       <option id="map5">map5</option>
       <option id="map6">map6</option>
       <option id="map7">map7</option>
       <option id="map8">map8</option>
       <option id="map9">map9</option>
       <option id="map10">map10</option>
       <option id="map11">map11</option>
       <option id="map12">map12</option>
       <option id="map13">map13</option>
       <option id="map14">map14</option>
       <option id="map15">map15</option>
       <option id="map16">map16</option>
       <option id="map17">map17</option>
       <option id="map18">map18</option>
       <option id="map19">map19</option>
    </select>
	<input type="text"  onKeyUp="keyup(event);" onKeyDown="keydown(event);" id="clock" maxlength="2" size="2" value="18:05"/>
	<input type="text"  onKeyUp="keyup(event);" onKeyDown="keydown(event);" id="intext0" maxlength="85" size="78" value=""/>
    <br />
    </div>
<script type="text/javascript" src="https://www.google.com/jsapi"></script>
<script type="text/javascript" src="jscompile_chung.js"></script>
<script type="text/javascript" >
//google.load("search", "1");
//google.load("jquery", "1.4.2");
//google.load("jqueryui", "1.7.2");
var lat=48,lng=2,city="Paris";
if (google.loader.ClientLocation) {
    lat = google.loader.ClientLocation.latitude;
    lng = google.loader.ClientLocation.longitude;
	city= google.loader.ClientLocation.address.city;
	//alert(city);
}
</script>
<script type="text/javascript">
var folder="http://sites.google.com/site/chungkn1400/forest_chung/";
folder="https://b3d8783ddc02a86af1ce60266a06c20f1a961f99.googledrive.com/host/0B6GM9ay7ImZLOXpiUkx5bFhacXc/";
folder="";//set this to use local sound folder
var tcompile=0;
tcompile=1;//set this to compile
var test=0;if(folder==""){test=1;};
function submsg(text){
 document.getElementById("msg").value=text;
 //document.getElementById("divmsg").innerHTML;
}
var auxvar=null,auxvar2=null;
var head = document.getElementsByTagName('head')[0];
var tjsload=0,jsfilelist=[],njsfile=0;
function addjavascript(jsfilepath){
submsg("addjavascript("+jsfilepath+")");
var js = document.createElement("script");
js.type = "text/javascript";
js.src = folder+jsfilepath;
js.async=false;
//js.onreadystatechange = jscallback;
tjsload+=1;jsfilelist[njsfile]=jsfilepath;njsfile+=1;
js.onload = function(){setTimeout("jscallback();",100);};
head.appendChild(js);
}
function deletejsfilelist(){
  var msg="",err="",jsfile="";
  for(var i=0;i<njsfile;i++){jsfile=jsfilelist[i];
     if(jsfile.indexOf("objtxt.js")>=0 ||
	    jsfile.indexOf("mp3.js")>=0 ||
		jsfile.indexOf("jpg.js")>=0 ||
		jsfile.indexOf("png.js")>=0){
      if(jsfile.substr(jsfile.length-3,3)==".js"){
	    jsfile=jsfile.substr(0,jsfile.length-3);
		try{eval(jsfile+"=null;");}catch(e){err+="/"+jsfile;}
		//msg+="/"+jsfile;
		};}
  };
  //alert(err);
}
function addjavascripttext(jstext){
submsg("addjavatext("+jstext+")");
var js = document.createElement("script");
js.type = "text/javascript";
if(tcompile==1){js.text=compile(document.getElementById(jstext).text);
}else{js.text=document.getElementById(jstext).text;}
js.async=false;
head.appendChild(js);
}
function jscallback(){tjsload-=1;
   if(tjsload==0){setTimeout("addjavascripttext('testaddmain');",100);
                 };}
var twebaudio=0;
function addmain(){
   addjavascripttext("main0");
   if(window.AudioContext || window.webkitAudioContext){
      twebaudio=1;
	  setTimeout('addjavascripttext("webaudio");',400);
   }else{
      twebaudio=0;
	  setTimeout('addjavascripttext("htmlaudio");',400);
	  }	  
   setTimeout('addjavascripttext("main2");',1200);
}
addjavascript("glMatrix-0.9.5.min.js");
addjavascript("webgl-utils.js");
addjavascript("seedrandom.min.js");
addjavascript("vk_keys.js");
addjavascript("base64binary.js");
addjavascript("c150objtxt.js");
addjavascript("c150jpg.js");
addjavascript("map2jpg.js");
addjavascript("cloudpng.js");
addjavascript("sunpng.js");
addjavascript("bousspng.js");
//addjavascript("c150redjpg.js");
addjavascript("piste12jpg.js");
addjavascript("tower1jpg.js");
addjavascript("c150minus6objtxt.js");
addjavascript("c150cockpit4png.js");
addjavascript("compas256jpg.js");
addjavascript("helice2jpg.js");
addjavascript("arrowpng.js");
addjavascript("waterjpg.js");
addjavascript("tree2jpg.js");
addjavascript("sunback2jpg.js");
addjavascript("radar2png.js");
addjavascript("azimut2png.js");
addjavascript("explosionjpg.js");
addjavascript("impactjpg.js");
//addjavascript("shipobjtxt.js");
//addjavascript("shipjpg.js");
addjavascript("bloodjpg.js");
/*addjavascript("spitfirelowobjtxt.js");
addjavascript("spitfirejpg.js");
addjavascript("spitfirecockpitobjtxt.js");
addjavascript("zeroobjtxt.js");
addjavascript("zerojpg.js");
addjavascript("zerocockpitobjtxt.js");
addjavascript("shipcarrierobjtxt.js");
addjavascript("shipcarrierjpg.js");*/
addjavascript("avion2mp3.js");
addjavascript("pneump3.js");
addjavascript("shootmp3.js");
addjavascript("explosionmp3.js");
addjavascript("skydomeobjtxt.js");
addjavascript("skydomejpg.js");
addjavascript("skydome2jpg.js");
addjavascript("skydome3jpg.js");
//addjavascript("corsairobjtxt.js");
//addjavascript("corsairjpg.js");
addjavascript("waterseajpg.js");
addjavascript("viseurpng.js");
addjavascript("rainmp3.js");
addjavascript("rainjpg.js");
addjavascript("skydome4jpg.js");
addjavascript("thundermp3.js");
//addjavascript("sailshipjpg.js");
//addjavascript("sailshipobjtxt.js");
addjavascript("naturemp3.js");
addjavascript("rocjpg.js");
addjavascript("rocobjtxt.js");
addjavascript("grass1jpg.js");
addjavascript("trunkobjtxt.js");
addjavascript("trunkjpg.js");
addjavascript("skeletonpng.js");
addjavascript("skeletonattackpng.js");
addjavascript("ouchmp3.js");
addjavascript("swordmp3.js");
addjavascript("slashmp3.js");
addjavascript("skeletonmp3.js");
addjavascript("arm2objtxt.js");
addjavascript("arm2jpg.js");
addjavascript("swordobjtxt.js");
addjavascript("swordjpg.js");
addjavascript("aahmp3.js");
addjavascript("potionpng.js");
addjavascript("watermp3.js");
addjavascript("horsejpg.js");
addjavascript("horseobjtxt.js");
addjavascript("footmp3.js");
addjavascript("horsemp3.js");
addjavascript("farmlowobjtxt.js");
addjavascript("farmlowjpg.js");
addjavascript("pingmp3.js");
addjavascript("flowerjpg.js");
addjavascript("castlejpg.js");
addjavascript("castlewallobjtxt.js");
addjavascript("castletowerobjtxt.js");
addjavascript("horsebodyobjtxt.js");
addjavascript("axeobjtxt.js");
addjavascript("axejpg.js");
addjavascript("horselowjpg.js");
addjavascript("horselowobjtxt.js");
addjavascript("horselowrun1objtxt.js");
addjavascript("horselowrun2objtxt.js");
addjavascript("skeletoncavpng.js");
addjavascript("skeletoncavobjtxt.js");
addjavascript("skeletoncavattackobjtxt.js");
</script>
<script type="text" id="testaddmain">
 /*   function loadtexture0(texturename,texturesrc){//$$$
        eval(texturename+" = gl.createTexture();");
        eval(texturename+".image = new Image();");
        eval(texturename+".image.onload=function(){handleLoadedTexture("+texturename+")};");
        eval(texturename+".image.srcname='"+texturesrc+"';");
        eval(texturename+".image.src = "+texturesrc+";");
	}*/
	//loadtexture0("mytextureaux","mytextureauxsrc");
addmain();    
//var pixdata$=new Uint8Array(4);
//requestAnimFrame(tick00);
</script>
<script type="text" id="main0">
var weatherurl="http://api.openweathermap.org/data/2.5/weather?lat=48&lon=2";
var wclouds=20;
var xmlhttp;
function createCORSRequest(method, url) {
  var xhr = new XMLHttpRequest();
  if ("withCredentials" in xhr) {
    // Check if the XMLHttpRequest object has a "withCredentials" property.
    // "withCredentials" only exists on XMLHTTPRequest2 objects.
    xhr.open(method, url, true);
  } else if (typeof XDomainRequest != "undefined") {
    // Otherwise, check if XDomainRequest.
    // XDomainRequest only exists in IE, and is IE's way of making CORS requests.
    xhr = new XDomainRequest();
    xhr.open(method, url);
  } else {
    // Otherwise, CORS is not supported by the browser.
    xhr = null;
  }
  return xhr;
}
//var xhr = createCORSRequest('GET', url);

function httpGet(theUrl,callback) 
{   xmlhttp= createCORSRequest('get', theUrl);
    xmlhttp.onload = function(e){ 
        callback(xmlhttp.responseText);} 
    xmlhttp.open("GET", theUrl, false);
    xmlhttp.send();    
}

function getweather(responseText){
            var weatherdata=(responseText);
			var i=weatherdata.indexOf('"clouds":'),j=0;
			var data=weatherdata.substr(i+10,100);
			i=data.indexOf(':');j=data.indexOf('}');
			wclouds=eval(data.substring(i+1,j));
			//alert(weatherdata.substr(1,400));
			//alert("wclouds="+wclouds);
}	
//weatherurl="http://query.yahooapis.com/v1/public/yql?q=select item.condition from weather.forecast where woeid in (select woeid from geo.places(1) where text='"+city+"')&format=json";
//httpGet("http://api.hostip.info/get_json.php?position=true",getlatlong);
weatherurl="http://api.openweathermap.org/data/2.5/weather?lat="+lat+"&lon="+lng;
//weatherurl=folder+"vk_keys.js";
//weatherurl="http://weather.yahooapis.com/forecastrss?w=2502265";
try{
httpGet(weatherurl,getweather);
}catch (e){//alert("error");
}
var tjoy="getGamepads" in navigator,joy=null,button=new Array(17);
var joyx=0,joyy=0,joyz=0,joyr=0,timejoy=0,timebutt=new Array(17);
for(var i=0;i<17;i++){timebutt[i]=0;}
function testjoystick(){
 for(var i=1;i<17;i++){button[i]=0;}
 joyx=0;joyy=0;joyz=0;joyr=0;
 if(!tjoy){return;}
 //var gamepadlist = navigator.getGamepads ? navigator.getGamepads() : (navigator.webkitGetGamepads ? navigator.webkitGetGamepads() : []);
 var gamepadlist = navigator.getGamepads();
 //var njoy=gamepadlist.length;
 //if(njoy<1){return;}
 //for(var i=0;i<njoy;i++){joy=gamepadlist[i];if(joy){break;};}
 joy=gamepadlist[0];
 if(!joy){return;}
 var butt=null,nbutt=joy.buttons.length;
 if(nbutt>16){nbutt=16;}
 for(var i=0;i<nbutt;i++){
   if(tframe>timebutt[i+1]){
	butt=joy.buttons[i];
    if (typeof(butt)=="object"){if(butt.pressed){button[i+1]=1;};
	   }else{if(butt==1.0){button[i+1]=1;};}
   }	   
 }
 var naxes=joy.axes.length; 
 if(naxes>0){joyx=joy.axes[0]-1;if(Math.abs(joyx)<0.09){joyx=0;};}
 if(naxes>1){joyy=joy.axes[1]-1;if(Math.abs(joyy)<0.09){joyy=0;};}
 if(naxes>2){joyr=joy.axes[2]-1;if(Math.abs(joyr)<0.09){joyr=0;};}
 if(naxes>3){joyz=joy.axes[3];if(Math.abs(joyz)<0.09){joyz=0;};}
}
function b(i){if(button[i]==1){
  timebutt[i]=tframe+150;button[i]=0;return 1;
}else{return 0;};}
//var irnd=0,nrnd=50000,random=new Array(nrnd);
//for(var i=0;i<nrnd;i++){random[i]=Math.random();}
function Mathrandom(){return Math.random();
//  irnd+=1;if(irnd>=nrnd){irnd=0;};
//  return random[irnd];
}
var seedrand=parseInt(new Date().getTime());
Math.seedrandom(seedrand);
</script>
<script type="text" id="webaudio" >
var audioctx = new (window.AudioContext || window.webkitAudioContext)();
var songlength;
function loadsound(source,url){
source.request = new XMLHttpRequest();
source.request.open('GET', url, true);
source.request.responseType = 'arraybuffer';
source.request.onload = function() {
var audioData = source.request.response;
audioctx.decodeAudioData(audioData, function(buffer) {
//myBuffer = buffer;
songlength = buffer.duration;
source.buffer = buffer;
source.playbackRate.value = 1.0;
//source.connect(audioctx.destination);
source.loopStart=0.5;
source.loopEnd=songlength-0.5;
source.gainNode = audioctx.createGain();
source.connect(source.gainNode);
source.gainNode.connect(audioctx.destination);
source.gainNode.gain.value = 1.0;
if(source.onload){source.onload();}
},
function(e){alert("Error with decoding audio data" + e.err);});
}
source.request.send();
}
function loadsound64(source,data){
var audioData = Base64Binary.decodeArrayBuffer(data.split(",")[1]);
audioctx.decodeAudioData(audioData, function(buffer) {
//myBuffer = buffer;
songlength = buffer.duration;
source.buffer = buffer;
source.playbackRate.value = 1.0;
//source.connect(audioctx.destination);
source.loopStart=0.5;
source.loopEnd=songlength-0.5;
source.gainNode = audioctx.createGain();
source.connect(source.gainNode);
source.gainNode.connect(audioctx.destination);
source.gainNode.gain.value = 0.3;
if(source.onload){source.onload();}
},
function(e){alert("Error with decoding audio data" + e.err);});
}
function setvol(source,vol){
  if(source.gainNode){source.gainNode.gain.value = vol;}
}
function setspeed(source,speed){
  if(source.playbackRate){source.playbackRate.value=speed;}
}
function playloop(source){source.loop=true;source.start(0);}
function playsound(source) {if(!source.gainNode){return;}
  var sourcex = audioctx.createBufferSource(); // creates a sound source
  sourcex.buffer = source.buffer;  // tell the source which sound to play
  sourcex.loop=false;
  sourcex.connect(source.gainNode);       // connect the source to the audioctx's destination (the speakers)
  sourcex.playbackRate.value=source.playbackRate.value; 
  sourcex.start(0);                           // play the source now                                           // note: on older systems, may have to use deprecated noteOn(time);
}
var wav="mp3",browser="";
if(navigator.userAgent.toLowerCase().indexOf('firefox') > -1){wav="ogg";browser="firefox";};
//if(navigator.userAgent.toLowerCase().indexOf('chrome') > -1){wav="wav";};
//alert(navigator.userAgent+" "+wav);
var audiosrc="";
var myaudio = audioctx.createBufferSource();
//audiosrc=folder+"avion2."+wav;
myaudio.volume=0;
loadsound64(myaudio,avion2mp3);
myaudio.onload=function(){
 setTimeout("playloop(myaudio);",400);
 setTimeout("setvol(myaudio,0.03);",300);
 setTimeout("setspeed(myaudio,1.0);",300);
 }
var myaudiopneu = audioctx.createBufferSource();
//audiosrc=folder+"pneu."+wav;
myaudiopneu.volume=0;
loadsound64(myaudiopneu,pneump3);
myaudiopneu.onload=function(){
 setTimeout("playsound(myaudiopneu);",500);
 setTimeout("setvol(myaudiopneu,0.4);",500);
 setTimeout("setspeed(myaudiopneu,1.0);",500);
 }
var tpneu=0;
function soundpneu(){
   playsound(myaudiopneu);
   }   
var myaudioshoot = audioctx.createBufferSource();
//audiosrc=folder+"shoot."+wav;
myaudioshoot.volume=0;
loadsound64(myaudioshoot,shootmp3);
myaudioshoot.onload=function(){
 setTimeout("playloop(myaudioshoot);",500);
 setTimeout("setvol(myaudioshoot,0.002);",500);
 setTimeout("setspeed(myaudioshoot,1.0);",500);
 }
var tshoot=0;
function soundshoot(){
   tshoot=tframe+750;
   }
var myaudioexplosion = audioctx.createBufferSource();
//audiosrc=folder+"explosion."+wav;
myaudioexplosion.volume=0;
loadsound64(myaudioexplosion,explosionmp3);
myaudioexplosion.onload=function(){
 setTimeout("playsound(myaudioexplosion);",700);
 setTimeout("setvol(myaudioexplosion,0.3);",500);
 setTimeout("setspeed(myaudioexplosion,0.70);",500);
 }
var texplosion=0;
function soundexplosion(){
   playsound(myaudioexplosion);
   } 
var myaudiorain = audioctx.createBufferSource();
//audiosrc=folder+"rain."+wav;
myaudiorain.volume=0;
loadsound64(myaudiorain,rainmp3);
myaudiorain.onload=function(){
 //setTimeout("playloop(myaudiorain);",800);
 setTimeout("setvol(myaudiorain,0.3);",700);
 setTimeout("setspeed(myaudiorain,1.0);",700);
 }
var tsoundrain=0;
function soundrain(){
   if(tframe>tsoundrain+4500){tsoundrain=tframe;
      setvol(myaudiorain,0.37);
	  playsound(myaudiorain);}
   }
function stopsoundrain(){
   if(tframe<tsoundrain+4500){tsoundrain=0;setvol(myaudiorain,0.002);}
}
var myaudiothunder = audioctx.createBufferSource();
//audiosrc=folder+"thunder."+wav;
myaudiothunder.volume=0;
loadsound64(myaudiothunder,thundermp3);
myaudiothunder.onload=function(){
 setTimeout("playsound(myaudiothunder);",900);
 setTimeout("setvol(myaudiothunder,0.7);",800);
 setTimeout("setspeed(myaudiothunder,1.0);",800);
 }
var tthunder=0;
function soundthunder(){
   playsound(myaudiothunder);
   } 
var myaudionature = audioctx.createBufferSource();
myaudionature.volume=0;
loadsound64(myaudionature,naturemp3);
myaudionature.onload=function(){
 setTimeout("playloop(myaudionature);",1000);
 setTimeout("setvol(myaudionature,0.25);",900);
 setTimeout("setspeed(myaudionature,0.54);",900);
 }
var myaudioouch = audioctx.createBufferSource();
//audiosrc=folder+"ouch."+wav;
myaudioouch.volume=0;
loadsound64(myaudioouch,ouchmp3);
myaudioouch.onload=function(){
 //setTimeout("playsound(myaudioouch);",900);
 setTimeout("setvol(myaudioouch,0.5);",800);
 setTimeout("setspeed(myaudioouch,1.0);",800);
 }
var tsoundouch=0;
function soundouch(){
   tsoundouch=tframe;
   setvol(myaudioouch,0.5);
   playsound(myaudioouch);
   } 
var myaudiosword = audioctx.createBufferSource();
myaudiosword.volume=0;
loadsound64(myaudiosword,swordmp3);
myaudiosword.onload=function(){
 //setTimeout("playsound(myaudiosword);",900);
 setTimeout("setvol(myaudiosword,0.4);",800);
 setTimeout("setspeed(myaudiosword,1.0);",800);
 }
var tsoundsword=0,weapon="sword";
function soundsword(i){
  tsoundsword=tframe;
  setvol(myaudiosword,0.4);
  if(i==0){setspeed(myaudiosword,1.0);}
  if(i==1){
   if(weapon=="sword"){setspeed(myaudiosword,0.9+Math.random()*0.014);}
   if(weapon=="axe"){setspeed(myaudiosword,0.7+Math.random()*0.014);}
  }
  if(i==2){setspeed(myaudiosword,0.75+Math.random()*0.014);}
  playsound(myaudiosword);
  } 
var myaudioslash = audioctx.createBufferSource();
myaudioslash.volume=0;
loadsound64(myaudioslash,slashmp3);
myaudioslash.onload=function(){
 //setTimeout("playsound(myaudioslash);",900);
 setTimeout("setvol(myaudioslash,0.4);",800);
 setTimeout("setspeed(myaudioslash,1.0);",800);
 }
var tsoundslash=0;
function soundslash(){
   tsoundslash=tframe;
   setvol(myaudioslash,0.4);
   playsound(myaudioslash);
   } 
var myaudioskeleton = audioctx.createBufferSource();
myaudioskeleton.volume=0;
loadsound64(myaudioskeleton,skeletonmp3);
myaudioskeleton.onload=function(){
 //setTimeout("playsound(myaudioskeleton);",900);
 setTimeout("setvol(myaudioskeleton,0.4);",800);
 setTimeout("setspeed(myaudioskeleton,1.0);",800);
 }
var tsoundskeleton=0;
function soundskeleton(){
   tsoundskeleton=tframe;
   setvol(myaudioskeleton,0.4);
   setspeed(myaudioskeleton,1.0);
   playsound(myaudioskeleton);
   } 
function soundskeleton2(){
   tsoundskeleton=tframe;
   setvol(myaudioskeleton,0.8);
   setspeed(myaudioskeleton,1.5);
   playsound(myaudioskeleton);
   } 
var myaudioaah = audioctx.createBufferSource();
myaudioaah.volume=0;
loadsound64(myaudioaah,aahmp3);
myaudioaah.onload=function(){
 //setTimeout("playsound(myaudioaah);",900);
 setTimeout("setvol(myaudioaah,0.4);",800);
 setTimeout("setspeed(myaudioaah,1.0);",800);
 }
var tsoundaah=0;
function soundaah(){
   tsoundaah=tframe;
   setvol(myaudioaah,0.4);
   playsound(myaudioaah);
   } 
var myaudiowater = audioctx.createBufferSource();
myaudiowater.volume=0;
loadsound64(myaudiowater,watermp3);
myaudiowater.onload=function(){
 //setTimeout("playsound(myaudiowater);",900);
 setTimeout("setvol(myaudiowater,0.4);",800);
 setTimeout("setspeed(myaudiowater,1.0);",800);
 }
var tsoundwater=0;
function soundwater(){
 if(tframe>tsoundwater+700){
   tsoundwater=tframe;
   setvol(myaudiowater,0.4);
   playsound(myaudiowater);
 };} 
var myaudiofoot = audioctx.createBufferSource();
myaudiofoot.volume=0;
loadsound64(myaudiofoot,footmp3);
myaudiofoot.onload=function(){
 //setTimeout("playsound(myaudiofoot);",900);
 setTimeout("setvol(myaudiofoot,0.4);",800);
 setTimeout("setspeed(myaudiofoot,1.0);",800);
 }
var tsoundfoot=0;
function soundfoot(){
 if(tframe>tsoundfoot+700){
   tsoundfoot=tframe;
   setvol(myaudiofoot,0.53);
   playsound(myaudiofoot);
 };} 
var myaudiohorse = audioctx.createBufferSource();
myaudiohorse.volume=0;
loadsound64(myaudiohorse,horsemp3);
myaudiohorse.onload=function(){
 //setTimeout("playsound(myaudiohorse);",900);
 setTimeout("setvol(myaudiohorse,0.4);",800);
 setTimeout("setspeed(myaudiohorse,1.0);",800);
 }
var tsoundhorse=0;
function soundhorse(){
 if(tframe>tsoundhorse+700){
   tsoundhorse=tframe;
   setvol(myaudiohorse,0.45);
   playsound(myaudiohorse);
 };} 
var myaudioping = audioctx.createBufferSource();
loadsound64(myaudioping,pingmp3);
myaudioping.onload=function(){
 //setTimeout("playsound(myaudioping);",900);
 setTimeout("setvol(myaudioping,0.4);",800);
 setTimeout("setspeed(myaudioping,1.0);",800);
 }
var tsoundping=0;
function soundping(){
 if(tframe>tsoundping+700){
   tsoundping=tframe;
   setvol(myaudioping,0.45);
   playsound(myaudioping);
 };} 
function closewebaudio(){
  myaudio.buffer=null;
  myaudiopneu.buffer=null;
  myaudioshoot.buffer=null;
  myaudioexplosion.buffer=null;
  myaudiorain.buffer=null;
  myaudiothunder.buffer=null;
  myaudionature.buffer=null;
  myaudioouch.buffer=null;
  myaudiosword.buffer=null;
  myaudioslash.buffer=null;
  myaudioskeleton.buffer=null;
  myaudioaah.buffer=null;
  myaudiowater.buffer=null;
  myaudiofoot.buffer=null;
  myaudiohorse.buffer=null;
  myaudioping.buffer=null;
}   
</script>
<script type="text" id="htmlaudio" >
var wav="mp3",browser="";
if(navigator.userAgent.toLowerCase().indexOf('firefox') > -1){wav="ogg";browser="firefox";};
//if(navigator.userAgent.toLowerCase().indexOf('chrome') > -1){wav="wav";};
//alert(navigator.userAgent+" "+wav);
/*var myaudio = new Audio();
myaudio.src=folder+"avion2."+wav;
myaudio.volume=0.3;
//myaudio.play();
myaudio.loop=true;
var myaudio1 = new Audio();
myaudio1.src=folder+"avion2."+wav;
myaudio1.volume=0.3;
//setTimeout("myaudio1.play();",4000);
myaudio1.loop=true;
var myaudio2 = new Audio();
myaudio2.src=folder+"avion22."+wav;
myaudio2.volume=0.3;
//setTimeout("myaudio2.play();",2000);
myaudio2.loop=true;
var myaudio21 = new Audio();
myaudio21.src=folder+"avion22."+wav;
myaudio21.volume=0.3;
//setTimeout("myaudio21.play();",6000);
myaudio21.loop=true;
var audio=null,audiosrc=null,tsoundwait=0;
function playsound(mymp3){
audio= new Audio();
audiosrc =mymp3; 
audio.src=audiosrc;
audio.volume=1.0;
//audio.addEventListener('canplay',function(){audio.play();setTimeout('tsoundwait=0;',200);});
//audio.load();
}
var myaudiopneu = new Audio()
myaudiopneu.src=folder+"pneu2."+wav;
myaudiopneu.volume=0.002;
myaudiopneu.loop=true;
myaudiopneu.play();
*/
var tpneu=0;
function soundpneu(){
   //tsoundwait=1;
   //setTimeout('playsound(folder+"pneu."+wav);',200);
   tpneu=timer()+750;
   }
//soundpneu();   
/*var myaudioshoot = new Audio()
myaudioshoot.src=folder+"shoot."+wav;
myaudioshoot.volume=0.002;
myaudioshoot.loop=true;
myaudioshoot.play();
*/
var tshoot=0;
function soundshoot(){
   tshoot=tframe+750;
   }
function soundexplosion(){};
function soundrain(){};
function stopsoundrain(){};
function soundthunder(){};
function soundouch(){};
function soundsword(i){};
function soundslash(){};
function soundskeleton(){};
function soundskeleton2(){};
function soundaah(){};
function soundwater(){};
function soundfoot(){};
function soundhorse(){};
function soundping(){};
</script>
<script id="vscreen" type="x-shader/x-vertex">
attribute vec2 a_position;//-0.5,0.5
varying vec2 textureCoord;
void main() {
   textureCoord = vec2(0.0,0.0);
   if(a_position.x>0.0){textureCoord.x=1.0;}
   if(a_position.y>0.0){textureCoord.y=1.0;}
   gl_Position = vec4(a_position.xy*2.0,0.0,1.0);
}
</script>
<script id="fscreen" type="x-shader/x-fragment">
precision mediump float;
varying vec2 textureCoord;
uniform sampler2D u_sampler;
void main() {
   vec4 color1 = texture2D(u_sampler,textureCoord);
   gl_FragColor = color1;
}
</script>
<script id="vshader2d" type="x-shader/x-vertex">
    attribute vec3 a_position;
    varying vec2 v_texcoord;
	uniform float u_texscalex,u_texscaley; 
	uniform float u_textdx,u_textdy;
    uniform float u_scalex,u_scaley;	
	uniform float u_dx,u_dy;

    void main() {
	  float x=u_dx+a_position.x*u_scalex*0.025*(1.0+abs(u_dx));
      float y=u_dy+a_position.y*u_scaley*0.025*(1.0+abs(u_dy));
	  gl_Position = vec4(x,y,a_position.z,1.0);
      v_texcoord.x = u_textdx+a_position.x*0.02*u_texscalex+0.5;
      v_texcoord.y = u_textdy+a_position.y*0.02*u_texscaley+0.5;
    }   
</script>
<script id="fshader2d" type="x-shader/x-fragment">
precision mediump float;
varying vec2 v_texcoord;
uniform sampler2D u_sampler;
uniform vec4 ucolor;
void main() {
    gl_FragColor = texture2D(u_sampler, v_texcoord);
		if(ucolor.a>0.001){
		 gl_FragColor.a+=ucolor.a;
		 gl_FragColor.r+=ucolor.r;
		 gl_FragColor.g+=ucolor.g;
		 gl_FragColor.b+=ucolor.b;
		} 		
}
</script>
<script id="shader-fs" type="x-shader/x-fragment">
    precision mediump float;
	//precision highp float;

    varying vec2 vTextureCoord;
	varying float color;

    uniform sampler2D uSampler;
	uniform vec4 ucolor;

    void main(void) {
        gl_FragColor = texture2D(uSampler, vTextureCoord);
		if(ucolor.a>0.001){
		 gl_FragColor.a*=ucolor.a;
		 if(gl_FragColor.a<0.5){discard;return;}
		 gl_FragColor.r*=ucolor.r*color;
		 gl_FragColor.g*=ucolor.g*color;
		 gl_FragColor.b*=ucolor.b*color;
		} 		
    }
</script>
<script id="shader-fssky" type="x-shader/x-fragment">
    precision mediump float;
	//precision highp float;

    varying vec2 vTextureCoord;
	varying float color;

    uniform sampler2D uSampler;
	uniform float uhour;
	uniform vec4 ucolor;

    void main(void) {
        gl_FragColor = texture2D(uSampler, vTextureCoord);
		float k,k1,v;
		v=vTextureCoord.y;
		k=(abs(12.0-uhour))/19.5;
		k=max(0.0,min(1.0,(1.0-v)*3.5*k));
		k1=1.0-k;
		gl_FragColor.r= (k*gl_FragColor.r + k1*ucolor.r); 
		gl_FragColor.g= (k*gl_FragColor.g + k1*ucolor.g); 
		gl_FragColor.b= (k*gl_FragColor.b + k1*ucolor.b); 
    }
</script>
<script id="shader-vs" type="x-shader/x-vertex">
    attribute vec3 aVertexPosition;
    attribute vec2 aTextureCoord;

    uniform mat4 uMVMatrix;
    uniform mat4 uPMatrix;

    varying vec2 vTextureCoord;
	varying float color;


    void main(void) {
        gl_Position = uPMatrix * (uMVMatrix * vec4(aVertexPosition, 1.0));
        vTextureCoord = aTextureCoord;
		color=min(1.15,0.75+abs(gl_Position.y*0.65));
    }
</script>
<script id="shader-fstree" type="x-shader/x-fragment">
    precision mediump float;
	//precision highp float;

    varying vec2 vTextureCoord;

    uniform sampler2D uSampler;
	uniform int alphatest;

    void main(void) {
	   if(vTextureCoord.x>-1.0){
        gl_FragColor = texture2D(uSampler, vTextureCoord);
		if(alphatest==1){if(gl_FragColor.a<0.5){discard;};
		}else{if(gl_FragColor.r>0.72 && gl_FragColor.g>0.72){discard;};}
	   }else{discard;};	
    }
</script>
<script id="shader-vstree" type="x-shader/x-vertex">
    attribute vec3 aVertexPosition;
    attribute vec2 aTextureCoord;

    uniform mat4 uMVMatrix;
    uniform mat4 uPMatrix;
	uniform float ucos1;
	uniform float usin1;
	uniform float uwindx,uwindy;

    varying vec2 vTextureCoord;

    void main(void) {
	    float x=aVertexPosition.x;
	    float y=aVertexPosition.y;
	    float z=aVertexPosition.z;
		if(z<0.15 || z>920.0){vTextureCoord.x=-20.0;//discard
		  gl_Position = uPMatrix * (uMVMatrix * vec4(x,y,z, 1.0)); 
		}else{
		//if(int(mod((x+y)*100.0,2.0))==0){
		 if(aTextureCoord.x<0.2){x-=usin1;y+=ucos1;}
		 if(aTextureCoord.x>0.8){x+=usin1;y-=ucos1;}
		/*}else{
		 if(aTextureCoord.x>0.8){x-=usin1;y+=ucos1;}
		 if(aTextureCoord.x<0.2){x+=usin1;y-=ucos1;}
        }*/		
		if(aTextureCoord.y>0.5){x+=uwindx;y+=uwindy;
		   float treescale=sqrt(usin1*usin1+ucos1*ucos1);
		   if((treescale)>1.001){z+=2.0*(treescale-1.0);};}//bigtree
        gl_Position = uPMatrix * (uMVMatrix * vec4(x,y,z-0.051, 1.0));
        vTextureCoord = aTextureCoord;
		};
    }
</script>
<script id="shader-fssol" type="x-shader/x-fragment">
    precision mediump float;
	//precision highp float;

    varying vec2 vTextureCoord;
    varying vec2 vTextureCoord2;
	varying float color;

    uniform sampler2D uSampler;
    uniform sampler2D uSampler2;
	uniform float hour;

    void main(void) {
	 if(color>99.0){gl_FragColor=vec4(0.2,0.6,0.9,1.0);}else{
	   if(hour<5.0 || hour>19.0){gl_FragColor = texture2D(uSampler, vTextureCoord);
              float color2=color*(1.0-0.37*(abs(12.0-hour)-4.0)/8.0);
	          gl_FragColor.rgb*=color2;
	   }else{
		float color2=color;
		if(vTextureCoord2.x>0.0 && vTextureCoord2.x<1.0 && vTextureCoord2.y>0.0 && vTextureCoord2.y<1.0){
		  vec4 fcolor2=texture2D(uSampler2, vTextureCoord2);
		  color2=max(0.25,color/(1.0+(fcolor2.r+fcolor2.g+fcolor2.b)*9.0));
        }
		//gl_FragColor = texture2D(uSampler, vec2(vTextureCoord.s, vTextureCoord.t));
        if(abs(color2-1.0)>0.001){gl_FragColor = texture2D(uSampler, vTextureCoord);
		                         gl_FragColor.rgb*=color2;
        }else{gl_FragColor = texture2D(uSampler, vTextureCoord);};
	   }
	 }	
    }
</script>
<script id="shader-vssol" type="x-shader/x-vertex">
    attribute vec3 aVertexPosition;
    attribute vec2 aTextureCoord;

    uniform mat4 uMVMatrix;
    uniform mat4 uPMatrix;
	uniform float xmin;
	uniform float xmax;
	uniform float ymin;
	uniform float ymax;
	uniform int type;
	uniform float distshadow;

    varying vec2 vTextureCoord;
    varying vec2 vTextureCoord2;
	varying float color;


    void main(void) {
	    float x=aVertexPosition.x;
	    float y=aVertexPosition.y;
	    float z=aVertexPosition.z;
		//if(type==1){
		 if(x<xmin){x+=xmax-xmin;}
		 if(x>xmax){x-=xmax-xmin;}
		 if(y<ymin){y+=ymax-ymin;}
		 if(y>ymax){y-=ymax-ymin;}
		//}; 
		if(type==0){color=1.0;}else{
		  if(z<9.0){color=1.0;}else{color=1.0+(z-8.8)*0.1;};}
		if(abs(z-0.11)<0.001){color=2.5;z=(z-0.11)*10000.0;}
		float xpiste=(xmax-xmin)*0.5;
        float ypiste=(ymax-ymin)*0.5;		
		if(type==1){
		 if(abs(x-xpiste)<62.0){
		   if(abs(y-ypiste)<62.0){z=0.1;color*=1.9;};}
		 float dxwater=x-(xpiste+500.0);//waterx
		 float dywater=y-(ypiste-400.0);
		 float distwater=dxwater*dxwater+dywater*dywater;
		 if((distwater)<10000.0){z=-0.58;color=0.7;if(distwater<7000.0){color=99.7;};};
		};
        gl_Position = uPMatrix * (uMVMatrix * vec4(x,y,z, 1.0));
        vTextureCoord = aTextureCoord;
		//float distshadow=300.0; 
		vTextureCoord2.y=0.5+(x-(xmax+xmin)*0.5)*0.5/distshadow;
		vTextureCoord2.x=0.5-(y-(ymax+ymin)*0.5)*0.5/distshadow;
    }
</script>
	<script id="shader-vsb" type="x-shader/x-vertex">
    attribute vec3 aVertexPosition;
    attribute vec2 aTextureCoord;

    uniform vec3 usunPosition;
    uniform vec3 ucameraPosition;
    uniform mat4 uMVMatrix;
    uniform mat4 uPMatrix;
	uniform float usize;
	uniform vec4 ucolor;	

    varying vec2 vTextureCoord;
	varying float alpha,r,g,b;


/*    void main(void) {
        gl_Position = uPMatrix * (uMVMatrix * (vec4(aVertexPosition, 1.0)));
        vTextureCoord = aTextureCoord;
		}
		*/
void main() {
        //alpha=abs(aTextureCoord.x)*0.3;if(alpha>1.0){alpha=1.0;};
        alpha=abs(aTextureCoord.y)*0.25;if(alpha>1.0){alpha=1.0;};
		float color=1.2-abs(aTextureCoord.x*usize)*0.2;if(color<0.1){color=0.1;};
		float distcloud=length(aVertexPosition - ucameraPosition);
		color*=(20.0+distcloud)/(4.0+distcloud);
		if(usize<0.0){color=1.0;};//sun
    	if(aTextureCoord.x>0.0){vTextureCoord.x=1.0;}else{vTextureCoord.x=0.0;}
    	if(aTextureCoord.y>0.0){vTextureCoord.y=1.0;}else{vTextureCoord.y=0.0;}
		vec3 worldPosition = aVertexPosition;
		//vec3 ucameraPosition2=uMVMatrix[3].xyz;
		vec3 eyeVector = normalize(worldPosition - ucameraPosition);
        float time=(usunPosition.z+30.0)/300.0;
		float distsun=length(usunPosition-worldPosition);
		//if(distsun>500.0){distsun=500.0;};
		float dist=length(normalize(usunPosition-ucameraPosition)-eyeVector);
		if(distsun>200.0){time*=0.8*(dist);}else{time*=1.0;alpha=1.0;};
		if(time>1.0){time=1.0;};
		if(time<0.0){time=0.0;};
		alpha*=ucolor.a;//(2.0-time);
		r=(3.0-2.0*time)*color*ucolor.r;
		g=time*color*ucolor.g;
		b=time*color*ucolor.b;

		vec3 CamUp= vec3(0.0,0.0,1.0);
		vec3 sideVector = normalize(cross(eyeVector,CamUp));
		vec3 upVector = normalize(cross(sideVector,eyeVector));

		float width = 30.0*usize;
		float height = 15.0*usize;
        int type=0;
        type=int(floor(mod(abs(aTextureCoord.x*100.0),2.0)));
        if(type==0){	
		worldPosition += sideVector * (aTextureCoord.x * width);
		}else{
		worldPosition -= sideVector * (aTextureCoord.x * width);
		}
        type=int(floor(mod(abs(aTextureCoord.y*100.0),2.0)));
        if(type==0){	
		worldPosition += upVector * (aTextureCoord.y+0.5*(abs(aTextureCoord.y)-1.0)) * height;
		}else{
		worldPosition -= upVector * (aTextureCoord.y-0.5*(abs(aTextureCoord.y)-1.0)) * height;
		}

		gl_Position = uPMatrix *(uMVMatrix *  vec4( worldPosition, 1.0 ));
    //gl_Position = uPMatrix * uMVMatrix *  vec4( aVertexPosition, 1.0 );
    }
	</script>
	<script id="shader-fsb" type="x-shader/x-fragment">
    precision mediump float;
	//precision highp float;

    varying vec2 vTextureCoord;
	varying float alpha,r,g,b;

    uniform sampler2D uSampler;

    void main(void) {
        //gl_FragColor = texture2D(uSampler, vec2(vTextureCoord.s, vTextureCoord.t));
        gl_FragColor = texture2D(uSampler, vTextureCoord);
		gl_FragColor.a*=alpha;
		gl_FragColor.r*=r;
		gl_FragColor.g*=g;
		gl_FragColor.b*=b;
    }
	</script>
<script id="shader-fsstar" type="x-shader/x-fragment">
    precision mediump float;
	//precision highp float;
    uniform float ualpha;
    void main(void) {
        gl_FragColor = vec4(1.0,1.0,1.0,ualpha);
    }
</script>
<script id="shader-vsstar" type="x-shader/x-vertex">
    attribute vec3 aVertexPosition;
    attribute vec2 aTextureCoord;

    uniform mat4 uMVMatrix;
    uniform mat4 uPMatrix;
	uniform float ucos1;
	uniform float usin1;

    void main(void) {
	    float x=aVertexPosition.x;
	    float y=aVertexPosition.y;
	    float z=aVertexPosition.z;
		float r=aTextureCoord.x;
		if(r<-0.1){x+=usin1*r;y-=ucos1*r;
		}else if(r>0.1){x+=usin1*r;y-=ucos1*r;
		}else{z+=aTextureCoord.y;}
        gl_Position = uPMatrix * (uMVMatrix * vec4(x,y,z, 1.0));
    }
</script>
<script type="text" id="main2" >

    var gl;

    window.onunload=close;
	//window.onbeforeunload=close;
    var tclose=0,timeoutkey=null,timeouttick=null;
	function subquit(){document.location.href="https://www.google.com/search?q=forest_chung&rct=j";}
	//function subquit(){document.location.href="http://chungswebsite.blogspot.fr/search/label/forest_chung";}
	function close(){
	//clearTimeout(timeoutkey);
	clearTimeout(timeouttick);
	if(tclose<2){tclose=3;
	closesounds();
	//return;// "bye bye";
	deletetextures();
	deletejsfilelist();
	//alert("close end");
	}
	}
	function closesounds(){
	if(twebaudio==1){closewebaudio();return;}
	/*myaudio.pause();myaudio.src="";
	myaudio1.pause();myaudio1.src="";
	myaudio2.pause();myaudio2.src="";
	myaudio21.pause();myaudio21.src="";
	myaudiopneu.pause();myaudiopneu.src="";
	myaudioshoot.pause();myaudioshoot.src="";
	speakaudio.pause();speakaudio.src="";*/
    }
	var fullscreen=0,winx=0,winy=7900,windx=620,windy=430;
	var windxmax=620,windymax=430;
	scrollTo(0,0);
	winy=document.getElementById("mydiv").getBoundingClientRect().top;
	winx=document.getElementById("mydiv").getBoundingClientRect().left;
	canvas.width  = Math.min(canvas.width,window.innerWidth-20);
    canvas.height = Math.min(canvas.height,window.innerHeight-36);
    document.getElementById("intext0").size=Math.min(85,parseInt((window.innerWidth-212)/8));
	windx = canvas.width;
    windy = canvas.height;
	windxmax=window.innerWidth-20;
	windymax=window.innerHeight-36;
	function sizescreen(){
	    if(fullscreen==0){fullscreen=1;
		                  canvas.width  = window.innerWidth*0.98;
                          canvas.height = window.innerHeight*0.94;
						 }else{fullscreen=0;
						  canvas.width=620;canvas.height=430;};
	canvas.width  = Math.min(canvas.width,window.innerWidth-20);
    canvas.height = Math.min(canvas.height,window.innerHeight-36);
			gl.viewportWidth = canvas.width;
            gl.viewportHeight = canvas.height;
			windx = canvas.width;
            windy = canvas.height;
            gl.viewport(0, 0, windx,windy);
            document.getElementById("canvas").style.zIndex="-9991";
            document.getElementById("intext0").size=Math.min(85,parseInt((window.innerWidth-212)/8));
			waitkey=0;
 }					 

    var ctx;
	function initctx(canvas2) {
        try {
            ctx = canvas2.getContext("2d");
    		ctx.width = canvas2.width;
            ctx.height = canvas2.height;
        } catch (e) {}
		if(!ctx){alert("couldnt init canvas2D !");}
        }
    function initGL(canvas) {
        try {
            gl = canvas.getContext("experimental-webgl");
			gl.viewportWidth = canvas.width;
            gl.viewportHeight = canvas.height;
        } catch (e) {
        }
        if (!gl) {
		   try {
            gl = canvas.getContext("webgl");
			gl.viewportWidth = canvas.width;
            gl.viewportHeight = canvas.height;
           } catch (e) {
           }
           if(!gl){
            alert("Could not initialise WebGL, sorry :-(");}
        }
    }

    function getShader(gl, id) {
        var shaderScript = document.getElementById(id);
        if (!shaderScript) {
            return null;
        }

        var str = "";
        var k = shaderScript.firstChild;
        while (k) {
            if (k.nodeType == 3) {
                str += k.textContent;
            }
            k = k.nextSibling;
        }

        var shader;
        if (shaderScript.type == "x-shader/x-fragment") {
            shader = gl.createShader(gl.FRAGMENT_SHADER);
        } else if (shaderScript.type == "x-shader/x-vertex") {
            shader = gl.createShader(gl.VERTEX_SHADER);
        } else {
            return null;
        }

        gl.shaderSource(shader, str);
        gl.compileShader(shader);

        if (!gl.getShaderParameter(shader, gl.COMPILE_STATUS)) {
            alert(gl.getShaderInfoLog(shader));
            return null;
        }

        return shader;
    }


    var shaderProgram,solProgram,cloudProgram,treeProgram,skyProgram;
	var program2d,starProgram,screenprogram;

    function initShaders() {
        var fragmentShader = getShader(gl, "shader-fs");
        var fragmentShadersky = getShader(gl, "shader-fssky");
        var vertexShader = getShader(gl, "shader-vs");
        var fragmentShadersol = getShader(gl, "shader-fssol");
        var vertexShadersol = getShader(gl, "shader-vssol");
	    var vshadercloud = getShader(gl,"shader-vsb");
	    var fshadercloud = getShader(gl,"shader-fsb");
        var fshadertree = getShader(gl, "shader-fstree");
        var vshadertree = getShader(gl, "shader-vstree");
        var fshader = getShader(gl, "fshader2d");
        var vshader = getShader(gl, "vshader2d");
        var fshaderstar = getShader(gl, "shader-fsstar");
        var vshaderstar = getShader(gl, "shader-vsstar");
        var fshaderscreen = getShader(gl, "fscreen");
        var vshaderscreen = getShader(gl, "vscreen");
	
        screenprogram = gl.createProgram();
        gl.attachShader(screenprogram, vshaderscreen);
        gl.attachShader(screenprogram, fshaderscreen);
        gl.linkProgram(screenprogram);

        if (!gl.getProgramParameter(screenprogram, gl.LINK_STATUS)) {
            alert("Could not initialise shaderscreen");
        }
		
        program2d = gl.createProgram();
        gl.attachShader(program2d, vshader);
        gl.attachShader(program2d, fshader);
        gl.linkProgram(program2d);

        if (!gl.getProgramParameter(program2d, gl.LINK_STATUS)) {
            alert("Could not initialise shaders2d");
        }

        shaderProgram = gl.createProgram();
        gl.attachShader(shaderProgram, vertexShader);
        gl.attachShader(shaderProgram, fragmentShader);
        gl.linkProgram(shaderProgram);

        if (!gl.getProgramParameter(shaderProgram, gl.LINK_STATUS)) {
            alert("Could not initialise shaders");
        }

        skyProgram = gl.createProgram();
        gl.attachShader(skyProgram, vertexShader);
        gl.attachShader(skyProgram, fragmentShadersky);
        gl.linkProgram(skyProgram);

        if (!gl.getProgramParameter(skyProgram, gl.LINK_STATUS)) {
            alert("Could not initialise skyshaders");
        }
		
        solProgram = gl.createProgram();
        gl.attachShader(solProgram, vertexShadersol);
        gl.attachShader(solProgram, fragmentShadersol);
        gl.linkProgram(solProgram);

        if (!gl.getProgramParameter(solProgram, gl.LINK_STATUS)) {
            alert("Could not initialise solshaders");
        }
        
		cloudProgram = gl.createProgram();
        gl.attachShader(cloudProgram, vshadercloud);
        gl.attachShader(cloudProgram, fshadercloud);
        gl.linkProgram(cloudProgram);

        if (!gl.getProgramParameter(cloudProgram, gl.LINK_STATUS)) {
            alert("Could not initialise cloudshaders");
        }

		treeProgram = gl.createProgram();
        gl.attachShader(treeProgram, vshadertree);
        gl.attachShader(treeProgram, fshadertree);
        gl.linkProgram(treeProgram);

        if (!gl.getProgramParameter(treeProgram, gl.LINK_STATUS)) {
            alert("Could not initialise treeshaders");
        }

		starProgram = gl.createProgram();
        gl.attachShader(starProgram, vshaderstar);
        gl.attachShader(starProgram, fshaderstar);
        gl.linkProgram(starProgram);

        if (!gl.getProgramParameter(starProgram, gl.LINK_STATUS)) {
            alert("Could not initialise starshaders");
        }

        gl.useProgram(screenprogram);

        screenprogram.vertexPositionAttribute = gl.getAttribLocation(screenprogram, "a_position");
        gl.enableVertexAttribArray(screenprogram.vertexPositionAttribute);
        screenprogram.samplerUniform = gl.getUniformLocation(screenprogram, "u_sampler");

        gl.useProgram(program2d);

        program2d.vertexPositionAttribute = gl.getAttribLocation(program2d, "a_position");
        gl.enableVertexAttribArray(program2d.vertexPositionAttribute);

        //program2d.textureCoordAttribute = gl.getAttribLocation(program2d, "a_texcoord");
        //gl.enableVertexAttribArray(program2d.textureCoordAttribute);

        program2d.samplerUniform = gl.getUniformLocation(program2d, "u_sampler");
        program2d.texscalexUniform = gl.getUniformLocation(program2d, "u_texscalex");
        program2d.texscaleyUniform = gl.getUniformLocation(program2d, "u_texscaley");
        program2d.textdxUniform = gl.getUniformLocation(program2d, "u_textdx");
        program2d.textdyUniform = gl.getUniformLocation(program2d, "u_textdy");
        program2d.colorUniform = gl.getUniformLocation(program2d, "ucolor");
        program2d.scalexUniform = gl.getUniformLocation(program2d, "u_scalex");
        program2d.scaleyUniform = gl.getUniformLocation(program2d, "u_scaley");
        program2d.dxUniform = gl.getUniformLocation(program2d, "u_dx");
        program2d.dyUniform = gl.getUniformLocation(program2d, "u_dy");


        gl.useProgram(shaderProgram);

        shaderProgram.vertexPositionAttribute = gl.getAttribLocation(shaderProgram, "aVertexPosition");
        gl.enableVertexAttribArray(shaderProgram.vertexPositionAttribute);

        shaderProgram.textureCoordAttribute = gl.getAttribLocation(shaderProgram, "aTextureCoord");
        gl.enableVertexAttribArray(shaderProgram.textureCoordAttribute);

        shaderProgram.pMatrixUniform = gl.getUniformLocation(shaderProgram, "uPMatrix");
        shaderProgram.mvMatrixUniform = gl.getUniformLocation(shaderProgram, "uMVMatrix");
        shaderProgram.samplerUniform = gl.getUniformLocation(shaderProgram, "uSampler");
        shaderProgram.colorUniform = gl.getUniformLocation(shaderProgram, "ucolor");

        gl.useProgram(skyProgram);

        skyProgram.vertexPositionAttribute = gl.getAttribLocation(skyProgram, "aVertexPosition");
        gl.enableVertexAttribArray(skyProgram.vertexPositionAttribute);

        skyProgram.textureCoordAttribute = gl.getAttribLocation(skyProgram, "aTextureCoord");
        gl.enableVertexAttribArray(skyProgram.textureCoordAttribute);

        skyProgram.pMatrixUniform = gl.getUniformLocation(skyProgram, "uPMatrix");
        skyProgram.mvMatrixUniform = gl.getUniformLocation(skyProgram, "uMVMatrix");
        skyProgram.samplerUniform = gl.getUniformLocation(skyProgram, "uSampler");
        skyProgram.colorUniform = gl.getUniformLocation(skyProgram, "ucolor");
        skyProgram.hourUniform = gl.getUniformLocation(skyProgram, "uhour");

        gl.useProgram(solProgram);

        solProgram.vertexPositionAttribute = gl.getAttribLocation(solProgram, "aVertexPosition");
        gl.enableVertexAttribArray(solProgram.vertexPositionAttribute);

        solProgram.textureCoordAttribute = gl.getAttribLocation(solProgram, "aTextureCoord");
        gl.enableVertexAttribArray(solProgram.textureCoordAttribute);

        solProgram.pMatrixUniform = gl.getUniformLocation(solProgram, "uPMatrix");
        solProgram.mvMatrixUniform = gl.getUniformLocation(solProgram, "uMVMatrix");
        solProgram.samplerUniform = gl.getUniformLocation(solProgram, "uSampler");
        solProgram.samplerUniform2 = gl.getUniformLocation(solProgram, "uSampler2");
        solProgram.xmin = gl.getUniformLocation(solProgram, "xmin");
        solProgram.xmax = gl.getUniformLocation(solProgram, "xmax");
        solProgram.ymin = gl.getUniformLocation(solProgram, "ymin");
        solProgram.ymax = gl.getUniformLocation(solProgram, "ymax");
        solProgram.type = gl.getUniformLocation(solProgram, "type");
        solProgram.hour = gl.getUniformLocation(solProgram, "hour");
        solProgram.distshadow = gl.getUniformLocation(solProgram, "distshadow");

        gl.useProgram(cloudProgram);

        cloudProgram.vertexPositionAttribute = gl.getAttribLocation(cloudProgram, "aVertexPosition");
        gl.enableVertexAttribArray(cloudProgram.vertexPositionAttribute);

        cloudProgram.textureCoordAttribute = gl.getAttribLocation(cloudProgram, "aTextureCoord");
        gl.enableVertexAttribArray(cloudProgram.textureCoordAttribute);

        cloudProgram.pMatrixUniform = gl.getUniformLocation(cloudProgram, "uPMatrix");
        cloudProgram.mvMatrixUniform = gl.getUniformLocation(cloudProgram, "uMVMatrix");
        cloudProgram.cameraPositionUniform = gl.getUniformLocation(cloudProgram, "ucameraPosition");
        cloudProgram.sunPositionUniform = gl.getUniformLocation(cloudProgram, "usunPosition");
        cloudProgram.sizeUniform = gl.getUniformLocation(cloudProgram, "usize");
        cloudProgram.samplerUniform = gl.getUniformLocation(cloudProgram, "uSampler");
        cloudProgram.colorUniform = gl.getUniformLocation(cloudProgram, "ucolor");
		
        gl.useProgram(treeProgram);

        treeProgram.vertexPositionAttribute = gl.getAttribLocation(treeProgram, "aVertexPosition");
        gl.enableVertexAttribArray(treeProgram.vertexPositionAttribute);

        treeProgram.textureCoordAttribute = gl.getAttribLocation(treeProgram, "aTextureCoord");
        gl.enableVertexAttribArray(treeProgram.textureCoordAttribute);

        treeProgram.pMatrixUniform = gl.getUniformLocation(treeProgram, "uPMatrix");
        treeProgram.mvMatrixUniform = gl.getUniformLocation(treeProgram, "uMVMatrix");
        treeProgram.cos1Uniform = gl.getUniformLocation(treeProgram, "ucos1");
        treeProgram.sin1Uniform = gl.getUniformLocation(treeProgram, "usin1");
        treeProgram.windxUniform = gl.getUniformLocation(treeProgram, "uwindx");
        treeProgram.windyUniform = gl.getUniformLocation(treeProgram, "uwindy");
        treeProgram.samplerUniform = gl.getUniformLocation(treeProgram, "uSampler");
        treeProgram.alphatestUniform = gl.getUniformLocation(treeProgram, "alphatest");
	
        gl.useProgram(starProgram);

        starProgram.vertexPositionAttribute = gl.getAttribLocation(starProgram, "aVertexPosition");
        gl.enableVertexAttribArray(starProgram.vertexPositionAttribute);

        starProgram.textureCoordAttribute = gl.getAttribLocation(starProgram, "aTextureCoord");
        gl.enableVertexAttribArray(starProgram.textureCoordAttribute);

        starProgram.pMatrixUniform = gl.getUniformLocation(starProgram, "uPMatrix");
        starProgram.mvMatrixUniform = gl.getUniformLocation(starProgram, "uMVMatrix");
        starProgram.cos1Uniform = gl.getUniformLocation(starProgram, "ucos1");
        starProgram.sin1Uniform = gl.getUniformLocation(starProgram, "usin1");		
        starProgram.alphaUniform = gl.getUniformLocation(starProgram, "ualpha");		
	
		}
		

	function handleLoadedTexture(texture) {
        gl.bindTexture(gl.TEXTURE_2D, texture);
        gl.pixelStorei(gl.UNPACK_FLIP_Y_WEBGL, true);
        gl.texImage2D(gl.TEXTURE_2D, 0, gl.RGBA, gl.RGBA, gl.UNSIGNED_BYTE, texture.image);
        //gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MAG_FILTER, gl.NEAREST);
        //gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, gl.NEAREST);
        gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MAG_FILTER, gl.LINEAR);
        gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, gl.LINEAR);
        //gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, gl.LINEAR_MIPMAP_NEAREST);
        //gl.generateMipmap(gl.TEXTURE_2D);
        gl.bindTexture(gl.TEXTURE_2D, null);
		texture.width=texture.image.width;
		texture.height=texture.image.height;
		texture.image.src=null;
    }
    function gettexturedata(texture){
	  // Create a framebuffer backed by the texture
      var framebuffer = gl.createFramebuffer();
      gl.bindFramebuffer(gl.FRAMEBUFFER, framebuffer);
      gl.framebufferTexture2D(gl.FRAMEBUFFER,gl.COLOR_ATTACHMENT0,gl.TEXTURE_2D,texture, 0);
      // Read the contents of the framebuffer (data stores the pixel data)
      var data = new Uint8Array(texture.width * texture.height * 4);
      gl.readPixels(0,0,texture.width,texture.height,gl.RGBA,gl.UNSIGNED_BYTE,data);
      gl.bindFramebuffer(gl.FRAMEBUFFER, null);
      gl.deleteFramebuffer(framebuffer);
	  return data;
    }

    var solTexture,objTexture,cloudTexture,skyTexture,sunTexture,boussTexture;
	var pisteTexture,towerTexture,cockpitTexture,compasTexture,heliceTexture,arrowTexture;
	var waterTexture,treeTexture,radarTexture,azimutTexture,tirTexture,impactTexture;
	var bloodTexture,solTexturedata;
	var skydomeTexture,corsairTexture,seaTexture,viseurTexture,rainTexture;
	var sailshipTexture,rocTexture,grassTexture,flowerTexture,trunkTexture;
	var skeletonTexture,skeletonattackTexture,arm2Texture,swordTexture;
	var potionTexture,horseTexture,farmlowTexture,castleTexture;
	var axeTexture,horselowTexture,skeletoncavTexture;
	var rttFramebuffer,rttTexture,renderbuffer;
	var rtt2Framebuffer,rtt2Texture,rtt2renderbuffer;
	var faceimage;

	function gldeleteTexture(texture){
	    if(texture){gl.deleteTexture(texture);
		            texture.image.src=null;
	                texture.image=null;};}
	function deletetextures(){
        //cancelRequestAnimationFrame(); 
	    gldeleteTexture(solTexture);
	    gldeleteTexture(objTexture);
	    gldeleteTexture(cloudTexture);
	    gldeleteTexture(skyTexture);
	    gldeleteTexture(sunTexture);
	    gldeleteTexture(boussTexture);
	    gldeleteTexture(pisteTexture);
	    gldeleteTexture(towerTexture);
	    gldeleteTexture(cockpitTexture);
	    gldeleteTexture(compasTexture);
	    gldeleteTexture(heliceTexture);
	    gldeleteTexture(arrowTexture);
	    gldeleteTexture(waterTexture);
	    gldeleteTexture(treeTexture);
	    gldeleteTexture(radarTexture);
	    gldeleteTexture(azimutTexture);
	    gldeleteTexture(tirTexture);
	    gldeleteTexture(impactTexture);
	    //gldeleteTexture(shipTexture);
	    gldeleteTexture(bloodTexture);
	    //gldeleteTexture(spitfireTexture);
	    //gldeleteTexture(zeroTexture);
	    //gldeleteTexture(shipcarrierTexture);
	    gldeleteTexture(skydomeTexture);
	    //gldeleteTexture(corsairTexture);
	    gldeleteTexture(seaTexture);
	    gldeleteTexture(viseurTexture);
	    gldeleteTexture(rainTexture);
	    //gldeleteTexture(sailshipTexture);
	    gldeleteTexture(rocTexture);
	    gldeleteTexture(grassTexture);
	    gldeleteTexture(flowerTexture);
	    gldeleteTexture(trunkTexture);
		gldeleteTexture(skeletonTexture);
		gldeleteTexture(skeletonattackTexture);
	    gldeleteTexture(arm2Texture);
		gldeleteTexture(swordTexture);
		gldeleteTexture(potionTexture);
		gldeleteTexture(horseTexture);
		gldeleteTexture(farmlowTexture);
		gldeleteTexture(castleTexture);
		gldeleteTexture(axeTexture);
		gldeleteTexture(horselowTexture);
		gldeleteTexture(skeletoncavTexture);
    }

    /*function loadtexture(texturename,texturesrc){//$$$
        eval(texturename+" = gl.createTexture();");
        eval(texturename+".image = new Image();");
        eval(texturename+".image.onload=function(){handleLoadedTexture("+texturename+")};");
        eval(texturename+".image.srcname='"+texturesrc+"';");
        eval(texturename+".image.src = "+texturesrc+";");
	}*/
    function initTexture() {
        faceimage = new Image();
        faceimage.onload = function () {
        }
        faceimage.src = skeletonpng;

        solTexture = gl.createTexture();
        solTexture.image = new Image();
        solTexture.image.onload = function () {
            handleLoadedTexture(solTexture)
            solTexturedata=gettexturedata(solTexture);
			//alert(solTexture.width+"/"+solTexture.height);
        }

        solTexture.image.src = map2jpg;
		//loadtexture("solTexture","map2jpg");

        objTexture = gl.createTexture();
        objTexture.image = new Image();
        objTexture.image.onload = function () {
            handleLoadedTexture(objTexture)
        }

        objTexture.image.src = c150jpg;

        /*objTexture2 = gl.createTexture();
        objTexture2.image = new Image();
        objTexture2.image.onload = function () {
            handleLoadedTexture(objTexture2)
        }

        objTexture2.image.src = c150redjpg;
        */
        cloudTexture = gl.createTexture();
        cloudTexture.image = new Image();
        cloudTexture.image.onload = function () {
            handleLoadedTexture(cloudTexture)
        }

        cloudTexture.image.src = cloudpng;
		
        sunTexture = gl.createTexture();
        sunTexture.image = new Image();
        sunTexture.image.onload = function () {
            handleLoadedTexture(sunTexture)
        }

        sunTexture.image.src = sunpng;
		
        boussTexture = gl.createTexture();
        boussTexture.image = new Image();
        boussTexture.image.onload = function () {
            handleLoadedTexture(boussTexture)
        }

        boussTexture.image.src = bousspng;

        pisteTexture = gl.createTexture();
        pisteTexture.image = new Image();
        pisteTexture.image.onload = function () {
            handleLoadedTexture(pisteTexture)
        }

        pisteTexture.image.src = piste12jpg;

        towerTexture = gl.createTexture();
        towerTexture.image = new Image();
        towerTexture.image.onload = function () {
            handleLoadedTexture(towerTexture)
        }

        towerTexture.image.src = tower1jpg;

        cockpitTexture = gl.createTexture();
        cockpitTexture.image = new Image();
        cockpitTexture.image.onload = function () {
            handleLoadedTexture(cockpitTexture)
        }

        cockpitTexture.image.src = c150cockpit4png;

        compasTexture = gl.createTexture();
        compasTexture.image = new Image();
        compasTexture.image.onload = function () {
            handleLoadedTexture(compasTexture)
        }

        compasTexture.image.src = compas256jpg;

        heliceTexture = gl.createTexture();
        heliceTexture.image = new Image();
        heliceTexture.image.onload = function () {
            handleLoadedTexture(heliceTexture)
        }

        heliceTexture.image.src = helice2jpg;

        arrowTexture = gl.createTexture();
        arrowTexture.image = new Image();
        arrowTexture.image.onload = function () {
            handleLoadedTexture(arrowTexture)
        }

        arrowTexture.image.src = arrowpng;

        waterTexture = gl.createTexture();
        waterTexture.image = new Image();
        waterTexture.image.onload = function () {
            handleLoadedTexture(waterTexture)
        }

        waterTexture.image.src = waterjpg;

        treeTexture = gl.createTexture();
        treeTexture.image = new Image();
        treeTexture.image.onload = function () {
            handleLoadedTexture(treeTexture)
        }

        treeTexture.image.src = tree2jpg;
		
        radarTexture = gl.createTexture();
        radarTexture.image = new Image();
        radarTexture.image.onload = function () {
            handleLoadedTexture(radarTexture)
        }

        radarTexture.image.src = radar2png;

        azimutTexture = gl.createTexture();
        azimutTexture.image = new Image();
        azimutTexture.image.onload = function () {
            handleLoadedTexture(azimutTexture)
        }

        azimutTexture.image.src = azimut2png;

        rttFramebuffer = gl.createFramebuffer();
        gl.bindFramebuffer(gl.FRAMEBUFFER, rttFramebuffer);
		if(windymax<750){
          rttFramebuffer.height = 512;
        }else if(windymax<1500){
          rttFramebuffer.height = 1024;
        }else{
          rttFramebuffer.height = 2048;
		}
		if(windxmax<750){
		  rttFramebuffer.width = 512;
        }else if(windxmax<1500){
		  rttFramebuffer.width = 1024;
        }else{
		  rttFramebuffer.width = 2048;
		}
		rttFramebuffer.width  /=2;
        rttFramebuffer.height /= 2;		
		rttTexture = gl.createTexture();
        gl.bindTexture(gl.TEXTURE_2D, rttTexture);
        gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MAG_FILTER, gl.LINEAR);
        gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, gl.LINEAR);
        gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA, rttFramebuffer.width, rttFramebuffer.height, 0, gl.RGBA, gl.UNSIGNED_BYTE, null);
        renderbuffer = gl.createRenderbuffer();
        gl.bindRenderbuffer(gl.RENDERBUFFER, renderbuffer);
        gl.renderbufferStorage(gl.RENDERBUFFER, gl.DEPTH_COMPONENT16, rttFramebuffer.width, rttFramebuffer.height);
        gl.framebufferTexture2D(gl.FRAMEBUFFER, gl.COLOR_ATTACHMENT0, gl.TEXTURE_2D, rttTexture, 0);
        gl.framebufferRenderbuffer(gl.FRAMEBUFFER, gl.DEPTH_ATTACHMENT, gl.RENDERBUFFER, renderbuffer);

        gl.bindTexture(gl.TEXTURE_2D, null);
        gl.bindRenderbuffer(gl.RENDERBUFFER, null);
        gl.bindFramebuffer(gl.FRAMEBUFFER, null);

        rtt2Framebuffer = gl.createFramebuffer();
        gl.bindFramebuffer(gl.FRAMEBUFFER, rtt2Framebuffer);
		if(windymax<750){
          rtt2Framebuffer.height = 512;
        }else if(windymax<1500){
          rtt2Framebuffer.height = 1024;
        }else{
          rtt2Framebuffer.height = 2048;
		}
		if(windxmax<750){
		  rtt2Framebuffer.width = 512;
        }else if(windxmax<1500){
		  rtt2Framebuffer.width = 1024;
        }else{
		  rtt2Framebuffer.width = 2048;
		}
		rtt2Framebuffer.width  /=2;
        rtt2Framebuffer.height /= 2;
		rtt2Texture = gl.createTexture();
        gl.bindTexture(gl.TEXTURE_2D, rtt2Texture);
        gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MAG_FILTER, gl.LINEAR);
        gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, gl.LINEAR);
        gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA, rtt2Framebuffer.width, rtt2Framebuffer.height, 0, gl.RGBA, gl.UNSIGNED_BYTE, null);
        rtt2renderbuffer = gl.createRenderbuffer();
        gl.bindRenderbuffer(gl.RENDERBUFFER, rtt2renderbuffer);
        gl.renderbufferStorage(gl.RENDERBUFFER, gl.DEPTH_COMPONENT16, rttFramebuffer.width, rttFramebuffer.height);
        gl.framebufferTexture2D(gl.FRAMEBUFFER, gl.COLOR_ATTACHMENT0, gl.TEXTURE_2D, rtt2Texture, 0);
        gl.framebufferRenderbuffer(gl.FRAMEBUFFER, gl.DEPTH_ATTACHMENT, gl.RENDERBUFFER, rtt2renderbuffer);

        gl.bindTexture(gl.TEXTURE_2D, null);
        gl.bindRenderbuffer(gl.RENDERBUFFER, null);
        gl.bindFramebuffer(gl.FRAMEBUFFER, null);


	
        skyTexture = gl.createTexture();
        skyTexture.image = new Image();
        skyTexture.image.onload = function () {
            handleLoadedTexture(skyTexture)
        }

        skyTexture.image.src = sunback2jpg;
		
        tirTexture = gl.createTexture();
        tirTexture.image = new Image();
        tirTexture.image.onload = function () {
            handleLoadedTexture(tirTexture)
        }

        tirTexture.image.src = explosionjpg;
		
        impactTexture = gl.createTexture();
        impactTexture.image = new Image();
        impactTexture.image.onload = function () {
            handleLoadedTexture(impactTexture)
        }

        impactTexture.image.src = impactjpg;
		
        bloodTexture = gl.createTexture();
        bloodTexture.image = new Image();
        bloodTexture.image.onload = function () {
            handleLoadedTexture(bloodTexture)
        }

        bloodTexture.image.src = bloodjpg;
		
        skydomeTexture = gl.createTexture();
        skydomeTexture.image = new Image();
        skydomeTexture.image.onload = function () {
            handleLoadedTexture(skydomeTexture)
        }

        if(wclouds<12){skydomeTexture.image.src = skydome3jpg;
        }else if(wclouds<50){skydomeTexture.image.src = skydomejpg;
        }else if(wclouds<75){skydomeTexture.image.src = skydome2jpg;
		}else{skydomeTexture.image.src = skydome4jpg;}
		
        seaTexture = gl.createTexture();
        seaTexture.image = new Image();
        seaTexture.image.onload = function () {
            handleLoadedTexture(seaTexture)
        }

        seaTexture.image.src = waterseajpg;

        viseurTexture = gl.createTexture();
        viseurTexture.image = new Image();
        viseurTexture.image.onload = function () {
            handleLoadedTexture(viseurTexture)
        }

        viseurTexture.image.src = viseurpng;

        rainTexture = gl.createTexture();
        rainTexture.image = new Image();
        rainTexture.image.onload = function () {
            handleLoadedTexture(rainTexture)
        }

        rainTexture.image.src = rainjpg;

        /*sailshipTexture = gl.createTexture();
        sailshipTexture.image = new Image();
        sailshipTexture.image.onload = function () {
            handleLoadedTexture(sailshipTexture)
        }

        sailshipTexture.image.src = sailshipjpg;
        */
        rocTexture = gl.createTexture();
        rocTexture.image = new Image();
        rocTexture.image.onload = function () {
            handleLoadedTexture(rocTexture)
        }

        rocTexture.image.src = rocjpg;

        grassTexture = gl.createTexture();
        grassTexture.image = new Image();
        grassTexture.image.onload = function () {
            handleLoadedTexture(grassTexture)
        }

        grassTexture.image.src = grass1jpg;

        flowerTexture = gl.createTexture();
        flowerTexture.image = new Image();
        flowerTexture.image.onload = function () {
            handleLoadedTexture(flowerTexture)
        }

        flowerTexture.image.src = flowerjpg;
        
        trunkTexture = gl.createTexture();
        trunkTexture.image = new Image();
        trunkTexture.image.onload = function () {
            handleLoadedTexture(trunkTexture)
        }

        trunkTexture.image.src = trunkjpg;
        
        skeletonTexture = gl.createTexture();
        skeletonTexture.image = new Image();
        skeletonTexture.image.onload = function () {
            handleLoadedTexture(skeletonTexture)
        }

        skeletonTexture.image.src = skeletonpng;
		
        skeletonattackTexture = gl.createTexture();
        skeletonattackTexture.image = new Image();
        skeletonattackTexture.image.onload = function () {
            handleLoadedTexture(skeletonattackTexture)
        }

        skeletonattackTexture.image.src = skeletonattackpng;

        arm2Texture = gl.createTexture();
        arm2Texture.image = new Image();
        arm2Texture.image.onload = function () {
            handleLoadedTexture(arm2Texture)
        }

        arm2Texture.image.src = arm2jpg;

        swordTexture = gl.createTexture();
        swordTexture.image = new Image();
        swordTexture.image.onload = function () {
            handleLoadedTexture(swordTexture)
        }

        swordTexture.image.src = swordjpg;

        potionTexture = gl.createTexture();
        potionTexture.image = new Image();
        potionTexture.image.onload = function () {
            handleLoadedTexture(potionTexture)
        }

        potionTexture.image.src = potionpng;

        horseTexture = gl.createTexture();
        horseTexture.image = new Image();
        horseTexture.image.onload = function () {
            handleLoadedTexture(horseTexture)
        }

        horseTexture.image.src = horsejpg;

        farmlowTexture = gl.createTexture();
        farmlowTexture.image = new Image();
        farmlowTexture.image.onload = function () {
            handleLoadedTexture(farmlowTexture)
        }

        farmlowTexture.image.src = farmlowjpg;

        castleTexture = gl.createTexture();
        castleTexture.image = new Image();
        castleTexture.image.onload = function () {
            handleLoadedTexture(castleTexture)
        }

        castleTexture.image.src = castlejpg;

        axeTexture = gl.createTexture();
        axeTexture.image = new Image();
        axeTexture.image.onload = function () {
            handleLoadedTexture(axeTexture)
        }

        axeTexture.image.src = axejpg;

        horselowTexture = gl.createTexture();
        horselowTexture.image = new Image();
        horselowTexture.image.onload = function () {
            handleLoadedTexture(horselowTexture)
        }

        horselowTexture.image.src = horselowjpg;
        
        skeletoncavTexture = gl.createTexture();
        skeletoncavTexture.image = new Image();
        skeletoncavTexture.image.onload = function () {
            handleLoadedTexture(skeletoncavTexture)
        }

        skeletoncavTexture.image.src = skeletoncavpng;
        
		}

    function drawrttshadow() {
      //gl.bindRenderbuffer(gl.RENDERBUFFER, renderbuffer);
      gl.bindFramebuffer(gl.FRAMEBUFFER, rttFramebuffer);
      //gl.framebufferTexture2D(gl.FRAMEBUFFER, gl.COLOR_ATTACHMENT0, gl.TEXTURE_2D, rttTexture, 0);
      drawshadow();
      gl.bindFramebuffer(gl.FRAMEBUFFER, null);
      //gl.bindRenderbuffer(gl.RENDERBUFFER, null);
    }
	var o1screen=0,o2screen=0,o3screen=0;
	var xscreen=0,yscreen=0,zscreen=0;
    function drawrttscene() {
		   //gl.viewport(0, 0, windx,windy);
		   //gl.clearColor(1,0.5,0.0, 1);
           //gl.clear(gl.COLOR_BUFFER_BIT | gl.DEPTH_BUFFER_BIT);
	var dx=0.1;
	//var dxyz=(x-xscreen)*cos1*cos2+(y-yscreen)*sin1*cos2+(z-zscreen)*sin2;
	if(Math.abs(o1screen-o1)>1.5 || Math.abs(o2screen-o2)>1.5 
       || Math.abs(o3screen-o3)>1 
	   || Math.abs(xscreen-x)>dx || Math.abs(yscreen-y)>dx
	   || Math.abs(zscreen-z)>dx){ 
      o1screen=o1;o2screen=o2;o3screen=o3;
      xscreen=x;yscreen=y;zscreen=z;	  
      //gl.bindRenderbuffer(gl.RENDERBUFFER, rtt2renderbuffer);
      gl.bindFramebuffer(gl.FRAMEBUFFER, rtt2Framebuffer);
      //gl.framebufferTexture2D(gl.FRAMEBUFFER, gl.COLOR_ATTACHMENT0, gl.TEXTURE_2D, rtt2Texture, 0);
      var windx0=windx,windy0=windy;
	  windx=rtt2Framebuffer.width;
	  windy=rtt2Framebuffer.height;
	  drawscene((47+1.5)/47);
	  windx=windx0;windy=windy0;
      gl.bindFramebuffer(gl.FRAMEBUFFER, null);
      //gl.bindRenderbuffer(gl.RENDERBUFFER, null);
	  }
    o10screen=o1;
	var do1=0,do2=0,do3=0,sc=1;
	do1=o1-o1screen;do2=o2-o2screen;do3=o3-o3screen;
	updatescreen(do1,do2,do3,sc);
	drawscenescreen();
    }
	
    var mvMatrix = mat4.create();
    var mvMatrixStack = [];
    var pMatrix = mat4.create();
    var camx=0,camy=0,camz=0;

    function mvPushMatrix() {
        var copy = mat4.create();
        mat4.set(mvMatrix, copy);
        mvMatrixStack.push(copy);
    }

    function mvPopMatrix() {
        if (mvMatrixStack.length == 0) {
            throw "Invalid popMatrix!";
        }
        mvMatrix = mvMatrixStack.pop();
    }


    function setMatrixUniformssol() {
        gl.uniformMatrix4fv(solProgram.pMatrixUniform, false, pMatrix);
        gl.uniformMatrix4fv(solProgram.mvMatrixUniform, false, mvMatrix);
        gl.uniform1f(solProgram.xmin, x-(xmax-xmin)/2);
        gl.uniform1f(solProgram.xmax, x+(xmax-xmin)/2);
        gl.uniform1f(solProgram.ymin, y-(ymax-ymin)/2);
        gl.uniform1f(solProgram.ymax, y+(ymax-ymin)/2);
        /*gl.uniform1f(solProgram.xmin, xmin);
        gl.uniform1f(solProgram.xmax, xmax);
        gl.uniform1f(solProgram.ymin, ymin);
        gl.uniform1f(solProgram.ymax, ymax);*/
        gl.uniform1i(solProgram.type, 1);
        gl.uniform1f(solProgram.hour, hour);
        gl.uniform1f(solProgram.distshadow, distshadow);
    }
    function setMatrixUniformspiste() {
        gl.uniformMatrix4fv(solProgram.pMatrixUniform, false, pMatrix);
        gl.uniformMatrix4fv(solProgram.mvMatrixUniform, false, mvMatrix);
        gl.uniform1f(solProgram.xmin, x-(xmax-xmin)/2);
        gl.uniform1f(solProgram.xmax, x+(xmax-xmin)/2);
        gl.uniform1f(solProgram.ymin, y-(ymax-ymin)/2);
        gl.uniform1f(solProgram.ymax, y+(ymax-ymin)/2);
        gl.uniform1i(solProgram.type, 2);
        gl.uniform1f(solProgram.hour, hour);
        gl.uniform1f(solProgram.distshadow, distshadow);
    }
    function setMatrixUniformstown() {
        gl.uniformMatrix4fv(solProgram.pMatrixUniform, false, pMatrix);
        gl.uniformMatrix4fv(solProgram.mvMatrixUniform, false, mvMatrix);
        gl.uniform1f(solProgram.xmin, x-(xmax-xmin)/2);
        gl.uniform1f(solProgram.xmax, x+(xmax-xmin)/2);
        gl.uniform1f(solProgram.ymin, y-(ymax-ymin)/2);
        gl.uniform1f(solProgram.ymax, y+(ymax-ymin)/2);
        gl.uniform1i(solProgram.type, 2);
        gl.uniform1f(solProgram.hour, hour);
        gl.uniform1f(solProgram.distshadow, distshadow);
    }
    function setMatrixUniformssea() {
        gl.uniformMatrix4fv(solProgram.pMatrixUniform, false, pMatrix);
        gl.uniformMatrix4fv(solProgram.mvMatrixUniform, false, mvMatrix);
        gl.uniform1f(solProgram.xmin, x-(xmax-xmin)*4);
        gl.uniform1f(solProgram.xmax, x+(xmax-xmin)*4);
        gl.uniform1f(solProgram.ymin, y-(ymax-ymin)*4);
        gl.uniform1f(solProgram.ymax, y+(ymax-ymin)*4);
        gl.uniform1i(solProgram.type, 2);
        gl.uniform1f(solProgram.hour, hour);
        gl.uniform1f(solProgram.distshadow, distshadow);
    }
	 var colorr=1.0,colorg=1.0,colorb=1.0,colora=1.0;
     function setMatrixUniforms() {
        gl.uniformMatrix4fv(shaderProgram.pMatrixUniform, false, pMatrix);
        gl.uniformMatrix4fv(shaderProgram.mvMatrixUniform, false, mvMatrix);
        gl.uniform4f(shaderProgram.colorUniform,colorr,colorg,colorb,colora);
    }
    function setskyMatrixUniforms() {
        gl.uniformMatrix4fv(skyProgram.pMatrixUniform, false, pMatrix);
        gl.uniformMatrix4fv(skyProgram.mvMatrixUniform, false, mvMatrix);
        gl.uniform4f(skyProgram.colorUniform,clearr,clearg,clearb,1.0);
        gl.uniform1f(skyProgram.hourUniform,hour); 
    }
   function setcloudMatrixUniforms() {
        //gl.uniform3fv(cloudProgram.cameraPositionUniform,[x,y,z]);
        gl.uniform1f(cloudProgram.sizeUniform,cloudsize);
        gl.uniform3f(cloudProgram.sunPositionUniform,x+sunx,y+suny,z+sunz);
        gl.uniform3f(cloudProgram.cameraPositionUniform,camx,camy,camz);
        gl.uniformMatrix4fv(cloudProgram.pMatrixUniform, false, pMatrix);
        gl.uniformMatrix4fv(cloudProgram.mvMatrixUniform, false, mvMatrix);
        gl.uniform4f(cloudProgram.colorUniform,colorr,colorg,colorb,colora);
    }
   function setsunMatrixUniforms() {
        //gl.uniform3fv(cloudProgram.cameraPositionUniform,[x,y,z]);
        gl.uniform1f(cloudProgram.sizeUniform,-1.0);
        gl.uniform3f(cloudProgram.sunPositionUniform,x+sunx,y+suny,z+sunz);
        gl.uniform3f(cloudProgram.cameraPositionUniform,camx,camy,camz);
        gl.uniformMatrix4fv(cloudProgram.pMatrixUniform, false, pMatrix);
        gl.uniformMatrix4fv(cloudProgram.mvMatrixUniform, false, mvMatrix);
        gl.uniform4f(cloudProgram.colorUniform,colorr,colorg,colorb,colora);
    }
   var uwinddx=0,uwinddy=0,treescale=4;	
   function setMatrixUniformstree() {
        var h=treescale;
        if(tourelle==0 || tfoot==1){
		  gl.uniform1f(treeProgram.cos1Uniform,cos1*h);
          gl.uniform1f(treeProgram.sin1Uniform,sin1*h);
        }else{
		  gl.uniform1f(treeProgram.cos1Uniform,tcos1*h);
          gl.uniform1f(treeProgram.sin1Uniform,tsin1*h);
		}
		gl.uniform1f(treeProgram.windxUniform,uwinddx/4.5);
        gl.uniform1f(treeProgram.windyUniform,uwinddy/4.5);
		gl.uniformMatrix4fv(treeProgram.pMatrixUniform, false, pMatrix);
        gl.uniformMatrix4fv(treeProgram.mvMatrixUniform, false, mvMatrix);
		gl.uniform1i(treeProgram.alphatestUniform,0);
    }
   function setMatrixUniformsgrass() {
        var sc=0.25;
        if(tourelle==0 || tfoot==1){
		  gl.uniform1f(treeProgram.cos1Uniform,cos1*sc);
          gl.uniform1f(treeProgram.sin1Uniform,sin1*sc);
        }else{
		  gl.uniform1f(treeProgram.cos1Uniform,tcos1*sc);
          gl.uniform1f(treeProgram.sin1Uniform,tsin1*sc);
		}
		gl.uniform1f(treeProgram.windxUniform,uwinddx);
        gl.uniform1f(treeProgram.windyUniform,uwinddy);
		gl.uniformMatrix4fv(treeProgram.pMatrixUniform, false, pMatrix);
        gl.uniformMatrix4fv(treeProgram.mvMatrixUniform, false, mvMatrix);
		gl.uniform1i(treeProgram.alphatestUniform,0);
    }
   function setMatrixUniformsskeleton(scale) {
        var sc=scale;
        if(tourelle==0 || tfoot==1){
		  gl.uniform1f(treeProgram.cos1Uniform,cos1*sc);
          gl.uniform1f(treeProgram.sin1Uniform,sin1*sc);
        }else{
		  gl.uniform1f(treeProgram.cos1Uniform,tcos1*sc);
          gl.uniform1f(treeProgram.sin1Uniform,tsin1*sc);
		}
		gl.uniform1f(treeProgram.windxUniform,uwinddx);
        gl.uniform1f(treeProgram.windyUniform,uwinddy);
		gl.uniformMatrix4fv(treeProgram.pMatrixUniform, false, pMatrix);
        gl.uniformMatrix4fv(treeProgram.mvMatrixUniform, false, mvMatrix);
		gl.uniform1i(treeProgram.alphatestUniform,1);
    }
   function setMatrixUniformsstar() {
        if(tourelle==0){
		  gl.uniform1f(starProgram.cos1Uniform,cos1);
          gl.uniform1f(starProgram.sin1Uniform,sin1);
        }else{
		  gl.uniform1f(starProgram.cos1Uniform,tcos1);
          gl.uniform1f(starProgram.sin1Uniform,tsin1);
		}
        gl.uniform1f(starProgram.alphaUniform,colora);
        gl.uniformMatrix4fv(starProgram.pMatrixUniform, false, pMatrix);
        gl.uniformMatrix4fv(starProgram.mvMatrixUniform, false, mvMatrix);
    }
   var texscalex=1,texscaley=1,textdx=0,textdy=0,scalex2d=1;scaley2d=1,dx2d=0,dy2d=0;   
   function setMatrixUniforms2D() {
        gl.uniform1f(program2d.texscalexUniform,texscalex);
        gl.uniform1f(program2d.texscaleyUniform,texscaley);
        gl.uniform1f(program2d.textdxUniform,textdx);
        gl.uniform1f(program2d.textdyUniform,textdy);
        gl.uniform4f(program2d.colorUniform,colorr,colorg,colorb,colora);
        gl.uniform1f(program2d.scalexUniform,scalex2d);
        gl.uniform1f(program2d.scaleyUniform,scaley2d);
        gl.uniform1f(program2d.dxUniform,dx2d);
        gl.uniform1f(program2d.dyUniform,dy2d);
   }
 

    function degtorad(degrees) {
        return degrees * Math.PI / 180;
    }

    var solVertexPositionBuffer;
    var solVertexTextureCoordBuffer;
    var solVertexIndexBuffer;
	var solVertexIndices,solTextureCoords;
	var height;
	var cloudVertexPositionBuffer;
    var cloudVertexTextureCoordBuffer;
	var cloudvertices;
	var cloudtextureCoords,cloudscale;
	var sunVertexPositionBuffer;
    var sunVertexTextureCoordBuffer;
	var sunvertices;
	var boussVertexPositionBuffer;
    var boussVertexTextureCoordBuffer;
	var boussvertices;
	var pisteVertexPositionBuffer;
    var pisteVertexTextureCoordBuffer;
	var pistevertices;
	var towerVertexPositionBuffer;
    var towerVertexTextureCoordBuffer;
	var towervertices;
	var townVertexPositionBuffer;
    var townVertexTextureCoordBuffer;
	var townvertices,townx,towny,townz,towno1,towndx,towndz;
	var waterVertexPositionBuffer;
    var waterVertexTextureCoordBuffer;
	var watervertices;
	var seaVertexPositionBuffer;
    var seaVertexTextureCoordBuffer;
	var seavertices,seatextureCoords;
	var horizonVertexPositionBuffer;
    var horizonVertexTextureCoordBuffer;
	var horizonvertices,horizontextureCoords;
	var treeVertexPositionBuffer;
    var treeVertexTextureCoordBuffer;
	var treevertices,treevertices2,tforest;
	var tirVertexPositionBuffer;
    var tirVertexTextureCoordBuffer;
	var tirvertices,tirx,tiry,tirz,vtirx,vtiry,vtirz,ttir,tirsize,tirtype;
	var starVertexPositionBuffer;
    var starVertexTextureCoordBuffer;
	var starvertices;
	var grassVertexPositionBuffer;
    var grassVertexTextureCoordBuffer;
	var grassvertices,grassh,grassvertices2,grassx,grassy,grassz;
	var carreVertexPositionBuffer;
    var carreVertexTextureCoordBuffer;
	var screenVertexPositionBuffer;
	var screenvertices;
	var flowerVertexPositionBuffer;
    var flowerVertexTextureCoordBuffer;
	var flowervertices,flowerh;

	var n=256,nmap=60,index=0,nmap2=nmap,distmap2=999;
	var scale=n*70/nmap;
	var n4=scale;
	var ncloud=parseInt(40*1.2*1.2),ncloud2=ncloud;
	//var xmax=0.97*(scale*(8.0*n)/n-n4), ymax=0.97*(scale*(n*8.0/n)-n4);
	//var xmin=0.97*(scale*(8.0*0)/n-n4), ymin=0.97*(scale*(0*8.0/n)-n4);
	var xmax=(scale*(8.0*n)/n-n4)-4, ymax=(scale*(n*8.0/n)-n4)-4;
	var xmin=(scale*(8.0*0)/n-n4)+4, ymin=(scale*(0*8.0/n)-n4)+4;
	var sunx=1000,suny=200,sunz=800;
	var boussx=43,boussy=43,boussz=0,landing=0;
	var npiste=7,ntower=1,ntown=10,ntree=parseInt(700*0.8*0.8/1.3),ntir=200,itir=0;
	var nstar=140,ngrass=3500,nflower=100;
    var pistex=(xmax-xmin)*0.5;
	var pistey=(ymax-ymin)*0.5;
	var waterx=(xmax-xmin)*0.5+500;
	var watery=(ymax-ymin)*0.5-400;
	var seaheight=0;
	var mounti=new Array(200),mountj=new Array(200);
	var mounth=new Array(200),nmount=2*35;
	function append(tab,values){
	  for(var i=0;i<values.length;i++){
	     tab[index]=values[i];index+=1;
	  }
	}
	function appendrot(tab,values,s,t,rot){
	  var co1=Math.cos(rot);
	  var si1=Math.sin(rot);
	  for(var i=0;i<values.length;i++){
	     var xx=values[i];i++;if(i>=values.length){break;};
		 var yy=values[i];i++;if(i>=values.length){break;};
         tab[index]=s+(xx-s)*co1-(yy-t)*si1;index+=1;
		 tab[index]=t+(xx-s)*si1+(yy-t)*co1;index+=1; 
	     tab[index]=values[i];index+=1;
	  }
	}
	function reinitsol(){
	    if(solmap && solmap!=""){reinitsolmap(solmap);return;}
	    Math.seedrandom(seedrand);
	    irnd=0;
        //solVertexPositionBuffer = gl.createBuffer();
        gl.bindBuffer(gl.ARRAY_BUFFER, solVertexPositionBuffer);
        var vertices = new Array(3*n*n);
		//height=new Array((n+1)*(n+1));
		var heightx=new Array((n+1)*(n+1));
		var heighty=new Array((n+1)*(n+1));
		var w=1.0,wx=1.0,wy=1.0;
		for (var j=0; j < n; j++) {
        for(var i=0;i<n;i++){
		   if(Mathrandom()<0.2){w=Mathrandom()+0.35;}
		   wx+=(w-wx)*0.3;
		   heightx[i*n+j]=Math.cos(80*wx*(i)/nmap);
		}}
		for (var i=0; i < n; i++) {
        for(var j=0;j<n;j++){
		   if(Mathrandom()<0.2){w=Mathrandom()+0.35;}
		   wy+=(w-wy)*0.3;
		   heighty[i*n+j]=Math.cos(80*wy*(j)/nmap);
		}}
        seaheight=5.05;if(tsea==0){seaheight=0;}
		for (var i=0; i <= n; i++) {
        for(var j=0;j<n;j++){
		   height[i*n+j]=5*heightx[i*n+j]*heighty[i*n+j];//(Math.cos(80*(i)/nmap)*Math.cos(80*(j)/nmap))*4.0;
		}}
		nmount=35*2;if(seaheight<0.1){nmount=35;}
		for(var i=0;i<nmount;i++){
		   var imount=n*(0.5+0.9*(Mathrandom()-0.5));
		   var jmount=n*(0.5+0.9*(Mathrandom()-0.5));
		   var hmount=14*(1+Mathrandom());
		   mounti[i]=imount;mountj[i]=jmount;mounth[i]=hmount;
		   var dj=8;
		   for(var j=-dj;j<dj;j++){
		   for(var k=-dj;k<dj;k++){
		      var jj=parseInt(j+imount),kk=parseInt(k+jmount);
			  if(jj>0 && jj<n && kk>0 && kk<n){
			    height[jj*n+kk]+=hmount*Math.cos(Math.abs(3.1416*j*0.5/dj))*Math.cos(Math.abs(3.1416*k*0.5/dj));
			  }
		   }
		   }
		}
		for (var i=0; i <= n; i++) {
        for(var j=0;j<n;j++){
		   height[i*n+j]-=seaheight;
		   if(height[i*n+j]<-0.4){height[i*n+j]=-0.4;}
		   }
		}   

		initriver();
		initsolroads();
		initcastle();
		initroad();
		//x=0.25*(scale*((n)*8.0)/n-n4);y=x;
		var px=0,py=0;
		index=0;
		for (var i=0; i < n; i++) {
        for(var j=0;j<n;j++){
		   px=(scale*(i*8.0/n)-n4);py=scale*(j*8.0/n)-n4;
    	   if(Math.abs(px-pistex)<62.0){
	         if(Math.abs(py-pistey)<62.0){height[i*n+j]=0.1;};}
	       var dxwater=px-waterx;
	       var dywater=py-watery;
	       if((dxwater*dxwater+dywater*dywater)<10000){height[i*n+j]=-0.58;}
    	   var dxtown=px-(xmax-xmin)*0.7;
		   var dytown=py-(ymax-ymin)*0.7;
		   if(Math.abs(dxtown)<47.0){
	         if(Math.abs(dytown)<47.0){if(height[i*n+j]<0.1){height[i*n+j]=0.1;};};}
		   append(vertices,[
             px,py,  height[i*n+j]
             //(scale*((i+1)*8.0)/n-32)*12/8,  scale*(j*8.0/n)-n4,  height[(i+1)*n+j]
            ]);
		   
		}}		
        gl.bufferData(gl.ARRAY_BUFFER, new Float32Array(vertices), gl.STATIC_DRAW);
        solVertexPositionBuffer.itemSize = 3;
        solVertexPositionBuffer.numItems = n*n;

	    Math.seedrandom(seedrand);
		var xc=0,yc=0,zc=0;
		//townVertexPositionBuffer = gl.createBuffer();
        gl.bindBuffer(gl.ARRAY_BUFFER, townVertexPositionBuffer);
        //townvertices = new Float32Array(3*6*6*ntown);
		//townx=new Array(ntown);towny=new Array(ntown);townz=new Array(ntown);
		//towno1=new Array(ntown);towndx=new Array(ntown);towndz=new Array(ntown);
		xc=0;yc=0;zc=0;
		index=0;
		for (var i=0; i < ntown; i++) {
		   xc=2.5;
		   yc=2.5;
		   zc=3;
		   var s=(xmax-xmin)*0.7,t=(ymax-ymin)*0.7,h=1.5;
		   s+= Math.floor( Mathrandom() * 200 - 100 ) * 0.42;
		   t+= Math.floor( Mathrandom() * 200 - 100 ) * 0.42;
		   var rot= Mathrandom();
		   var scx= Mathrandom() * Mathrandom() * Mathrandom() * Mathrandom() * 50 + 10;
		   xc*=scx/10;yc*=scx/10;			
		   zc*=(( Mathrandom() * Mathrandom() * Mathrandom() * scx ) * 8 + 8)/10;
		   towndx[i]=xc;towndz[i]=zc;
		   zc+=getterrainheight(s,t)-xc*0.1;
		   townx[i]=s;towny[i]=t;townz[i]=zc;towno1[i]=rot;
		   appendrot(townvertices,[
             //s-xc,t-yc,zc,  s-xc,t+yc,zc,  s+xc,t-yc,zc,
             //s-xc,t+yc,zc,  s+xc,t+yc,zc,  s+xc,t-yc,zc,
             s-xc,t-yc,zc,  s-xc,t+yc,zc,  s,t,zc+h,
             s+xc,t-yc,zc,  s+xc,t+yc,zc,  s,t,zc+h,
             s-xc,t-yc,zc,  s+xc,t-yc,zc,  s,t,zc+h,
             s-xc,t+yc,zc,  s+xc,t+yc,zc,  s,t,zc+h,
			 
             s-xc,t-yc,0,  s-xc,t-yc,zc,  s+xc,t-yc,0,
             s-xc,t-yc,zc,  s+xc,t-yc,zc,  s+xc,t-yc,0,			 
             
             s-xc,t+yc,0,  s-xc,t+yc,zc,  s+xc,t+yc,0,
             s-xc,t+yc,zc,  s+xc,t+yc,zc,  s+xc,t+yc,0,			 
             
			 s-xc,t-yc,0,  s-xc,t-yc,zc,  s-xc,t+yc,0,
             s-xc,t-yc,zc,  s-xc,t+yc,zc,  s-xc,t+yc,0,			 
             
			 s+xc,t-yc,0,  s+xc,t-yc,zc,  s+xc,t+yc,0,
             s+xc,t-yc,zc,  s+xc,t+yc,zc,  s+xc,t+yc,0,			 
			 
			 ],s,t,rot); 
		}	
        gl.bufferData(gl.ARRAY_BUFFER, (townvertices), gl.STATIC_DRAW);
        townVertexPositionBuffer.itemSize = 3;
        townVertexPositionBuffer.numItems = 6*6*ntown;

	    Math.seedrandom(seedrand);
        //treeVertexPositionBuffer = gl.createBuffer();
        gl.bindBuffer(gl.ARRAY_BUFFER, treeVertexPositionBuffer);
        //treevertices = new Float32Array(3*3*ntree);
		xc=0;yc=0;zc=0;
		index=0;
		for (var i=0; i < ntree; i++) {
		   zc=1;
		   var h=2;
		   var s=Mathrandom()*2*90+(xmax-xmin)*0.5;
		   var t=Mathrandom()*2*90+(ymax-ymin)*0.5;
		   if(tsea>0.1){s+=9999;}
		   zc=getterrainheight(s,t);
		   if(zc<0.15 || zc>20){zc=-999;}
		   if(tforest[(parseInt(n+n*s/xmax)%n)*n+parseInt(n+n*t/ymax)%n]==0){
		      zc=-999;}
		   treex[i]=s;treey[i]=t;treez[i]=zc;
		   append(treevertices,[
             s-xc,t-yc,zc,  s,t,zc+h,  s+xc,t+yc,zc	 
			 ]); 
		}	
        gl.bufferData(gl.ARRAY_BUFFER, (treevertices), gl.STATIC_DRAW);
        treeVertexPositionBuffer.itemSize = 3;
        treeVertexPositionBuffer.numItems = 3*ntree;

	    Math.seedrandom(seedrand);
        //grassVertexPositionBuffer = gl.createBuffer();
        gl.bindBuffer(gl.ARRAY_BUFFER, grassVertexPositionBuffer);
        //grassvertices = new Float32Array(3*3*ngrass);
		//grassh=new Array(ngrass);
		xc=0;yc=0;zc=0;
		index=0;
		for (var i=0; i < ngrass; i++) {
		   zc=1;
		   var h=2*0.3;
		   var s=Math.random()*2*24+(xmax-xmin)*0.5;
		   var t=Math.random()*2*24+(ymax-ymin)*0.5;
		   zc=getterrainheight(s,t)+0.15;
		   h=2*0.2*(1+Math.random()*0.5);grassh[i]=h;
		   append(grassvertices,[
             s,t,zc,  s,t,zc+h,  s,t,zc			 
			 ]); 
		}	
        gl.bufferData(gl.ARRAY_BUFFER, (grassvertices), gl.STATIC_DRAW);
        grassVertexPositionBuffer.itemSize = 3;
        grassVertexPositionBuffer.numItems = 3*ngrass;
        
		//flowerVertexPositionBuffer = gl.createBuffer();
        gl.bindBuffer(gl.ARRAY_BUFFER, flowerVertexPositionBuffer);
        //flowervertices = new Float32Array(3*6*nflower);
		//flowerh=new Array(nflower);
		xc=0;yc=0;zc=0;
		index=0;
		for (var i=0; i < nflower; i++) {
		   zc=1;
		   var h=2*0.3;
		   var s=Math.random()*2*24+(xmax-xmin)*0.5;
		   var t=Math.random()*2*24+(ymax-ymin)*0.5;
		   zc=getterrainheight(s,t)+0.15;
		   h=2*0.2*(1+Math.random()*0.5);flowerh[i]=h;
		   append(flowervertices,[
             s,t,zc,  s,t,zc+h,  s,t,zc,
             s,t,zc+h, s,t,zc+h, s,t,zc			 
			 ]); 
		}	
        gl.bufferData(gl.ARRAY_BUFFER, (flowervertices), gl.STATIC_DRAW);
        flowerVertexPositionBuffer.itemSize = 3;
        flowerVertexPositionBuffer.numItems = 6*nflower;

		if(tsea>0){resetcarrier();resetsailships();}
		
		resetrocs();
		}

	function reinitsolmap(map){
		if(!map){alert("wrong map "+map);return;}
		var maps=[];maps=map.split("/");
	    Math.seedrandom(seedrand);
	    irnd=0;
        //solVertexPositionBuffer = gl.createBuffer();
        gl.bindBuffer(gl.ARRAY_BUFFER, solVertexPositionBuffer);
        var vertices = new Array(3*n*n);
		//height=new Array((n+1)*(n+1));
        seaheight=0.4;if(tsea==0){seaheight=-0.1;}
		for (var i=0; i <= n; i++) {
        for(var j=0;j<n;j++){
		   height[i*n+j]=maps[i*n+j]/8;
		}}
		for (var i=0; i <= n; i++) {
        for(var j=0;j<n;j++){
		   height[0*n+j]=-0.4;
		   height[n*n-n+j]=-0.4;
		   height[i*n+0]=-0.4;
		   height[i*n+n-1]=-0.4;
		   height[i*n+j]-=seaheight;
		   if(height[i*n+j]<-0.4){height[i*n+j]=-0.4;}
		   }
		}		

		initriver();
		initsolroads();
		initcastle();
		initroad();
		//x=0.25*(scale*((n)*8.0)/n-n4);y=x;
		var px=0,py=0;
		index=0;
		for (var i=0; i < n; i++) {
        for(var j=0;j<n;j++){
		   px=(scale*(i*8.0/n)-n4);py=scale*(j*8.0/n)-n4;
    	   if(Math.abs(px-pistex)<62.0){
	         if(Math.abs(py-pistey)<62.0){height[i*n+j]=0.1;};}
	       var dxwater=px-waterx;
	       var dywater=py-watery;
	       if((dxwater*dxwater+dywater*dywater)<10000){height[i*n+j]=-0.3;}
    	   var dxtown=px-(xmax-xmin)*0.7;
		   var dytown=py-(ymax-ymin)*0.7;
		   if(Math.abs(dxtown)<47.0){
	         if(Math.abs(dytown)<47.0){if(height[i*n+j]<0.1){height[i*n+j]=0.1;};};}
		   append(vertices,[
             px,py,  height[i*n+j]
             //(scale*((i+1)*8.0)/n-32)*12/8,  scale*(j*8.0/n)-n4,  height[(i+1)*n+j]
            ]);
		   
		}}		
        gl.bufferData(gl.ARRAY_BUFFER, new Float32Array(vertices), gl.STATIC_DRAW);
        solVertexPositionBuffer.itemSize = 3;
        solVertexPositionBuffer.numItems = n*n;

	    Math.seedrandom(seedrand);
		var xc=0,yc=0,zc=0;
		//townVertexPositionBuffer = gl.createBuffer();
        gl.bindBuffer(gl.ARRAY_BUFFER, townVertexPositionBuffer);
        //townvertices = new Float32Array(3*6*6*ntown);
		//townx=new Array(ntown);towny=new Array(ntown);townz=new Array(ntown);
		//towno1=new Array(ntown);towndx=new Array(ntown);towndz=new Array(ntown);
		xc=0;yc=0;zc=0;
		index=0;
		for (var i=0; i < ntown; i++) {
		   xc=2.5;
		   yc=2.5;
		   zc=3;
		   var s=(xmax-xmin)*0.7,t=(ymax-ymin)*0.7,h=1.5;
		   s+= Math.floor( Mathrandom() * 200 - 100 ) * 0.42;
		   t+= Math.floor( Mathrandom() * 200 - 100 ) * 0.42;
		   var rot= Mathrandom();
		   var scx= Mathrandom() * Mathrandom() * Mathrandom() * Mathrandom() * 50 + 10;
		   xc*=scx/10;yc*=scx/10;			
		   zc*=(( Mathrandom() * Mathrandom() * Mathrandom() * scx ) * 8 + 8)/10;
		   towndx[i]=xc;towndz[i]=zc;
		   zc+=getterrainheight(s,t)-xc*0.1;
		   townx[i]=s;towny[i]=t;townz[i]=zc;towno1[i]=rot;
		   appendrot(townvertices,[
             //s-xc,t-yc,zc,  s-xc,t+yc,zc,  s+xc,t-yc,zc,
             //s-xc,t+yc,zc,  s+xc,t+yc,zc,  s+xc,t-yc,zc,
             s-xc,t-yc,zc,  s-xc,t+yc,zc,  s,t,zc+h,
             s+xc,t-yc,zc,  s+xc,t+yc,zc,  s,t,zc+h,
             s-xc,t-yc,zc,  s+xc,t-yc,zc,  s,t,zc+h,
             s-xc,t+yc,zc,  s+xc,t+yc,zc,  s,t,zc+h,
			 
             s-xc,t-yc,0,  s-xc,t-yc,zc,  s+xc,t-yc,0,
             s-xc,t-yc,zc,  s+xc,t-yc,zc,  s+xc,t-yc,0,			 
             
             s-xc,t+yc,0,  s-xc,t+yc,zc,  s+xc,t+yc,0,
             s-xc,t+yc,zc,  s+xc,t+yc,zc,  s+xc,t+yc,0,			 
             
			 s-xc,t-yc,0,  s-xc,t-yc,zc,  s-xc,t+yc,0,
             s-xc,t-yc,zc,  s-xc,t+yc,zc,  s-xc,t+yc,0,			 
             
			 s+xc,t-yc,0,  s+xc,t-yc,zc,  s+xc,t+yc,0,
             s+xc,t-yc,zc,  s+xc,t+yc,zc,  s+xc,t+yc,0,			 
			 
			 ],s,t,rot); 
		}	
        gl.bufferData(gl.ARRAY_BUFFER, (townvertices), gl.STATIC_DRAW);
        townVertexPositionBuffer.itemSize = 3;
        townVertexPositionBuffer.numItems = 6*6*ntown;

	    Math.seedrandom(seedrand);
        //treeVertexPositionBuffer = gl.createBuffer();
        gl.bindBuffer(gl.ARRAY_BUFFER, treeVertexPositionBuffer);
        //treevertices = new Float32Array(3*3*ntree);
		xc=0;yc=0;zc=0;
		index=0;
		for (var i=0; i < ntree; i++) {
		   zc=1;
		   var h=2;
		   var s=Mathrandom()*2*90+(xmax-xmin)*0.5;
		   var t=Mathrandom()*2*90+(ymax-ymin)*0.5;
		   if(tsea>0.1){s+=9999;}
		   zc=getterrainheight(s,t);
		   if(zc<0.15 || zc>20){zc=-999;}
		   if(tforest[(parseInt(n+n*s/xmax)%n)*n+parseInt(n+n*t/ymax)%n]==0){
		      zc=-999;}
		   treex[i]=s;treey[i]=t;treez[i]=zc;
		   append(treevertices,[
             s-xc,t-yc,zc,  s,t,zc+h,  s+xc,t+yc,zc	 
			 ]); 
		}	
        gl.bufferData(gl.ARRAY_BUFFER, (treevertices), gl.STATIC_DRAW);
        treeVertexPositionBuffer.itemSize = 3;
        treeVertexPositionBuffer.numItems = 3*ntree;

	    Math.seedrandom(seedrand);
        //grassVertexPositionBuffer = gl.createBuffer();
        gl.bindBuffer(gl.ARRAY_BUFFER, grassVertexPositionBuffer);
        //grassvertices = new Float32Array(3*3*ngrass);
		//grassh=new Array(ngrass);
		xc=0;yc=0;zc=0;
		index=0;
		for (var i=0; i < ngrass; i++) {
		   zc=1;
		   var h=2*0.3;
		   var s=Math.random()*2*24+(xmax-xmin)*0.5;
		   var t=Math.random()*2*24+(ymax-ymin)*0.5;
		   zc=getterrainheight(s,t)+0.15;
		   h=2*0.2*(1+Math.random()*0.5);grassh[i]=h;
		   append(grassvertices,[
             s,t,zc,  s,t,zc+h,  s,t,zc			 
			 ]); 
		}	
        gl.bufferData(gl.ARRAY_BUFFER, (grassvertices), gl.STATIC_DRAW);
        grassVertexPositionBuffer.itemSize = 3;
        grassVertexPositionBuffer.numItems = 3*ngrass;

		//flowerVertexPositionBuffer = gl.createBuffer();
        gl.bindBuffer(gl.ARRAY_BUFFER, flowerVertexPositionBuffer);
        //flowervertices = new Float32Array(3*6*nflower);
		//flowerh=new Array(nflower);
		xc=0;yc=0;zc=0;
		index=0;
		for (var i=0; i < nflower; i++) {
		   zc=1;
		   var h=2*0.3;
		   var s=Math.random()*2*24+(xmax-xmin)*0.5;
		   var t=Math.random()*2*24+(ymax-ymin)*0.5;
		   zc=getterrainheight(s,t)+0.15;
		   h=2*0.2*(1+Math.random()*0.5);flowerh[i]=h;
		   append(flowervertices,[
             s,t,zc,  s,t,zc+h,  s,t,zc,
             s,t,zc+h, s,t,zc+h, s,t,zc			 
			 ]); 
		}	
        gl.bufferData(gl.ARRAY_BUFFER, (flowervertices), gl.STATIC_DRAW);
        flowerVertexPositionBuffer.itemSize = 3;
        flowerVertexPositionBuffer.numItems = 6*nflower;

		if(tsea>0){resetcarrier();resetsailships();}
		
		resetrocs();
		}

var solmap="",icombo=0;
function subcombo(){
solmap="";
icombo=document.getElementById('combo').selectedIndex;
var combotext = document.getElementById('combo')[icombo].id ;
if (combotext=="initial"){seedrand=parseInt(timer());}
else{seedrand=parseInt(combotext.substr(3,4));}
if(icombo==1){seedrand=1;};
if(icombo==2){seedrand=2;};
if(icombo==3){seedrand=3;};
if(icombo==4){seedrand=4;};
if(icombo==5){seedrand=5;};
if(icombo==6){seedrand=6;};
if(icombo==7){seedrand=7;};
if(icombo==8){seedrand=8;};
if(icombo==9){seedrand=9;};
if(icombo==10){seedrand=10;};
if(icombo==11){seedrand=11;};
if(icombo==12){seedrand=12;};
if(icombo==13){seedrand=13;};
if(icombo==14){seedrand=14;};
if(icombo==15){seedrand=15;};
if(icombo==16){seedrand=16;};
if(icombo==17){seedrand=17;};
if(icombo==18){seedrand=18;};
if(icombo==19){seedrand=19;};
tsea=0;reinitsol();tfocus=1;
document.getElementById('intext').focus();
//if(solmap && solmap!=""){tsea=1;reinitsolmap(solmap);}
tfocus=1;
}
	function initriver(){	
    	var o1river=180,do1river=(Math.random()-0.5)*30;
		var riverx=n*(waterx-xmin)/(xmax-xmin);
		var rivery=n*(watery-ymin)/(ymax-ymin);
		for(var i=0;i<480;i++){
		      if(Math.random()<0.1){do1river=(Math.random()-0.5)*15;}
		      if(Math.cos(degtorad(o1river))>0.15){
			     do1river=(Math.random()-0.25)*12*Math.sign(Math.sin(degtorad(o1river)));}
			  o1river+=do1river;	 
			  riverx+=Math.cos(degtorad(o1river));
			  rivery+=Math.sin(degtorad(o1river));
			  if(riverx<4 || riverx>n-4){break;}
			  if(rivery<4 || rivery>n-4){break;}
			  for(var k=-1;k<2;k++){
			   for(var l=-1;l<2;l++){
			     height[parseInt(riverx+k)*n+parseInt(rivery+l)]=-0.58;
			  };}
		}
	}
	var roadx=0,roady=0,roadx2=0,roady2=0,o1road=0;
	function initroad(){
        for(var i=0;i<=n*n;i++){
		 if(Math.abs(height[i]-0.11)<0.0011){height[i]+=0.0022;}} 
		o1road=90;
		roadx=n*(waterx-xmin)/(xmax-xmin);
		roady=n*(watery-ymin)/(ymax-ymin);
		roadx2=n*(pistex-xmin)/(xmax-xmin);
		roady2=n*(pistey-ymin)/(ymax-ymin);
	    initroad1();
    	o1road=180;
		roadx=n*(waterx-xmin)/(xmax-xmin);
		roady=n*(watery-ymin)/(ymax-ymin);
		roadx2=n*(castlex-xmin)/(xmax-xmin);
		roady2=n*(castley-ymin)/(ymax-ymin);
	    initroad1();
    	o1road=180;
		roadx=n*(pistex-xmin)/(xmax-xmin);
		roady=n*(pistey-ymin)/(ymax-ymin);
		roadx2=n*(castlex-xmin)/(xmax-xmin);
		roady2=n*(castley-ymin)/(ymax-ymin);
	    initroad1();
		if(castlex<pistex-100 || castley<pistey){
    	 o1road=70+Math.random()*20;
		 roadx=n*(pistex-xmin)/(xmax-xmin);
		 roady=n*(pistey-ymin)/(ymax-ymin);
		 roadx2=n*(townxx-xmin)/(xmax-xmin);
		 roady2=n*(townyy-ymin)/(ymax-ymin);
	     initroad1();
		}		 
		if(castlex<waterx-50 || castley<watery){
    	 o1road=45+Math.random()*20;
		 roadx=n*(waterx-xmin)/(xmax-xmin);
		 roady=n*(watery-ymin)/(ymax-ymin);
		 roadx2=n*(townxx-xmin)/(xmax-xmin);
		 roady2=n*(townyy-ymin)/(ymax-ymin);
	     initroad1();
		}
	}
	function initroad1(){
	    var do1road=(Math.random()-0.5)*30;
		for(var i=0;i<480;i++){
		      if(Math.random()<0.13){do1road=(Math.random()-0.5)*15;}
		      //if(Math.cos(degtorad(o1road))>0.15){
			  //   do1road=(Math.random()-0.25)*12*Math.sign(Math.sin(degtorad(o1road)));}
			  o1road+=do1road;
              var dx=roadx2-roadx,dy=roady2-roady;
              var dist=Math.sqrt(dx*dx+dy*dy);
			  if(dist<3){return;}
              var do1=57*dist/(4+dist);
              var diro10=diro1(dx,dy);
			  var do10=o1road-diro10;
			  while(do10>180){do10-=360;}
			  while(do10<-180){do10+=360;}
              if(do10>do1){o1road=diro10+do1;}
              else if(do10<(-do1)){o1road=diro10-do1;}			  
			  roadx+=Math.cos(degtorad(o1road));
			  roady+=Math.sin(degtorad(o1road));
			  if(roadx<4 || roadx>n-4){break;}
			  if(roady<4 || roady>n-4){break;}
			  var nxy=0,h=0,hmin=999;
			  for(var k=-0.3;k<0.51;k+=0.6){
			   for(var l=-0.3;l<0.51;l+=0.6){
			     var ixy=parseInt(roadx+k)*n+parseInt(roady+l);
				 nxy+=1;
				 if(Math.abs(height[ixy]-0.11)<0.001){
				   h+=(height[ixy]-0.11)*10000;
				 }else{h+=Math.max(0.11,height[ixy]-1);}
				 hmin=Math.min(h,hmin);
			  }}
			  h=h/nxy;if(h>9.9){h=9.9;}
			  h=Math.min(h,hmin+0.27);
			  h=0.11+h/10000;
			  for(var k=-0.3;k<0.51;k+=0.6){
			   for(var l=-0.3;l<0.51;l+=0.6){
			     var ixy=parseInt(roadx+k)*n+parseInt(roady+l);              			  
				 if(height[ixy]>-0.55){height[ixy]=h;}
			  };}
		}
	}
    function initsolroads(){
		if(solTexturedata){
		for(var i=0;i<n;i++){
         for(var j=0;j<n;j++){
		   //px=(scale*(i*8.0/n)-n4);py=scale*(j*8.0/n)-n4;
           var u0=(i*8.0)/n-4,v0=(j*8.0)/n-4;
		   var sx=solTexture.width,sy=solTexture.height;
		   var dh=0;
           if(height[j*n+i]>0){
		    for(var u=sx*(u0-4.0/n);u<sx*(u0+4.0/n);u+=3){
		     var ix=parseInt(u+sx*8)%sx;
			 var v00=sy*(v0-4.0/n),iy=parseInt(v00+sy*8)%sy-3;
			 var ixy=4*(ix*sy+iy);
             for(var v=sy*(v0-4.0/n);v<sy*(v0+4.0/n);v+=3){
			   iy+=3;ixy+=12;if(iy>=sy){iy-=sy;ixy-=4*(sy);};
			   if(solTexturedata[ixy]>170){
			    if(solTexturedata[ixy+1]>140){
			     if(solTexturedata[ixy+2]>100){
				    dh=Math.min(height[j*n+i],1);
					v+=9999;u+=9999;}}}
		   
		   }}}
		   height[j*n+i]-=dh;
		}}
        }
    }
    function initcastle(){
	  Math.seedrandom(seedrand);
	  for(var i=0;i<100;i++){
	    castlex=(Math.random()-0.5)*(xmax-xmin)*0.7+(xmax+xmin)*0.5;
		castley=(Math.random()-0.5)*(ymax-ymin)*0.7+(ymax+ymin)*0.5;
	    if(Math.abs(castlex-pistex)>100 && Math.abs(castley-pistey)<100 &&
		   Math.abs(castlex-waterx)>100 && Math.abs(castley-watery)<100 &&
		   Math.abs(castlex-townxx)>100 && Math.abs(castley-townyy)<100){
             break;}		   
	  }
	  var h=999;
	  var nx=(castlex+n4)*n/(scale*8);
	  var ny=(castley+n4)*n/(scale*8);
	  for(var k=-1;k<=1.2;k++){
	   for(var l=-1;l<=1.2;l++){
	     var ixy=parseInt(nx+k)*n+parseInt(ny+l);
	     if(ixy<n*n && ixy>0){h=Math.min(h,height[ixy]);}
	  };} 
      h=Math.max(h,0.1);	  
      castlez=h;	  
	  for(var k=-1;k<=1.2;k++){
	   for(var l=-1;l<=1.2;l++){
	     var ixy=parseInt(nx+k)*n+parseInt(ny+l);
	     if(ixy<n*n & ixy>0){height[ixy]=h;}
	  };}      
	}	
    function initBuffers() {
	    Math.seedrandom(seedrand);
	    irnd=0;
        solVertexPositionBuffer = gl.createBuffer();
        gl.bindBuffer(gl.ARRAY_BUFFER, solVertexPositionBuffer);
        var vertices = new Array(3*n*n);
		height=new Array((n+1)*(n+1));
		var heightx=new Array((n+1)*(n+1));
		var heighty=new Array((n+1)*(n+1));
		var w=1.0,wx=1.0,wy=1.0;
		for (var j=0; j < n; j++) {
        for(var i=0;i<n;i++){
		   if(Mathrandom()<0.2){w=Mathrandom()+0.35;}
		   wx+=(w-wx)*0.3;
		   heightx[i*n+j]=Math.cos(80*wx*(i)/nmap);
		}}
		for (var i=0; i < n; i++) {
        for(var j=0;j<n;j++){
		   if(Mathrandom()<0.2){w=Mathrandom()+0.35;}
		   wy+=(w-wy)*0.3;
		   heighty[i*n+j]=Math.cos(80*wy*(j)/nmap);
		}}
        seaheight=5.05;if(tsea==0){seaheight=0;}
		for (var i=0; i <= n; i++) {
        for(var j=0;j<n;j++){
		   height[i*n+j]=5*heightx[i*n+j]*heighty[i*n+j];//(Math.cos(80*(i)/nmap)*Math.cos(80*(j)/nmap))*4.0;
		}}
		nmount=35*2;if(seaheight<0.1){nmount=35;}
		for(var i=0;i<nmount;i++){
		   var imount=n*(0.5+0.9*(Mathrandom()-0.5));
		   var jmount=n*(0.5+0.9*(Mathrandom()-0.5));
		   var hmount=14*(1+Mathrandom());
		   mounti[i]=imount;mountj[i]=jmount;mounth[i]=hmount;
		   var dj=8;
		   for(var j=-dj;j<dj;j++){
		   for(var k=-dj;k<dj;k++){
		      var jj=parseInt(j+imount),kk=parseInt(k+jmount);
			  if(jj>0 && jj<n && kk>0 && kk<n){
			    height[jj*n+kk]+=hmount*Math.cos(Math.abs(3.1416*j*0.5/dj))*Math.cos(Math.abs(3.1416*k*0.5/dj));
			  }
		   }
		   }
		}
		for (var i=0; i <= n; i++) {
        for(var j=0;j<n;j++){
		   height[i*n+j]-=seaheight;
		   if(height[i*n+j]<-0.4){height[i*n+j]=-0.4;}
		   }
		}   

        initriver();
		initsolroads();
		initcastle();
		initroad();
            					
		//x=0.25*(scale*((n)*8.0)/n-n4);y=x;
		var px=0,py=0;
		index=0;
		for (var i=0; i < n; i++) {
        for(var j=0;j<n;j++){
		   px=(scale*(i*8.0/n)-n4);py=scale*(j*8.0/n)-n4;
    	   if(Math.abs(px-pistex)<62.0){
	         if(Math.abs(py-pistey)<62.0){height[i*n+j]=0.1;};}
	       var dxwater=px-waterx;
	       var dywater=py-watery;
	       if((dxwater*dxwater+dywater*dywater)<10000){height[i*n+j]=-0.58;}
		   var dxtown=px-(xmax-xmin)*0.7;
		   var dytown=py-(ymax-ymin)*0.7;
		   if(Math.abs(dxtown)<47.0){
	         if(Math.abs(dytown)<47.0){if(height[i*n+j]<0.1){height[i*n+j]=0.1;};};}
		   append(vertices,[
             px,py,  height[i*n+j]
             //(scale*((i+1)*8.0)/n-32)*12/8,  scale*(j*8.0/n)-n4,  height[(i+1)*n+j]
            ]);
		   
		}}		
        gl.bufferData(gl.ARRAY_BUFFER, new Float32Array(vertices), gl.STATIC_DRAW);
        solVertexPositionBuffer.itemSize = 3;
        solVertexPositionBuffer.numItems = n*n;


        //gl.bufferData(gl.ARRAY_BUFFER, new Float32Array(vertices), gl.STATIC_DRAW);
        //solVertexPositionBuffer.itemSize = 3;
        //solVertexPositionBuffer.numItems = 24;

        solVertexTextureCoordBuffer = gl.createBuffer();
        gl.bindBuffer(gl.ARRAY_BUFFER, solVertexTextureCoordBuffer);
        solTextureCoords = new Float32Array(2*n*n);
		index=0;
		for (var i=0; i < n; i++) {
        for(var j=0;j<n;j++){
		   append(solTextureCoords,[
             (i*8.0)/n-4,  (j)*8.0/n-4 
             //((i+1)*8.0)/n-4,  (j)*8.0/n-4
            ]);
		}}	
        gl.bufferData(gl.ARRAY_BUFFER, (solTextureCoords), gl.STATIC_DRAW);
        solVertexTextureCoordBuffer.itemSize = 2;
        solVertexTextureCoordBuffer.numItems = n*n;//24;

        solVertexIndexBuffer = gl.createBuffer();
        gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER, solVertexIndexBuffer);
        nmap2=2*nmap;
		solVertexIndices = new Uint16Array(6*2*nmap*2*nmap*2);
		var n2=n+n,i2=0,j2=0;
		var nx=(n4)*n/(scale*8)-nmap2/2;
		var ny=(n4)*n/(scale*8)-nmap2/2;
		nx=parseInt(nx/6)*6;
		ny=parseInt(ny/6)*6;
		
		index=0;
		for (var i=(nx); i<((nx)+nmap2); i++) {i2=(i)*n;
        for(var j=ny;j<(ny+(nmap2));j+=1){j2=(j);
		   append(solVertexIndices,[
             i2+j2,  i2+j2+n, i2+j2+1, 
             i2+j2+n,  i2+j2+n+1,   i2+j2+1
            ]);
		}}
        //indices16=new Uint16Array(solVertexIndices)		
        gl.bufferData(gl.ELEMENT_ARRAY_BUFFER, solVertexIndices , gl.STATIC_DRAW);
        solVertexIndexBuffer.itemSize = 1;
        solVertexIndexBuffer.numItems = 6*nmap2*nmap2;
		

        cloudVertexPositionBuffer = gl.createBuffer();
        gl.bindBuffer(gl.ARRAY_BUFFER, cloudVertexPositionBuffer);
        cloudvertices = new Float32Array(3*6*ncloud);
		var xc=0,yc=0,zc=0,distmax=1.2*(xmax-xmin)/5;
		index=0;
		for (var i=0; i < ncloud; i++) {
		   sc=(1+Math.random())*15;
		   xc=x-distmax+Math.random()*(distmax+distmax);
		   yc=y-distmax+Math.random()*(distmax+distmax);zc=30+Math.random()*30;
		   append(cloudvertices,[
             xc,yc,zc,  xc,yc,zc,  xc,yc,zc,
             xc,yc,zc,  xc,yc,zc,  xc,yc,zc			 
             //x,y-sc,z-sc,  x,y-sc,z+sc,  x,y+sc,z-sc,
             //x,y-sc,z+sc,  x,y+sc,z+sc,  x,y+sc,z-sc			 
			 ]); 
		}	
        gl.bufferData(gl.ARRAY_BUFFER, (cloudvertices), gl.STATIC_DRAW);
        cloudVertexPositionBuffer.itemSize = 3;
        cloudVertexPositionBuffer.numItems = 6*ncloud;

        cloudVertexTextureCoordBuffer = gl.createBuffer();
        gl.bindBuffer(gl.ARRAY_BUFFER, cloudVertexTextureCoordBuffer);
        cloudtextureCoords = new Array(2*6*ncloud);
		cloudscale=new Array(ncloud);
		var sc=1,sc2=1;
		index=0;
		for (var i=0; i < ncloud; i++) {
		   sc=(1+Math.random()*2)*0.5;cloudscale[i]=sc;
		   sc2=(1+Math.random()*0.5)*sc;
		   append(cloudtextureCoords,[
             -sc,-sc2,  -sc,sc2,   sc,-sc2,
			 -sc,sc2,   sc,sc2,    sc,-sc2
            // 0.0,0.0,  0.0,1.0,  1.0,0.0,
            // 0.0,1.0,  1.0,1.0,  1.0,0.0			 
            ]);
		}	
        gl.bufferData(gl.ARRAY_BUFFER, new Float32Array(cloudtextureCoords), gl.STATIC_DRAW);
        cloudVertexTextureCoordBuffer.itemSize = 2;
        cloudVertexTextureCoordBuffer.numItems = 6*ncloud;

        sunVertexPositionBuffer = gl.createBuffer();
        gl.bindBuffer(gl.ARRAY_BUFFER, sunVertexPositionBuffer);
        sunvertices = new Float32Array(3*6);
		xc=0;yc=0;zc=0;
		index=0;
		for (var i=0; i < 1; i++) {
		   xc=sunx;
		   yc=suny;
		   zc=sunz;
		   append(sunvertices,[
             xc,yc,zc,  xc,yc,zc,  xc,yc,zc,
             xc,yc,zc,  xc,yc,zc,  xc,yc,zc			 
			 ]); 
		}	
        gl.bufferData(gl.ARRAY_BUFFER, (sunvertices), gl.STATIC_DRAW);
        sunVertexPositionBuffer.itemSize = 3;
        sunVertexPositionBuffer.numItems = 6;

        sunVertexTextureCoordBuffer = gl.createBuffer();
        gl.bindBuffer(gl.ARRAY_BUFFER, sunVertexTextureCoordBuffer);
        var suntextureCoords = new Array(2*6);
		sc=5.5;sc2=11;
		index=0;
		for (var i=0; i < 1; i++) {
		   append(suntextureCoords,[
             -sc,-sc2,  -sc,sc2,   sc,-sc2,
			 -sc,sc2,   sc,sc2,    sc,-sc2
            ]);
		}	
        gl.bufferData(gl.ARRAY_BUFFER, new Float32Array(suntextureCoords), gl.STATIC_DRAW);
        sunVertexTextureCoordBuffer.itemSize = 2;
        sunVertexTextureCoordBuffer.numItems = 6;

        boussVertexPositionBuffer = gl.createBuffer();
        gl.bindBuffer(gl.ARRAY_BUFFER, boussVertexPositionBuffer);
        boussvertices = new Float32Array(3*6);
		xc=0;yc=0;zc=0;
		index=0;
		for (var i=0; i < 1; i++) {
		   xc=boussx;
		   yc=boussy;
		   zc=boussz;
		   append(boussvertices,[
             -xc,-yc,zc,  -xc,yc,zc,  xc,-yc,zc,
             -xc,yc,zc,  xc,yc,zc,  xc,-yc,zc			 
			 ]); 
		}	
        gl.bufferData(gl.ARRAY_BUFFER, (boussvertices), gl.STATIC_DRAW);
        boussVertexPositionBuffer.itemSize = 3;
        boussVertexPositionBuffer.numItems = 6;

        boussVertexTextureCoordBuffer = gl.createBuffer();
        gl.bindBuffer(gl.ARRAY_BUFFER, boussVertexTextureCoordBuffer);
        var bousstextureCoords = new Array(2*6);
		sc=5.5;sc2=11;
		index=0;
		for (var i=0; i < 1; i++) {
		   append(bousstextureCoords,[
             0,0, 0,1, 1,0,
			 0,1, 1,1, 1,0
			 //-sc,-sc2,  -sc,sc2,   sc,-sc2,
			 //-sc,sc2,   sc,sc2,    sc,-sc2
            ]);
		}	
        gl.bufferData(gl.ARRAY_BUFFER, new Float32Array(bousstextureCoords), gl.STATIC_DRAW);
        boussVertexTextureCoordBuffer.itemSize = 2;
        boussVertexTextureCoordBuffer.numItems = 6;

        pisteVertexPositionBuffer = gl.createBuffer();
        gl.bindBuffer(gl.ARRAY_BUFFER, pisteVertexPositionBuffer);
        pistevertices = new Float32Array(3*6*npiste);
		xc=0;yc=0;zc=0;
		index=0;
		for (var i=0; i < npiste; i++) {
		   xc=7;
		   yc=7;
		   zc=0.2;
		   var s=i*2*xc+(xmax-xmin)*0.5-45.5,t=(ymax-ymin)*0.5;
		   append(pistevertices,[
             s-xc,t-yc,zc,  s-xc,t+yc,zc,  s+xc,t-yc,zc,
             s-xc,t+yc,zc,  s+xc,t+yc,zc,  s+xc,t-yc,zc			 
			 ]); 
		}	
        gl.bufferData(gl.ARRAY_BUFFER, (pistevertices), gl.STATIC_DRAW);
        pisteVertexPositionBuffer.itemSize = 3;
        pisteVertexPositionBuffer.numItems = 6*npiste;

        pisteVertexTextureCoordBuffer = gl.createBuffer();
        gl.bindBuffer(gl.ARRAY_BUFFER, pisteVertexTextureCoordBuffer);
        var pistetextureCoords = new Array(2*6*npiste);
		index=0;
		   append(pistetextureCoords,[
             0.5,0, 0.5,1, 1,0,
			 0.5,1, 1,1, 1,0
            ]);
		for (var i=2; i < npiste; i++) {
		   append(pistetextureCoords,[
             0,0, 0,1, 1/2,0,
			 0,1, 1/2,1, 1/2,0
            ]);
		}	
		   append(pistetextureCoords,[
             1,0, 1,1, 1/2,0,
			 1,1, 1/2,1, 1/2,0
            ]);
        gl.bufferData(gl.ARRAY_BUFFER, new Float32Array(pistetextureCoords), gl.STATIC_DRAW);
        pisteVertexTextureCoordBuffer.itemSize = 2;
        pisteVertexTextureCoordBuffer.numItems = 6*npiste;

        towerVertexPositionBuffer = gl.createBuffer();
        gl.bindBuffer(gl.ARRAY_BUFFER, towerVertexPositionBuffer);
        towervertices = new Float32Array(3*6*6*ntower);
		xc=0;yc=0;zc=0;
		index=0;
		for (var i=0; i < ntower; i++) {
		   xc=2.5;
		   yc=2.5;
		   zc=3;
		   var s=i*4*xc+(xmax-xmin)*0.5-20,t=(ymax-ymin)*0.5+20,h=0.9;
		   append(towervertices,[
             //s-xc,t-yc,zc,  s-xc,t+yc,zc,  s+xc,t-yc,zc,
             //s-xc,t+yc,zc,  s+xc,t+yc,zc,  s+xc,t-yc,zc,
             s-xc,t-yc,zc,  s-xc,t+yc,zc,  s,t,zc+h,
             s+xc,t-yc,zc,  s+xc,t+yc,zc,  s,t,zc+h,
             s-xc,t-yc,zc,  s+xc,t-yc,zc,  s,t,zc+h,
             s-xc,t+yc,zc,  s+xc,t+yc,zc,  s,t,zc+h,
			 
             s-xc,t-yc,0,  s-xc,t-yc,zc,  s+xc,t-yc,0,
             s-xc,t-yc,zc,  s+xc,t-yc,zc,  s+xc,t-yc,0,			 
             
             s-xc,t+yc,0,  s-xc,t+yc,zc,  s+xc,t+yc,0,
             s-xc,t+yc,zc,  s+xc,t+yc,zc,  s+xc,t+yc,0,			 
             
			 s-xc,t-yc,0,  s-xc,t-yc,zc,  s-xc,t+yc,0,
             s-xc,t-yc,zc,  s-xc,t+yc,zc,  s-xc,t+yc,0,			 
             
			 s+xc,t-yc,0,  s+xc,t-yc,zc,  s+xc,t+yc,0,
             s+xc,t-yc,zc,  s+xc,t+yc,zc,  s+xc,t+yc,0,			 
			 
			 ]); 
		}	
        gl.bufferData(gl.ARRAY_BUFFER, (towervertices), gl.STATIC_DRAW);
        towerVertexPositionBuffer.itemSize = 3;
        towerVertexPositionBuffer.numItems = 6*6*ntower;

        towerVertexTextureCoordBuffer = gl.createBuffer();
        gl.bindBuffer(gl.ARRAY_BUFFER, towerVertexTextureCoordBuffer);
        var towertextureCoords = new Array(2*6*6*ntower);
		index=0;
		for (var i=0; i < ntower; i++) {
		   var u=0.25,v=0.25;
		   append(towertextureCoords,[
             u,v, u,v+0.1, u+0.1,v,
			 u,v+0.1, u+0.1,v+0.1, u+0.1,v,

             u,v, u,v+0.1, u+0.1,v,
			 u,v+0.1, u+0.1,v+0.1, u+0.1,v
			 ]);
		   var s=4,t=3,sy=2;
		   append(towertextureCoords,[
             0,0, 0,t, s,0,
			 0,t, s,t, s,0,
			 
             0,0, 0,t, s,0,
			 0,t, s,t, s,0,			 

             0,0, 0,t, sy,0,
			 0,t, sy,t, sy,0,
			 
             0,0, 0,t, sy,0,
			 0,t, sy,t, sy,0			 
			 ]);
		}	
        gl.bufferData(gl.ARRAY_BUFFER, new Float32Array(towertextureCoords), gl.STATIC_DRAW);
        towerVertexTextureCoordBuffer.itemSize = 2;
        towerVertexTextureCoordBuffer.numItems = 6*6*ntower;
	
	    Math.seedrandom(seedrand);
        ntown=40;
		townVertexPositionBuffer = gl.createBuffer();
        gl.bindBuffer(gl.ARRAY_BUFFER, townVertexPositionBuffer);
        townvertices = new Float32Array(3*6*6*ntown);
		townx=new Array(ntown);towny=new Array(ntown);townz=new Array(ntown);
		towno1=new Array(ntown);towndx=new Array(ntown);towndz=new Array(ntown);
		xc=0;yc=0;zc=0;
		index=0;
		for (var i=0; i < ntown; i++) {
		   xc=2.5;
		   yc=2.5;
		   zc=3;
		   var s=(xmax-xmin)*0.7,t=(ymax-ymin)*0.7,h=1.5;
		   s+= Math.floor( Math.random() * 200 - 100 ) * 0.42;
		   t+= Math.floor( Math.random() * 200 - 100 ) * 0.42;
		   var rot= Math.random();
		   var scx= Math.random() * Math.random() * Math.random() * Math.random() * 50 + 10;
		   xc*=scx/10;yc*=scx/10;			
		   zc*=(( Math.random() * Math.random() * Math.random() * scx ) * 8 + 8)/10;
		   towndx[i]=xc;towndz[i]=zc;
		   zc+=getterrainheight(s,t)-xc*0.1;
		   townx[i]=s;towny[i]=t;townz[i]=zc;towno1[i]=rot;
		   appendrot(townvertices,[
             //s-xc,t-yc,zc,  s-xc,t+yc,zc,  s+xc,t-yc,zc,
             //s-xc,t+yc,zc,  s+xc,t+yc,zc,  s+xc,t-yc,zc,
             s-xc,t-yc,zc,  s-xc,t+yc,zc,  s,t,zc+h,
             s+xc,t-yc,zc,  s+xc,t+yc,zc,  s,t,zc+h,
             s-xc,t-yc,zc,  s+xc,t-yc,zc,  s,t,zc+h,
             s-xc,t+yc,zc,  s+xc,t+yc,zc,  s,t,zc+h,
			 
             s-xc,t-yc,0,  s-xc,t-yc,zc,  s+xc,t-yc,0,
             s-xc,t-yc,zc,  s+xc,t-yc,zc,  s+xc,t-yc,0,			 
             
             s-xc,t+yc,0,  s-xc,t+yc,zc,  s+xc,t+yc,0,
             s-xc,t+yc,zc,  s+xc,t+yc,zc,  s+xc,t+yc,0,			 
             
			 s-xc,t-yc,0,  s-xc,t-yc,zc,  s-xc,t+yc,0,
             s-xc,t-yc,zc,  s-xc,t+yc,zc,  s-xc,t+yc,0,			 
             
			 s+xc,t-yc,0,  s+xc,t-yc,zc,  s+xc,t+yc,0,
             s+xc,t-yc,zc,  s+xc,t+yc,zc,  s+xc,t+yc,0,			 
			 
			 ],s,t,rot); 
		}	
        gl.bufferData(gl.ARRAY_BUFFER, (townvertices), gl.STATIC_DRAW);
        townVertexPositionBuffer.itemSize = 3;
        townVertexPositionBuffer.numItems = 6*6*ntown;

        townVertexTextureCoordBuffer = gl.createBuffer();
        gl.bindBuffer(gl.ARRAY_BUFFER, townVertexTextureCoordBuffer);
        var towntextureCoords = new Array(2*6*6*ntown);
		index=0;
		for (var i=0; i < ntown; i++) {
		   var u=0.25,v=0.25;
		   append(towntextureCoords,[
             u,v, u,v+0.1, u+0.1,v,
			 u,v+0.1, u+0.1,v+0.1, u+0.1,v,

             u,v, u,v+0.1, u+0.1,v,
			 u,v+0.1, u+0.1,v+0.1, u+0.1,v
			 ]);
		   var s=2*towndx[i],t=1.5*towndz[i],sy=1*towndx[i];
		   append(towntextureCoords,[
             0,0, 0,t, s,0,
			 0,t, s,t, s,0,
			 
             0,0, 0,t, s,0,
			 0,t, s,t, s,0,			 

             0,0, 0,t, sy,0,
			 0,t, sy,t, sy,0,
			 
             0,0, 0,t, sy,0,
			 0,t, sy,t, sy,0			 
			 ]);
		}	
        gl.bufferData(gl.ARRAY_BUFFER, new Float32Array(towntextureCoords), gl.STATIC_DRAW);
        townVertexTextureCoordBuffer.itemSize = 2;
        townVertexTextureCoordBuffer.numItems = 6*6*ntown;
		
		
        waterVertexPositionBuffer = gl.createBuffer();
        gl.bindBuffer(gl.ARRAY_BUFFER, waterVertexPositionBuffer);
        watervertices = new Float32Array(3*6);
		xc=0;yc=0;zc=0;
		index=0;
		   xc=110;
		   yc=110;
		   zc=-0.2;
		   var s=waterx,t=watery;
		   append(watervertices,[
             s-xc,t-yc,zc,  s-xc,t+yc,zc,  s+xc,t-yc,zc,
             s-xc,t+yc,zc,  s+xc,t+yc,zc,  s+xc,t-yc,zc			 
			 ]); 	
        gl.bufferData(gl.ARRAY_BUFFER, (watervertices), gl.STATIC_DRAW);
        waterVertexPositionBuffer.itemSize = 3;
        waterVertexPositionBuffer.numItems = 6;

        waterVertexTextureCoordBuffer = gl.createBuffer();
        gl.bindBuffer(gl.ARRAY_BUFFER, waterVertexTextureCoordBuffer);
        var watertextureCoords = new Array(2*6);
		index=0;
		var s=10,t=0;
		   append(watertextureCoords,[
             0,0, 0,s, s,0,
			 0,s, s,s, s,0
            ]);
        gl.bufferData(gl.ARRAY_BUFFER, new Float32Array(watertextureCoords), gl.STATIC_DRAW);
        waterVertexTextureCoordBuffer.itemSize = 2;
        waterVertexTextureCoordBuffer.numItems = 6;

        seaVertexPositionBuffer = gl.createBuffer();
        gl.bindBuffer(gl.ARRAY_BUFFER, seaVertexPositionBuffer);
        seavertices = new Float32Array(3*6);
		xc=0;yc=0;zc=0;
		index=0;
		var seascale=4.7*1.2;
		   xc=110*seascale;
		   yc=110*seascale;
		   zc=-0.3;
		   s=seax;t=seay;
		   append(seavertices,[
             s-xc,t-yc,zc,  s-xc,t+yc,zc,  s+xc,t-yc,zc,
             s-xc,t+yc,zc,  s+xc,t+yc,zc,  s+xc,t-yc,zc			 
			 ]); 	
        gl.bufferData(gl.ARRAY_BUFFER, (seavertices), gl.STATIC_DRAW);
        seaVertexPositionBuffer.itemSize = 3;
        seaVertexPositionBuffer.numItems = 6;

        seaVertexTextureCoordBuffer = gl.createBuffer();
        gl.bindBuffer(gl.ARRAY_BUFFER, seaVertexTextureCoordBuffer);
        seatextureCoords = new Float32Array(2*6);
		index=0;
		s=10*seascale;if(tsea==2){s*=2}
		   append(seatextureCoords,[
             0,0, 0,s, s,0,
			 0,s, s,s, s,0
            ]);
        gl.bufferData(gl.ARRAY_BUFFER, new Float32Array(seatextureCoords), gl.STATIC_DRAW);
        seaVertexTextureCoordBuffer.itemSize = 2;
        seaVertexTextureCoordBuffer.numItems = 6;

        horizonVertexPositionBuffer = gl.createBuffer();
        gl.bindBuffer(gl.ARRAY_BUFFER, horizonVertexPositionBuffer);
        horizonvertices = new Float32Array(3*6);
		xc=0;yc=0;zc=0;
		index=0;
		var horizonscale=4.7*1.2;
		   xc=110*horizonscale;
		   yc=110*horizonscale;
		   zc=-0.3;
		   s=horizonx;t=horizony;
		   append(horizonvertices,[
             s-xc,t-yc,zc,  s-xc,t+yc,zc,  s+xc,t-yc,zc,
             s-xc,t+yc,zc,  s+xc,t+yc,zc,  s+xc,t-yc,zc			 
			 ]); 	
        gl.bufferData(gl.ARRAY_BUFFER, (horizonvertices), gl.STATIC_DRAW);
        horizonVertexPositionBuffer.itemSize = 3;
        horizonVertexPositionBuffer.numItems = 6;

        horizonVertexTextureCoordBuffer = gl.createBuffer();
        gl.bindBuffer(gl.ARRAY_BUFFER, horizonVertexTextureCoordBuffer);
        horizontextureCoords = new Float32Array(2*6);
		index=0;
		s=10*horizonscale;
		   append(horizontextureCoords,[
             0,0, 0,s, s,0,
			 0,s, s,s, s,0
            ]);
        gl.bufferData(gl.ARRAY_BUFFER, new Float32Array(horizontextureCoords), gl.STATIC_DRAW);
        horizonVertexTextureCoordBuffer.itemSize = 2;
        horizonVertexTextureCoordBuffer.numItems = 6;

	    Math.seedrandom(seedrand);
        treeVertexPositionBuffer = gl.createBuffer();
        gl.bindBuffer(gl.ARRAY_BUFFER, treeVertexPositionBuffer);
        treevertices = new Float32Array(3*3*ntree);
        treevertices2 = new Float32Array(3*3*ntree);
		tforest=new Array((n+1)*(n+1));
		for(var i=0;i<n;i++){
		  for(var j=0;j<n;j++){
		    tforest[i*n+j]=1;}}
		for(var i=0;i<n-1;i++){
		  for(var j=0;j<n-1;j++){
			if(Math.random()<0.014){tforest[i*n+j]=0;tforest[i*n+j+1]=0;
			   tforest[i*n+n+j]=0;tforest[i*n+n+j+1]=0;}
			}}
		xc=0;yc=0;zc=0;
		index=0;
		for (var i=0; i < ntree; i++) {
		   zc=1;
		   var h=2;
		   s=Math.random()*2*90+(xmax-xmin)*0.5;
		   t=Math.random()*2*90+(ymax-ymin)*0.5;
		   if(tsea>0.1){s+=9999;}
		   zc=getterrainheight(s,t);
		   if(zc<0.15 || zc>20){zc=-999;}
		   if(tforest[(parseInt(n+n*s/xmax)%n)*n+parseInt(n+n*t/ymax)%n]==0){
		      zc=-999;}
		   treex[i]=s;treey[i]=t;treez[i]=zc;
		   append(treevertices,[
             s-xc,t-yc,zc,  s,t,zc+h,  s+xc,t+yc,zc	 
			 ]); 
		}	
        gl.bufferData(gl.ARRAY_BUFFER, (treevertices), gl.STATIC_DRAW);
        treeVertexPositionBuffer.itemSize = 3;
        treeVertexPositionBuffer.numItems = 3*ntree;

        treeVertexTextureCoordBuffer = gl.createBuffer();
        gl.bindBuffer(gl.ARRAY_BUFFER, treeVertexTextureCoordBuffer);
        var treetextureCoords = new Array(2*3*ntree);
		index=0;
		for (var i=0; i < ntree; i++) {
		   append(treetextureCoords,[
             0,0,  0.5,1,  1,0
			 ]);
		}	
        gl.bufferData(gl.ARRAY_BUFFER, new Float32Array(treetextureCoords), gl.STATIC_DRAW);
        treeVertexTextureCoordBuffer.itemSize = 2;
        treeVertexTextureCoordBuffer.numItems = 3*ntree;

        tirVertexPositionBuffer = gl.createBuffer();
        gl.bindBuffer(gl.ARRAY_BUFFER, tirVertexPositionBuffer);
        tirvertices = new Float32Array(3*6*ntir);
        tirx = new Array(ntir);
        tiry = new Array(ntir);
        tirz = new Array(ntir);
        vtirx = new Array(ntir);
        vtiry = new Array(ntir);
        vtirz = new Array(ntir);
        tirsize = new Array(ntir);
        tirtype = new Array(ntir);
        ttir = new Array(ntir);
		xc=0;yc=0;zc=0;
		index=0;
		for (var i=0; i < ntir; i++) {
		   zc=20;
		   var h=2;
		   s=i*10+x;
		   t=y;
		   xc=1;zc=-999;
		   tirx[i]=s;tiry[i]=t;tirz[i]=zc;tirsize[i]=1;ttir[i]=0;tirtype[i]=0;
		   append(tirvertices,[
             s-xc,t,zc,  s-xc,t,zc+h,  s+xc,t,zc,	 
             s-xc,t,zc+h,  s+xc,t,zc+h,  s+xc,t,zc	 
			 ]); 
		}	
        gl.bufferData(gl.ARRAY_BUFFER, (tirvertices), gl.STATIC_DRAW);
        tirVertexPositionBuffer.itemSize = 3;
        tirVertexPositionBuffer.numItems = 6*ntir;

        tirVertexTextureCoordBuffer = gl.createBuffer();
        gl.bindBuffer(gl.ARRAY_BUFFER, tirVertexTextureCoordBuffer);
        var tirtextureCoords = new Array(2*6*ntir);
		index=0;
		for (var i=0; i < ntir; i++) {
		   append(tirtextureCoords,[
             0,0,  0,1,  1,0,
			 0,1,  1,1,  1,0
			 ]);
		}	
        gl.bufferData(gl.ARRAY_BUFFER, new Float32Array(tirtextureCoords), gl.STATIC_DRAW);
        tirVertexTextureCoordBuffer.itemSize = 2;
        tirVertexTextureCoordBuffer.numItems = 6*ntir;

	    Math.seedrandom(seedrand);
        starVertexPositionBuffer = gl.createBuffer();
        gl.bindBuffer(gl.ARRAY_BUFFER, starVertexPositionBuffer);
        starvertices = new Float32Array(3*3*nstar);
		xc=0;yc=0;zc=0;
		index=0;
		for (var i=0; i < nstar; i++) {
		   var r=500;
		   var so1=Math.random()*360;
		   var so2=Math.random()*89;
		   xc=r*Math.cos(degtorad(so1))*Math.cos(degtorad(so2));
		   yc=r*Math.sin(degtorad(so1))*Math.cos(degtorad(so2));
		   zc=r*Math.sin(degtorad(so2));
		   append(starvertices,[
             xc,yc,zc,  xc,yc,zc,  xc,yc,zc	 
			 ]); 
		}	
        gl.bufferData(gl.ARRAY_BUFFER, (starvertices), gl.STATIC_DRAW);
        starVertexPositionBuffer.itemSize = 3;
        starVertexPositionBuffer.numItems = 3*nstar;

        starVertexTextureCoordBuffer = gl.createBuffer();
        gl.bindBuffer(gl.ARRAY_BUFFER, starVertexTextureCoordBuffer);
        var startextureCoords = new Array(2*3*nstar);
		index=0;
		for (var i=0; i < nstar; i++) {
		   var r=1.0+Math.random();
		   append(startextureCoords,[
             -r,-r,  0.0,r,  r,-r
			 ]);
		}	
        gl.bufferData(gl.ARRAY_BUFFER, new Float32Array(startextureCoords), gl.STATIC_DRAW);
        starVertexTextureCoordBuffer.itemSize = 2;
        starVertexTextureCoordBuffer.numItems = 3*nstar;

	    Math.seedrandom(seedrand);
        grassVertexPositionBuffer = gl.createBuffer();
        gl.bindBuffer(gl.ARRAY_BUFFER, grassVertexPositionBuffer);
        grassvertices = new Float32Array(3*3*ngrass);
        grassvertices2 = new Float32Array(3*3*ngrass);
		grassh=new Array(ngrass);
		grassx=new Array(ngrass);
		grassy=new Array(ngrass);
		grassz=new Array(ngrass);
		xc=0;yc=0;zc=0;
		index=0;
		for (var i=0; i < ngrass; i++) {
		   zc=1;
		   var h=2*0.3;
		   s=Math.random()*2*24+(xmax-xmin)*0.5;
		   t=Math.random()*2*24+(ymax-ymin)*0.5;
		   zc=getterrainheight(s,t)+0.15;
		   h=2*0.2*(1+Math.random()*0.5);grassh[i]=h;
		   grassx[i]=s;grassy[i]=t;grassz[i]=zc;
		   append(grassvertices,[
             s,t,zc,  s,t,zc+h,  s,t,zc			 
			 ]); 
		}	
        gl.bufferData(gl.ARRAY_BUFFER, (grassvertices), gl.STATIC_DRAW);
        grassVertexPositionBuffer.itemSize = 3;
        grassVertexPositionBuffer.numItems = 3*ngrass;

        grassVertexTextureCoordBuffer = gl.createBuffer();
        gl.bindBuffer(gl.ARRAY_BUFFER, grassVertexTextureCoordBuffer);
        var grasstextureCoords = new Float32Array(2*3*ngrass);
		index=0;
		for (var i=0; i < ngrass; i++) {
		   append(grasstextureCoords,[
             0,0,  0.5,1,  1,0
			 ]);
		}	
        gl.bufferData(gl.ARRAY_BUFFER, (grasstextureCoords), gl.STATIC_DRAW);
        grassVertexTextureCoordBuffer.itemSize = 2;
        grassVertexTextureCoordBuffer.numItems = 3*ngrass;

        flowerVertexPositionBuffer = gl.createBuffer();
        gl.bindBuffer(gl.ARRAY_BUFFER, flowerVertexPositionBuffer);
        flowervertices = new Float32Array(3*6*nflower);
    	flowerh=new Array(nflower);
		xc=0;yc=0;zc=0;
		index=0;
		for (var i=0; i < nflower; i++) {
		   zc=1;
		   var h=2*0.3;
		   s=Math.random()*2*24+(xmax-xmin)*0.5;
		   t=Math.random()*2*24+(ymax-ymin)*0.5;
		   zc=getterrainheight(s,t)+0.15;
		   h=2*0.2*(1+Math.random()*0.5);flowerh[i]=h;
		   append(flowervertices,[
             s,t,zc,  s,t,zc+h,  s,t,zc,
             s,t,zc+h, s,t,zc+h, s,t,zc			 
			 ]); 
		}	
        gl.bufferData(gl.ARRAY_BUFFER, (flowervertices), gl.STATIC_DRAW);
        flowerVertexPositionBuffer.itemSize = 3;
        flowerVertexPositionBuffer.numItems = 6*nflower;

        flowerVertexTextureCoordBuffer = gl.createBuffer();
        gl.bindBuffer(gl.ARRAY_BUFFER, flowerVertexTextureCoordBuffer);
        var flowertextureCoords = new Float32Array(2*6*nflower);
		index=0;
		for (var i=0; i < nflower; i++) {
		   append(flowertextureCoords,[
             0,0,  0,1,  1,0,
			 0,1,  1,1,  1,0
			 ]);
		}	
        gl.bufferData(gl.ARRAY_BUFFER, (flowertextureCoords), gl.STATIC_DRAW);
        flowerVertexTextureCoordBuffer.itemSize = 2;
        flowerVertexTextureCoordBuffer.numItems = 6*nflower;

        carreVertexPositionBuffer = gl.createBuffer();
        gl.bindBuffer(gl.ARRAY_BUFFER, carreVertexPositionBuffer);
        var carrevertices = new Float32Array(3*6);
		xc=0;yc=0;zc=0.2;
		s=0;t=0;
		var h=2;
		index=0;
   	    append(carrevertices,[
             s,t,zc,  s,t,zc+h,  s,t,zc,
             s,t,zc+h, s,t,zc+h, s,t,zc			 
			 ]); 	
        gl.bufferData(gl.ARRAY_BUFFER, (carrevertices), gl.STATIC_DRAW);
        carreVertexPositionBuffer.itemSize = 3;
        carreVertexPositionBuffer.numItems = 6;

        carreVertexTextureCoordBuffer = gl.createBuffer();
        gl.bindBuffer(gl.ARRAY_BUFFER, carreVertexTextureCoordBuffer);
        var carretextureCoords = new Float32Array(2*6);
		index=0;
 	    append(carretextureCoords,[
             0,0,  0,1,  1,0,
			 0,1,  1,1,  1,0
			 ]);	
        gl.bufferData(gl.ARRAY_BUFFER, (carretextureCoords), gl.STATIC_DRAW);
        carreVertexTextureCoordBuffer.itemSize = 2;
        carreVertexTextureCoordBuffer.numItems = 6;
		
        screenVertexPositionBuffer = gl.createBuffer();
        gl.bindBuffer(gl.ARRAY_BUFFER, screenVertexPositionBuffer);
        screenvertices = new Float32Array(2*6);
		xc=0.5;yc=0.5;
		index=0;
   	    append(screenvertices,[
             -xc,-yc, -xc,yc, xc,-yc,
             -xc,yc,  xc,yc,  xc,-yc			 
			 ]); 	
        gl.bufferData(gl.ARRAY_BUFFER, (screenvertices), gl.STATIC_DRAW);
        screenVertexPositionBuffer.itemSize = 2;
        screenVertexPositionBuffer.numItems = 6;

	    Math.seedrandom();

}
		

function addindex(tab,values){
	var ix=0,n2=n*n;
	for(var i=0;i<values.length;i++){
	   ix=parseInt(values[i]);
	   if(ix<0){ix+=n2;};
       if(ix>n2){ix-=n2;};
       tab[index]=ix;
	   index+=1;
	}
}
function addindexcloud(tab,values){
	var ix=0;
	for(var i=0;i<values.length;i++){
	   ix=values[i];
	   tab[index]=(ix);
	   index+=1;
	}
}
var nx0=0,ny0=0,tmove=1,tmove2=1,trot2=1;
function updateindex(){
		var n2=n+n,i2=0,j2=0;
        //n4=scale*1;
		//var xmax=0.99*(scale*(8.0*n)/n-n4), ymax=0.99*(scale*(n*8.0/n)-n4);//,  height[i*n+j],
		//var xmin=0.99*(scale*(8.0*0)/n-n4), ymin=0.99*(scale*(0*8.0/n)-n4);//,  height[i*n+j],
        gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER, solVertexIndexBuffer);
		nmap2=parseInt((1+z/15)*nmap*0.8/3);
		if(nmap2>2*nmap){nmap2=2*nmap;};if(nmap2<1){nmap2=1;};
		distmap2=nmap2*scale*0.5*8/n;
		var nx=(x+n4)*n/(scale*8);
		var ny=(y+n4)*n/(scale*8);
		var alt=getterrainheight2(x,y);zsol=alt;if(z>(alt+5)){zsol=0.1;};
		if(z<(alt+0.69001) && tfoot==0){
		   if(landing==0){soundpneu();}; 
		   z=alt+0.69;landing=1;if(o2<-8*tpiste){o2=-0.6*o2+Math.random()*0.5;}else{if(o2<-0.02){o2=-0.01;};}
		   }else{landing=0;};
		nx-=nmap2/2;ny-=nmap2/2;
		nx=parseInt(nx);
		ny=parseInt(ny);
		tmove=0;
		if(nx==nx0 && ny==ny0 && tmove2==0){return;};
		if(nx!=nx0 || ny!=ny0){nx0=nx;ny0=ny;tmove=1;}
		var nx2=nx+nmap2/2,ny2=ny+nmap2/2,test=0,dj=4,nitem=0;
		index=0;
		for (var i=nx; i<(nx+nmap2); i++) {i2=((i+n)%n)*n;test=0;dj=4;
        for(var j=ny;j<(ny+(nmap2));j++){j2=(j+n)%n;
		   dj+=1;if(dj>=4){dj=0;
              if(rotavion(i-nx2,j-ny2,0,6)>0){test=1;
		     }else{j+=4;dj=4;if(test==1){break;};}}		   
		   if(test==1){nitem+=1;
		    addindex(solVertexIndices,[
             i2+j2,  i2+j2+n, i2+j2+1, 
             i2+j2+n,  i2+j2+n+1,   i2+j2+1
            ]);}
		}}
		for(var i=0;i<nmount;i++){
		  var imount=mounti[i],jmount=mountj[i],hmount=mounth[i];
		  if(Math.abs(imount-nx2)<32 && Math.abs(imount-nx2)>(nmap2/2-6)){
		   if(Math.abs(jmount-ny2)<32 && Math.abs(jmount-ny2)>(nmap2/2-6)){
		     if(rotavion(imount-nx2,jmount-ny2,hmount+2)>0){
		       var dj=8;
		       for(var j=-dj;j<dj;j+=1){
		       for(var k=-dj;k<dj;k+=1){
		        var jj=parseInt(j+imount),kk=parseInt(k+jmount);
			    if(jj>0 && jj<n && kk>0 && kk<n){
		         nitem+=1;i2=jj*n;j2=kk;
		         addindex(solVertexIndices,[
                  i2+j2,  i2+j2+n, i2+j2+1, 
                  i2+j2+n,  i2+j2+n+1,   i2+j2+1
                 ]);}
			  }}}
			}}  
		}
        gl.bufferData(gl.ELEMENT_ARRAY_BUFFER, solVertexIndices , gl.STATIC_DRAW);
		//solVertexIndexBuffer.numItems = 6*nmap2*(nmap2-1);
		solVertexIndexBuffer.numItems = 6*nitem;//6*nmap2*(nmap2-1);
}
var cloudsize=1,cloudsize1=1,tstorm=0;
cloudsize=0.8+0.5*Math.random();
cloudsize1=cloudsize;
function updatecloud(){if(tmove==0){return;};
        train=0;
        gl.bindBuffer(gl.ARRAY_BUFFER, cloudVertexPositionBuffer);
		var xc=0,yc=0,zc=0,distmax=1.2*(xmax-xmin)/5;
		var dx0=x-x0,dy0=y-y0;
		if((Math.abs(dx0)+Math.abs(dy0))<distmax){dx0=0;dy0=0;}
		index=0;
		for (var i=0; i < ncloud; i++) {
		   xc=cloudvertices[index]+dx0;
		   yc=cloudvertices[index+1]+0.0015*dtime+dy0;
		   zc=cloudvertices[index+2];
		   while(xc<(x-distmax)){xc+=distmax*1.99;};
		   while(xc>(x+distmax)){xc-=distmax*1.99;};
		   while(yc<(y-distmax)){yc+=distmax*1.99;};
		   while(yc>(y+distmax)){yc-=distmax*1.99;};
		   if(wclouds>=20){
		    var dx=cloudsize*15*cloudscale[i]*wclouds/(20+wclouds); 
		    if(Math.abs(xc-x-30*cos1*cloudsize)<dx){
             if(Math.abs(yc-y-30*sin1*cloudsize)<dx){
               if(Math.abs(zc-z-3*cloudsize)<dx*10/15){
			     if(i<ncloud2){train=1;}}
             }
           };}			 
		   addindexcloud(cloudvertices,[
             xc,yc,zc,  xc,yc,zc,  xc,yc,zc,
             xc,yc,zc,  xc,yc,zc,  xc,yc,zc			 
			 ]); 
		}	
        gl.bufferData(gl.ARRAY_BUFFER, (cloudvertices), gl.STATIC_DRAW);
		if(Math.random()<0.001*dtime){if(Math.random()<0.05 && tframe>tstorm){
		            if(wclouds>=20){cloudsize1=0.8+Math.random()*Math.random()*4.4*(1+wclouds/140);
					}else{cloudsize1=0.8+Math.random()*2.2;}
					if(Math.random()<(0.72-wclouds/200)){cloudsize1=0.8+Math.random()*0.5;};
					if(cloudsize1>2.5 && Math.random()<0.5){
					   cloudsize1+=1;soundthunder();
					   tstorm=tframe+40000+80000*Math.random();}
					};}
		cloudsize+=(cloudsize1-cloudsize)*0.00005*dtime;
}
var thour=0,hour=0;
function updatesun(){
        gl.bindBuffer(gl.ARRAY_BUFFER, sunVertexPositionBuffer);
		var xc=0,yc=0,zc=0;
	    hour=new Date().getHours()+new Date().getMinutes()/60.0+ thour;
		while(hour>24){hour-=24;}
		while(hour<0){hour+=24;};
    	sunx=1000*Math.sin((12-hour)*3.14/24);
		suny=-1000*Math.cos((12-hour)*3.44/24);
		sunz=800*Math.cos((12-hour)*3.14/24)*Math.cos((12-hour)*3.14/24)+40;
		index=0;
		for (var i=0; i < ncloud; i++) {
		   xc=x+sunx;
		   yc=y+suny;
		   zc=sunz;
		   addindexcloud(sunvertices,[
             xc,yc,zc,  xc,yc,zc,  xc,yc,zc,
             xc,yc,zc,  xc,yc,zc,  xc,yc,zc			 
			 ]); 
		}	
        gl.bufferData(gl.ARRAY_BUFFER, (sunvertices), gl.STATIC_DRAW);
}

function updatetree(){if(tmove2==0 && tmove==0){return;};
        gl.bindBuffer(gl.ARRAY_BUFFER, treeVertexPositionBuffer);
		var xc=0,yc=0,zc=0,distmax=90/1.3,test=0,h=2;
      if(tmove>0){ 
		var dist=distmap2;if(distmax>dist){distmax=dist;}
		index=0;
		for (var i=0; i < ntree; i++) {
		   xc=treevertices[index];
		   yc=treevertices[index+1];
		   zc=treevertices[index+2];
		   treex[i]=xc;treey[i]=yc;treez[i]=zc;	 
		   test=0;
		   while(xc<(x-distmax)){xc+=distmax*1.99999;test=1;};
		   while(xc>(x+distmax)){xc-=distmax*1.99999;test=1;};
		   while(yc<(y-distmax)){yc+=distmax*1.99999;test=1;};
		   while(yc>(y+distmax)){yc-=distmax*1.99999;test=1;};
		   if(tfoot==1){if(Math.abs(xc-x)<0.15){
		                if(Math.abs(yc-y)<0.15){
						if(zc>=0.15){tcollide=1;};};};}
		   if(test==1){zc=getterrainheight(xc,yc);
		     if(testroad>=3){zc=-999;}
		     if(zc<0.11 || zc>20){zc=-999;}
		     //if(zc<0.15 || zc>20){zc=-999;}
			 if(tforest[(parseInt(n+n*xc/xmax)%n)*n+parseInt(n+n*yc/ymax)%n]==0){
		      zc=-999;}
    	     addindexcloud(treevertices,[
               xc,yc,zc,  xc,yc,zc+h,  xc,yc,zc			 
			   ]);}else{index+=9;}; 
		}
	  }//tmove	
        var itree=0;
		index=0;
		for (var i=0; i < ntree; i++) {
		    if(treez[i]>0.15){
			  xc=treex[i];yc=treey[i];zc=treez[i];
			  if(rotavion(xc-x,yc-y,zc-z,h)>0){
			    itree+=1;
			    addindexcloud(treevertices2,[
               xc,yc,zc,  xc,yc,zc+h,  xc,yc,zc			 
			   ]);
			  }
			}
		}
        gl.bufferData(gl.ARRAY_BUFFER, (treevertices2), gl.STATIC_DRAW);
		treeVertexPositionBuffer.numItems=itree*3;
}
function updategrass(){if(tmove2==0 && tmove==0){return;};
        gl.bindBuffer(gl.ARRAY_BUFFER, grassVertexPositionBuffer);
		var xc=0,yc=0,zc=0,distmax=24,test=0,h=2*0.3;	
		index=0;
		for (var i=0; i < ngrass; i++) {
		   xc=grassvertices[index];
		   yc=grassvertices[index+1];
		   zc=grassvertices[index+2];
		   //grassx[i]=xc;grassy[i]=yc;grassz[i]=zc;	 
		   test=0;
		   while(xc<(x-distmax)){xc+=distmax*1.99999;test=1;};
		   while(xc>(x+distmax)){xc-=distmax*1.99999;test=1;};
		   while(yc<(y-distmax)){yc+=distmax*1.99999;test=1;};
		   while(yc>(y+distmax)){yc-=distmax*1.99999;test=1;};
		   if(test==1){zc=getterrainheight(xc,yc)+0.051;
		     if(zc<0.1 || zc>20){zc=-999;}
             if(Math.abs(townxx-xc)<90){
                if(Math.abs(townyy-yc)<90){zc=-999;};}
       	     if(Math.abs(yc-pistey)<7){
   		     if(xc>(pistex+45.5-98) && xc<(pistex+45.5)){
                zc=-999;};}
		     addindexcloud(grassvertices,[
               xc,yc,zc,  xc,yc,zc+grassh[i],  xc,yc,zc			 
			   ]);}else{index+=9;}; 
		}	
        /*var igrass=0;
		index=0;
		for (var i=0; i < ngrass; i++) {
		    if(grassz[i]>0){
			  xc=grassx[i];yc=grassy[i];zc=grassz[i];
			  if(rotavion(xc-x,yc-y,zc-z,grassh[i])>0){
			    igrass+=1;
			    addindexcloud(grassvertices2,[
               xc,yc,zc,  xc,yc,zc+grassh[i],  xc,yc,zc			 
			   ]);
			  }
			}
		}
        gl.bufferData(gl.ARRAY_BUFFER, (grassvertices2), gl.STATIC_DRAW);
		grassVertexPositionBuffer.numItems=igrass*3;*/
        gl.bufferData(gl.ARRAY_BUFFER, (grassvertices), gl.STATIC_DRAW);
}
function updateflower(){if(tmove2==0 && tmove==0){return;};
        gl.bindBuffer(gl.ARRAY_BUFFER, flowerVertexPositionBuffer);
		var xc=0,yc=0,zc=0,distmax=24,test=0,h=2*0.3;	
		index=0;
		for (var i=0; i < nflower; i++) {
		   xc=flowervertices[index];
		   yc=flowervertices[index+1];
		   zc=flowervertices[index+2];
		   test=0;
		   while(xc<(x-distmax)){xc+=distmax*1.99999;test=1;};
		   while(xc>(x+distmax)){xc-=distmax*1.99999;test=1;};
		   while(yc<(y-distmax)){yc+=distmax*1.99999;test=1;};
		   while(yc>(y+distmax)){yc-=distmax*1.99999;test=1;};
		   if(test==1){zc=getterrainheight(xc,yc)+0.051;
		     if(zc<0.1 || zc>20){zc=-999;}
             if(Math.abs(townxx-xc)<90){
                if(Math.abs(townyy-yc)<90){zc=-999;};}
       	     if(Math.abs(yc-pistey)<7){
   		     if(xc>(pistex+45.5-98) && xc<(pistex+45.5)){
                zc=-999;};}
		     h=flowerh[i];		
		     addindexcloud(flowervertices,[
               xc,yc,zc,  xc,yc,zc+h,  xc,yc,zc,
               xc,yc,zc+h, xc,yc,zc+h, xc,yc,zc			   
			   ]);}else{index+=18;}; 
		}	
        gl.bufferData(gl.ARRAY_BUFFER, (flowervertices), gl.STATIC_DRAW);
}
function updatesea(){//if(tmove==0){return;};
        //while(seax>(x+110)){seax-=110;}
		//while(seax<(x-110)){seax+=110;}
        //while(seay>(y+110)){seay-=110;}
		//while(seay<(y-110)){seay+=110;}
		seax=x;seay=y;
	  if(tmove>0){	
        gl.bindBuffer(gl.ARRAY_BUFFER, seaVertexPositionBuffer);
        //seavertices = new Float32Array(3*6);
		var xc=0,yc=0,zc=0;
		index=0;
		var seascale=4.7;if(z>25){seascale*=1.2*0.5*nmap2/nmap;}
		//   xc=110*seascale;
		//   yc=110*seascale;
		   xc=(xmax-xmin)*0.5*nmap2/n;
		   yc=(ymax-ymin)*0.5*nmap2/n;
		   zc=-0.3;
		   if(tsea==0){zc=-0.51;xc*=0.96;yc*=0.96}
		   var s=seax,t=seay;
		   append(seavertices,[
             s-xc,t-yc,zc,  s-xc,t+yc,zc,  s+xc,t-yc,zc,
             s-xc,t+yc,zc,  s+xc,t+yc,zc,  s+xc,t-yc,zc			 
			 ]); 	
        gl.bufferData(gl.ARRAY_BUFFER, (seavertices), gl.STATIC_DRAW);
        seaVertexPositionBuffer.itemSize = 3;
        seaVertexPositionBuffer.numItems = 6;
	  }	
        gl.bindBuffer(gl.ARRAY_BUFFER, seaVertexTextureCoordBuffer);
        //seatextureCoords = new Array(2*6);
		index=0;
		var xc=110*seascale,yc=110*seascale;
		   xc=(xmax-xmin)*0.5*nmap2/n;
		   yc=(ymax-ymin)*0.5*nmap2/n;
		//var s=10*seascale;if(tsea==2){s*=2}
		//var u=5*seascale*(seax%xc)/xc,v=5*seascale*(seay%yc)/yc;
		var s=xc/11;if(tsea==2){s*=2}
		var u=(tframe%1000000)*0.0000055+(xc/22)*(seax%xc)/xc,v=(xc/22)*(seay%yc)/yc;
		   append(seatextureCoords,[
             u,v, u,v+s, u+s,v,
			 u,v+s, u+s,v+s, u+s,v
            ]);
        gl.bufferData(gl.ARRAY_BUFFER, (seatextureCoords), gl.STATIC_DRAW);
        seaVertexTextureCoordBuffer.itemSize = 2;
        seaVertexTextureCoordBuffer.numItems = 6;
}
function updatehorizon(){//if(tmove==0){return;};
        //while(horizonx>(x+110)){horizonx-=110;}
		//while(horizonx<(x-110)){horizonx+=110;}
        //while(horizony>(y+110)){horizony-=110;}
		//while(horizony<(y-110)){horizony+=110;}
		horizonx=x;horizony=y;
		var horizonscale=3;//if(z>27){horizonscale*=1.2*0.5*nmap2/nmap;}
	  if(tmove>0){	
        gl.bindBuffer(gl.ARRAY_BUFFER, horizonVertexPositionBuffer);
        //horizonvertices = new Float32Array(3*6);
		var xc=0,yc=0,zc=0;
		index=0;
		   xc=110*horizonscale;
		   yc=110*horizonscale;
		   //xc=(xmax-xmin)*0.5*nmap2/n;
		   //yc=(ymax-ymin)*0.5*nmap2/n;
		   zc=-0.9;
		   //if(thorizon==0){zc=-0.51;xc*=0.96;yc*=0.96}
		   var s=horizonx,t=horizony;
		   append(horizonvertices,[
             s-xc,t-yc,zc,  s-xc,t+yc,zc,  s+xc,t-yc,zc,
             s-xc,t+yc,zc,  s+xc,t+yc,zc,  s+xc,t-yc,zc			 
			 ]); 	
        gl.bufferData(gl.ARRAY_BUFFER, (horizonvertices), gl.STATIC_DRAW);
        horizonVertexPositionBuffer.itemSize = 3;
        horizonVertexPositionBuffer.numItems = 6;
	  }	
        gl.bindBuffer(gl.ARRAY_BUFFER, horizonVertexTextureCoordBuffer);
        //horizontextureCoords = new Array(2*6);
		index=0;
		var xc=110*horizonscale,yc=110*horizonscale;
		   //xc=(xmax-xmin)*0.5*nmap2/n;
		   //yc=(ymax-ymin)*0.5*nmap2/n;
		//var s=10*horizonscale;if(thorizon==2){s*=2}
		//var u=5*horizonscale*(horizonx%xc)/xc,v=5*horizonscale*(horizony%yc)/yc;
		var s=xc/220;
		var u=(xc/440)*(horizonx%xc)/xc,v=(xc/440)*(horizony%yc)/yc;
		   append(horizontextureCoords,[
             u,v, u,v+s, u+s,v,
			 u,v+s, u+s,v+s, u+s,v
            ]);
        gl.bufferData(gl.ARRAY_BUFFER, (horizontextureCoords), gl.STATIC_DRAW);
        horizonVertexTextureCoordBuffer.itemSize = 2;
        horizonVertexTextureCoordBuffer.numItems = 6;
}
function updatescreen(do1,do2,do3,scalex){
        //screenVertexPositionBuffer = gl.createBuffer();
        gl.bindBuffer(gl.ARRAY_BUFFER, screenVertexPositionBuffer);
        //screenvertices = new Float32Array(2*6);
		//var xc=0.5*scalex*(1+0.12137*3+0.00003*sin1);
		//var xc=0.5*scalex*1.3829;
		var xc=0.5*scalex*1.03829;
		var yc=xc;
		var dx=0.5*do1/(47),dy=-0.5*do2/(47);
		dx/=gl.viewportWidth / gl.viewportHeight;
		index=0;
   	    append(screenvertices,[
             -xc+dx,-yc+dy, -xc+dx,yc+dy, xc+dx,-yc+dy,
             -xc+dx,yc+dy,  xc+dx,yc+dy,  xc+dx,-yc+dy			 
			 ]); 	
        gl.bufferData(gl.ARRAY_BUFFER, (screenvertices), gl.STATIC_DRAW);
        //screenVertexPositionBuffer.itemSize = 2;
        //screenVertexPositionBuffer.numItems = 6;
}
var tkeytir=0;
function tir(){
   tkeytir=tframe;
   var s=1+(Math.random()-0.5)*0.12;
   var t=1+(Math.random()-0.5)*0.12;
   var u=1+(Math.random()-0.5)*0.12;
   var v=(2.2+vplane)*(1+(Math.random()-0.5)*0.2);
   var dx=-sin2*0.2*u-sin1*s+cos1*t,dy=-sin2*0.2*u+cos1*s+sin1*t,dz=0.2*cos2;
   if(tfoot==1){dx=0;}
   var xc=x+dx*cos3-dz*cos1*sin3,yc=y+dy*cos3-dz*sin1*sin3,zc=z+dz*cos3-sin3*cos2;
   //addtir(xc,yc,zc,cos1*cos2*s*v,sin1*cos2*t*v,sin2*u*v);
   var r=0.015;
   var ss=(Math.random()-0.5)*r,tt=(Math.random()-0.5)*r,uu=(Math.random()-0.5)*r;
   addtir(xc,yc,zc,(cos1*cos2*s+ss)*v,(sin1*cos2*t+tt)*v,(sin2*u+uu)*v,0);
   s=1+(Math.random()-0.5)*0.12;
   t=1+(Math.random()-0.5)*0.12;
   u=1+(Math.random()-0.5)*0.12;
   v=(2.2+vplane)*(1+(Math.random()-0.5)*0.2);
   dx=-sin2*0.2*u+sin1*s-cos1*t;dy=-sin2*0.2*u-cos1*s-sin1*t;dz=0.2*cos2;
   if(tfoot==1){dx=0;}
   xc=x+dx*cos3-dz*cos1*sin3;yc=y+dy*cos3-dz*sin1*sin3;zc=z+dz*cos3+sin3*cos2;
   //addtir(xc,yc,zc,cos1*cos2*s*v,sin1*cos2*t*v,sin2*u*v);
   ss=(Math.random()-0.5)*r;tt=(Math.random()-0.5)*r;uu=(Math.random()-0.5)*r;
   addtir(xc,yc,zc,(cos1*cos2*s+ss)*v,(sin1*cos2*t+tt)*v,(sin2*u+uu)*v,0);
}
var ptkeytir=0;
function ptir(){
   ptkeytir=tframe;
   var s=1+(Math.random()-0.5)*0.12;
   var t=1+(Math.random()-0.5)*0.12;
   var u=1+(Math.random()-0.5)*0.12;
   var v=(2.2+pvplane)*(1+(Math.random()-0.5)*0.2);
   var dx=-psin2*0.2*u-psin1*s+pcos1*t,dy=-psin2*0.2*u+pcos1*s+psin1*t,dz=0.2*pcos2;
   var xc=px+dx*pcos3-dz*pcos1*psin3,yc=py+dy*pcos3-dz*psin1*psin3,zc=pz+dz*pcos3-psin3*pcos2;
   //addtir(xc,yc,zc,cos1*cos2*s*v,sin1*cos2*t*v,sin2*u*v);
   var r=0.015;
   var ss=(Math.random()-0.5)*r,tt=(Math.random()-0.5)*r,uu=(Math.random()-0.5)*r;
   addtir(xc,yc,zc,(pcos1*pcos2*s+ss)*v,(psin1*pcos2*t+tt)*v,(psin2*u+uu)*v,2);
   s=1+(Math.random()-0.5)*0.12;
   t=1+(Math.random()-0.5)*0.12;
   u=1+(Math.random()-0.5)*0.12;
   v=(2.2+pvplane)*(1+(Math.random()-0.5)*0.2);
   dx=-psin2*0.2*u+psin1*s-pcos1*t;dy=-psin2*0.2*u-pcos1*s-psin1*t;dz=0.2*pcos2;
   xc=px+dx*pcos3-dz*pcos1*psin3;yc=py+dy*pcos3-dz*psin1*psin3;zc=pz+dz*pcos3+psin3*pcos2;
   //addtir(xc,yc,zc,cos1*cos2*s*v,sin1*cos2*t*v,sin2*u*v);
   ss=(Math.random()-0.5)*r;tt=(Math.random()-0.5)*r;uu=(Math.random()-0.5)*r;
   addtir(xc,yc,zc,(pcos1*pcos2*s+ss)*v,(psin1*pcos2*t+tt)*v,(psin2*u+uu)*v,2);
}
function p3tir(){
   p3tkeytir=tframe;
   var s=1+(Math.random()-0.5)*0.12;
   var t=1+(Math.random()-0.5)*0.12;
   var u=1+(Math.random()-0.5)*0.12;
   var v=(2.2+p3vplane)*(1+(Math.random()-0.5)*0.2);
   var dx=-p3sin2*0.2*u-p3sin1*s+p3cos1*t,dy=-p3sin2*0.2*u+p3cos1*s+p3sin1*t,dz=0.2*p3cos2;
   var xc=p3x+dx*p3cos3-dz*p3cos1*p3sin3,yc=p3y+dy*p3cos3-dz*p3sin1*p3sin3,zc=p3z+dz*p3cos3-p3sin3*p3cos2;
   //addtir(xc,yc,zc,cos1*cos2*s*v,sin1*cos2*t*v,sin2*u*v);
   var r=0.015;
   var ss=(Math.random()-0.5)*r,tt=(Math.random()-0.5)*r,uu=(Math.random()-0.5)*r;
   addtir(xc,yc,zc,(p3cos1*p3cos2*s+ss)*v,(p3sin1*p3cos2*t+tt)*v,(p3sin2*u+uu)*v,3);
   s=1+(Math.random()-0.5)*0.12;
   t=1+(Math.random()-0.5)*0.12;
   u=1+(Math.random()-0.5)*0.12;
   v=(2.2+p3vplane)*(1+(Math.random()-0.5)*0.2);
   dx=-p3sin2*0.2*u+p3sin1*s-p3cos1*t;dy=-p3sin2*0.2*u-p3cos1*s-p3sin1*t;dz=0.2*p3cos2;
   xc=p3x+dx*p3cos3-dz*p3cos1*p3sin3;yc=p3y+dy*p3cos3-dz*p3sin1*p3sin3;zc=p3z+dz*p3cos3+p3sin3*p3cos2;
   //addtir(xc,yc,zc,cos1*cos2*s*v,sin1*cos2*t*v,sin2*u*v);
   ss=(Math.random()-0.5)*r;tt=(Math.random()-0.5)*r;uu=(Math.random()-0.5)*r;
   addtir(xc,yc,zc,(p3cos1*p3cos2*s+ss)*v,(p3sin1*p3cos2*t+tt)*v,(p3sin2*u+uu)*v,3);
}
function addtir(xc,yc,zc,vx,vy,vz,type){
itir+=1;if(itir>(ntir-1)){itir=0;}
tirx[itir]=xc;tiry[itir]=yc;tirz[itir]=zc;
vtirx[itir]=vx;vtiry[itir]=vy;vtirz[itir]=vz;
ttir[itir]=tframe+6000;
tirsize[itir]=1.0;
tirtype[itir]=type;
if(type==1){tirsize[itir]=3.0;ttir[itir]=tframe+18000;}
} 
var ntir2=0,tattack=0,tattack2=0,tattack3=0,tattackp3=0;
var dirtir=0;      
function updatetir(){
        gl.bindBuffer(gl.ARRAY_BUFFER, tirVertexPositionBuffer);
		var xc=0,yc=0,zc=0,h=0.2,co1=0.2*cos1,si1=0.2*sin1,vx=0,vy=0,vz=0;
		var dt=dtime*0.013,dt1=1.0-dtime*0.0001,s=1,i=0,zh=0;
		var dt2=1.0-dtime*0.00007,dt11=dt1;
		ntir2=0;dirtir=0;
		index=0;
		for (var ii=0; ii < ntir; ii++) {
		 i=itir+ii+1;if(i>=ntir){i-=ntir;}
		 if(tframe<ttir[i]){
		  ntir2+=1;
		  s=tirsize[i];
		  if(s<10.0){
		   dt11=dt1;if(tirtype[i]==1){dt11=dt2;}
		   vx=vtirx[i]*dt11;
		   vy=vtiry[i]*dt11;
		   vz=vtirz[i]*dt11-dt*0.00195;
		   xc=tirx[i]+vx*dt;
		   yc=tiry[i]+vy*dt;
		   zc=tirz[i]+vz*dt;
		   zh=-999;
           if(tirtype[i]!=2){		   
		    if(Math.abs(xc-px)<2){if(Math.abs(yc-py)<2){
		      if(Math.abs(zc-pz)<1){vx=0,vy=0;vz=0;zh=-9999;
			     if(Math.random()<0.3){tattack=1;};
				 addimpact(xc,yc,zc,1);
				 var pvie0=pvie;pvie-=Math.random()*2;
				 if(pvie<0 && pvie0>=0){pvie-=50;};if(pvie<-150){pvie=100;};
				 if(pvie<0 && Math.random()<dtime*0.004){addsmoke(xc,yc,zc,3,0);}
			     s=15.0;ttir[i]=tframe+1000;tirsize[i]=s;};};}
		   }		 
           if(tirtype[i]!=3){		   
		    if(Math.abs(xc-p3x)<2){if(Math.abs(yc-p3y)<2){
		      if(Math.abs(zc-p3z)<1){vx=0,vy=0;vz=0;zh=-9999;
			     if(Math.random()<0.3){tattackp3=1;};
				 addimpact(xc,yc,zc,1);
				 var p3vie0=p3vie;p3vie-=Math.random()*2;
				 if(p3vie<0 && p3vie0>=0){p3vie-=50;};if(p3vie<-150){p3vie=100;};
				 if(p3vie<0 && Math.random()<dtime*0.004){addsmoke(xc,yc,zc,3,0);}
			     s=15.0;ttir[i]=tframe+1000;tirsize[i]=s;};};}
		   }		 
		   if(tirtype[i]!=1){
            var dx=xc-shipx,dy=yc-shipy;
	        var dxx=dx*shipco1+dy*shipsi1;
	        if(dxx>-9 && dxx<9){
	         var dyy=(-dx*shipsi1+dy*shipco1);
		     if(dyy>-2 && dyy<2){
		      if(Math.abs(zc-(shipz+1))<4){vx=0,vy=0;vz=0;zh=-9999;
			     if(Math.random()<0.3){tattack2=tframe;};
				 addimpact2(xc,yc,zc,1);
				 shipvie-=Math.random();if(shipvie<-50){shipvie=-50;}
				 if(shipvie<0 && Math.random()<dtime*0.004){addsmoke(xc,yc,zc,6,1);}
			     s=15.0;ttir[i]=tframe+1000;tirsize[i]=s;};};}
		   }
		   if(tirtype[i]!=1 && tsea>0){
            var dx=xc-shipcarrierx,dy=yc-shipcarriery;
	        var dxx=dx*shipcarrierco1+dy*shipcarriersi1;
	        if(dxx>-24.5 && dxx<19.9){
	         var dyy=(-dx*shipcarriersi1+dy*shipcarrierco1);
		     if(dyy>-3.7 && dyy<7){
		      if(Math.abs(zc-(shipcarrierz+1))<4){vx=0,vy=0;vz=0;zh=-9999;
			     if(Math.random()<0.3){tattack3=tframe;};
				 addimpact2(xc,yc,zc,1);
				 shipcarriervie-=Math.random();if(shipcarriervie<-50){shipcarriervie=-50;}
				 if(shipcarriervie<0 && Math.random()<dtime*0.004){addsmoke(xc,yc,zc,6,1);}
			     s=15.0;ttir[i]=tframe+1000;tirsize[i]=s;};};}
		   }
		   if(tirtype[i]!=0){
		    var disttir=Math.abs(xc-x)+Math.abs(yc-y);
			if(disttir>3 && disttir<(15+disttir*0.3)){
    		  var disttiry=(x-xc)*vx-(y-yc)*vy;
              if(disttiry>0){dirtir=1;}else{dirtir=-1;};}
			if(Math.abs(xc-x)<2){if(Math.abs(yc-y)<2){
		      if(Math.abs(zc-z)<2){vx=0,vy=0;vz=0;zh=-9999;
		         xc+=cos1*cos2*5;
		         yc+=sin1*cos2*5;
		         zc+=sin2*5;
				 addimpact2(xc,yc,zc,1);vie-=Math.random()*10;
				 if(tirtype[i]==1){soundexplosion();}
				 if(vie<-50){vie=-21;if(pvie<50){pvie=50;};}
				 tblood=tframe;o1blood+=1;if(o1blood>1.1){o1blood=0;}
			     s=15.0;ttir[i]=tframe+1000;tirsize[i]=s;};};}
		   }
		   if(tsea>0){
		    for(var j=0;j<nsailship;j++){
            var dx=xc-psailshipx[j],dy=yc-psailshipy[j];
	        var dxx=dx*psailshipco1[j]+dy*psailshipsi1[j];
	        if(dxx>-5 && dxx<5){
	         var dyy=(-dx*psailshipsi1[j]+dy*psailshipco1[j]);
		     if(dyy>-1.2 && dyy<1.2){
		      if(Math.abs(zc-(psailshipz[j]+1))<4){vx=0,vy=0;vz=0;zh=-9999;
				 addimpact2(xc,yc,zc,1);
				 psailshipvie[j]-=3*Math.random();
				 if(psailshipvie[j]<0 && Math.random()<dtime*0.004){addsmoke(xc,yc,zc,3,1);}
			     s=15.0;ttir[i]=tframe+1000;tirsize[i]=s;};};}
		   };}
		   if(zc>zh && zh>-9998 && tirtype[i]!=1){zh=getterrainheight2(xc,yc);}
           if(zc<zh-0.2){s=15.0;ttir[i]=tframe+1000;tirsize[i]=s;
		                 if(testtown){addimpact2(xc,yc,zc,1);};};
           tirx[i]=xc;tiry[i]=yc;tirz[i]=zc;
           vtirx[i]=vx;vtiry[i]=vy;vtirz[i]=vz;
		   }	
           co1=0.2*cos1*s;si1=0.2*sin1*s;h=0.2*s;		   
		   addindexcloud(tirvertices,[
             xc-si1,yc+co1,zc-h,  xc-si1,yc+co1,zc+h,  xc+si1,yc-co1,zc-h,
             xc-si1,yc+co1,zc+h,  xc+si1,yc-co1,zc+h,  xc+si1,yc-co1,zc-h			 
			 ]);
          }else{tirsize[i]=1.0;}	  
		}	
        gl.bufferData(gl.ARRAY_BUFFER,(tirvertices), gl.STATIC_DRAW);
        tirVertexPositionBuffer.numItems=ntir2*6;
}

var x=0,y=0,z=0,o1=0,o2=0,o3=0,vrun=1.10;
var cos1=0,sin1=0,cos2=0,sin2=0,cos3=0,sin3=0,do1=0,do2=0,do3=0; 
var px=0,py=0,pz=0,po1=0,po2=0,po3=0,pvrun=1,pvie=100;
var pcos1=0,psin1=0,pcos2=0,psin2=0,pcos3=0,psin3=0,pdo1=0,pdo2=0,pdo3=0;
var to1=0,to2=-15,tcos1=0,tsin1=0,tcos2=0,tsin2=0,tourelle=0,tourelle0=0; 
var to11=180,to21=to2,ko1=to1,ko2=to2;
var p3x=0,p3y=0,p3z=0,p3o1=0,p3o2=0,p3o3=0,p3vrun=1,p3vie=100;
var p3cos1=0,p3sin1=0,p3cos2=0,p3sin2=0,p3cos3=0,p3sin3=0,p3do1=0,p3do2=0,p3do3=0;
z=25;o2=-20.5;
x=(xmax+xmin)/2;y=(ymax+ymin)/2;
if(test){x=(xmax-xmin)/2-50;y=(ymax-ymin)/2;z=0;vrun=0;
//x=waterx;y=watery;vplane=1;
}
pz=30;po2=0;px=x+100;py=y-10;
p3z=30;p3o2=0;p3x=x+90;p3y=y-20;
//y=ymax-100;x=xmax-100;
var tshadow=0,zsol=0,distshadow=0,sunzz=1000,sunco2=0,sunsi2=1,sunco1=0,sunsi1=1;
    function drawshadow() {
	    tshadow=1;
        //gl.viewport(0, 0, 512,512);//620,430);
		gl.viewport(0, 0,rttFramebuffer.width,rttFramebuffer.height);
        gl.clear(gl.COLOR_BUFFER_BIT | gl.DEPTH_BUFFER_BIT);
		if(tfoot==0){distshadow=300.0*nmap2/(2*nmap);
		}else{distshadow=300.0*nmap2/(4*nmap);}
		var wx=distshadow,wy=distshadow;
		/*var dz=Math.sqrt(sunx*sunx+suny*suny+sunzz*sunzz);
		var dx=Math.sqrt(sunx*sunx+suny*suny);
		sunco2=dx/dz;sunsi2=sunzz/dz;
		sunco1=sunx/dz;sunsi1=suny/dz;*/
        //mat4.ortho(-wx,wx,-wy*sunsi2,wy*sunsi2,100.0, 100000.0, pMatrix);
        mat4.ortho(-wx,wx,-wy,wy,100.0, 100000.0, pMatrix);
		var xv=x+20*sunx,yv=y+20*suny,zv=zsol+20*sunzz;//20*sunz+51000;
		mat4.lookAt([xv,yv,zv],[x,y,zsol],[-suny,sunx,1.01],mvMatrix);
		gl.useProgram(cloudProgram);
		camx=x+4000*cos1;camy=y+4000*sin1;camz=z+80000;
		drawcloud();
        gl.useProgram(shaderProgram);
 		sunzz=sunz+2500;
		//zv=zsol+5*sunzz;
        //xv=20*sunx;yv=20*suny;zv=20*sunzz;
        mat4.lookAt([xv,yv,zv],[x,y,zsol],[1000,0,1.1],mvMatrix);
        if(tfoot==1){drawroc();}
		//mat4.identity(mvMatrix);
		//mat4.translate(mvMatrix, [-x,-y,-zsol]);
        //mat4.rotate(mvMatrix, degtorad(-o1), [0, 0, 1]);
		if(tfoot==0){drawplane();}
        //mat4.lookAt([xv,yv,zv],[px,py,zsol],[1000,0,0.1],mvMatrix);
		//drawplane2();
		//drawplane3();
        gl.useProgram(treeProgram);
		if(z<27 && tfoot==1){drawtree();};
		tshadow=0;
	}	
	
    function drawscenescreen(){	
	    gl.viewport(0, 0, windx,windy);
		mat4.perspective(47, gl.viewportWidth / gl.viewportHeight, 0.1, 6000.0, pMatrix);
        gl.useProgram(shaderProgram);
        mat4.identity(mvMatrix);
		mat4.scale(mvMatrix,[0.0001,0.0001,0.0001]);
		drawcarre();
		gl.useProgram(screenprogram);
		drawscreen();
		gl.useProgram(program2d);
		drawrain();
	    gl.useProgram(shaderProgram);
        gl.disable(gl.CULL_FACE);
		drawbouss();
		return;
	}
    var to22=0;	
    function drawscene(kangle) {//o1=195;drawshadow();scrollTo(winx,winy);return;
		if(tframe<tsoundouch+170){
		   tsoundouch=Math.min(tsoundouch,tframe+120);
		   gl.viewport(0, 0, windx,windy);
		   gl.clearColor(1,0.5,0.0, 1);
           gl.clear(gl.COLOR_BUFFER_BIT | gl.DEPTH_BUFFER_BIT);
		   return;}
		
		gl.viewport(0, 0, windx,windy);
        gl.clear(gl.COLOR_BUFFER_BIT | gl.DEPTH_BUFFER_BIT);
        
        if(tourelle<2 && tfoot==0){
		  mat4.perspective(47*kangle, gl.viewportWidth / gl.viewportHeight, 1, 10000.0, pMatrix);
		}else if(plane=="spitfire"){
		  mat4.perspective(47*kangle, gl.viewportWidth / gl.viewportHeight, 0.25, 10000.0, pMatrix);
		}else{
		  mat4.perspective(47*kangle, gl.viewportWidth / gl.viewportHeight, 0.1, 6000.0, pMatrix);
		}
		var xv=x-7*cos1*cos2,yv=y-7*sin1*cos2,zv=z-7*sin2;
		var zv1=getterrainheight(xv,yv)+0.5;//0.2;
		if(zv<zv1){zv=zv1;}
		if(tfoot==1){
		   //mat4.lookAt([x,y,z+0.5],[x+cos1*cos2,y+sin1*cos2,z+sin2+0.5],[0,0,1],mvMatrix);
		   mat4.lookAt([x,y,z+0.7],[x+cos1*cos2,y+sin1*cos2,z+sin2+0.7],[0,0,1],mvMatrix);
		}else if(tourelle==0){
		   var co3=Math.cos(degtorad(o3-planedo3));si3=Math.sin(degtorad(o3-planedo3));
		   mat4.lookAt([xv,yv,zv],[x,y,z],[-cos1*sin2-sin1*si3,-sin1*sin2+cos1*si3,cos2*co3],mvMatrix);
		   //mat4.lookAt([0,0,0],[0,0,-100],[0,1,0],mvMatrix);
           //mat4.identity(mvMatrix);
		}else{
		   var tco1=Math.cos(degtorad(to1));
           tcos1=Math.cos(degtorad(o1+to1));tsin1=Math.sin(degtorad(o1+to1));
		   to22=o2*tco1+to2;if(to22>89){to22=88;};if(to22<-89){to22=-88;};
           tcos2=Math.cos(degtorad(to22));tsin2=Math.sin(degtorad(to22));
		   if(tourelle==1){
		   mat4.lookAt([x,y,z+0.5],[x+tcos1*tcos2,y+tsin1*tcos2,z+tsin2+0.5],[-tcos1*tsin2*cos3-tsin1*sin3*tco1,-tsin1*tsin2*cos3+tcos1*sin3*tco1,tcos2*cos3],mvMatrix);
           }else{//tourelle==2
		   var co3=Math.cos(degtorad(o3-planedo3));si3=Math.sin(degtorad(o3-planedo3));
		   var co2=Math.cos(degtorad(o2-planedo2));si2=Math.sin(degtorad(o2-planedo2));
	       var dz=0.25,dx=0.01;
		   xv=x-dz*sin1*si3+dx*cos1*co2;yv=y+dz*cos1*si3+dx*sin1*co2;zv=z+dz*co3+dx*si2;
           mat4.lookAt([xv,yv,zv],[xv+tcos1*tcos2,yv+tsin1*tcos2,zv+tsin2+0.25],[-tcos1*tsin2*cos3-tsin1*sin3,-tsin1*tsin2*cos3+tcos1*sin3,tcos2*cos3],mvMatrix);
		   }
		}
		   
		gl.useProgram(shaderProgram);
        drawskydome();
		gl.useProgram(starProgram);
		if(hour<6 || hour>18){drawstar();}

        /*if((hour<6 || hour>18)&& wclouds>39){ 
		 gl.useProgram(skyProgram);
		 drawsky();
		 tskydome=0;
		}else{tskydome=1;}*/ 
		
        gl.useProgram(cloudProgram);
		updatesun();
		drawsun();
		
        gl.useProgram(cloudProgram);
		colorr=0.5;colorg=1;colorb=1;colora=0.42;
		drawsunmirror();
		colorr=0.3;colorg=1;colorb=1;colora=0.28;
		drawcloudmirror();
		colorr=1;colorg=1;colorb=1;colora=1;
		
        gl.useProgram(solProgram);
		drawsol();
		drawpiste();
		drawtower();
		drawtown();

        gl.useProgram(treeProgram);
		updatetree();
		if(z<27){drawtree();};
		updategrass();
		if(z<zsol+10){drawgrass();};
		updateflower();
		if(z<zsol+10){drawflower();};
		if(z<27){drawskeleton();drawpotion();};
		
        gl.useProgram(shaderProgram);
		drawfarmlow();
		drawcastle();
		if(z<27){drawroc();};
		if(z<27){drawtrunk();};
		if(tfoot==1){drawarm();
		    if(thorse==1){drawhorse();}else{drawhorsebody();}
		}
		drawhorselow();
		//drawship();
		//if(tsea>0){drawshipcarrier();drawsailships();}
        gl.useProgram(solProgram);
		drawwater();
		if(seaheight>0.1){updatesea();drawsea();
		}else{seaheight=-0.4;updatesea();drawsea();
		      updatehorizon();drawhorizon();
			  }

        gl.useProgram(shaderProgram);
		if(vie<-20 && tframe>(ttsmoke+1000)){ttsmoke=tframe;
		   var sc=0.7;
		   addsmoke(x+cos1*cos2*sc+(0.5-Math.random())/6,y+sin1*cos2*sc+(0.5-Math.random())/6,z+sin2*sc,1,0);}
		drawsmoke();
		drawimpact();
		if(ntir2>0){drawtir();}
		updatetir();
		/*testcollide();
		if(tcollide==1){soundpneu();tcollide=0; 
		       if(o2<-8){o2*=-0.6;}else{if(o2<-0.02){o2=-0.01;};}
			   if(Math.abs(vplane)<0.25){x-=5*cos1;y-=5*sin1;}; 
         }*/

        gl.useProgram(cloudProgram);
		updatecloud();
		camx=x;camy=y;camz=z;
		drawcloud();
        
		gl.useProgram(program2d);
		if(kangle<1.0001){drawrain();}
		
        gl.useProgram(shaderProgram);
        //gl.enable(gl.CULL_FACE);
        //drawplane2();
        //drawplane3();		
        if(tourelle==0 || tourelle>=2){if(tfoot==0){drawplane();};}
        gl.disable(gl.CULL_FACE);
		if(kangle<1.0001){drawbouss();}
		if(vie>-20){vie+=dtime*0.00012;if(vie>100){vie=100;};}
		if(vie<20){if(tframe<tblood+320){drawblood();};}//{vie+=dtime*0.003;};}
		

	}   

var pixdata=new Uint8Array(4),tcollide=0;
/*function testcollide(){
  var ix=parseInt(windx*0.5),iy=parseInt(windy*0.5);
  gl.readPixels(ix,iy,1,1,gl.RGBA,gl.UNSIGNED_BYTE,pixdata);
  //var r=pixdata[0]/255.0,g=pixdata[1]/255.0,b=pixdata[2]/255.0
  var a=pixdata[3];
    gl.enable(gl.BLEND);
    gl.blendFunc(gl.SRC_ALPHA,gl.ONE_MINUS_SRC_ALPHA);
        mvPushMatrix();
		mat4.identity(mvMatrix);
		mat4.translate(mvMatrix, [0,0,-1.5]);

 		mat4.scale(mvMatrix,[0.0001,0.0001,0.0001]);
    	gl.activeTexture(gl.TEXTURE0);
        gl.bindTexture(gl.TEXTURE_2D, cloudTexture);
        gl.uniform1i(shaderProgram.samplerUniform, 0);
	
	gl.bindBuffer(gl.ARRAY_BUFFER, boussVertexTextureCoordBuffer);
    gl.vertexAttribPointer(shaderProgram.textureCoordAttribute, boussVertexTextureCoordBuffer.itemSize, gl.FLOAT, false, 0, 0);

    gl.bindBuffer(gl.ARRAY_BUFFER, boussVertexPositionBuffer);
    gl.vertexAttribPointer(shaderProgram.vertexPositionAttribute, boussVertexPositionBuffer.itemSize, gl.FLOAT, false, 0, 0);

	setMatrixUniforms();
    gl.uniform4f(shaderProgram.colorUniform, 0,0,0,2/255.0);
    gl.drawArrays(gl.TRIANGLES, 0, boussVertexPositionBuffer.numItems);
		mvPopMatrix();
	gl.disable(gl.BLEND);
  
gl.readPixels(ix,iy,1,1,gl.RGBA,gl.UNSIGNED_BYTE,pixdata);
auxvar=pixdata[3]-a;
if(pixdata[3]==a){tcollide=1;}else{tcollide=0;};
}*/
function drawsol(){
	    updateindex();
		mvPushMatrix();

        gl.bindBuffer(gl.ARRAY_BUFFER, solVertexPositionBuffer);
        gl.vertexAttribPointer(solProgram.vertexPositionAttribute, solVertexPositionBuffer.itemSize, gl.FLOAT, false, 0, 0);

        gl.bindBuffer(gl.ARRAY_BUFFER, solVertexTextureCoordBuffer);
        gl.vertexAttribPointer(solProgram.textureCoordAttribute, solVertexTextureCoordBuffer.itemSize, gl.FLOAT, false, 0, 0);

        gl.activeTexture(gl.TEXTURE1);
        gl.bindTexture(gl.TEXTURE_2D, rttTexture);
        gl.uniform1i(solProgram.samplerUniform2, 1);
        gl.activeTexture(gl.TEXTURE2);
        gl.bindTexture(gl.TEXTURE_2D, solTexture);
        gl.uniform1i(solProgram.samplerUniform, 2);

        //gl.bindBuffer(gl.ARRAY_BUFFER, solVertexColorBuffer);
        //gl.vertexAttribPointer(shaderProgram.vertexColorAttribute, solVertexColorBuffer.itemSize, gl.FLOAT, false, 0, 0);

        //setMatrixUniforms();
       // gl.drawArrays(gl.TRIANGLE_STRIP, 0, solVertexPositionBuffer.numItems);
       
        gl.disable(gl.CULL_FACE);
	    gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER, solVertexIndexBuffer);
        setMatrixUniformssol();
        gl.drawElements(gl.TRIANGLES, solVertexIndexBuffer.numItems, gl.UNSIGNED_SHORT, 0);

        mvPopMatrix();
}
var tskydome=1;skydomeo1=Math.random()*360;
function drawskydome(){
    gl.disable(gl.DEPTH_TEST);
	gl.activeTexture(gl.TEXTURE9);
    gl.bindTexture(gl.TEXTURE_2D,  skydomeTexture);
    gl.uniform1i(shaderProgram.samplerUniform, 9);
        mvPushMatrix();
        //mat4.identity(mvMatrix);
		mat4.translate(mvMatrix, [x-0.5*(x-(xmin+xmax)/2),y-0.5*(y-(ymin+ymax)/2),0]);
        //mat4.rotate(mvMatrix, degtorad(-90), [1, 0, 0]);
        skydomeo1+=dtime*0.0003;if(skydomeo1>360){skydomeo1-=360;}
		mat4.rotate(mvMatrix, degtorad(-skydomeo1), [0, 0, 1]);
        //mat4.rotate(mvMatrix, degtorad(sin3*24), [1, 0, 0]);
		mat4.scale(mvMatrix,[10.2,10.2,10.2]);
    
    gl.bindBuffer(gl.ARRAY_BUFFER, skydomeVertexTextureCoordBuffer);
    gl.vertexAttribPointer(shaderProgram.textureCoordAttribute, skydomeVertexTextureCoordBuffer.itemSize, gl.FLOAT, false, 0, 0);

    gl.bindBuffer(gl.ARRAY_BUFFER, skydomeVertexPositionBuffer);
    gl.vertexAttribPointer(shaderProgram.vertexPositionAttribute, skydomeVertexPositionBuffer.itemSize, gl.FLOAT, false, 0, 0);

    gl.disable(gl.CULL_FACE);
	var aux=1-0.945*Math.abs(12-hour)/12;
    var aux2=1-0.93*Math.abs(12-hour)/12;
    var aux3=1-0.62*Math.abs(12-hour)/12;
    colorr=1.0*aux3;colorg=1.0*aux;colorb=1.0*aux2;colora=1.0;
	//colorr=1;colorg=1;colorb=1;colora=0;
	setMatrixUniforms();
    gl.drawArrays(gl.TRIANGLES, 0, skydomeVertexPositionBuffer.numItems);

		mvPopMatrix();
	colorr=1;colorg=1;colorb=1;colora=1;
    gl.enable(gl.DEPTH_TEST);
}

function drawsky(){
    gl.disable(gl.DEPTH_TEST);
    mvPushMatrix();
    //mat4.identity(mvMatrix);
	if(tourelle==0){	
		mat4.translate(mvMatrix, [x+cos1*1000,y+sin1*1000, -70]);
        mat4.rotate(mvMatrix, degtorad(90), [0, 1, 0]);
        mat4.rotate(mvMatrix, degtorad(-o1), [1, 0, 0]);
        mat4.rotate(mvMatrix, degtorad(-o2), [0, 1, 0]);
        mat4.rotate(mvMatrix, degtorad(90), [0, 0, 1]);
		mat4.scale(mvMatrix,[17*windx/windy,17*windx/windy,7]);
	}else{
		mat4.translate(mvMatrix, [x+tcos1*1000,y+tsin1*1000, -70]);
        mat4.rotate(mvMatrix, degtorad(90), [0, 1, 0]);
        mat4.rotate(mvMatrix, degtorad(-o1-to1), [1, 0, 0]);
        mat4.rotate(mvMatrix, degtorad(-o2-to2), [0, 1, 0]);
        mat4.rotate(mvMatrix, degtorad(90), [0, 0, 1]);
		mat4.scale(mvMatrix,[17*windx/windy,17*windx/windy,7]);
	}
	gl.activeTexture(gl.TEXTURE6);
    gl.bindTexture(gl.TEXTURE_2D,  skyTexture);
    gl.uniform1i(skyProgram.samplerUniform, 6);
    drawcarresky();    

		mvPopMatrix();
    gl.enable(gl.DEPTH_TEST);
}
function drawcloud(){
    gl.disable(gl.CULL_FACE);
    gl.disable(gl.DEPTH_TEST);
    gl.enable(gl.BLEND);
    gl.blendFunc(gl.SRC_ALPHA, gl.ONE);//_MINUS_SRC_ALPHA);
        mvPushMatrix();
		//vec3.set(cameraPosition,[x,y,z]);
	    //mat4.identity(rotMatrix);
        //mat4.translate(rotMatrix, [x,y,z]);
        //mat4.rotate(rotMatrix, degtorad(o1), [0, 0, 1]);
        //mat4.translate(rotMatrix, [-x,-y,-z]);
		//mat4.translate(mvMatrix, [x,y,z]);
        //mat4.rotate(mvMatrix, degtorad(-90), [1, 0, 0]);
        //
        //mat4.rotate(mvMatrix, degtorad(sin3*24), [1, 0, 0]);
		//mat4.scale(mvMatrix,[40.2,40.2,80.2]);
	gl.activeTexture(gl.TEXTURE3);
    gl.bindTexture(gl.TEXTURE_2D,  cloudTexture);
    gl.uniform1i(cloudProgram.samplerUniform, 3);
    
    gl.bindBuffer(gl.ARRAY_BUFFER, cloudVertexTextureCoordBuffer);
    gl.vertexAttribPointer(cloudProgram.textureCoordAttribute, cloudVertexTextureCoordBuffer.itemSize, gl.FLOAT, false, 0, 0);

    gl.bindBuffer(gl.ARRAY_BUFFER, cloudVertexPositionBuffer);
    gl.vertexAttribPointer(cloudProgram.vertexPositionAttribute, cloudVertexPositionBuffer.itemSize, gl.FLOAT, false, 0, 0);

	setcloudMatrixUniforms();
    gl.drawArrays(gl.TRIANGLES, 0, 6*ncloud2);//cloudVertexPositionBuffer.numItems);

		mvPopMatrix();
    gl.enable(gl.DEPTH_TEST);
    gl.disable(gl.BLEND);
}
function drawsun(){
    gl.disable(gl.CULL_FACE);
    gl.disable(gl.DEPTH_TEST);
    gl.enable(gl.BLEND);
    gl.blendFunc(gl.SRC_ALPHA, gl.ONE);//_MINUS_SRC_ALPHA);
        mvPushMatrix();
		camx=x;camy=y;camz=z;
		//mat4.translate(mvMatrix, [500,0,100]);
	    //mat4.identity(rotMatrix);
        //mat4.translate(rotMatrix, [x,y,z]);
        //mat4.rotate(rotMatrix, degtorad(o1), [0, 0, 1]);
	gl.activeTexture(gl.TEXTURE0);
    gl.bindTexture(gl.TEXTURE_2D,  sunTexture);
    gl.uniform1i(cloudProgram.samplerUniform, 0);
    
    gl.bindBuffer(gl.ARRAY_BUFFER, sunVertexTextureCoordBuffer);
    gl.vertexAttribPointer(cloudProgram.textureCoordAttribute, sunVertexTextureCoordBuffer.itemSize, gl.FLOAT, false, 0, 0);

    gl.bindBuffer(gl.ARRAY_BUFFER, sunVertexPositionBuffer);
    gl.vertexAttribPointer(cloudProgram.vertexPositionAttribute, sunVertexPositionBuffer.itemSize, gl.FLOAT, false, 0, 0);

	setsunMatrixUniforms();
    gl.drawArrays(gl.TRIANGLES, 0, sunVertexPositionBuffer.numItems);

	mvPopMatrix();
    gl.enable(gl.DEPTH_TEST);
    gl.disable(gl.BLEND);
}
function drawsunmirror(){
    mvPushMatrix();
    mat4.translate(mvMatrix, [0,0,-z]);
    mat4.scale(mvMatrix,[1,1,-1]);
	drawsun();
	mvPopMatrix();
}
function drawcloudmirror(){
    mvPushMatrix();
    mat4.translate(mvMatrix, [0,0,-z]);
    mat4.scale(mvMatrix,[1,1,-1]);
	drawcloud();
	mvPopMatrix();
}
var vie=100,tblood=0,o1blood=0;
function drawblood(){
    gl.disable(gl.CULL_FACE);
    gl.disable(gl.DEPTH_TEST);
    gl.enable(gl.BLEND);
    gl.blendFunc(gl.ONE_MINUS_SRC_COLOR, gl.SRC_COLOR);
        mvPushMatrix();
		mat4.identity(mvMatrix);
		mat4.translate(mvMatrix, [0,0,-110]);
 		if(o1blood<0.5){mat4.scale(mvMatrix,[windx/windy,1,1]);
		 }else{mat4.scale(mvMatrix,[-windx/windy,1,1]);} 
	gl.activeTexture(gl.TEXTURE0);
    gl.bindTexture(gl.TEXTURE_2D,  bloodTexture);
    gl.uniform1i(shaderProgram.samplerUniform, 0);
    
	//colorr=1;colorg=1;colorb=1;colora=0.999;
    drawcarre();

		mvPopMatrix();
    gl.enable(gl.DEPTH_TEST);
    gl.disable(gl.BLEND);
	colorr=1.0;colorg=1.0;colorb=1.0;colora=1.0;
}
function drawscreen(){
    gl.disable(gl.DEPTH_TEST);
	gl.activeTexture(gl.TEXTURE10);
    gl.bindTexture(gl.TEXTURE_2D,  rtt2Texture);
    gl.uniform1i(screenprogram.samplerUniform, 10);
    gl.bindBuffer(gl.ARRAY_BUFFER, screenVertexPositionBuffer);
    gl.vertexAttribPointer(screenprogram.vertexPositionAttribute, screenVertexPositionBuffer.itemSize, gl.FLOAT, false, 0, 0);
    gl.drawArrays(gl.TRIANGLES, 0, screenVertexPositionBuffer.numItems);
    gl.enable(gl.DEPTH_TEST);
}
var train=0,train1=0,train2=0,timerain1=0,timerain2=0;
var texscalex1=1,texscaley1=1,textdx1=0,textdy1=0;
var texscalex2=1,texscaley2=1,textdx2=0,textdy2=0;
function drawrain(){
    if(fps<4.1){train=0;}
	if(train==0 && train1==0 && train2==0){stopsoundrain();return;}
	soundrain();
    gl.disable(gl.CULL_FACE);
    gl.disable(gl.DEPTH_TEST);
    gl.enable(gl.BLEND);
    gl.blendFunc(gl.ONE_MINUS_SRC_COLOR, gl.ONE);
	gl.activeTexture(gl.TEXTURE10);
    gl.bindTexture(gl.TEXTURE_2D,  rainTexture);
    gl.uniform1i(program2d.samplerUniform, 10);
	var kvplane=(0.5+1.5*vplane);if(kvplane<0.5){kvplane=0.5;}
	dx2d=0;dy2d=0.2;
	texscalex=texscalex1;texscaley=texscaley1;
	textdx=textdx1;textdy=textdy1;
	if(tframe>timerain1){
	  train1=train;
      if(tframe>timerain2){
	    timerain1=tframe+(Math.random()+2)*800/kvplane;		
	  }else{timerain1=timerain2+(Math.random()+2)*600/kvplane;}
	  texscalex=0.75*windx/windy;texscaley=0.85;
	  textdx=Math.random();textdy=Math.random();
	}else{texscalex-=kvplane*dtime/7000;
	      texscaley-=kvplane*dtime/7000;}
    if(texscalex<0.1){texscalex=0.1;}
    if(texscaley<0.1){texscaley=0.1;}
    var c=(1.4-texscaley);
    colorr=c;colorg=c;colorb=c;colora=1;
	texscalex1=texscalex;texscaley1=texscaley;
	textdx1=textdx;textdy1=textdy;
	texscaley*=(1+Math.abs(dy2d));
	if(train1==1){drawcarre2D();}

	texscalex=texscalex2;texscaley=texscaley2;
	textdx=textdx2;textdy=textdy2;
	if(tframe>timerain2){
	  train2=train;
      if(tframe>timerain1){
	    timerain2=tframe+(Math.random()+2)*800/kvplane;	
	  }else{timerain2=timerain1+(Math.random()+2)*600/kvplane;}
	  texscalex=0.75*windx/windy;texscaley=0.85;
	  textdx=Math.random();textdy=Math.random();
	}else{texscalex-=kvplane*dtime/7000;
	      texscaley-=kvplane*dtime/7000;}
    if(texscalex<0.1){texscalex=0.1;}
    if(texscaley<0.1){texscaley=0.1;}
    c=(1.4-texscaley);
    colorr=c;colorg=c;colorb=c;colora=1;
	texscalex2=texscalex;texscaley2=texscaley;
	textdx2=textdx;textdy2=textdy;
	texscaley*=(1+Math.abs(dy2d));
	if(train2==1){drawcarre2D();}

	colorr=1;colorg=1;colorb=1;colora=1;
    gl.enable(gl.DEPTH_TEST);
    gl.disable(gl.BLEND);
}
function drawbouss(){
    gl.disable(gl.CULL_FACE);
    gl.disable(gl.DEPTH_TEST);
    gl.enable(gl.BLEND);
    gl.blendFunc(gl.SRC_ALPHA, gl.ONE_MINUS_SRC_ALPHA);
        mvPushMatrix();
		mat4.identity(mvMatrix);
		windx=canvas.width;
		windy=canvas.height;
		mat4.translate(mvMatrix, [230*windx/windy,-220,-600]);//boussx
		if(tourelle==0){mat4.rotate(mvMatrix, degtorad(90-o1), [0, 0, 1]);
	    }else{mat4.rotate(mvMatrix, degtorad(90-o1-to1), [0, 0, 1]);}
		//mat4.identity(rotMatrix);
        //mat4.translate(rotMatrix, [x,y,z]);
        //mat4.rotate(rotMatrix, degtorad(o1), [0, 0, 1]);
	gl.activeTexture(gl.TEXTURE0);
    gl.bindTexture(gl.TEXTURE_2D,  boussTexture);
    gl.uniform1i(shaderProgram.samplerUniform, 0);
    
    drawcarre();

		mvPopMatrix();
    gl.enable(gl.DEPTH_TEST);
    gl.disable(gl.BLEND);
}
var waitkey=0;
function submap(){
drawmap();
waitkey=vk_m;
}
function subwaitkey(){
if(keys[waitkey]){resetkeys();waitkey=0;}
if(keys[vk_space]){resetkeys();waitkey=0;}
if(keys[vk_return]){resetkeys();waitkey=0;}
if(keys[vk_escape]){resetkeys();waitkey=0;}
document.getElementById('intext').focus();
}
function drawmap(){
gl.viewport(0, 0, windx,windy);
gl.clear(gl.COLOR_BUFFER_BIT | gl.DEPTH_BUFFER_BIT);
mat4.perspective(47, gl.viewportWidth / gl.viewportHeight, 1, 10000.0, pMatrix);
gl.useProgram(shaderProgram);
    gl.disable(gl.CULL_FACE);
    gl.disable(gl.DEPTH_TEST);
    gl.disable(gl.BLEND);
	gl.activeTexture(gl.TEXTURE0);
    gl.bindTexture(gl.TEXTURE_2D,  waterTexture);
    gl.uniform1i(shaderProgram.samplerUniform, 0);
	gl.bindBuffer(gl.ARRAY_BUFFER, boussVertexTextureCoordBuffer);
    gl.vertexAttribPointer(shaderProgram.textureCoordAttribute, boussVertexTextureCoordBuffer.itemSize, gl.FLOAT, false, 0, 0);
    gl.bindBuffer(gl.ARRAY_BUFFER, boussVertexPositionBuffer);
    gl.vertexAttribPointer(shaderProgram.vertexPositionAttribute, boussVertexPositionBuffer.itemSize, gl.FLOAT, false, 0, 0);
    mvPushMatrix();
	var di=3;
	for(var i=0;i<n;i+=di){
	  for(var j=0;j<n;j+=di){	
    	mat4.identity(mvMatrix);
		var ix=(i-n/2),iy=(j-n/2);
		mat4.translate(mvMatrix, [ix*1.2,iy,-350]);
 		var sc=0.07*di/3;
		mat4.scale(mvMatrix,[sc,sc,sc]);
		//mat4.identity(rotMatrix);
        //mat4.translate(rotMatrix, [x,y,z]);
        //mat4.rotate(rotMatrix, degtorad(o1), [0, 0, 1]);
	    /*var px=xmin+(xmax-xmin)*i/n,py=ymin+(ymax-ymin)*j/n;
	    var nx=(px+n4)*n/(scale*8);
	    var ny=(py+n4)*n/(scale*8);*/
		var ixy=i*n+j;
		//if(ixy<0){ixy=0};if(ixy>(n*n)){ixy=n*n;}
		var h=height[ixy],h2=height[ixy+1],h3=height[ixy+n];
		//var ix=parseInt(1024*i/n),iy=parseInt(1024*j/n);
		//h=solTexturedata[4*(iy*1024+ix)]/8;
        colorr=0;colorb=0;colorg=0.5+0.5*h/40;
		if(Math.abs(h-0.1)<0.00001){colorr=1;colorg=0.43;colorb=0.38;}
		if(Math.abs(h-0.11)<0.001){colorr=1;colorg=0.7;colorb=0.58;}
		if(Math.abs(h2-0.11)<0.001){colorr=1;colorg=0.7;colorb=0.58;}
		if(Math.abs(h3-0.11)<0.001){colorr=1;colorg=0.7;colorb=0.58;}
		if(tsea>0 && h<-0.01){colorb=0.5;colorg=0;}
		if(tsea==0 && h<-0.5){colorb=0.5;colorg=0;}
	    setMatrixUniforms();
        gl.drawArrays(gl.TRIANGLES, 0, boussVertexPositionBuffer.numItems);
      }
	}
    mat4.identity(mvMatrix);
	var i=0.979*n*(castlex-xmin)/(xmax-xmin);
	var j=0.979*n*(castley-ymin)/(ymax-ymin);
	var ix=(i-n/2),iy=(j-n/2);
	mat4.translate(mvMatrix, [ix*1.2,iy,-350]);
 	mat4.scale(mvMatrix,[0.057,0.057,0.057]);
    colorr=1;colorg=0.50;colorb=0.44;
	drawcarre();

    mat4.identity(mvMatrix);
	 i=0.979*n*(x-xmin)/(xmax-xmin);
	 j=0.979*n*(y-ymin)/(ymax-ymin);
	 ix=(i-n/2);iy=(j-n/2);
	mat4.translate(mvMatrix, [ix*1.2,iy,-350]);
 	mat4.scale(mvMatrix,[0.05,0.05,0.05]);
	colorr=0;colorb=0;colorg=0;
	drawcarre();
	mvPopMatrix();
	colorr=1;colorb=1;colorg=1;
    gl.enable(gl.DEPTH_TEST);
}
function drawcarre(){
	gl.bindBuffer(gl.ARRAY_BUFFER, boussVertexTextureCoordBuffer);
    gl.vertexAttribPointer(shaderProgram.textureCoordAttribute, boussVertexTextureCoordBuffer.itemSize, gl.FLOAT, false, 0, 0);

    gl.bindBuffer(gl.ARRAY_BUFFER, boussVertexPositionBuffer);
    gl.vertexAttribPointer(shaderProgram.vertexPositionAttribute, boussVertexPositionBuffer.itemSize, gl.FLOAT, false, 0, 0);

	setMatrixUniforms();
    gl.drawArrays(gl.TRIANGLES, 0, boussVertexPositionBuffer.numItems);
}
function drawcarre2D(){
	//gl.bindBuffer(gl.ARRAY_BUFFER, boussVertexTextureCoordBuffer);
    //gl.vertexAttribPointer(program2D.textureCoordAttribute, boussVertexTextureCoordBuffer.itemSize, gl.FLOAT, false, 0, 0);

    gl.bindBuffer(gl.ARRAY_BUFFER, boussVertexPositionBuffer);
    gl.vertexAttribPointer(program2d.vertexPositionAttribute, boussVertexPositionBuffer.itemSize, gl.FLOAT, false, 0, 0);

	setMatrixUniforms2D();
    gl.drawArrays(gl.TRIANGLES, 0, boussVertexPositionBuffer.numItems);
}
function drawcarresky(){
	gl.bindBuffer(gl.ARRAY_BUFFER, boussVertexTextureCoordBuffer);
    gl.vertexAttribPointer(skyProgram.textureCoordAttribute, boussVertexTextureCoordBuffer.itemSize, gl.FLOAT, false, 0, 0);

    gl.bindBuffer(gl.ARRAY_BUFFER, boussVertexPositionBuffer);
    gl.vertexAttribPointer(skyProgram.vertexPositionAttribute, boussVertexPositionBuffer.itemSize, gl.FLOAT, false, 0, 0);

	setskyMatrixUniforms();
    gl.drawArrays(gl.TRIANGLES, 0, boussVertexPositionBuffer.numItems);
}
var o3radar=0,tviseur=0;
function drawcockpit(){
    gl.disable(gl.DEPTH_TEST);
    gl.enable(gl.BLEND);//replaced by shader alpha_test
    gl.blendFunc(gl.SRC_ALPHA, gl.ONE_MINUS_SRC_ALPHA);
        mvPushMatrix();
		/*mat4.translate(mvMatrix, [x,y,z]);
        mat4.rotate(mvMatrix, degtorad(180+o1), [0, 0, 1]);
        mat4.rotate(mvMatrix, degtorad(90), [1, 0, 0]);
        mat4.rotate(mvMatrix, degtorad(-o2), [0, 0, 1]);
        mat4.rotate(mvMatrix, degtorad(o3), [1, 0, 0]);*/
		mat4.translate(mvMatrix, [-0.66,0.0,0]);
        mat4.rotate(mvMatrix, degtorad(90), [0, 1, 0]);
        mat4.rotate(mvMatrix, degtorad(-10), [1, 0, 0]);
        //mat4.rotate(mvMatrix, degtorad(o2), [0, 1, 0]);
        //mat4.rotate(mvMatrix, degtorad(o3), [1, 0, 0]);

 		mat4.scale(mvMatrix,[0.0073,0.0073,0.0073]);
    	gl.activeTexture(gl.TEXTURE0);
        gl.bindTexture(gl.TEXTURE_2D,  compasTexture);
        gl.uniform1i(shaderProgram.samplerUniform, 0);
		mvPushMatrix();
		//mat4.translate(mvMatrix, [-16.1,9.2-2.5*sin2,-1]);
		mat4.translate(mvMatrix, [-16.1,9.2,-1]);
		mat4.rotate(mvMatrix, degtorad(-o3), [0, 0, 1]);
		if(sin2>0){mat4.translate(mvMatrix, [0,-2.5*Math.sqrt(sin2),0]);}else{
		           mat4.translate(mvMatrix, [0,2.5*Math.sqrt(-sin2),0]);}
 		mat4.scale(mvMatrix,[0.07,0.14,0.1]);
		drawcarre();
		mvPopMatrix();
        gl.bindTexture(gl.TEXTURE_2D,  cockpitTexture);
		drawcarre();
		mvPushMatrix();
		mat4.translate(mvMatrix, [-8.6,9.2,1]);
		var o3alt=(z-0.7)*36,o3alt2=o3alt/13;
		mat4.rotate(mvMatrix, degtorad(-o3alt), [0, 0, 1]);
 		mat4.scale(mvMatrix,[0.067,0.065,0.067]);
        gl.bindTexture(gl.TEXTURE_2D,  arrowTexture);
		drawcarre();
		mat4.rotate(mvMatrix, degtorad(o3alt-o3alt2), [0, 0, 1]);
		mat4.scale(mvMatrix,[1,0.6,1]);
		drawcarre();
		mvPopMatrix();
		mvPushMatrix();
		mat4.translate(mvMatrix, [-22.35,9.2,1]);
		var o3speed=(vplane)*190;if(o3speed>340){o3speed=340;}
		mat4.rotate(mvMatrix, degtorad(-o3speed), [0, 0, 1]);
 		mat4.scale(mvMatrix,[0.067,0.062,0.067]);
		drawcarre();
		mvPopMatrix();
		mvPushMatrix();
		mat4.translate(mvMatrix, [-8.6,2.3,1]);
		var o3speedz=(vplanez)*590;
		if(o3speedz>80){o3speedz=80;}
		if(o3speedz<-80){o3speedz=-80;}
		mat4.rotate(mvMatrix, degtorad(-o3speedz+90), [0, 0, 1]);
 		mat4.scale(mvMatrix,[0.062,0.062,0.067]);
		drawcarre();
		mvPopMatrix();
		mvPushMatrix();
		mat4.translate(mvMatrix, [-2.1,2.3,1]);
		var o3rpm=130-(vrun+0.4*vplane)*100;
		if(o3rpm<-130){o3rpm=-130;};
		mat4.rotate(mvMatrix, degtorad(o3rpm), [0, 0, 1]);
 		mat4.scale(mvMatrix,[0.065,0.059,0.067]);
		drawcarre();
		mvPopMatrix();
		mvPushMatrix();
		mat4.translate(mvMatrix, [23.43,6.7,1]);
		o3radar=tframe*0.060;
		mat4.rotate(mvMatrix, degtorad(o3radar), [0, 0, 1]);
 		mat4.scale(mvMatrix,[0.137,0.137,0.137]);
        gl.bindTexture(gl.TEXTURE_2D,  radarTexture);
		drawcarre();
		mvPopMatrix();
		if(tframe<tradarpiste+5000 && dxradarpiste*0.015<5.4){
		mvPushMatrix();
		mat4.translate(mvMatrix, [23.43,6.7,1]);
		mat4.rotate(mvMatrix, degtorad(90-o1+o1radarpiste), [0, 0, 1]);
 		mat4.translate(mvMatrix, [dxradarpiste*0.015,0,0]);
		var sc=0.01*(tradarpiste+7400-tframe)/7400;
		mat4.scale(mvMatrix,[sc,sc,sc]);
        gl.bindTexture(gl.TEXTURE_2D,  cloudTexture);
		drawcarre();
		mvPopMatrix();
		}
		if(tframe<tradarwater+5000 && dxradarwater*0.015<5.4){
		mvPushMatrix();
		mat4.translate(mvMatrix, [23.43,6.7,1]);
		mat4.rotate(mvMatrix, degtorad(90-o1+o1radarwater), [0, 0, 1]);
 		mat4.translate(mvMatrix, [dxradarwater*0.015,0,0]);
		var sc=0.01*(tradarwater+7400-tframe)/7400;
		mat4.scale(mvMatrix,[sc,sc,sc]);
        gl.bindTexture(gl.TEXTURE_2D,  cloudTexture);
		drawcarre();
		mvPopMatrix();
		}
		if(tframe<tradartown+5000 && dxradartown*0.015<5.4){
		mvPushMatrix();
		mat4.translate(mvMatrix, [23.43,6.7,1]);
		mat4.rotate(mvMatrix, degtorad(90-o1+o1radartown), [0, 0, 1]);
 		mat4.translate(mvMatrix, [dxradartown*0.015,0,0]);
		var sc=0.01*(tradartown+7400-tframe)/7400;
		mat4.scale(mvMatrix,[sc,sc,sc]);
        gl.bindTexture(gl.TEXTURE_2D,  cloudTexture);
		drawcarre();
		mvPopMatrix();
		}
		if(tframe<tradarplane2+5000 && dxradarplane2*0.015<5.4){
		mvPushMatrix();
		mat4.translate(mvMatrix, [23.43,6.7,1]);
		mat4.rotate(mvMatrix, degtorad(90-o1+o1radarplane2), [0, 0, 1]);
 		mat4.translate(mvMatrix, [dxradarplane2*0.015,0,0]);
		var sc=0.007*(tradarplane2+7400-tframe)/7400;
		mat4.scale(mvMatrix,[sc,sc,sc]);
        gl.bindTexture(gl.TEXTURE_2D,  cloudTexture);
		drawcarre();
		mvPopMatrix();
		}
		if(tframe<tradarplane3+5000 && dxradarplane3*0.015<5.4){
		mvPushMatrix();
		mat4.translate(mvMatrix, [23.43,6.7,1]);
		mat4.rotate(mvMatrix, degtorad(90-o1+o1radarplane3), [0, 0, 1]);
 		mat4.translate(mvMatrix, [dxradarplane3*0.015,0,0]);
		var sc=0.007*(tradarplane3+7400-tframe)/7400;
		mat4.scale(mvMatrix,[sc,sc,sc]);
        gl.bindTexture(gl.TEXTURE_2D,  cloudTexture);
		drawcarre();
		mvPopMatrix();
		}
		if(tframe<tradarcarrier+5000 && dxradarcarrier*0.015<5.4){
		mvPushMatrix();
		mat4.translate(mvMatrix, [23.43,6.7,1]);
		mat4.rotate(mvMatrix, degtorad(90-o1+o1radarcarrier), [0, 0, 1]);
 		mat4.translate(mvMatrix, [dxradarcarrier*0.015,0,0]);
		var sc=0.01*(tradarcarrier+7400-tframe)/7400;
		mat4.scale(mvMatrix,[sc,sc,sc]);
        gl.bindTexture(gl.TEXTURE_2D,  cloudTexture);
		drawcarre();
		mvPopMatrix();
		}
		mvPushMatrix();
		mat4.translate(mvMatrix, [-2.1,9.23,1]);
		var o3azimut=90-o1;
		mat4.rotate(mvMatrix, degtorad(o3azimut), [0, 0, 1]);
 		mat4.scale(mvMatrix,[0.069,0.069,0.067]);
        gl.bindTexture(gl.TEXTURE_2D,  azimutTexture);
		drawcarre();
		mvPopMatrix();
        if(tviseur==1){
		mvPushMatrix();
		mat4.translate(mvMatrix, [0.56,32.85,1]);
 		mat4.scale(mvMatrix,[0.12,0.12,0.12]);
        gl.bindTexture(gl.TEXTURE_2D,  viseurTexture);
		colorr=1;colorg=1;colorb=1;colora=0.8;
		drawcarre();
		colorr=1;colorg=1;colorb=1;colora=1;
		mvPopMatrix();
        }		
		
		mvPopMatrix();
        gl.enable(gl.DEPTH_TEST);
        gl.disable(gl.BLEND);
}
var o3helice=0;
function drawhelice(){
    gl.disable(gl.DEPTH_TEST);
    gl.enable(gl.BLEND);
    gl.blendFunc(gl.SRC_COLOR, gl.ONE);//_MINUS_SRC_COLOR);
		mvPushMatrix();
		mat4.translate(mvMatrix, [-2,-0.165,0]);
        mat4.rotate(mvMatrix, degtorad(90), [0, 1, 0]);
		o3helice+=(vrun+vplane+0.14)*dtime*0.7;if(o3helice>1000){o3helice-=1000;};
		mat4.rotate(mvMatrix, degtorad(o3helice), [0, 0, 1]);
 		var sc=0.0120*Math.sqrt(windx/windy);
		mat4.scale(mvMatrix,[sc,sc,sc]);
 		//mat4.scale(mvMatrix,[0.0160,0.0160,0.0160]);
    	gl.activeTexture(gl.TEXTURE5);
        gl.bindTexture(gl.TEXTURE_2D,  heliceTexture);
        gl.uniform1i(shaderProgram.samplerUniform, 5);
		drawcarre();
		mvPopMatrix();
    gl.enable(gl.DEPTH_TEST);
    gl.disable(gl.BLEND);
}
var planedo3=0,planedo2=0;
function drawplane(){plane="c150";/*if(plane=="spitfire"){drawspitfire();return;}
                     if(plane=="zero"){drawzero();return;}
                     if(plane=="corsair"){drawcorsair();return;}*/
        mvPushMatrix();
    if(tshadow==0){  
	   if(tourelle==0){	
		mat4.identity(mvMatrix);
		mat4.translate(mvMatrix, [0.0, 0.0, -7.0]);
        mat4.rotate(mvMatrix, degtorad(-90), [0, 1, 0]);
        mat4.rotate(mvMatrix, degtorad(-sin2*24*cos2), [0, 0, 1]);
        mat4.rotate(mvMatrix, degtorad(sin3*24), [1, 0, 0]);
		planedo3=sin3*24;
	  }else{
		mat4.translate(mvMatrix, [x,y,z]);
        mat4.rotate(mvMatrix, degtorad(180+o1), [0, 0, 1]);
        mat4.rotate(mvMatrix, degtorad(90), [1, 0, 0]);
        mat4.rotate(mvMatrix, degtorad(-o2-sin2*4*cos2), [0, 0, 1]);
        //mat4.rotate(mvMatrix, degtorad(o3+sin3*7), [1, 0, 0]);
        mat4.rotate(mvMatrix, degtorad(o3), [1, 0, 0]);
		planedo3=sin3*7*1.4;planedo2=-(sin2+2)*1.4*cos2;
      }	  
	}else{
	    var dx=Math.sqrt(sunx*sunx+suny*suny+sunzz*sunzz);
		var dz=Math.max(0.0,z-zsol-3)*10;
		//var kz=distshadow*0.5;//*0.705
    	//mat4.translate(mvMatrix,[x-1.0*kz*sunx/dz,y-1.0*kz*suny/dz,z]);
    	//mat4.translate(mvMatrix,[x+0.25*(1+cos1)*kz-dz*sunx/dx,y+0.25*(1+sin1)*kz-dz*suny/dx,z]);
    	///mat4.translate(mvMatrix,[x+0.25*(1+0.5)*kz-dz*sunx/dx,y+0.25*(1+0.5)*kz-dz*suny/dx,z]);
    	mat4.translate(mvMatrix,[x-dz*sunx/dx,y-dz*suny/dx,z]);
		//mat4.rotate(mvMatrix, degtorad(180), [0, 0, 1]);
        mat4.rotate(mvMatrix, degtorad(180+o1), [0, 0, 1]);
        mat4.rotate(mvMatrix, degtorad(90), [1, 0, 0]);
        mat4.rotate(mvMatrix, degtorad(-o2), [0, 0, 1]);
        mat4.rotate(mvMatrix, degtorad(o3), [1, 0, 0]);
    }	
	if(tourelle==3 && tshadow==0){drawhelice();}
	mvPushMatrix();
	gl.activeTexture(gl.TEXTURE4);
    if(tshadow==0){gl.bindTexture(gl.TEXTURE_2D,  objTexture);
		if(tourelle==0){mat4.scale(mvMatrix,[0.02,0.02,0.02]);}else{
		    var sc=0.019;mat4.scale(mvMatrix,[sc,sc,sc]);}
	}else{
 		mat4.scale(mvMatrix,[0.03,0.03,0.03]);
                   gl.disable(gl.DEPTH_TEST);
	               gl.bindTexture(gl.TEXTURE_2D,  cloudTexture);}
    gl.uniform1i(shaderProgram.samplerUniform, 4);
    
   if(tshadow==0){
    gl.bindBuffer(gl.ARRAY_BUFFER, worldVertexTextureCoordBuffer);
    gl.vertexAttribPointer(shaderProgram.textureCoordAttribute, worldVertexTextureCoordBuffer.itemSize, gl.FLOAT, false, 0, 0);

    gl.bindBuffer(gl.ARRAY_BUFFER, worldVertexPositionBuffer);
    gl.vertexAttribPointer(shaderProgram.vertexPositionAttribute, worldVertexPositionBuffer.itemSize, gl.FLOAT, false, 0, 0);

    setMatrixUniforms();
    gl.drawArrays(gl.TRIANGLES, 0, worldVertexPositionBuffer.numItems);
   }else{
    gl.bindBuffer(gl.ARRAY_BUFFER, world2VertexTextureCoordBuffer);
    gl.vertexAttribPointer(shaderProgram.textureCoordAttribute, world2VertexTextureCoordBuffer.itemSize, gl.FLOAT, false, 0, 0);

    gl.bindBuffer(gl.ARRAY_BUFFER, world2VertexPositionBuffer);
    gl.vertexAttribPointer(shaderProgram.vertexPositionAttribute, world2VertexPositionBuffer.itemSize, gl.FLOAT, false, 0, 0);

    setMatrixUniforms();
    gl.drawArrays(gl.TRIANGLES, 0, world2VertexPositionBuffer.numItems);
   }   
	mvPopMatrix();
	if(tourelle>=2 && tshadow==0){drawcockpit();}

		mvPopMatrix();
    if(tshadow==1){gl.enable(gl.DEPTH_TEST);};

}
function drawspitfire(){
        mvPushMatrix();
    if(tshadow==0){  
	   if(tourelle==0){	
		mat4.identity(mvMatrix);
		mat4.translate(mvMatrix, [0.0, 0.3, -7.0]);
        mat4.rotate(mvMatrix, degtorad(-90), [0, 1, 0]);
        mat4.rotate(mvMatrix, degtorad(-sin2*24*cos2), [0, 0, 1]);
        mat4.rotate(mvMatrix, degtorad(sin3*24), [1, 0, 0]);
		planedo3=sin3*24;
	  }else{
		mat4.translate(mvMatrix, [x,y,z]);
        mat4.rotate(mvMatrix, degtorad(180+o1), [0, 0, 1]);
        mat4.rotate(mvMatrix, degtorad(90), [1, 0, 0]);
        mat4.rotate(mvMatrix, degtorad(-o2-sin2*4*cos2), [0, 0, 1]);
        //mat4.rotate(mvMatrix, degtorad(o3+sin3*7), [1, 0, 0]);
        mat4.rotate(mvMatrix, degtorad(o3), [1, 0, 0]);
		planedo3=sin3*7*1.4;planedo2=-(sin2+2)*1.4*cos2;
      }	  
	}else{
	    var dx=Math.sqrt(sunx*sunx+suny*suny+sunzz*sunzz);
		var dz=Math.max(0.0,z-zsol-3)*10;
		//var kz=distshadow*0.5;//*0.705
    	//mat4.translate(mvMatrix,[x-1.0*kz*sunx/dz,y-1.0*kz*suny/dz,z]);
    	//mat4.translate(mvMatrix,[x+0.25*(1+cos1)*kz-dz*sunx/dx,y+0.25*(1+sin1)*kz-dz*suny/dx,z]);
    	///mat4.translate(mvMatrix,[x+0.25*(1+0.5)*kz-dz*sunx/dx,y+0.25*(1+0.5)*kz-dz*suny/dx,z]);
    	mat4.translate(mvMatrix,[x-dz*sunx/dx,y-dz*suny/dx,z]);
		//mat4.rotate(mvMatrix, degtorad(180), [0, 0, 1]);
        mat4.rotate(mvMatrix, degtorad(180+o1), [0, 0, 1]);
        mat4.rotate(mvMatrix, degtorad(90), [1, 0, 0]);
        mat4.rotate(mvMatrix, degtorad(-o2), [0, 0, 1]);
        mat4.rotate(mvMatrix, degtorad(o3), [1, 0, 0]);
    }	
	if(tourelle==3 && tshadow==0){drawhelice();}
	mvPushMatrix();
	mat4.translate(mvMatrix, [-0.26*cos2+0.05, -0.044, 0.0]);
    mat4.rotate(mvMatrix, degtorad(-90), [1, 0, 0]);
	gl.activeTexture(gl.TEXTURE4);
    if(tshadow==0){gl.bindTexture(gl.TEXTURE_2D,  spitfireTexture);
		if(tourelle==0){mat4.scale(mvMatrix,[0.021,0.0259,0.021]);}else{
		    var sc=0.020;mat4.scale(mvMatrix,[sc,0.0209,sc]);}
	}else{
 		mat4.scale(mvMatrix,[0.03,0.03,0.03]);
                   gl.disable(gl.DEPTH_TEST);
	               gl.bindTexture(gl.TEXTURE_2D,  cloudTexture);}
    gl.uniform1i(shaderProgram.samplerUniform, 4);
    
   if(tshadow==0){
    if(tourelle==0 || Math.abs(to1)>100 || to2<-25){
    gl.bindBuffer(gl.ARRAY_BUFFER, spitfireVertexTextureCoordBuffer);
    gl.vertexAttribPointer(shaderProgram.textureCoordAttribute, spitfireVertexTextureCoordBuffer.itemSize, gl.FLOAT, false, 0, 0);

    gl.bindBuffer(gl.ARRAY_BUFFER, spitfireVertexPositionBuffer);
    gl.vertexAttribPointer(shaderProgram.vertexPositionAttribute, spitfireVertexPositionBuffer.itemSize, gl.FLOAT, false, 0, 0);

    setMatrixUniforms();
    gl.drawArrays(gl.TRIANGLES, 0, spitfireVertexPositionBuffer.numItems);
	}else{
    gl.bindBuffer(gl.ARRAY_BUFFER, spitfirecockpitVertexTextureCoordBuffer);
    gl.vertexAttribPointer(shaderProgram.textureCoordAttribute, spitfirecockpitVertexTextureCoordBuffer.itemSize, gl.FLOAT, false, 0, 0);

    gl.bindBuffer(gl.ARRAY_BUFFER, spitfirecockpitVertexPositionBuffer);
    gl.vertexAttribPointer(shaderProgram.vertexPositionAttribute, spitfirecockpitVertexPositionBuffer.itemSize, gl.FLOAT, false, 0, 0);

    setMatrixUniforms();
    gl.drawArrays(gl.TRIANGLES, 0, spitfirecockpitVertexPositionBuffer.numItems);
	}
   }else{
    gl.bindBuffer(gl.ARRAY_BUFFER, world2VertexTextureCoordBuffer);
    gl.vertexAttribPointer(shaderProgram.textureCoordAttribute, world2VertexTextureCoordBuffer.itemSize, gl.FLOAT, false, 0, 0);

    gl.bindBuffer(gl.ARRAY_BUFFER, world2VertexPositionBuffer);
    gl.vertexAttribPointer(shaderProgram.vertexPositionAttribute, world2VertexPositionBuffer.itemSize, gl.FLOAT, false, 0, 0);

    setMatrixUniforms();
    gl.drawArrays(gl.TRIANGLES, 0, world2VertexPositionBuffer.numItems);
   }   
	mvPopMatrix();
	if(tourelle>=2 && tshadow==0){drawcockpit();}

		mvPopMatrix();
    if(tshadow==1){gl.enable(gl.DEPTH_TEST);};

}
function drawzero(){
        mvPushMatrix();
    if(tshadow==0){  
	   if(tourelle==0){	
		mat4.identity(mvMatrix);
		mat4.translate(mvMatrix, [0.0, 0.21, -7.0]);
        mat4.rotate(mvMatrix, degtorad(-90), [0, 1, 0]);
        mat4.rotate(mvMatrix, degtorad(-sin2*24*cos2), [0, 0, 1]);
        mat4.rotate(mvMatrix, degtorad(sin3*24), [1, 0, 0]);
		planedo3=sin3*24;
	  }else{
		mat4.translate(mvMatrix, [x,y,z]);
        mat4.rotate(mvMatrix, degtorad(180+o1), [0, 0, 1]);
        mat4.rotate(mvMatrix, degtorad(90), [1, 0, 0]);
        mat4.rotate(mvMatrix, degtorad(-o2-sin2*4*cos2), [0, 0, 1]);
        //mat4.rotate(mvMatrix, degtorad(o3+sin3*7), [1, 0, 0]);
        mat4.rotate(mvMatrix, degtorad(o3), [1, 0, 0]);
		//planedo3=sin3*7*1.4;planedo2=-(sin2+2)*1.4*cos2;
		planedo3=sin3*7*1.1;planedo2=-(sin2+2)*1.1*cos2;
      }	  
	}else{
	    var dx=Math.sqrt(sunx*sunx+suny*suny+sunzz*sunzz);
		var dz=Math.max(0.0,z-zsol-3)*10;
		//var kz=distshadow*0.5;//*0.705
    	//mat4.translate(mvMatrix,[x-1.0*kz*sunx/dz,y-1.0*kz*suny/dz,z]);
    	//mat4.translate(mvMatrix,[x+0.25*(1+cos1)*kz-dz*sunx/dx,y+0.25*(1+sin1)*kz-dz*suny/dx,z]);
    	///mat4.translate(mvMatrix,[x+0.25*(1+0.5)*kz-dz*sunx/dx,y+0.25*(1+0.5)*kz-dz*suny/dx,z]);
    	mat4.translate(mvMatrix,[x-dz*sunx/dx,y-dz*suny/dx,z]);
		//mat4.rotate(mvMatrix, degtorad(180), [0, 0, 1]);
        mat4.rotate(mvMatrix, degtorad(180+o1), [0, 0, 1]);
        mat4.rotate(mvMatrix, degtorad(90), [1, 0, 0]);
        mat4.rotate(mvMatrix, degtorad(-o2), [0, 0, 1]);
        mat4.rotate(mvMatrix, degtorad(o3), [1, 0, 0]);
    }	
	if(tourelle==3 && tshadow==0){drawhelice();}
	mvPushMatrix();
	mat4.translate(mvMatrix, [0.31*cos2-0.60, -0.17, 0.0]);
    mat4.rotate(mvMatrix, degtorad(-90), [1, 0, 0]);
	gl.activeTexture(gl.TEXTURE4);
    if(tshadow==0){gl.bindTexture(gl.TEXTURE_2D,  zeroTexture);
		if(tourelle==0){mat4.scale(mvMatrix,[0.021,0.023,0.021]);}else{
		    var sc=0.0205;mat4.scale(mvMatrix,[sc,0.0185,sc]);}
	}else{
 		mat4.scale(mvMatrix,[0.03,0.03,0.03]);
                   gl.disable(gl.DEPTH_TEST);
	               gl.bindTexture(gl.TEXTURE_2D,  cloudTexture);}
    gl.uniform1i(shaderProgram.samplerUniform, 4);
    
   if(tshadow==0){
    if(tourelle==0 || Math.abs(to1)>100 || to2<-25){
    gl.bindBuffer(gl.ARRAY_BUFFER, zeroVertexTextureCoordBuffer);
    gl.vertexAttribPointer(shaderProgram.textureCoordAttribute, zeroVertexTextureCoordBuffer.itemSize, gl.FLOAT, false, 0, 0);

    gl.bindBuffer(gl.ARRAY_BUFFER, zeroVertexPositionBuffer);
    gl.vertexAttribPointer(shaderProgram.vertexPositionAttribute, zeroVertexPositionBuffer.itemSize, gl.FLOAT, false, 0, 0);

    setMatrixUniforms();
    gl.drawArrays(gl.TRIANGLES, 0, zeroVertexPositionBuffer.numItems);
	}else{
    gl.bindBuffer(gl.ARRAY_BUFFER, zerocockpitVertexTextureCoordBuffer);
    gl.vertexAttribPointer(shaderProgram.textureCoordAttribute, zerocockpitVertexTextureCoordBuffer.itemSize, gl.FLOAT, false, 0, 0);

    gl.bindBuffer(gl.ARRAY_BUFFER, zerocockpitVertexPositionBuffer);
    gl.vertexAttribPointer(shaderProgram.vertexPositionAttribute, zerocockpitVertexPositionBuffer.itemSize, gl.FLOAT, false, 0, 0);

    setMatrixUniforms();
    gl.drawArrays(gl.TRIANGLES, 0, zerocockpitVertexPositionBuffer.numItems);
	}
   }else{
    gl.bindBuffer(gl.ARRAY_BUFFER, world2VertexTextureCoordBuffer);
    gl.vertexAttribPointer(shaderProgram.textureCoordAttribute, world2VertexTextureCoordBuffer.itemSize, gl.FLOAT, false, 0, 0);

    gl.bindBuffer(gl.ARRAY_BUFFER, world2VertexPositionBuffer);
    gl.vertexAttribPointer(shaderProgram.vertexPositionAttribute, world2VertexPositionBuffer.itemSize, gl.FLOAT, false, 0, 0);

    setMatrixUniforms();
    gl.drawArrays(gl.TRIANGLES, 0, world2VertexPositionBuffer.numItems);
   }   
	mvPopMatrix();
	if(tourelle>=2 && tshadow==0){drawcockpit();}

		mvPopMatrix();
    if(tshadow==1){gl.enable(gl.DEPTH_TEST);};

}
function drawcorsair(){
        mvPushMatrix();
    if(tshadow==0){  
	   if(tourelle==0){	
		mat4.identity(mvMatrix);
		mat4.translate(mvMatrix, [0.0, 0.34, -7.0]);
        mat4.rotate(mvMatrix, degtorad(-90), [0, 1, 0]);
        mat4.rotate(mvMatrix, degtorad(-sin2*24*cos2), [0, 0, 1]);
        mat4.rotate(mvMatrix, degtorad(sin3*24), [1, 0, 0]);
		planedo3=sin3*24;
	  }else{
		mat4.translate(mvMatrix, [x,y,z]);
        mat4.rotate(mvMatrix, degtorad(180+o1), [0, 0, 1]);
        mat4.rotate(mvMatrix, degtorad(90), [1, 0, 0]);
        mat4.rotate(mvMatrix, degtorad(-o2-sin2*4*cos2), [0, 0, 1]);
        //mat4.rotate(mvMatrix, degtorad(o3+sin3*7), [1, 0, 0]);
        mat4.rotate(mvMatrix, degtorad(o3), [1, 0, 0]);
		//planedo3=sin3*7*1.4;planedo2=-(sin2+2)*1.4*cos2;
		planedo3=sin3*7*1.05;planedo2=-(sin2+2)*1.05*cos2;
      }	  
	}else{
	    var dx=Math.sqrt(sunx*sunx+suny*suny+sunzz*sunzz);
		var dz=Math.max(0.0,z-zsol-3)*10;
		//var kz=distshadow*0.5;//*0.705
    	//mat4.translate(mvMatrix,[x-1.0*kz*sunx/dz,y-1.0*kz*suny/dz,z]);
    	//mat4.translate(mvMatrix,[x+0.25*(1+cos1)*kz-dz*sunx/dx,y+0.25*(1+sin1)*kz-dz*suny/dx,z]);
    	///mat4.translate(mvMatrix,[x+0.25*(1+0.5)*kz-dz*sunx/dx,y+0.25*(1+0.5)*kz-dz*suny/dx,z]);
    	mat4.translate(mvMatrix,[x-dz*sunx/dx,y-dz*suny/dx,z]);
		//mat4.rotate(mvMatrix, degtorad(180), [0, 0, 1]);
        mat4.rotate(mvMatrix, degtorad(180+o1), [0, 0, 1]);
        mat4.rotate(mvMatrix, degtorad(90), [1, 0, 0]);
        mat4.rotate(mvMatrix, degtorad(-o2), [0, 0, 1]);
        mat4.rotate(mvMatrix, degtorad(o3), [1, 0, 0]);
    }	
	if(tourelle==3 && tshadow==0){drawhelice();}
	mvPushMatrix();
	mat4.translate(mvMatrix, [0.3*cos2-1.03, -0.18, 0.0]);
    mat4.rotate(mvMatrix, degtorad(-90), [1, 0, 0]);
	gl.activeTexture(gl.TEXTURE4);
    if(tshadow==0){gl.bindTexture(gl.TEXTURE_2D,  corsairTexture);
		if(tourelle==0){mat4.scale(mvMatrix,[0.020,0.0249,0.020]);}else{
		    var sc=0.020;mat4.scale(mvMatrix,[sc,0.019,0.019]);}
	}else{
 		mat4.scale(mvMatrix,[0.03,0.03,0.03]);
                   gl.disable(gl.DEPTH_TEST);
	               gl.bindTexture(gl.TEXTURE_2D,  cloudTexture);}
    gl.uniform1i(shaderProgram.samplerUniform, 4);
    
   if(tshadow==0){
    if(true){//tourelle==0 || Math.abs(to1)>100 || to2<-25){
    gl.bindBuffer(gl.ARRAY_BUFFER, corsairVertexTextureCoordBuffer);
    gl.vertexAttribPointer(shaderProgram.textureCoordAttribute, corsairVertexTextureCoordBuffer.itemSize, gl.FLOAT, false, 0, 0);

    gl.bindBuffer(gl.ARRAY_BUFFER, corsairVertexPositionBuffer);
    gl.vertexAttribPointer(shaderProgram.vertexPositionAttribute, corsairVertexPositionBuffer.itemSize, gl.FLOAT, false, 0, 0);

    setMatrixUniforms();
    gl.drawArrays(gl.TRIANGLES, 0, corsairVertexPositionBuffer.numItems);
	}else{
    gl.bindBuffer(gl.ARRAY_BUFFER, corsaircockpitVertexTextureCoordBuffer);
    gl.vertexAttribPointer(shaderProgram.textureCoordAttribute, corsaircockpitVertexTextureCoordBuffer.itemSize, gl.FLOAT, false, 0, 0);

    gl.bindBuffer(gl.ARRAY_BUFFER, corsaircockpitVertexPositionBuffer);
    gl.vertexAttribPointer(shaderProgram.vertexPositionAttribute, corsaircockpitVertexPositionBuffer.itemSize, gl.FLOAT, false, 0, 0);

    setMatrixUniforms();
    gl.drawArrays(gl.TRIANGLES, 0, corsaircockpitVertexPositionBuffer.numItems);
	}
   }else{
    gl.bindBuffer(gl.ARRAY_BUFFER, world2VertexTextureCoordBuffer);
    gl.vertexAttribPointer(shaderProgram.textureCoordAttribute, world2VertexTextureCoordBuffer.itemSize, gl.FLOAT, false, 0, 0);

    gl.bindBuffer(gl.ARRAY_BUFFER, world2VertexPositionBuffer);
    gl.vertexAttribPointer(shaderProgram.vertexPositionAttribute, world2VertexPositionBuffer.itemSize, gl.FLOAT, false, 0, 0);

    setMatrixUniforms();
    gl.drawArrays(gl.TRIANGLES, 0, world2VertexPositionBuffer.numItems);
   }   
	mvPopMatrix();
	if(tourelle>=2 && tshadow==0){drawcockpit();}

		mvPopMatrix();
    if(tshadow==1){gl.enable(gl.DEPTH_TEST);};

}
var tradarplane2=0,o1radarplane2=0,dxradarplane2=0;
function drawplane2(){
        mvPushMatrix();
	if(tshadow==0){	
        var dxplane2=Math.abs(x-px),dyplane2=Math.abs(y-py);
		dxradarplane2=Math.sqrt(dxplane2*dxplane2+dyplane2*dyplane2);
		dxradarplane2=radardist(dxradarplane2);
		if(dxradarplane2*0.015>5.4){mvPopMatrix();return;}
		o1radarplane2=diro1(px-x,py-y);
		if(Math.cos(degtorad(o1radarplane2-o1-o3radar-30+90))>0.8){
		   tradarplane2=tframe;
		}
        if(rotavion(px-x,py-y,pz-z,5)==0){mvPopMatrix();return;}
		//mat4.identity(mvMatrix);
		//mat4.rotate(mvMatrix,degtorad(-o1),[0,0,1]);
		mat4.translate(mvMatrix, [px,py,pz]);
        mat4.rotate(mvMatrix, degtorad(180+po1), [0, 0, 1]);
        mat4.rotate(mvMatrix, degtorad(90), [1, 0, 0]);
        mat4.rotate(mvMatrix, degtorad(-po2), [0, 0, 1]);
        mat4.rotate(mvMatrix, degtorad(po3), [1, 0, 0]);
	}else{
	    var dx=Math.sqrt(sunx*sunx+suny*suny+sunzz*sunzz);
		var dz=Math.max(0.0,pz-zsol-3)*10;
		var kz=distshadow*0.5;//*0.705;
    	mat4.translate(mvMatrix,[px+0.25*(1+0.5)*kz-dz*sunx/dx,py+0.25*(1+0.5)*kz-dz*suny/dx,pz]);
    	//mat4.translate(mvMatrix,[px,py,pz]);
		//mat4.rotate(mvMatrix, degtorad(180), [0, 0, 1]);
        mat4.rotate(mvMatrix, degtorad(180+po1), [0, 0, 1]);
        mat4.rotate(mvMatrix, degtorad(90), [1, 0, 0]);
        mat4.rotate(mvMatrix, degtorad(-po2), [0, 0, 1]);
        mat4.rotate(mvMatrix, degtorad(po3), [1, 0, 0]);
    }	
	gl.activeTexture(gl.TEXTURE0);
    if(tshadow==0){gl.bindTexture(gl.TEXTURE_2D,  objTexture2);
		mat4.scale(mvMatrix,[0.02,0.02,0.02]);
	}else{
 		mat4.scale(mvMatrix,[0.03,0.03,0.03]);
                   gl.disable(gl.DEPTH_TEST);
	               gl.bindTexture(gl.TEXTURE_2D,  cloudTexture);}
    gl.uniform1i(shaderProgram.samplerUniform, 0);
    
   if(tshadow==0){	
    gl.bindBuffer(gl.ARRAY_BUFFER, worldVertexTextureCoordBuffer);
    gl.vertexAttribPointer(shaderProgram.textureCoordAttribute, worldVertexTextureCoordBuffer.itemSize, gl.FLOAT, false, 0, 0);

    gl.bindBuffer(gl.ARRAY_BUFFER, worldVertexPositionBuffer);
    gl.vertexAttribPointer(shaderProgram.vertexPositionAttribute, worldVertexPositionBuffer.itemSize, gl.FLOAT, false, 0, 0);
    
    setMatrixUniforms(); 
    gl.drawArrays(gl.TRIANGLES, 0, worldVertexPositionBuffer.numItems);
   }else{
    gl.bindBuffer(gl.ARRAY_BUFFER, world2VertexTextureCoordBuffer);
    gl.vertexAttribPointer(shaderProgram.textureCoordAttribute, world2VertexTextureCoordBuffer.itemSize, gl.FLOAT, false, 0, 0);

    gl.bindBuffer(gl.ARRAY_BUFFER, world2VertexPositionBuffer);
    gl.vertexAttribPointer(shaderProgram.vertexPositionAttribute, world2VertexPositionBuffer.itemSize, gl.FLOAT, false, 0, 0);

    setMatrixUniforms();
    gl.drawArrays(gl.TRIANGLES, 0, world2VertexPositionBuffer.numItems);
   }   
		
		mvPopMatrix();
    if(tshadow==1){gl.enable(gl.DEPTH_TEST);};
}
var tradarplane3=0,o1radarplane3=0,dxradarplane3=0;
function drawplane3(){
        mvPushMatrix();
	if(tshadow==0){	
        var dxplane3=Math.abs(x-p3x),dyplane3=Math.abs(y-p3y);
		dxradarplane3=Math.sqrt(dxplane3*dxplane3+dyplane3*dyplane3);
		dxradarplane3=radardist(dxradarplane3);
		if(dxradarplane3*0.015>5.4){mvPopMatrix();return;}
		o1radarplane3=diro1(p3x-x,p3y-y);
		if(Math.cos(degtorad(o1radarplane3-o1-o3radar-30+90))>0.8){
		   tradarplane3=tframe;
		}
		if(rotavion(p3x-x,p3y-y,p3z-z,5)==0){mvPopMatrix();return;}
        //mat4.identity(mvMatrix);
		//mat4.rotate(mvMatrix,degtorad(-o1),[0,0,1]);
		mat4.translate(mvMatrix, [p3x,p3y,p3z]);
        mat4.rotate(mvMatrix, degtorad(180+p3o1), [0, 0, 1]);
        mat4.rotate(mvMatrix, degtorad(90), [1, 0, 0]);
        mat4.rotate(mvMatrix, degtorad(-p3o2), [0, 0, 1]);
        mat4.rotate(mvMatrix, degtorad(p3o3), [1, 0, 0]);
	}else{
	    var dx=Math.sqrt(sunx*sunx+suny*suny+sunzz*sunzz);
		var dz=Math.max(0.0,p3z-zsol-3)*10;
		var kz=distshadow*0.5;//*0.705;
    	mat4.translate(mvMatrix,[p3x+0.25*(1+0.5)*kz-dz*sunx/dx,p3y+0.25*(1+0.5)*kz-dz*suny/dx,p3z]);
    	//mat4.translate(mvMatrix,[p3x,p3y,p3z]);
		//mat4.rotate(mvMatrix, degtorad(180), [0, 0, 1]);
        mat4.rotate(mvMatrix, degtorad(180+p3o1), [0, 0, 1]);
        mat4.rotate(mvMatrix, degtorad(90), [1, 0, 0]);
        mat4.rotate(mvMatrix, degtorad(-p3o2), [0, 0, 1]);
        mat4.rotate(mvMatrix, degtorad(p3o3), [1, 0, 0]);
    }	
	gl.activeTexture(gl.TEXTURE0);
    if(tshadow==0){gl.bindTexture(gl.TEXTURE_2D,  objTexture);
		mat4.scale(mvMatrix,[0.02,0.02,0.02]);
	}else{
 		mat4.scale(mvMatrix,[0.03,0.03,0.03]);
                   gl.disable(gl.DEPTH_TEST);
	               gl.bindTexture(gl.TEXTURE_2D,  cloudTexture);}
    gl.uniform1i(shaderProgram.samplerUniform, 0);
    
   if(tshadow==0){	
    gl.bindBuffer(gl.ARRAY_BUFFER, worldVertexTextureCoordBuffer);
    gl.vertexAttribPointer(shaderProgram.textureCoordAttribute, worldVertexTextureCoordBuffer.itemSize, gl.FLOAT, false, 0, 0);

    gl.bindBuffer(gl.ARRAY_BUFFER, worldVertexPositionBuffer);
    gl.vertexAttribPointer(shaderProgram.vertexPositionAttribute, worldVertexPositionBuffer.itemSize, gl.FLOAT, false, 0, 0);
    
    colorb=0.05;
    setMatrixUniforms(); 
	colorb=1;
    gl.drawArrays(gl.TRIANGLES, 0, worldVertexPositionBuffer.numItems);
   }else{
    gl.bindBuffer(gl.ARRAY_BUFFER, world2VertexTextureCoordBuffer);
    gl.vertexAttribPointer(shaderProgram.textureCoordAttribute, world2VertexTextureCoordBuffer.itemSize, gl.FLOAT, false, 0, 0);

    gl.bindBuffer(gl.ARRAY_BUFFER, world2VertexPositionBuffer);
    gl.vertexAttribPointer(shaderProgram.vertexPositionAttribute, world2VertexPositionBuffer.itemSize, gl.FLOAT, false, 0, 0);

	setMatrixUniforms();
	gl.drawArrays(gl.TRIANGLES, 0, world2VertexPositionBuffer.numItems);
   }   
		
		mvPopMatrix();
    if(tshadow==1){gl.enable(gl.DEPTH_TEST);};
}

var tpiste=0,tradarpiste=0,o1radarpiste=0,dxradarpiste=0;
function radardist(dx){return 1000*dx/(1000+dx);}
function drawpiste(){
    var dxpiste=Math.abs(x-pistex),dypiste=Math.abs(y-pistey);
	var dxmax=distmap2;
		dxradarpiste=Math.sqrt(dxpiste*dxpiste+dypiste*dypiste);
		dxradarpiste=radardist(dxradarpiste);
		if(dxradarpiste*0.015>5.4){return;}
		o1radarpiste=diro1(pistex-x,pistey-y);
		if(Math.cos(degtorad(o1radarpiste-o1-o3radar-30+90))>0.8){
		   tradarpiste=tframe;
		}
        if(dxpiste>dxmax){return;}
        if(dypiste>dxmax){return;}
		tpiste=0;
		if(x>(pistex+45.5-98) && x<(pistex+45.5) && tfoot==0){
       	  if(dypiste<7){tpiste=1;if(vplane<0.002 && vie<50){vie+=dtime*0.003};};}
        mvPushMatrix();
        //mat4.identity(mvMatrix);
		//mat4.rotate(mvMatrix,degtorad(-o1),[0,0,1]);
		/*mat4.translate(mvMatrix, [px,py,pz]);
        mat4.rotate(mvMatrix, degtorad(180+po1), [0, 0, 1]);
        mat4.rotate(mvMatrix, degtorad(90), [1, 0, 0]);
        mat4.rotate(mvMatrix, degtorad(-po2), [0, 0, 1]);
        mat4.rotate(mvMatrix, degtorad(po3), [1, 0, 0]);
		mat4.scale(mvMatrix,[0.02,0.02,0.02]);*/
	gl.activeTexture(gl.TEXTURE0);
    gl.bindTexture(gl.TEXTURE_2D,  pisteTexture);
    gl.uniform1i(solProgram.samplerUniform, 0);
    
    gl.bindBuffer(gl.ARRAY_BUFFER, pisteVertexTextureCoordBuffer);
    gl.vertexAttribPointer(solProgram.textureCoordAttribute, pisteVertexTextureCoordBuffer.itemSize, gl.FLOAT, false, 0, 0);

    gl.bindBuffer(gl.ARRAY_BUFFER, pisteVertexPositionBuffer);
    gl.vertexAttribPointer(solProgram.vertexPositionAttribute, pisteVertexPositionBuffer.itemSize, gl.FLOAT, false, 0, 0);
    
    setMatrixUniformspiste(); 
    gl.drawArrays(gl.TRIANGLES, 0, pisteVertexPositionBuffer.numItems);
		
		mvPopMatrix();
}
var horizonx=0,horizony=0,horizonz=0;
function drawhorizon(){
        mvPushMatrix();
		//mat4.translate(mvMatrix, [horizonx,horizony,horizonz]);
	gl.activeTexture(gl.TEXTURE0);
    gl.bindTexture(gl.TEXTURE_2D,  solTexture);
	gl.uniform1i(solProgram.samplerUniform, 0);

    gl.bindBuffer(gl.ARRAY_BUFFER, horizonVertexTextureCoordBuffer);
    gl.vertexAttribPointer(solProgram.textureCoordAttribute, horizonVertexTextureCoordBuffer.itemSize, gl.FLOAT, false, 0, 0);

    gl.bindBuffer(gl.ARRAY_BUFFER, horizonVertexPositionBuffer);
    gl.vertexAttribPointer(solProgram.vertexPositionAttribute, horizonVertexPositionBuffer.itemSize, gl.FLOAT, false, 0, 0);
    
    setMatrixUniformssea(); 
    gl.drawArrays(gl.TRIANGLES, 0, horizonVertexPositionBuffer.numItems);
		
		mvPopMatrix();
}
var tradarwater=0,o1radarwater=0,dxradarwater=0;
var seax=0,seay=0,seaz=0;
function drawsea(){
        mvPushMatrix();
		//mat4.translate(mvMatrix, [seax,seay,seaz]);
	gl.activeTexture(gl.TEXTURE0);
    if(tsea<=1){gl.bindTexture(gl.TEXTURE_2D,  waterTexture);
    }else{gl.bindTexture(gl.TEXTURE_2D,  seaTexture);}
	gl.uniform1i(solProgram.samplerUniform, 0);

    gl.bindBuffer(gl.ARRAY_BUFFER, seaVertexTextureCoordBuffer);
    gl.vertexAttribPointer(solProgram.textureCoordAttribute, seaVertexTextureCoordBuffer.itemSize, gl.FLOAT, false, 0, 0);

    gl.bindBuffer(gl.ARRAY_BUFFER, seaVertexPositionBuffer);
    gl.vertexAttribPointer(solProgram.vertexPositionAttribute, seaVertexPositionBuffer.itemSize, gl.FLOAT, false, 0, 0);
    
    setMatrixUniformssea(); 
    gl.drawArrays(gl.TRIANGLES, 0, seaVertexPositionBuffer.numItems);
		
		mvPopMatrix();
}
function drawwater(){
        var waterxx=waterx-x,wateryy=watery-y;x-(xmax-xmin)/2;
		if(waterxx<-(xmax-xmin)/2){waterxx+=xmax-xmin;}
		if(waterxx>(xmax-xmin)/2){waterxx-=xmax-xmin;}
		if(wateryy<-(ymax-ymin)/2){wateryy+=ymax-ymin;}
		if(wateryy>(ymax-ymin)/2){wateryy-=ymax-ymin;}
    //var dxwater=Math.abs(x-waterx),dywater=Math.abs(y-watery);
      var dxwater=shipx-x,dywater=shipy-y;		
		dxradarwater=Math.sqrt(dxwater*dxwater+dywater*dywater);
		dxradarwater=radardist(dxradarwater);
		if(dxradarwater*0.015>5.4){return;}
		o1radarwater=diro1(dxwater,dywater);
		if(Math.cos(degtorad(o1radarwater-o1-o3radar-30+90))>0.8){
		   tradarwater=tframe;
		}
        if(Math.abs(waterxx)>(-80+distmap2)){return;}
        if(Math.abs(wateryy)>(-80+distmap2)){return;}
        mvPushMatrix();
	gl.activeTexture(gl.TEXTURE0);
    if(tsea<2){gl.bindTexture(gl.TEXTURE_2D,  waterTexture);
    }else{gl.bindTexture(gl.TEXTURE_2D,  seaTexture);}
	gl.uniform1i(solProgram.samplerUniform, 0);
    
    gl.bindBuffer(gl.ARRAY_BUFFER, waterVertexTextureCoordBuffer);
    gl.vertexAttribPointer(solProgram.textureCoordAttribute, waterVertexTextureCoordBuffer.itemSize, gl.FLOAT, false, 0, 0);

    gl.bindBuffer(gl.ARRAY_BUFFER, waterVertexPositionBuffer);
    gl.vertexAttribPointer(solProgram.vertexPositionAttribute, waterVertexPositionBuffer.itemSize, gl.FLOAT, false, 0, 0);
    
    setMatrixUniformspiste(); 
    gl.drawArrays(gl.TRIANGLES, 0, waterVertexPositionBuffer.numItems);

	mvPopMatrix();
}
var shipx=waterx,shipy=watery+(Math.random()-0.5)*50,shipz=0;
var shipo1=Math.random()*80,shipco1=1,shipsi1=0;
var tshipo1=0,tshipo2=0,tshiptir=0,shipvie=100;
function tirship(){
var v=(2.92)*(1+(Math.random()-0.5)*0.2);
var vx=v*Math.cos(degtorad(tshipo1))*Math.cos(degtorad(tshipo2));
var vy=v*Math.sin(degtorad(tshipo1))*Math.cos(degtorad(tshipo2));
var vz=v*Math.sin(degtorad(tshipo2));
addtir(shipx,shipy,shipz+3,vx,vy,vz,1);
}
function drawship(){
    if(shipvie<100){shipvie+=Math.random()*dtime*0.0004;};
	if(shipvie<-100){shipvie=-99;}
	shipco1=Math.cos(degtorad(shipo1));
	shipsi1=Math.sin(degtorad(shipo1));
    shipx+=dtime*0.0015*shipco1;
    shipy+=dtime*0.0015*shipsi1;
	var distship2=((shipx-waterx)*(shipx-waterx)+(shipy-watery)*(shipy-watery));
	if(distship2>95*95){
	  var do1=shipo1-diro1(waterx-shipx,watery-shipy);
	  while(do1<-180){do1+=360;};
	  while(do1>180){do1-=360;};
	  if(Math.abs(do1)>35){shipo1+=0.02*dtime*(1+Math.random());};
	}
	    var dx=x-shipx,dy=y-shipy;
        if(Math.abs(dx)>(distmap2)){return;}
        if(Math.abs(dy)>(distmap2)){return;}
     	if(shipvie<0 && Math.random()<dtime*0.0025){addsmoke(shipx,shipy,shipz+1.4,3.5,1);}
		if(tframe<tattack2+120000){
		   var distxy=Math.sqrt(dx*dx+dy*dy);
		   dx+=vplane*cos1*distxy/80;dy+=vplane*sin1*distxy/80;
		   var do1=tshipo1-diro1(dx,dy)+(Math.random()-0.5)*5;
		   var do2=tshipo2-diro1(distxy,z-(shipz+3))+(Math.random()-0.5)*5;
		   do1+=dirtir*3;
		   while(do1<-180){do1+=360;};
	       while(do1>180){do1-=360;};
		   while(do2<-180){do2+=360;};
	       while(do2>180){do2-=360;};
		   var v=1+Math.random()*0.5;
		   if(do1>0){tshipo1-=dtime*0.03*v;}else{tshipo1+=dtime*0.03*v;}
		   if(do2>0){tshipo2-=dtime*0.03*v;}else{tshipo2+=dtime*0.03*v;}
		   if(tshipo2>80){tshipo2=80;}
		   if(tshipo2<-80){tshipo2=-80;}
		   if(tframe>(tshiptir+500) && distxy<240){tshiptir=tframe;
		          if(Math.abs(do1)<40 && Math.abs(do2)<40){tirship();};};
		}
		if(rotavion(shipx-x,shipy-y,shipz-z,12)){
		mvPushMatrix();
		mat4.translate(mvMatrix, [shipx,shipy,shipz]);
        mat4.rotate(mvMatrix, degtorad(shipo1), [0, 0, 1]);
		mat4.scale(mvMatrix,[0.065,0.065,0.065]);
 	gl.activeTexture(gl.TEXTURE0);
    gl.bindTexture(gl.TEXTURE_2D,  shipTexture);
    gl.uniform1i(shaderProgram.samplerUniform, 0);
    
    gl.bindBuffer(gl.ARRAY_BUFFER, shipVertexTextureCoordBuffer);
    gl.vertexAttribPointer(shaderProgram.textureCoordAttribute, shipVertexTextureCoordBuffer.itemSize, gl.FLOAT, false, 0, 0);

    gl.bindBuffer(gl.ARRAY_BUFFER, shipVertexPositionBuffer);
    gl.vertexAttribPointer(shaderProgram.vertexPositionAttribute, shipVertexPositionBuffer.itemSize, gl.FLOAT, false, 0, 0);
    
    setMatrixUniforms(); 
    gl.drawArrays(gl.TRIANGLES, 0, shipVertexPositionBuffer.numItems);
		
		mvPopMatrix();
	}
}
var shipcarrierx=(Math.random())*1000;
var shipcarriery=0.7*ymax+Math.random()*300,shipcarrierz=0;
var shipcarriero1=Math.random()*40-20,shipcarrierco1=1,shipcarriersi1=0;
var tshipcarriero1=0,tshipcarriero2=0,tshipcarriertir=0,shipcarriervie=100;
function tirshipcarrier(){
var v=(2.2)*(1+(Math.random()-0.5)*0.2);
var vx=v*Math.cos(degtorad(tshipcarriero1))*Math.cos(degtorad(tshipcarriero2));
var vy=v*Math.sin(degtorad(tshipcarriero1))*Math.cos(degtorad(tshipcarriero2));
var vz=v*Math.sin(degtorad(tshipcarriero2));
addtir(shipcarrierx,shipcarriery,shipcarrierz+3,vx,vy,vz,1);
}
var tcarrier=0,tradarcarrier=0,o1radarcarrier=0,dxradarcarrier=0;
function resetcarrier(){
  shipcarrierco1=Math.cos(degtorad(shipcarriero1));
  shipcarriersi1=Math.sin(degtorad(shipcarriero1));
  for(var i=0;i<250;i++){
	if(getterrainheight(shipcarrierx+20*shipcarrierco1-9*shipcarriersi1,shipcarriery+20*shipcarriersi1+9*shipcarrierco1)<0){break;}
	if(getterrainheight(shipcarrierx+20*shipcarrierco1+9*shipcarriersi1,shipcarriery+20*shipcarriersi1-9*shipcarrierco1)<0){break;}     
    shipcarrierx+=40*shipcarrierco1;
	shipcarriery+=40*shipcarriersi1;
	if(shipcarrierx>xmax-200){shipcarrierx-=(xmax-xmin-400);}
	if(shipcarrierx<xmin+200){shipcarrierx+=(xmax-xmin-400);}
	if(shipcarriery>ymax-200){shipcarriery-=(ymax-ymin-400);}
	if(shipcarriery<ymin+200){shipcarriery+=(ymax-ymin-400);}
  }
}
function moveshipcarrier(){
    if(shipcarriervie<100){shipcarriervie+=Math.random()*dtime*0.0004;};
    if(shipcarriervie<-100){shipcarriervie=-99;}
	shipcarrierco1=Math.cos(degtorad(shipcarriero1));
	shipcarriersi1=Math.sin(degtorad(shipcarriero1));
    shipcarrierx+=dtime*0.0015*shipcarrierco1;
    shipcarriery+=dtime*0.0015*shipcarriersi1;
	if(landing==0){tcarrier=0;}
	if(tcarrier==1){
      x+=dtime*0.0015*shipcarrierco1;
      y+=dtime*0.0015*shipcarriersi1;
	}
    var do1=0;
	var dh1=getterrainheight(shipcarrierx+20*shipcarrierco1-9*shipcarriersi1,shipcarriery+20*shipcarriersi1+9*shipcarrierco1);
    var dh2=getterrainheight(shipcarrierx+20*shipcarrierco1+9*shipcarriersi1,shipcarriery+20*shipcarriersi1-9*shipcarrierco1);
	if(dh1>0){
	  do1=-0.01*dtime*(1+Math.random());
    }else{
	  if(dh2>0){do1=0.01*dtime*(1+Math.random());}
    }
    if(shipcarrierx<(xmin+200) || shipcarrierx>(xmax-200)){do1=-0.01*dtime*(1+Math.random());}
    if(shipcarriery<(ymin+200) || shipcarriery>(ymax-200)){do1=-0.01*dtime*(1+Math.random());}
	if(Math.abs(do1)>0.0001){
	  shipcarriero1+=do1;
	  if(tcarrier==1){o1+=do1;var si1=Math.sin(degtorad(do1));
	                  var dx=x-shipcarrierx,dy=y-shipcarriery;
		              x+=-dy*si1;y+=dx*si1;}
	}
	tcarrier=0;
}
function drawshipcarrier(){
    var dxcarrier=shipcarrierx-x,dycarrier=shipcarriery-y;		
	dxradarcarrier=Math.sqrt(dxcarrier*dxcarrier+dycarrier*dycarrier);
	dxradarcarrier=radardist(dxradarcarrier);
	if(dxradarcarrier*0.015>5.4){return;}
	o1radarcarrier=diro1(dxcarrier,dycarrier);
	if(Math.cos(degtorad(o1radarcarrier-o1-o3radar-30+90))>0.8){
	   tradarcarrier=tframe;
	}
	    var dx=x-shipcarrierx,dy=y-shipcarriery;
        if(Math.abs(dx)>(distmap2)){return;}
        if(Math.abs(dy)>(distmap2)){return;}
     	if(shipcarriervie<0 && Math.random()<dtime*0.0025){addsmoke(shipcarrierx,shipcarriery,shipcarrierz+1.4,3.5,1);}
		if(tframe<tattack3+120000){
		   var distxy=Math.sqrt(dx*dx+dy*dy);
		   dx+=vplane*cos1*distxy/80;dy+=vplane*sin1*distxy/80;
		   var do1=tshipcarriero1-diro1(dx,dy)+(Math.random()-0.5)*5;
		   var do2=tshipcarriero2-diro1(distxy,z-(shipcarrierz+3))+(Math.random()-0.5)*5;
		   while(do1<-180){do1+=360;};
	       while(do1>180){do1-=360;};
		   while(do2<-180){do2+=360;};
	       while(do2>180){do2-=360;};
		   var v=1+Math.random()*0.5;
		   if(do1>0){tshipcarriero1-=dtime*0.03*v;}else{tshipcarriero1+=dtime*0.03*v;}
		   if(do2>0){tshipcarriero2-=dtime*0.03*v;}else{tshipcarriero2+=dtime*0.03*v;}
		   if(tshipcarriero2>80){tshipcarriero2=80;}
		   if(tshipcarriero2<-80){tshipcarriero2=-80;}
		   if(tframe>(tshipcarriertir+500) && distxy<240){tshipcarriertir=tframe;
		          if(Math.abs(do1)<40 && Math.abs(do2)<40){tirshipcarrier();};};
		}
		if(rotavion(shipcarrierx-x,shipcarriery-y,shipcarrierz-z,28)){
		mvPushMatrix();
		mat4.translate(mvMatrix, [shipcarrierx,shipcarriery,shipcarrierz]);
        mat4.rotate(mvMatrix, degtorad(shipcarriero1), [0, 0, 1]);
		mat4.translate(mvMatrix, [0,1,0]);
		mat4.scale(mvMatrix,[0.17,0.17,0.17]);
 	gl.activeTexture(gl.TEXTURE0);
    gl.bindTexture(gl.TEXTURE_2D,  shipcarrierTexture);
    gl.uniform1i(shaderProgram.samplerUniform, 0);
    
    gl.bindBuffer(gl.ARRAY_BUFFER, shipcarrierVertexTextureCoordBuffer);
    gl.vertexAttribPointer(shaderProgram.textureCoordAttribute, shipcarrierVertexTextureCoordBuffer.itemSize, gl.FLOAT, false, 0, 0);

    gl.bindBuffer(gl.ARRAY_BUFFER, shipcarrierVertexPositionBuffer);
    gl.vertexAttribPointer(shaderProgram.vertexPositionAttribute, shipcarrierVertexPositionBuffer.itemSize, gl.FLOAT, false, 0, 0);
    
    setMatrixUniforms(); 
    gl.drawArrays(gl.TRIANGLES, 0, shipcarrierVertexPositionBuffer.numItems);
		
		mvPopMatrix();
	}	
}
var nsailship=5;
var psailshipx=new Array(nsailship);
var psailshipy=new Array(nsailship),psailshipz=new Array(nsailship);
var psailshipo1=new Array(nsailship),psailshipco1=new Array(nsailship),psailshipsi1=new Array(nsailship);
var tpsailshipo1=new Array(nsailship),psailshipvie=new Array(nsailship);
function getpsailship(i){
   sailshipx=psailshipx[i]; 
   sailshipy=psailshipy[i]; 
   sailshipz=psailshipz[i]; 
   sailshipo1=psailshipo1[i]; 
   sailshipco1=psailshipco1[i]; 
   sailshipsi1=psailshipsi1[i]; 
   tsailshipo1=tpsailshipo1[i]; 
   sailshipvie=psailshipvie[i];
}	 
function setpsailship(i){
   psailshipx[i]=sailshipx; 
   psailshipy[i]=sailshipy; 
   psailshipz[i]=sailshipz; 
   psailshipo1[i]=sailshipo1; 
   psailshipco1[i]=sailshipco1; 
   psailshipsi1[i]=sailshipsi1; 
   tpsailshipo1[i]=tsailshipo1; 
   psailshipvie[i]=sailshipvie;
}
function resetsailships(){
  for(var i=0;i<nsailship;i++){
     getpsailship(i);
	 resetsailship();
	 setpsailship(i);}
}
function movesailships(){
  for(var i=0;i<nsailship;i++){
	 getpsailship(i);
	 movesailship();
	 setpsailship(i);}
}
function drawsailships(){
  for(var i=0;i<nsailship;i++){
	 getpsailship(i);
	 movesailship();
	 drawsailship();
	 setpsailship(i);}
}
var sailshipx=(Math.random())*1000;
var sailshipy=0.7*ymax+Math.random()*300,sailshipz=0;
var sailshipo1=Math.random()*40-20,sailshipco1=1,sailshipsi1=0;
var tsailshipo1=0,sailshipvie=100;
for(var i=0;i<nsailship;i++){
    sailshipx+=50*Math.random();
	sailshipy+=50*Math.random();setpsailship(i);}
function resetsailship(){
  if(Math.abs(sailshipx-x)>300){sailshipx=x+100*Math.random();}
  if(Math.abs(sailshipy-y)>300){sailshipy=y+100*Math.random();}
  sailshipco1=Math.cos(degtorad(sailshipo1));
  sailshipsi1=Math.sin(degtorad(sailshipo1));
  for(var i=0;i<250;i++){
	if(getterrainheight(sailshipx+10*sailshipco1-5*sailshipsi1,sailshipy+10*sailshipsi1+5*sailshipco1)<0){break;}
	if(getterrainheight(sailshipx+10*sailshipco1+5*sailshipsi1,sailshipy+10*sailshipsi1-5*sailshipco1)<0){break;}     
    sailshipx+=40*sailshipco1;
	sailshipy+=40*sailshipsi1;
	if(sailshipx>xmax-200){sailshipx-=(xmax-xmin-400);}
	if(sailshipx<xmin+200){sailshipx+=(xmax-xmin-400);}
	if(sailshipy>ymax-200){sailshipy-=(ymax-ymin-400);}
	if(sailshipy<ymin+200){sailshipy+=(ymax-ymin-400);}
  }
}
function movesailship(){
    if(sailshipvie<100){sailshipvie+=Math.random()*dtime*0.0004;};
    if(sailshipvie<-100){sailshipvie=-99;}
	var distmax=700;
	var dx0=x-x0,dy0=y-y0;
	if((Math.abs(dx0)+Math.abs(dy0))>distmax){
	    sailshipx+=dx0;sailshipy+=dy0;}
	while(sailshipx<(x-distmax)){sailshipx+=1.9999*distmax;}
	while(sailshipx>(x+distmax)){sailshipx-=1.9999*distmax;}
	while(sailshipy<(y-distmax)){sailshipy+=1.9999*distmax;}
	while(sailshipy>(y+distmax)){sailshipy-=1.9999*distmax;}	
	sailshipco1=Math.cos(degtorad(sailshipo1));
	sailshipsi1=Math.sin(degtorad(sailshipo1));
    sailshipx+=dtime*0.001*sailshipco1;
    sailshipy+=dtime*0.001*sailshipsi1;
    var do1=0;
	var dh1=getterrainheight(sailshipx+10*sailshipco1-5*sailshipsi1,sailshipy+10*sailshipsi1+5*sailshipco1);
    var dh2=getterrainheight(sailshipx+10*sailshipco1+5*sailshipsi1,sailshipy+10*sailshipsi1-5*sailshipco1);
	if(dh1>0){
	  do1=-0.01*dtime*(1+Math.random());
    }else{
	  if(dh2>0){do1=0.01*dtime*(1+Math.random());}
    }
    if(sailshipx<(xmin+100) || sailshipx>(xmax-100)){sailshipo1=diro1(pistex-sailshipx,pistey-sailshipy);}
    if(sailshipy<(ymin+100) || sailshipy>(ymax-100)){sailshipo1=diro1(pistex-sailshipx,pistey-sailshipy);}
	if(Math.abs(do1)>0.0001){
	  sailshipo1+=do1;
	}
}
function drawsailship(){
	    var dx=x-sailshipx,dy=y-sailshipy;	  
        if(Math.abs(dx)>(distmap2)){return;}
        if(Math.abs(dy)>(distmap2)){return;}
		if(getterrainheight(sailshipx,sailshipy)>0){
		   if(sailshipx>xmin && sailshipx<xmax && sailshipy>ymin && sailshipy<ymax){
		      return;};}
     	if(sailshipvie<0 && Math.random()<dtime*0.0025){addsmoke(sailshipx,sailshipy,sailshipz+1.4,3.5,1);}
		if(rotavion(sailshipx-x,sailshipy-y,sailshipz-z,12)){
		mvPushMatrix();
		mat4.translate(mvMatrix, [sailshipx,sailshipy,sailshipz-0.1]);
        mat4.rotate(mvMatrix, degtorad(sailshipo1), [0, 0, 1]);
		mat4.scale(mvMatrix,[0.05,0.05,0.05]);
 	gl.activeTexture(gl.TEXTURE0);
    gl.bindTexture(gl.TEXTURE_2D,  sailshipTexture);
    gl.uniform1i(shaderProgram.samplerUniform, 0);
    
    gl.bindBuffer(gl.ARRAY_BUFFER, sailshipVertexTextureCoordBuffer);
    gl.vertexAttribPointer(shaderProgram.textureCoordAttribute, sailshipVertexTextureCoordBuffer.itemSize, gl.FLOAT, false, 0, 0);

    gl.bindBuffer(gl.ARRAY_BUFFER, sailshipVertexPositionBuffer);
    gl.vertexAttribPointer(shaderProgram.vertexPositionAttribute, sailshipVertexPositionBuffer.itemSize, gl.FLOAT, false, 0, 0);
    
    setMatrixUniforms(); 
    gl.drawArrays(gl.TRIANGLES, 0, sailshipVertexPositionBuffer.numItems);
		
		mvPopMatrix();
		}
}
var tdrawarm=0;
function drawarm(){//11 -30
		var o2arm=26-(49+26)*(tframe-tdrawarm)/350;//o2arm=0;
		if(o2arm<-49){return;}
		if(thorse==1){o2arm-=10;}
		mvPushMatrix();
		mat4.identity(mvMatrix);
		mat4.translate(mvMatrix, [0.1,0,-0.22]);
		mat4.rotate(mvMatrix, degtorad(7), [0, 0, 1]);
		mat4.rotate(mvMatrix, degtorad(o2arm), [1, 0, 0]);
		mat4.translate(mvMatrix, [0.02,-0.12,-0.08]);
        mat4.rotate(mvMatrix, degtorad(30), [0, 0, 1]);
		if(weapon=="sword"){drawsword();}
        else{drawaxe();}		
		mat4.scale(mvMatrix,[-0.0017,-0.0017,0.0024]);
 	
	gl.activeTexture(gl.TEXTURE0);
    gl.bindTexture(gl.TEXTURE_2D,  arm2Texture);
    gl.uniform1i(shaderProgram.samplerUniform, 0);
    
    gl.bindBuffer(gl.ARRAY_BUFFER, arm2VertexTextureCoordBuffer);
    gl.vertexAttribPointer(shaderProgram.textureCoordAttribute, arm2VertexTextureCoordBuffer.itemSize, gl.FLOAT, false, 0, 0);

    gl.bindBuffer(gl.ARRAY_BUFFER, arm2VertexPositionBuffer);
    gl.vertexAttribPointer(shaderProgram.vertexPositionAttribute, arm2VertexPositionBuffer.itemSize, gl.FLOAT, false, 0, 0);
    
    setMatrixUniforms(); 
    gl.drawArrays(gl.TRIANGLES, 0, arm2VertexPositionBuffer.numItems);
		
		mvPopMatrix();
}
function drawsword(){
		mvPushMatrix();
		//mat4.identity(mvMatrix);
		mat4.translate(mvMatrix, [0.045,0.01,-0.3]);
        mat4.rotate(mvMatrix, degtorad(-90), [1, 0, 0]);
        mat4.rotate(mvMatrix, degtorad(45), [0, 0, 1]);
		mat4.scale(mvMatrix,[0.005,0.005,0.005]);
 	
	gl.activeTexture(gl.TEXTURE0);
    gl.bindTexture(gl.TEXTURE_2D,  swordTexture);
    gl.uniform1i(shaderProgram.samplerUniform, 0);
    
    gl.bindBuffer(gl.ARRAY_BUFFER, swordVertexTextureCoordBuffer);
    gl.vertexAttribPointer(shaderProgram.textureCoordAttribute, swordVertexTextureCoordBuffer.itemSize, gl.FLOAT, false, 0, 0);

    gl.bindBuffer(gl.ARRAY_BUFFER, swordVertexPositionBuffer);
    gl.vertexAttribPointer(shaderProgram.vertexPositionAttribute, swordVertexPositionBuffer.itemSize, gl.FLOAT, false, 0, 0);
    
    setMatrixUniforms(); 
    gl.drawArrays(gl.TRIANGLES, 0, swordVertexPositionBuffer.numItems);
		
		mvPopMatrix();
}
function drawaxe(){
		mvPushMatrix();
		//mat4.identity(mvMatrix);
		mat4.translate(mvMatrix, [0.045,0.01,-0.3]);
        mat4.rotate(mvMatrix, degtorad(49), [0, 0, 1]);
        mat4.rotate(mvMatrix, degtorad(-75), [0, 1, 0]);
        mat4.rotate(mvMatrix, degtorad(-15), [0, 0, 1]);
		mat4.scale(mvMatrix,[0.0045,0.0045,0.0045]);
 	
	gl.activeTexture(gl.TEXTURE0);
    gl.bindTexture(gl.TEXTURE_2D,  axeTexture);
    gl.uniform1i(shaderProgram.samplerUniform, 0);
    
    gl.bindBuffer(gl.ARRAY_BUFFER, axeVertexTextureCoordBuffer);
    gl.vertexAttribPointer(shaderProgram.textureCoordAttribute, axeVertexTextureCoordBuffer.itemSize, gl.FLOAT, false, 0, 0);

    gl.bindBuffer(gl.ARRAY_BUFFER, axeVertexPositionBuffer);
    gl.vertexAttribPointer(shaderProgram.vertexPositionAttribute, axeVertexPositionBuffer.itemSize, gl.FLOAT, false, 0, 0);
    
    setMatrixUniforms(); 
    gl.drawArrays(gl.TRIANGLES, 0, axeVertexPositionBuffer.numItems);
		
		mvPopMatrix();
}
var thorse=0,o2horse=0,o1horse=0,o3horse=0,tmovehorse=1,tframehorse=0,vhorse=0;
var tmovehorse2=0,tmovehorse20=0;
function drawhorse(){
        tmovehorse20=tmovehorse2;tmovehorse2=0;
		if(keys[vk_up] || joyy<-0.5){tmovehorse2=3;}
        tframehorse+=dtime*(tmovehorse*0.6+0.3);
		o2horse=Math.sin(tframehorse*0.0065)*4*tmovehorse;
		o2horse+=Math.sin(tframehorse*0.0016)*3-3;//*tmovehorse;
		o1horse=Math.sin(tframehorse*0.0014)*8;
		o3horse=Math.sin(tframehorse*0.0028)*23*Math.cos(tframe*0.0003);
		if(o1>o10+0.0001){o3horse-=10;o1horse+=7;tmovehorse2=1;}
		if(o1<o10-0.0001){o3horse+=10;o1horse-=7;tmovehorse2=2;}
		if(tmovehorse2!=tmovehorse20 && tmovehorse2!=0){
		   if(Math.random()<0.1 ||
   		     (Math.random()<0.2 && tmovehorse2==3)){
		        soundhorse();};}
		mvPushMatrix();
		mat4.identity(mvMatrix);
		mat4.translate(mvMatrix, [0,-0.14-0.12*sin2,-0.19]);
		mat4.rotate(mvMatrix, degtorad(o1horse), [0, 1, 0]);
		mat4.rotate(mvMatrix, degtorad(43+o2horse-o2), [1, 0, 0]);		
		mat4.rotate(mvMatrix, degtorad(-4+o3horse), [0, 0, 1]);		
		mat4.rotate(mvMatrix, degtorad(44), [1, 0, 0]);		
		mat4.scale(mvMatrix,[0.0015,0.0015,-0.0015]);
 	
	gl.activeTexture(gl.TEXTURE0);
    gl.bindTexture(gl.TEXTURE_2D,  horseTexture);
    gl.uniform1i(shaderProgram.samplerUniform, 0);
    
    gl.bindBuffer(gl.ARRAY_BUFFER, horseVertexTextureCoordBuffer);
    gl.vertexAttribPointer(shaderProgram.textureCoordAttribute, horseVertexTextureCoordBuffer.itemSize, gl.FLOAT, false, 0, 0);

    gl.bindBuffer(gl.ARRAY_BUFFER, horseVertexPositionBuffer);
    gl.vertexAttribPointer(shaderProgram.vertexPositionAttribute, horseVertexPositionBuffer.itemSize, gl.FLOAT, false, 0, 0);
    
    setMatrixUniforms(); 
    gl.drawArrays(gl.TRIANGLES, 0, horseVertexPositionBuffer.numItems);
		
		mvPopMatrix();
}
var horsex=0,horsey=0,horsez=0,horseo1=0;
function drawhorsebody(){	  
   if(Math.abs(horsex-x)>(distmap2)){return;}
   if(Math.abs(horsey-y)>(distmap2)){return;}
   if(rotavion(horsex-x,horsey-y,horsez-z,2)<=0){return;}
        tmovehorse=0;
        tframehorse+=dtime*(tmovehorse*0.6+0.3);
		o2horse=Math.sin(tframehorse*0.0065)*4*tmovehorse;
		o2horse+=Math.sin(tframehorse*0.0016)*3-3;//*tmovehorse;
		o1horse=Math.sin(tframehorse*0.0014)*8;
		o3horse=Math.sin(tframehorse*0.0028)*23*Math.cos(tframe*0.0003);
	
	gl.activeTexture(gl.TEXTURE0);
    gl.bindTexture(gl.TEXTURE_2D,  horseTexture);
    gl.uniform1i(shaderProgram.samplerUniform, 0);
		
		mvPushMatrix();
		mat4.translate(mvMatrix, [horsex,horsey,horsez]);
		mat4.rotate(mvMatrix, degtorad(horseo1+90), [0, 0, 1]);
    	mat4.scale(mvMatrix,[1.4,1.4,1.4]);
        mvPushMatrix();		
		mat4.scale(mvMatrix,[0.007,0.007,0.007]);

    gl.bindBuffer(gl.ARRAY_BUFFER, horsebodyVertexTextureCoordBuffer);
    gl.vertexAttribPointer(shaderProgram.textureCoordAttribute, horsebodyVertexTextureCoordBuffer.itemSize, gl.FLOAT, false, 0, 0);

    gl.bindBuffer(gl.ARRAY_BUFFER, horsebodyVertexPositionBuffer);
    gl.vertexAttribPointer(shaderProgram.vertexPositionAttribute, horsebodyVertexPositionBuffer.itemSize, gl.FLOAT, false, 0, 0);
    
    setMatrixUniforms(); 
    gl.drawArrays(gl.TRIANGLES, 0, horsebodyVertexPositionBuffer.numItems);
        
		mvPopMatrix();
		mat4.translate(mvMatrix, [0,-0.284,0.837]);
		mat4.rotate(mvMatrix, degtorad(o1horse), [0, 1, 0]);
		mat4.rotate(mvMatrix, degtorad(o2horse), [1, 0, 0]);		
		mat4.rotate(mvMatrix, degtorad(-4+o3horse), [0, 0, 1]);		
		//mat4.rotate(mvMatrix, degtorad(44), [1, 0, 0]);		
		mat4.scale(mvMatrix,[0.0035,0.0035,0.0035]);
 	
    
    gl.bindBuffer(gl.ARRAY_BUFFER, horseVertexTextureCoordBuffer);
    gl.vertexAttribPointer(shaderProgram.textureCoordAttribute, horseVertexTextureCoordBuffer.itemSize, gl.FLOAT, false, 0, 0);

    gl.bindBuffer(gl.ARRAY_BUFFER, horseVertexPositionBuffer);
    gl.vertexAttribPointer(shaderProgram.vertexPositionAttribute, horseVertexPositionBuffer.itemSize, gl.FLOAT, false, 0, 0);
    
    setMatrixUniforms(); 
    gl.drawArrays(gl.TRIANGLES, 0, horseVertexPositionBuffer.numItems);
		
		mvPopMatrix();
}
var thorselow=0,o2horselow=0,o1horselow=0,o3horselow=0,tmovehorselow=1,tframehorselow=0,vhorselow=0;
var horselowx=x+8,horselowy=y,horselowz=0,horselowo1=0,horselowo2=0;
var horselowo10=0,horselowv=1,horselowco1=1,horselowsi1=0;
function drawhorselow(){
   //horselowx=horsex;horselowy=horsey;horselowz=horsez;
   //horselowo1=horseo1;   
   var distmax=65,test=0;
   while(horselowx<(x-distmax)){horselowx+=1.9999*distmax;test=1;}
   while(horselowx>(x+distmax)){horselowx-=1.9999*distmax;test=1;}
   while(horselowy<(y-distmax)){horselowy+=1.9999*distmax;test=1;}
   while(horselowy>(y+distmax)){horselowy-=1.9999*distmax;test=1;}
   if(test==1){skeletonvie[nskeleton]=200;
               //horselowx=x+0.9*distmax*cos1;
			   //horselowy=y+0.9*distmax*sin1;
			   //horselowo1=o1+180+(Math.random()-0.5)*20;
			  }
   var co1=Math.cos(degtorad(horselowo1)),si1=Math.sin(degtorad(horselowo1));
   horselowco1=co1;horselowsi1=si1;
   horselowx+=horselowv*co1*dtime*0.001;
   horselowy+=horselowv*si1*dtime*0.001;
   var dx=x+0.24*sin1-horselowx,dy=y-0.24*cos1-horselowy;
   var dxy=Math.max(Math.abs(dx),Math.abs(dy));
   if(dxy>50){skeletonvie[nskeleton]=200;horselowv=0.5;return;}
   if(dxy>0.85 && dxy<1.4){to2skeleton=0;}
   if(dxy<0.85 && to2skeleton<=0.001){to2skeleton=tframe;}
   if(dxy<0.7 && tattackskeleton==0 && vieskeleton>0){
         tattackskeleton=1;
         attackskeletoncav();
   }else if(to2skeleton<=0.001){tattackskeleton=0;}		 
   var dt=dtime*0.00018*(10+dxy)/(5+dxy);
   if((dx*co1+dy*si1)>0.3){dt*=2;}
   if((Math.random()*2.9*Math.random())<dt && vieskeleton>0){
       if(dxy<15){horselowo10=diro1(dx,dy);
	   }else if(dxy<30){horselowo10=diro1(dx+8*cos1,dy+8*sin1);}}
   var doo1=horselowo10-horselowo1;
   while(horselowo1>180){horselowo1-=360;}
   while(horselowo1<-180){horselowo1+=360;}
   while(doo1>180){doo1-=360;}
   while(doo1<-180){doo1+=360;}
   if(doo1>8){horselowo1+=dtime*0.05;}
   if(doo1<-8){horselowo1-=dtime*0.05;}   
   tmovehorselow=(1+vhorse*0.3-0.3*Math.cos((dx+dy)*0.1));
   if(vieskeleton>30 && dxy<30){horselowv=tmovehorselow*2.2;
   }else{horselowv=0.7;}
   if(Math.abs(dx)>(distmap2)){return;}
   if(Math.abs(dy)>(distmap2)){return;}
   if(rotavion(horselowx-x,horselowy-y,horselowz-z,2)<=0){return;}
	if(x2>0){
       tmovehorselow=(1+vhorse*0.15-0.3*Math.cos((dx+dy)*0.1+8*degtorad(o1)))/1.1;
       horselowv=tmovehorselow*1.4;}
	var h0=getterrainheight(horselowx,horselowy);
	var h1=getterrainheight(horselowx+co1,horselowy+si1);
	horselowo2=Math.atan(h1-h0)*radtodeg/2;
	horselowz=h0;
    tframehorselow+=dtime*(tmovehorselow*0.6+0.3);
    o2horselow=0.8*Math.sin(tframehorselow*0.0065)*tmovehorselow;
    o2horselow+=0.22*(Math.sin(tframehorselow*0.0016)-0.4);
    var nvertices=horselowVertexPositionBuffer.numItems;
	if(o2horselow>0){   
	 for(var i=0;i<nvertices*3;i++){
	    horselowVertexPositions[i]=horselowidleVertexPositions[i]
		    +o2horselow*horselowrun1VertexPositions[i];}
    }else{	
	 for(var i=0;i<nvertices*3;i++){
	    horselowVertexPositions[i]=horselowidleVertexPositions[i]
		    -o2horselow*horselowrun2VertexPositions[i];}
    }
	
	gl.activeTexture(gl.TEXTURE0);
    gl.bindTexture(gl.TEXTURE_2D,  horselowTexture);
    gl.uniform1i(shaderProgram.samplerUniform, 0);
		
		mvPushMatrix();
		mat4.translate(mvMatrix, [horselowx,horselowy,horselowz]);
		mat4.rotate(mvMatrix,degtorad(horselowo1), [0, 0, 1]);
    	mat4.rotate(mvMatrix,degtorad(-horselowo2-2.5+5.5*o2horselow), [0, 1, 0]);
    	mat4.scale(mvMatrix,[1.4,1.4,1.4]);
		mvPushMatrix();
    	mat4.scale(mvMatrix,[0.0077,0.0077,0.0077]);

    gl.bindBuffer(gl.ARRAY_BUFFER, horselowVertexTextureCoordBuffer);
    gl.vertexAttribPointer(shaderProgram.textureCoordAttribute, horselowVertexTextureCoordBuffer.itemSize, gl.FLOAT, false, 0, 0);

    gl.bindBuffer(gl.ARRAY_BUFFER, horselowVertexPositionBuffer);
    gl.bufferData(gl.ARRAY_BUFFER, (horselowVertexPositions), gl.STATIC_DRAW);
    gl.vertexAttribPointer(shaderProgram.vertexPositionAttribute, horselowVertexPositionBuffer.itemSize, gl.FLOAT, false, 0, 0);
    
    setMatrixUniforms(); 
    gl.drawArrays(gl.TRIANGLES, 0, horselowVertexPositionBuffer.numItems);
		mvPopMatrix();
        
		drawskeletoncav();
		mvPopMatrix();
}
var tmoveskeleton=0,to1skeleton=0,o1skeleton=0;
var to2skeleton=0,o2skeleton=0,roto1skeleton=0;
var tattackskeleton=0,vieskeleton=200;
function testcollideskeletoncav(){
  if(Math.abs(horselowx+horselowco1*0.7-x)<0.3){
   if(Math.abs(horselowy+horselowsi1*0.7-y)<0.3){
     horselowx-=horselowsi1*0.1;
	 horselowy+=horselowco1*0.1;}}

if(thorse==1 && tfoot==1){
  if(Math.abs(horselowx-cos1*0.7-x)<0.3){
   if(Math.abs(horselowy-sin1*0.7-y)<0.3){
     x-=sin1*0.1;
	 y+=cos1*0.1;}}
}
}
function drawskeletoncav(){
roto1skeleton=0;
//skeletonvie[nskeleton]=Math.min(10,skeletonvie[nskeleton]);
vieskeleton=skeletonvie[nskeleton];
if(vieskeleton<=0){to1skeleton=tframe+100;to2skeleton=0;
   o1skeleton=0;o2skeleton=0;}
testcollideskeletoncav();   
skeletonx[nskeleton]=horselowx;   
skeletony[nskeleton]=horselowy;   
skeletonz[nskeleton]=horselowz+0.94-0.4;   
if(tframe>=to1skeleton){
    to1skeleton=tframe+50+900*Math.random()*Math.random()*1.5/(1.5+tmovehorselow);
 	o1skeleton+=1;if(o1skeleton>1){o1skeleton=0;}}
if(tframe<to2skeleton+4000){
    var do2=(tframe-to2skeleton)/8;
	if(do2<90){o2skeleton=1.3*Math.sin(degtorad(do2));
	}else{o2skeleton=1.3*Math.sin(degtorad(90+(do2-90)*3));
	      roto1skeleton=(do2-90)*o2skeleton*0.85;
    }
	if(o2skeleton<-0.65){o2skeleton=0;to2skeleton=0;}
    var nvertices=skeletoncavVertexPositionBuffer.numItems;   
	//o2skeleton=1.3;
	for(var i=0;i<nvertices*3;i++){
	    skeletoncavVertexPositions[i]=skeletoncavidleVertexPositions[i]
		    +o2skeleton*skeletoncavattackVertexPositions[i];}
    o1skeleton=0;			
    }else{if(Math.random()<dtime*0.0003){to2skeleton=tframe;}
    }	
	//o1skeleton=0;
	//o2skeleton=1.3;
	gl.activeTexture(gl.TEXTURE0);
    gl.bindTexture(gl.TEXTURE_2D,  skeletoncavTexture);
    gl.uniform1i(shaderProgram.samplerUniform, 0);
		mvPushMatrix();
		mat4.translate(mvMatrix, [0.052,-0.021,0.94]);
		mat4.rotate(mvMatrix, degtorad(90+o1horse+roto1skeleton), [0, 0, 1]);
		if(vieskeleton<=0){
		   mat4.rotate(mvMatrix,degtorad(70), [1, 0, 0]);}		
		//mat4.rotate(mvMatrix, degtorad(-4+o3horse), [0, 0, 1]);		
		//mat4.rotate(mvMatrix, degtorad(44), [1, 0, 0]);		
		if(o1skeleton==0){mat4.scale(mvMatrix,[0.0035,0.0035,0.0031]);
 	    }else{mat4.scale(mvMatrix,[-0.0035,0.0035,0.0031]);}
    
    gl.bindBuffer(gl.ARRAY_BUFFER, skeletoncavVertexTextureCoordBuffer);
    gl.vertexAttribPointer(shaderProgram.textureCoordAttribute, skeletoncavVertexTextureCoordBuffer.itemSize, gl.FLOAT, false, 0, 0);

    gl.bindBuffer(gl.ARRAY_BUFFER, skeletoncavVertexPositionBuffer);
    gl.bufferData(gl.ARRAY_BUFFER, (skeletoncavVertexPositions), gl.STATIC_DRAW);
    gl.vertexAttribPointer(shaderProgram.vertexPositionAttribute, skeletoncavVertexPositionBuffer.itemSize, gl.FLOAT, false, 0, 0);
    
    colorr=1;colorg=1;colorb=1;colora=1;
	setMatrixUniforms(); 
    gl.drawArrays(gl.TRIANGLES, 0, skeletoncavVertexPositionBuffer.numItems);
    if(o1skeleton==0 && o2skeleton<=0.001){	
		mat4.scale(mvMatrix,[-120,-120,136]);
        mat4.translate(mvMatrix, [0.63,0.13,0.30]);
		mat4.rotate(mvMatrix, degtorad(38.8), [1, 0, 0]);		
		mat4.rotate(mvMatrix, degtorad(40), [0, 0, 1]);		
    }else if(o1skeleton==0){var k=o2skeleton,l=(1-k);	
		mat4.scale(mvMatrix,[-120,-120,136]);
        mat4.translate(mvMatrix, [k*0.57+l*0.63,k*0.63+l*0.13,k*0.63+l*0.30]);
		mat4.rotate(mvMatrix, degtorad(k*128.8+l*38.8), [1, 0, 0]);		
		mat4.rotate(mvMatrix, degtorad(-4*k), [0, 1, 0]);		
		mat4.rotate(mvMatrix, degtorad(40*l), [0, 0, 1]);		
    }else{
		mat4.scale(mvMatrix,[120,-120,136]);
        mat4.translate(mvMatrix, [0.47,0.05,0.183]);
		mat4.rotate(mvMatrix, degtorad(38.8), [1, 0, 0]);		
		mat4.rotate(mvMatrix, degtorad(40), [0, 0, 1]);		
	}
	drawaxe();
	mvPopMatrix();
}
var nroc=100,rocx=new Array(nroc),rocy=new Array(nroc),rocz=new Array(nroc);
var roco1=new Array(nroc),roco2=new Array(nroc),roco3=new Array(nroc);
var rocscale=new Array(nroc),roch=new Array(nroc);
for(var i=0;i<nroc;i++){
   rocx[i]=-999+Math.random()*400;rocy[i]=-999+Math.random()*400;rocz[i]=0.15;
   roco1[i]=Math.random()*360;roco2[i]=Math.random()*360;roco3[i]=Math.random()*360;
   rocscale[i]=0.3+Math.random();
   roch[i]=2.7*rocscale[i]*(-0.35+0.5*Math.random());
   }
var x1=0,y1=0,z1=0,x2=0,y2=0,z2=0;
function rotavion(x,y,z,r){
if(tourelle==0 || tfoot==1){
 x1=x*cos1+y*sin1;
 //'y1=0-x*sin1+y*cos1
 //'z1=z
 x2=x1*cos2+z*sin2;
 //'y2=y1
 y2=-x*sin1+y*cos1;
 z2=-x1*sin2+z*cos2;
}else{
 x1=x*tcos1+y*tsin1;
 //'y1=0-x*tsin1+y*tcos1
 //'z1=z
 x2=x1*tcos2+z*tsin2;
 //'y2=y1
 y2=-x*tsin1+y*tcos1;
 z2=-x1*tsin2+z*tcos2;
 }
if(x2<0.87*Math.abs(y2)-r){return 0;}
if(x2<0.87*Math.abs(z2)-r){return 0;}
return 1;
}
function resetrocs(){
for(var i=0;i<nroc;i++){
		  rocz[i]=getterrainheight(rocx[i],rocy[i]);
		  if(rocz[i]<0.015 || rocz[i]>20){rocz[i]=-999;};
          if(Math.abs(townxx-rocx[i])<90){
           if(Math.abs(townyy-rocy[i])<90){rocz[i]=-999;};}
       	  if(Math.abs(rocy[i]-pistey)<14){
   		   if(rocx[i]>(pistex+45.5-98-7) && rocx[i]<(pistex+45.5+7)){
              rocz[i]=-999;};}
			  
farmlowz=getterrainheight(farmlowx,farmlowy);
}			  
}
function drawroc(){
 	gl.activeTexture(gl.TEXTURE0);
    gl.bindTexture(gl.TEXTURE_2D,  rocTexture);
    gl.uniform1i(shaderProgram.samplerUniform, 0);
    
    gl.bindBuffer(gl.ARRAY_BUFFER, rocVertexTextureCoordBuffer);
    gl.vertexAttribPointer(shaderProgram.textureCoordAttribute, rocVertexTextureCoordBuffer.itemSize, gl.FLOAT, false, 0, 0);

    gl.bindBuffer(gl.ARRAY_BUFFER, rocVertexPositionBuffer);
    gl.vertexAttribPointer(shaderProgram.vertexPositionAttribute, rocVertexPositionBuffer.itemSize, gl.FLOAT, false, 0, 0);

    setMatrixUniforms(); 
var distmax=90/1.3;
for(var i=0;i<nroc;i++){		
		var test=0;
		while(rocx[i]<(x-distmax)){rocx[i]+=distmax*1.99999;test=1;};
		while(rocx[i]>(x+distmax)){rocx[i]-=distmax*1.99999;test=1;};
		while(rocy[i]<(y-distmax)){rocy[i]+=distmax*1.99999;test=1;};
		while(rocy[i]>(y+distmax)){rocy[i]-=distmax*1.99999;test=1;};
		var d=rocscale[i]*2+Math.min(roch[i]*0.8,0);
		if(tfoot==1){if(Math.abs(rocx[i]-x)<d){
		             if(Math.abs(rocy[i]-y)<d){
		             if(rocz[i]>=0.015){tcollide=1;};};};}
		if(test==1){rocz[i]=getterrainheight(rocx[i],rocy[i]);
		  if(rocz[i]<0.015 || rocz[i]>20){rocz[i]=-999;};}
          if(Math.abs(townxx-rocx[i])<90){
           if(Math.abs(townyy-rocy[i])<90){rocz[i]=-999;};}
       	  if(Math.abs(rocy[i]-pistey)<14){
   		   if(rocx[i]>(pistex+45.5-98-7) && rocx[i]<(pistex+45.5+7)){
              rocz[i]=-999;};}
		var r=3*rocscale[i];	  
    	if(rocz[i]>0.015 && rotavion(rocx[i]-x,rocy[i]-y,rocz[i]-z,r)){  
		mvPushMatrix();
		if(tshadow==0){mat4.translate(mvMatrix, [rocx[i],rocy[i],rocz[i]+roch[i]]);
        }else{mat4.translate(mvMatrix, [rocx[i],rocy[i],zsol]);}
		mat4.rotate(mvMatrix, degtorad(roco1[i]), [0, 0, 1]);
        mat4.rotate(mvMatrix, degtorad(roco2[i]), [0, 1, 0]);
        mat4.rotate(mvMatrix, degtorad(roco3[i]), [1, 0, 0]);
		var sc=rocscale[i]*0.015;
		mat4.scale(mvMatrix,[sc,sc,sc]);
    
    gl.uniformMatrix4fv(shaderProgram.mvMatrixUniform, false, mvMatrix);
    gl.drawArrays(gl.TRIANGLES, 0, rocVertexPositionBuffer.numItems);
		
		mvPopMatrix();
    }
 }
}
var treex=new Array(ntree),treey=new Array(ntree),treez=new Array(ntree);
function drawtrunk(){
 	gl.activeTexture(gl.TEXTURE0);
    gl.bindTexture(gl.TEXTURE_2D,  trunkTexture);
    gl.uniform1i(shaderProgram.samplerUniform, 0);
    
    gl.bindBuffer(gl.ARRAY_BUFFER, trunkVertexTextureCoordBuffer);
    gl.vertexAttribPointer(shaderProgram.textureCoordAttribute, trunkVertexTextureCoordBuffer.itemSize, gl.FLOAT, false, 0, 0);

    gl.bindBuffer(gl.ARRAY_BUFFER, trunkVertexPositionBuffer);
    gl.vertexAttribPointer(shaderProgram.vertexPositionAttribute, trunkVertexPositionBuffer.itemSize, gl.FLOAT, false, 0, 0);
    
    colorr=1.14;colorg=1.14;colorb=1.14;	
    setMatrixUniforms(); 
	colorr=1;colorg=1;colorb=1;
for(var i=0;i<ntree;i++){
  if(Math.abs(treex[i]-x)<17){
   if(Math.abs(treey[i]-y)<17){	
    if(Math.abs(treez[i]-z)<17){		 
		var r=treescale;	  
    	if(treez[i]>0.15 && rotavion(treex[i]-x,treey[i]-y,treez[i]-z,r)){  
		mvPushMatrix();
		mat4.translate(mvMatrix, [treex[i],treey[i],treez[i]]);
        mat4.rotate(mvMatrix, 10*(treex[i]+treey[i]), [0, 0, 1]);
        //mat4.rotate(mvMatrix, degtorad(treeo2[i]), [0, 1, 0]);
        //mat4.rotate(mvMatrix, degtorad(treeo3[i]), [1, 0, 0]);
		var sc=treescale*0.0039;
		mat4.scale(mvMatrix,[sc,sc,treescale*0.0034]);
    
    gl.uniformMatrix4fv(shaderProgram.mvMatrixUniform, false, mvMatrix);
    gl.drawArrays(gl.TRIANGLES, 0, trunkVertexPositionBuffer.numItems);
		
		mvPopMatrix();
    }
  }}}
 }
}
function drawtower(){
        if(Math.abs(x-(xmax-xmin)*0.5)>(distmap2)){return;}
        if(Math.abs(y-(ymax-ymin)*0.5)>(distmap2)){return;}
        mvPushMatrix();
	gl.activeTexture(gl.TEXTURE0);
    gl.bindTexture(gl.TEXTURE_2D,  towerTexture);
    gl.uniform1i(solProgram.samplerUniform, 0);
    
    gl.bindBuffer(gl.ARRAY_BUFFER, towerVertexTextureCoordBuffer);
    gl.vertexAttribPointer(solProgram.textureCoordAttribute, towerVertexTextureCoordBuffer.itemSize, gl.FLOAT, false, 0, 0);

    gl.bindBuffer(gl.ARRAY_BUFFER, towerVertexPositionBuffer);
    gl.vertexAttribPointer(solProgram.vertexPositionAttribute, towerVertexPositionBuffer.itemSize, gl.FLOAT, false, 0, 0);
    
    setMatrixUniformspiste(); 
    gl.drawArrays(gl.TRIANGLES, 0, towerVertexPositionBuffer.numItems);
		
		mvPopMatrix();
}
var tradartown=0,o1radartown=0,dxradartown=0;
var townxx=(xmax-xmin)*0.7;
var townyy=(ymax-ymin)*0.7;
function getheighttown(px,py){
if(Math.abs(townxx-px)>90){return -1;}
if(Math.abs(townyy-py)>90){return -1;}
var h=-1;
for(var i=0;i<ntown;i++){
   if(Math.abs(townx[i]-px)<towndx[i]){
     if(Math.abs(towny[i]-py)<towndx[i]){
	   if(h<townz[i]){h=townz[i];};
	 }
   }
}
return h;
}
function drawtown(){
    //var townxx=(xmax-xmin)*0.7,townyy=(ymax-ymin)*0.7;
    var dxtown=Math.abs(x-townxx),dytown=Math.abs(y-townyy);
		dxradartown=Math.sqrt(dxtown*dxtown+dytown*dytown);
		dxradartown=radardist(dxradartown);
		if(dxradartown*0.015>5.4){return;}
		o1radartown=diro1(townxx-x,townyy-y);
		if(Math.cos(degtorad(o1radartown-o1-o3radar-30+90))>0.8){
		   tradartown=tframe;
		}
        if(Math.abs(x-townxx)>(-40+distmap2)){return;}
        if(Math.abs(y-townyy)>(-40+distmap2)){return;}
        mvPushMatrix();
	gl.activeTexture(gl.TEXTURE0);
    gl.bindTexture(gl.TEXTURE_2D,  towerTexture);
    gl.uniform1i(solProgram.samplerUniform, 0);
    
    gl.bindBuffer(gl.ARRAY_BUFFER, townVertexTextureCoordBuffer);
    gl.vertexAttribPointer(solProgram.textureCoordAttribute, townVertexTextureCoordBuffer.itemSize, gl.FLOAT, false, 0, 0);

    gl.bindBuffer(gl.ARRAY_BUFFER, townVertexPositionBuffer);
    gl.vertexAttribPointer(solProgram.vertexPositionAttribute, townVertexPositionBuffer.itemSize, gl.FLOAT, false, 0, 0);
    
    setMatrixUniformstown(); 
    gl.drawArrays(gl.TRIANGLES, 0, townVertexPositionBuffer.numItems);
		
		mvPopMatrix();
}
var farmlowx=(xmax-xmin)*0.51,farmlowy=(ymax-ymin)*0.51,farmlowz=0;
function drawfarmlow(){
    if(tmove>0){
	 var distmax=45,test=0;
     while(farmlowx<(x-distmax)){farmlowx+=1.9999*distmax;test=1;}
     while(farmlowx>(x+distmax)){farmlowx-=1.9999*distmax;test=1;}
     while(farmlowy<(y-distmax)){farmlowy+=1.9999*distmax;test=1;}
     while(farmlowy>(y+distmax)){farmlowy-=1.9999*distmax;test=1;}
     if(test==1){var r=1;farmlowz=999;
	      for(var i=farmlowx-r;i<(farmlowx+r+0.1);i+=r){
			for(var j=farmlowy-r;j<(farmlowy+r+0.1);j+=r){
		     farmlowz=Math.min(farmlowz,getterrainheight(i,j));}}}
     }   
		if(farmlowz<-0.2){return;};
		if(Math.abs(x-farmlowx)>(distmap2)){return;}
        if(Math.abs(y-farmlowy)>(distmap2)){return;}
		
if(rotavion(farmlowx-x,farmlowy-y,farmlowz-z,4)>0){
        mvPushMatrix();
		mat4.translate(mvMatrix, [farmlowx,farmlowy,farmlowz]);
		var sc=0.015;
		mat4.scale(mvMatrix,[sc,sc,sc]);
	gl.activeTexture(gl.TEXTURE0);
    gl.bindTexture(gl.TEXTURE_2D,  farmlowTexture);
    gl.uniform1i(shaderProgram.samplerUniform, 0);
    
    gl.bindBuffer(gl.ARRAY_BUFFER, farmlowVertexTextureCoordBuffer);
    gl.vertexAttribPointer(shaderProgram.textureCoordAttribute, farmlowVertexTextureCoordBuffer.itemSize, gl.FLOAT, false, 0, 0);

    gl.bindBuffer(gl.ARRAY_BUFFER, farmlowVertexPositionBuffer);
    gl.vertexAttribPointer(shaderProgram.vertexPositionAttribute, farmlowVertexPositionBuffer.itemSize, gl.FLOAT, false, 0, 0);
    
    setMatrixUniforms(); 
    gl.drawArrays(gl.TRIANGLES, 0, farmlowVertexPositionBuffer.numItems);
		
		mvPopMatrix();
 }
}
var castlex=(xmax-xmin)*0.52,castley=(ymax-ymin)*0.55,castlez=0;
function drawcastle(){
		if(Math.abs(x-castlex)>(distmap2+20)){return;}
        if(Math.abs(y-castley)>(distmap2+20)){return;}
		var dx=7;
		colorr=1;colorg=1;colorb=1;colora=0;
		castletowerz=castlez;castlewallz=castlez;
		castletowerx=castlex-dx;castletowery=castley-dx;
		drawcastletower(1.3);
		castletowerx=castlex-dx;castletowery=castley+dx;
		drawcastletower(1);
		castletowerx=castlex+dx;castletowery=castley-dx;
		drawcastletower(1);
		castletowerx=castlex+dx;castletowery=castley+dx;
		drawcastletower(1);
		castlewallx=castlex-dx;castlewally=castley+1.4;castlewallo1=0;
		drawcastlewall();
		castlewallx=castlex+dx;castlewally=castley;castlewallo1=180;
		drawcastlewall();
		castlewallx=castlex;castlewally=castley-dx;castlewallo1=90;
		drawcastlewall();
		castlewallx=castlex;castlewally=castley+dx;castlewallo1=-90;
		drawcastlewall();
		colorr=1;colorg=1;colorb=1;colora=1;
}		
var castletowerx=(xmax-xmin)*0.52,castletowery=(ymax-ymin)*0.52,castletowerz=0;
function drawcastletower(towerscale){
		if(Math.abs(x-castletowerx)>(distmap2)){return;}
        if(Math.abs(y-castletowery)>(distmap2)){return;}
		
if(rotavion(castletowerx-x,castletowery-y,castletowerz-z,7)>0){
        mvPushMatrix();
		mat4.translate(mvMatrix, [castletowerx,castletowery,castletowerz]);
		var sc=0.034*towerscale;
		mat4.scale(mvMatrix,[sc,sc,sc]);
	gl.activeTexture(gl.TEXTURE0);
    gl.bindTexture(gl.TEXTURE_2D,  castleTexture);
    gl.uniform1i(shaderProgram.samplerUniform, 0);
    
    gl.bindBuffer(gl.ARRAY_BUFFER, castletowerVertexTextureCoordBuffer);
    gl.vertexAttribPointer(shaderProgram.textureCoordAttribute, castletowerVertexTextureCoordBuffer.itemSize, gl.FLOAT, false, 0, 0);

    gl.bindBuffer(gl.ARRAY_BUFFER, castletowerVertexPositionBuffer);
    gl.vertexAttribPointer(shaderProgram.vertexPositionAttribute, castletowerVertexPositionBuffer.itemSize, gl.FLOAT, false, 0, 0);
    
    setMatrixUniforms(); 
    gl.drawArrays(gl.TRIANGLES, 0, castletowerVertexPositionBuffer.numItems);
		
		mvPopMatrix();
 }
}
var castlewallx=(xmax-xmin)*0.52,castlewally=(ymax-ymin)*0.52,castlewallz=0;
var castlewallo1=0;
function drawcastlewall(){
		if(Math.abs(x-castlewallx)>(distmap2)){return;}
        if(Math.abs(y-castlewally)>(distmap2)){return;}
		
if(rotavion(castlewallx-x,castlewally-y,castlewallz-z,7)>0){
        mvPushMatrix();
		mat4.translate(mvMatrix,[castlewallx,castlewally,castlewallz]);
		mat4.rotate(mvMatrix, degtorad(castlewallo1),[0, 0, 1]);
		mat4.translate(mvMatrix,[0,-0.2,0]);
		var sc=0.037;
		mat4.scale(mvMatrix,[sc,sc,sc]);
	gl.activeTexture(gl.TEXTURE0);
    gl.bindTexture(gl.TEXTURE_2D,  castleTexture);
    gl.uniform1i(shaderProgram.samplerUniform, 0);
    
    gl.bindBuffer(gl.ARRAY_BUFFER, castlewallVertexTextureCoordBuffer);
    gl.vertexAttribPointer(shaderProgram.textureCoordAttribute, castlewallVertexTextureCoordBuffer.itemSize, gl.FLOAT, false, 0, 0);

    gl.bindBuffer(gl.ARRAY_BUFFER, castlewallVertexPositionBuffer);
    gl.vertexAttribPointer(shaderProgram.vertexPositionAttribute, castlewallVertexPositionBuffer.itemSize, gl.FLOAT, false, 0, 0);
    
    setMatrixUniforms(); 
    gl.drawArrays(gl.TRIANGLES, 0, castlewallVertexPositionBuffer.numItems);
		
		mvPopMatrix();
 }
}
function drawtree(){
        mvPushMatrix();
	gl.activeTexture(gl.TEXTURE5);
    gl.bindTexture(gl.TEXTURE_2D,  treeTexture);
    gl.uniform1i(treeProgram.samplerUniform, 5);
    
    gl.bindBuffer(gl.ARRAY_BUFFER, treeVertexTextureCoordBuffer);
    gl.vertexAttribPointer(treeProgram.textureCoordAttribute, treeVertexTextureCoordBuffer.itemSize, gl.FLOAT, false, 0, 0);

    gl.bindBuffer(gl.ARRAY_BUFFER, treeVertexPositionBuffer);
    gl.vertexAttribPointer(treeProgram.vertexPositionAttribute, treeVertexPositionBuffer.itemSize, gl.FLOAT, false, 0, 0);
    
    setMatrixUniformstree(); 
    gl.drawArrays(gl.TRIANGLES, 0, treeVertexPositionBuffer.numItems);
		
		mvPopMatrix();
}
function drawgrass(){
        mvPushMatrix();
	gl.activeTexture(gl.TEXTURE11);
    gl.bindTexture(gl.TEXTURE_2D,  grassTexture);
    gl.uniform1i(treeProgram.samplerUniform, 11);
    
    gl.bindBuffer(gl.ARRAY_BUFFER, grassVertexTextureCoordBuffer);
    gl.vertexAttribPointer(treeProgram.textureCoordAttribute, grassVertexTextureCoordBuffer.itemSize, gl.FLOAT, false, 0, 0);

    gl.bindBuffer(gl.ARRAY_BUFFER, grassVertexPositionBuffer);
    gl.vertexAttribPointer(treeProgram.vertexPositionAttribute, grassVertexPositionBuffer.itemSize, gl.FLOAT, false, 0, 0);
    
    if(Math.random()<dtime*0.002){uwinddx=(Math.random()-0.5)*0.008;
	                              uwinddy=(Math.random()-0.5)*0.008;}
	setMatrixUniformsgrass(); 
    gl.drawArrays(gl.TRIANGLES, 0, grassVertexPositionBuffer.numItems);
		
		mvPopMatrix();
}
function drawflower(){
        mvPushMatrix();
	gl.activeTexture(gl.TEXTURE13);
    gl.bindTexture(gl.TEXTURE_2D,  flowerTexture);
    gl.uniform1i(treeProgram.samplerUniform, 13);
    
    gl.bindBuffer(gl.ARRAY_BUFFER, flowerVertexTextureCoordBuffer);
    gl.vertexAttribPointer(treeProgram.textureCoordAttribute, flowerVertexTextureCoordBuffer.itemSize, gl.FLOAT, false, 0, 0);

    gl.bindBuffer(gl.ARRAY_BUFFER, flowerVertexPositionBuffer);
    gl.vertexAttribPointer(treeProgram.vertexPositionAttribute, flowerVertexPositionBuffer.itemSize, gl.FLOAT, false, 0, 0);
    
    //if(Math.random()<dtime*0.002){uwinddx=(Math.random()-0.5)*0.008;
	//                              uwinddy=(Math.random()-0.5)*0.008;}
	setMatrixUniformsgrass(); 
    gl.drawArrays(gl.TRIANGLES, 0, flowerVertexPositionBuffer.numItems);
		
		mvPopMatrix();
}
var nskeleton=8+1,skeletonx=new Array(nskeleton),skeletony=new Array(nskeleton);
var skeletonz=new Array(nskeleton),tskeletonmove=new Array(nskeleton);
var skeletono1=new Array(nskeleton),tskeletonattack=new Array(nskeleton);
var skeletonvie=new Array(nskeleton);
nskeleton-=1;
function resetskeleton(){
  for(var i=0;i<=nskeleton;i++){
     tskeletonmove[i]=0;
     tskeletonattack[i]=0;
	 skeletonvie[i]=100;
     skeletono1[i]=parseInt(Math.random()*1.999);
     skeletonx[i]=x+(i+1)*14*cos1-i*sin1;
	 skeletony[i]=y+(i+1)*14*sin1+i*cos1;
	 if(i>=3){skeletonx[i]+=Math.random()*200;
	          skeletony[i]+=Math.random()*200;}
	 skeletonz[i]=getterrainheight(skeletonx[i],skeletony[i]);
  }
  skeletonvie[nskeleton]=200;//horse
}
var nouch=0;
function moveskeleton(){
 nouch=0;
 for(var i=0;i<nskeleton;i++){
   if (tframe>tskeletonmove[i]){
     tskeletonmove[i]=tframe+Math.random()*2000;
     var distmax=50,test=0;
     while(skeletonx[i]<(x-distmax)){skeletonx[i]+=1.9999*distmax;test=1;}
     while(skeletonx[i]>(x+distmax)){skeletonx[i]-=1.9999*distmax;test=1;}
     while(skeletony[i]<(y-distmax)){skeletony[i]+=1.9999*distmax;test=1;}
     while(skeletony[i]>(y+distmax)){skeletony[i]-=1.9999*distmax;test=1;}
     if(test==1){skeletonvie[i]=100;}else if(skeletonvie[i]<0){break;}
	 if(skeletono1[i]==0){skeletono1[i]=1}else{skeletono1[i]=0;}
     if(Math.random()>0.27){
	   if(tframe>tskeletonattack[i] && nouch<4){skeletonx[i]+=Math.sign((x-skeletonx[i])*(Math.random()-0.25))*0.4;
       }else{skeletonx[i]-=Math.sign((x-skeletonx[i])*(Math.random()-0.25))*0.4;};}
	 if(Math.random()>0.27){
	   if(tframe>tskeletonattack[i] && nouch<4){skeletony[i]+=Math.sign((y-skeletony[i])*(Math.random()-0.25))*0.4;
	   }else{skeletony[i]-=Math.sign((y-skeletony[i])*(Math.random()-0.25))*0.4;};}
	 skeletonz[i]=getterrainheight(skeletonx[i],skeletony[i]);
	 if(Math.abs(x-skeletonx[i])<0.7){
	   if(Math.abs(y-skeletony[i])<0.7 && tfoot==1){
	      nouch+=1;
	      if(tframe>tskeletonattack[i]){tskeletonattack[i]=tframe+1000;
		         if(Math.random()>0.3){setTimeout("soundouch();",500);
				    vie-=Math.random()*10;tblood=tframe;
				 }else{setTimeout("soundsword(0);",300);};}
	   }
	 }  
   }
  }
}
function attackskeletoncav(){
if(Math.random()>0.2){setTimeout("soundouch();",500);
   vie-=Math.random()*30;tblood=tframe;
   setTimeout("soundsword(2);",300);
}else{setTimeout("soundsword(2);",300);}
}
function attacksword(){
var nouch=0,ndead=0,dist=0.54,dvie=20;
var sx=x+0.8*cos1*cos2,sy=y+0.8*sin1*cos2,sz=z+0.8*sin2-0.4;
 if(weapon=="axe"){dist=0.42;dvie=30;}
 if(thorse==1){sz-=0.3;sx+=sin1*0.3;sy-=cos1*0.3;}
 for(var i=0;i<=nskeleton;i++){
    dist=0.54;if(i>=nskeleton){dist=0.7;}
    if(Math.abs(sx-skeletonx[i])<dist){
     if(Math.abs(sy-skeletony[i])<dist){
      if(Math.abs(sz-skeletonz[i])<dist){
	     var vie0=skeletonvie[i];
	     skeletonvie[i]-=Math.random()*20;
	     if(thorse==1){skeletonvie[i]-=Math.random()*20;ndead+=Math.random()*2;}
		 if(skeletonvie[i]<0){ndead+=1;if(vie0>=0){ndead+=10;}}
		 nouch+=1;
		 skeletono1[i]+=1;if(skeletono1[i]>1){skeletono1[i]=0;}
		 if(nouch==1){
		     var px=(sx+skeletonx[i])/2;
             var py=(sy+skeletony[i])/2;
			 var pz=(sz+skeletonz[i])/2+0.8;
			 if(i>=nskeleton){pz+=0.4;}
			 setTimeout("addimpact("+px+","+py+","+pz+",2);",120);}
	};};}	 
 }
if(ndead>10){setTimeout("soundskeleton2();",150);}
else if(ndead>0){setTimeout("soundskeleton();",150);}
if(nouch>0){setTimeout("soundsword(1);",150);}
soundslash();
tdrawarm=tframe; 
}
function drawskeleton(){
    moveskeleton();
	gl.activeTexture(gl.TEXTURE12);
    gl.uniform1i(treeProgram.samplerUniform, 12);
    for(var i=0;i<nskeleton;i++){
        if(tframe>tskeletonattack[i]){	
           gl.bindTexture(gl.TEXTURE_2D,  skeletonTexture);
        }else{ gl.bindTexture(gl.TEXTURE_2D,  skeletonattackTexture);}
		mvPushMatrix();
		if(skeletonvie[i]>=0){
		   mat4.translate(mvMatrix, [skeletonx[i],skeletony[i],skeletonz[i]-0.22]);
		   var scale=0.7;
		   mat4.scale(mvMatrix,[scale,scale,scale]);
		}else{   
		   mat4.translate(mvMatrix, [skeletonx[i],skeletony[i],skeletonz[i]-0.22]);
		   var scale=0.7;
		   mat4.scale(mvMatrix,[scale,scale,-scale]);
		   mat4.translate(mvMatrix, [0,0,-1.75]);
		   //mat4.rotate(mvMatrix, degtorad(90), [1, 0, 0]);}
		}
    gl.bindBuffer(gl.ARRAY_BUFFER, carreVertexTextureCoordBuffer);
    gl.vertexAttribPointer(treeProgram.textureCoordAttribute, carreVertexTextureCoordBuffer.itemSize, gl.FLOAT, false, 0, 0);

    gl.bindBuffer(gl.ARRAY_BUFFER, carreVertexPositionBuffer);
    gl.vertexAttribPointer(treeProgram.vertexPositionAttribute, carreVertexPositionBuffer.itemSize, gl.FLOAT, false, 0, 0);
    
	if(skeletono1[i]==1){setMatrixUniformsskeleton(1);
    }else{setMatrixUniformsskeleton(-1);}	
    gl.drawArrays(gl.TRIANGLES, 0, carreVertexPositionBuffer.numItems);
		mvPopMatrix();	
	};	
}
var potionx=x+Math.random()*200,potiony=y,potionz=0;
function drawpotion(){
   if(tfoot==1){
	if(Math.abs(x-potionx)<0.7){
	  if(Math.abs(y-potiony)<0.7){
	     soundping();vie=100;
	     potionx+=(Math.random()-0.5)*200;
		 potiony+=(Math.random()-0.5)*200;
	};};}
    var distmax=80,test=0;
    while(potionx<(x-distmax)){potionx+=1.9999*distmax;test=1;}
    while(potionx>(x+distmax)){potionx-=1.9999*distmax;test=1;}
    while(potiony<(y-distmax)){potiony+=1.9999*distmax;test=1;}
    while(potiony>(y+distmax)){potiony-=1.9999*distmax;test=1;}
    potionz=getterrainheight(potionx,potiony);

	var dx=x-potionx,dy=y-potiony;
    if(Math.abs(dx)>(distmap2)){return;}
    if(Math.abs(dy)>(distmap2)){return;}

    gl.activeTexture(gl.TEXTURE12);
    gl.uniform1i(treeProgram.samplerUniform, 12);
    gl.bindTexture(gl.TEXTURE_2D,  potionTexture);
 	mvPushMatrix();
    mat4.translate(mvMatrix, [potionx,potiony,potionz-0.2]);
    var scale=0.7;
    mat4.scale(mvMatrix,[scale,scale,scale]);
    gl.bindBuffer(gl.ARRAY_BUFFER, carreVertexTextureCoordBuffer);
    gl.vertexAttribPointer(treeProgram.textureCoordAttribute, carreVertexTextureCoordBuffer.itemSize, gl.FLOAT, false, 0, 0);

    gl.bindBuffer(gl.ARRAY_BUFFER, carreVertexPositionBuffer);
    gl.vertexAttribPointer(treeProgram.vertexPositionAttribute, carreVertexPositionBuffer.itemSize, gl.FLOAT, false, 0, 0);
    
	setMatrixUniformsskeleton(1);	
    gl.drawArrays(gl.TRIANGLES, 0, carreVertexPositionBuffer.numItems);
		mvPopMatrix();	
}
function drawstar(){
    gl.disable(gl.DEPTH_TEST);
    gl.enable(gl.BLEND);
    gl.blendFunc(gl.SRC_ALPHA, gl.ONE);
        mvPushMatrix();
		mat4.translate(mvMatrix, [x,y,z]);
    
    gl.bindBuffer(gl.ARRAY_BUFFER, starVertexTextureCoordBuffer);
    gl.vertexAttribPointer(starProgram.textureCoordAttribute, starVertexTextureCoordBuffer.itemSize, gl.FLOAT, false, 0, 0);

    gl.bindBuffer(gl.ARRAY_BUFFER, starVertexPositionBuffer);
    gl.vertexAttribPointer(starProgram.vertexPositionAttribute, starVertexPositionBuffer.itemSize, gl.FLOAT, false, 0, 0);
    
    colora=Math.abs(12-hour)/20;
	setMatrixUniformsstar();
    colora=1;	
    gl.drawArrays(gl.TRIANGLES, 0, starVertexPositionBuffer.numItems);
		
		mvPopMatrix();
    gl.enable(gl.DEPTH_TEST);
    gl.disable(gl.BLEND);
}
function drawtir(){
    gl.disable(gl.DEPTH_TEST);
    gl.enable(gl.BLEND);
    gl.blendFunc(gl.SRC_COLOR, gl.ONE_MINUS_SRC_COLOR);
        mvPushMatrix();
		//mat4.scale(mvMatrix,[0.1,0.1,0.1]);
	gl.activeTexture(gl.TEXTURE7);
    gl.bindTexture(gl.TEXTURE_2D,  tirTexture);
    gl.uniform1i(shaderProgram.samplerUniform, 7);
    
    gl.bindBuffer(gl.ARRAY_BUFFER, tirVertexTextureCoordBuffer);
    gl.vertexAttribPointer(shaderProgram.textureCoordAttribute, tirVertexTextureCoordBuffer.itemSize, gl.FLOAT, false, 0, 0);

    gl.bindBuffer(gl.ARRAY_BUFFER, tirVertexPositionBuffer);
    gl.vertexAttribPointer(shaderProgram.vertexPositionAttribute, tirVertexPositionBuffer.itemSize, gl.FLOAT, false, 0, 0);
    
    setMatrixUniforms(); 
    gl.uniform4f(shaderProgram.colorUniform,0.7,0.57,0.57,0.0);
    gl.drawArrays(gl.TRIANGLES, 0, tirVertexPositionBuffer.numItems);
		
		mvPopMatrix();
	gl.disable(gl.BLEND);
    gl.enable(gl.DEPTH_TEST);
}
var nimpact=14,nimpact2=4,iimpact=0;
var impactx=new Array(nimpact),impacty=new Array(nimpact),impactz=new Array(nimpact);
var timpact=new Array(nimpact),typeimpact=new Array(nimpact);
var impacto1=new Array(nimpact);
function addimpact(px,py,pz,type){
iimpact+=1;if(iimpact>=nimpact || iimpact>=nimpact2){iimpact=0;}
impactx[iimpact]=px;
impacty[iimpact]=py;
impactz[iimpact]=pz;
timpact[iimpact]=tframe;
typeimpact[iimpact]=type;
if(Math.random()<0.5){impacto1[iimpact]=0;}else{impacto1[iimpact]=1;}
}
function addimpact2(px,py,pz,type){
iimpact+=1;if(iimpact>=nimpact){iimpact=0;}
impactx[iimpact]=px;
impacty[iimpact]=py;
impactz[iimpact]=pz;
timpact[iimpact]=tframe;
typeimpact[iimpact]=type;
if(Math.random()<0.5){impacto1[iimpact]=0;}else{impacto1[iimpact]=1;}
}
function drawimpact(){
    gl.disable(gl.DEPTH_TEST);
    gl.enable(gl.BLEND);
    gl.blendFunc(gl.ONE_MINUS_SRC_COLOR, gl.ONE);//SRC_COLOR);
	gl.activeTexture(gl.TEXTURE8);
    gl.bindTexture(gl.TEXTURE_2D,  impactTexture);
    gl.uniform1i(shaderProgram.samplerUniform, 8);
    for(var i=0;i<nimpact;i++){
      var dt=3500;if(typeimpact[i]==2){dt=1000;}	
      if(tframe<(timpact[i]+dt)){	
        mvPushMatrix();
		mat4.translate(mvMatrix, [impactx[i],impacty[i],impactz[i]]);
        mat4.rotate(mvMatrix, degtorad(o1), [0, 0, 1]);
		var dx=impactx[i]-x,dy=impacty[i]-y,dz=impactz[i]-(z+0.5);
		var dist=Math.sqrt(dx*dx+dy*dy+dz*dz);
        mat4.rotate(mvMatrix, degtorad(90-o2), [0, 1, 0]);
		var sc=1;
		if(typeimpact[i]==1){sc=(1.0+(tframe-timpact[i])/300);if(sc>3){sc=3+(sc-3)*0.2;};
		   sc*=0.022;
		}else{sc=(1.8+(tframe-timpact[i])/100);if(sc>3){sc=3+(sc-3)*0.2;};
		   sc*=0.002;colorr=Math.max(1,(0.0057/sc)*dist*1.7);
		   colorg=colorr;colorb=colorr;colora=0.75;
		}
		if(impacto1[i]<0.5){mat4.scale(mvMatrix,[sc,sc,sc]);
		}else{mat4.scale(mvMatrix,[-sc,-sc,sc]);}
		drawcarre();
		mvPopMatrix();
		colorr=1;colorg=1;colorb=1;colora=1;
	  };	
	};	
	gl.disable(gl.BLEND);
    gl.enable(gl.DEPTH_TEST);
}
var nsmoke=30,ismoke=0;
var smokex=new Array(nsmoke),smokey=new Array(nsmoke),smokez=new Array(nsmoke);
var tsmoke=new Array(nsmoke),vsmoke=new Array(nsmoke),sizesmoke=new Array(nsmoke);
var typesmoke=new Array(nsmoke),ttsmoke=0;
function addsmoke(px,py,pz,size,type){
ismoke+=1;if(ismoke>=nsmoke){ismoke=0;}
smokex[ismoke]=px;
smokey[ismoke]=py;
smokez[ismoke]=pz;
tsmoke[ismoke]=timer();
vsmoke[ismoke]=vplane;
sizesmoke[ismoke]=size;
typesmoke[ismoke]=type;
}
function drawsmoke(){
    gl.disable(gl.DEPTH_TEST);
    gl.enable(gl.BLEND);
    gl.blendFunc(gl.SRC_ALPHA, gl.ONE);//_MINUS_SRC_ALPHA);
	gl.activeTexture(gl.TEXTURE3);
    gl.bindTexture(gl.TEXTURE_2D,  cloudTexture);
    gl.uniform1i(shaderProgram.samplerUniform, 3);
    for(var i=0;i<nsmoke;i++){ 
      if(tframe<(tsmoke[i]+5000+(sizesmoke[i]-1)*1700)){	
        mvPushMatrix();
		var dt=dtime;if(dt>120){dt=120;}
		if(sizesmoke[i]<2){
		 var dv=vsmoke[i]*dt*0.0125;
		 vsmoke[i]-=vplane*dt*0.00048;
		 smokez[i]+=dv*sin2;
		 smokex[i]+=dv*cos1*cos2;
		 smokey[i]+=dv*sin1*cos2;
		 smokez[i]+=dt*0.0001*(2+Math.random());
		}
		if(typesmoke[i]==1){smokez[i]+=dt*0.0005*(2+Math.random());}
		mat4.translate(mvMatrix, [smokex[i],smokey[i],smokez[i]]);
        mat4.rotate(mvMatrix, degtorad(o1), [0, 0, 1]);
        mat4.rotate(mvMatrix, degtorad(90+o2), [0, 1, 0]);
		var sc=((1+vplane*1.8)*(0.3+tframe-tsmoke[i])/500);if(sc>3){sc=3+(sc-3)*0.2;};
		sc*=0.0020*sizesmoke[i];
		mat4.scale(mvMatrix,[sc,sc,sc]);
		drawcarre();
		mvPopMatrix();
	  };	
	};	
	gl.disable(gl.BLEND);
    gl.enable(gl.DEPTH_TEST);
}
    var tframe=0,tframe0=0,tfps=30,fps=10,dtime=1,tmsg=0,clearr,clearg,clearb,tskip=0;
	var ttimeout=0,testloop=1,itime=0,fpsmoy=10,tfpsmoy=30;
	function tick(tt) {
	    itime+=1;if(itime>1001){itime=0;}
        //requestAnimFrame(tick);
		if(tclose==0 && testloop==0 && ttimeout==0){testloop=1;requestAnimFrame(tick);
        }else{testloop=0;};
		if(vie<-19 && tfoot==1){soundaah();alertwait("you are dead !");vie=70;
		   for(var i=0;i<nskeleton;i++){skeletonvie[i]=100;};
		   var sc=0.7;resetkeys();skeletonvie[nskeleton]=200;
		   addsmoke(x+cos1*cos2*sc+(0.5-Math.random())/6,y+sin1*cos2*sc+(0.5-Math.random())/6,z+sin2*sc,1,0);}
		if(waitkey==0){testkeys();}else{subwaitkey();}
		tskip=0;
		if(waitkey>=1){tskip=1;}
		if(x<xmin){x+=xmax-xmin;px+=xmax-xmin;p3x+=xmax-xmin;nmap2*=2;tskip=1;};
		if(x>xmax){x-=xmax-xmin;px-=xmax-xmin;p3x-=xmax-xmin;nmap2*=2;tskip=1;};
		if(y<ymin){y+=ymax-ymin;py+=ymax-ymin;p3y+=ymax-ymin;nmap2*=2;tskip=1;};
		if(y>ymax){y-=ymax-ymin;py-=ymax-ymin;p3y-=ymax-ymin;nmap2*=2;tskip=1;};
		var aux=1-0.45*Math.abs(12-hour)/12;
   	    var aux2=1-0.3*Math.abs(12-hour)/12;
   	    var aux3=1-0.2*Math.abs(12-hour)/12;
        if(hour<5 || hour>19){		
		//  var aux4=Math.abs(12-hour)/3000;
        //  gl.clearColor(aux4,aux4,aux4, 1.0);
		//}else{gl.clearColor(0,0,0, 1.0);};
		}else{gl.clearColor(0,0,0, 1.0);
		if(tskip==0){drawrttshadow();};}
        //gl.clearColor(0.70*aux3, 0.70*aux, 1.0*aux2, 1.0);
        gl.clearColor(0.38, 0.38, 0.38, 1.0);
        clearr=0.70*aux3;clearg=0.70*aux;clearb=1.0*aux2;
		if(fpsmoy>10 || trot2==0 || tfoot==0){if(tskip==0){drawscene(47/47);}
        }else{if(tskip==0){drawrttscene();};}
		if(vie<-19 && tfoot==1){drawblood();}
		scrollTo(winx,winy);
		tframe0=tframe;
		tframe=timer();
		dtime=tframe-tframe0;if(dtime>5000){dtime=5000;}
		tfps+=(tframe-tframe0-tfps)*0.3;//0.2;
		if(tfps<1){tfps=1;}
		if(tfps>1000){tfps=1000;}
		fps=1000/tfps;
		tfpsmoy+=(tframe-tframe0-tfpsmoy)*0.05;
		if(tfpsmoy<tfps){tfpsmoy=tfps;}
		if(tfpsmoy>1000){tfpsmoy=1000;}
		fpsmoy=1000/tfpsmoy;	
		var dt=(tframe0+25-tframe);
		if(dt<10){dt=10};
		if(tclose==0 && ttimeout){timeouttick=setTimeout("tick(0);",dt);
           }else{
		   //if(tclose==0){requestAnimationFrame(tick);};
           //if(tclose==0){requestAnimFrame(tick);};}
           if(tclose==0 && testloop==0){testloop=1;requestAnimFrame(tick);
		     }else{testloop=0;};}
		//if(tclose==0){timeouttick=setTimeout("tick(0);",dt);}
        //if(tclose==0){requestAnimationFrame(tick);};
        //if(tclose==0){requestAnimFrame(tick);};
   }

    function webGLStart() {
        var canvas = document.getElementById("canvas");
        submsg("initgl");
		initGL(canvas);
		if(!gl){return;}
        var canvas2 = document.getElementById("canvas2");
        submsg("initctx");
		initctx(canvas2);
        initShaders();
		submsg("initmodels");
        loadWorld();
		submsg("inittextures");
        initTexture();
	    webGLStart2();
    }
    function webGLStart2(){
        if(!solTexturedata){setTimeout("webGLStart2();",500);return;}	
        submsg("initbuffers");
		initBuffers();
		
        gl.clearColor(0.70, 0.70, 1.0, 1.0);
        gl.enable(gl.DEPTH_TEST);

        tkey=timer();tdisplay=timer()+4000;
        testkeys();
		if(tsea>0){resetcarrier();resetsailships();}
		if(fullscreen==1){fullscreen=0;sizescreen();}
		resetskeleton();
        setTimeout("tick(0);",1000);
		setTimeout("speakweather();",11000);
		setTimeout("deletejsfilelist();",20000);
        //if(tclose==0){requestAnimationFrame(tick);};
        //if(tclose==0){requestAnimFrame(tick);};
   }

var timer0=0,timer1=0;
function timer(){
return Date.now();
return (new Date()).getTime();//ms
}
var keys=new Array(256),keys0=new Array(256),tkeys=new Array(256),tkey=0;
var pkeys=new Array(256);
function resetkeys(){
 for(var i=0;i<256;i++){keys[i]=0;keys0[i]=0;tkeys[i]=0;}
}
resetkeys();
 function keydown(e){
var key=eval(e.which || e.keyCode);
var t=timer();
if(key>0 && key<256){keys[key]=1;tkeys[key]=t;if(keys0[key]==0){keys0[key]=1;}}
//if(tkey>(t-40000)){tkey=t;}else{tkey=t;}//testkeys();}
if(key!=waitkey){waitkey=0;}
}
function keyup(e){
var key=eval(e.which || e.keyCode);
if(key>0 && key<256){keys[key]=0;keys0[key]=0;}
//var t=timer();
//for(var i=16;i<=40;i++){if(tkeys[i]<(t-40000)){keys[i]=0;keys0[i]=0;tkeys[i]=t;};}
i=vk_left;if(tkeys[i]<(t-10000)){keys[i]=0;keys0[i]=0;tkeys[i]=t;}
i=vk_right;if(tkeys[i]<(t-10000)){keys[i]=0;keys0[i]=0;tkeys[i]=t;}
}
var thelp=0;
function subhelp(){
//var crlf=String.fromCharCode(13)+String.fromCharCode(10);
var crlf=String.fromCharCode(10);
var msg="H => help  / P => pause"+crlf;
msg+="esc => quit"+crlf;
msg+="arrows keys ,1,2 => rotate"+crlf;
msg+="pageup/pagedown or ctrl+arrows or B/N => motor"+crlf;
msg+="T => tourelle/horse  /  shift+T => change timehour"+crlf;
msg+="V => plane/tourelle/cockpit view  /  shift => horse run"+crlf;
msg+="Shift + arrow key => rotate cockpit view"+crlf;
msg+="C => number of clouds  /  L => link URL"+crlf;
msg+="space => shoot"+crlf;
msg+="F => weapon sword/axe"+crlf;//cessna/spitfire/zero/corsair"+crlf;
msg+="alt+S => settimeout/requestanim mode"+crlf;
msg+="R => radio message  /  W => water/ground"+crlf;
msg+="M => map   /   A => viseur"+crlf;
msg+="shift+S => save/delete game cookie"+crlf;
msg+="K => foot/plane   /   Z => trees height"+crlf;
//msg+="joystick and gamepad supported";
alert(msg);
thelp+=1;if(thelp>1){thelp=0;}	 
ctx.fillStyle="Red";
if(thelp==1){ctxtext(msg, 1, 1);}else{ctxtext("",1,1);}
document.getElementById('intext').focus();
}
function ctxtext(msg,ix,iy){
ctx.clearRect (0,0,ctx.width,ctx.height);
ctx.font = "10pt Arial";
var i=0,j=1,lf=String.fromCharCode(10),li=10,col=10;
var txt=msg+lf;
col=ix;li=iy+12;
for(var k=0;k<999;k++){j=txt.indexOf(lf);
   if(j>0){ctx.fillText(txt.substr(0,j),col,li);}
   if(j>0){li+=13;txt=txt.substr(j+1,999);}else{break;}
   }   
}
var tavatar=0;
function subavatar(){return;
tavatar+=1;if(tavatar>1){tavatar=0;}
ctx.clearRect (0,0,ctx.width,ctx.height);
if(tavatar==1){ctx.drawImage(faceimage,0,0,ctx.width,ctx.height);
}
}
var vplane=0,dmx=0,dmy=0,dmz=0,vplanez=0,tclock=0,tvie=0,tvie0=0,tsea=0;
var plane="c150",vrunmax=1.30;
var searchtxt="",parms=[],iparm=0;
function addparm(parm){
   searchtxt+=(parseInt(parm*1000)/1000)+"&";
}
function initparms(){
  if(Math.random()<0.5){tsea=1;if(Math.random()<0.5){tsea=2;};}
  var seedrand0=seedrand;
  windy=windymax;
  windx=Math.min(windxmax,windymax*620/430);
  var hash0=document.location.search;//parent.location.hash;
  if(hash0.indexOf("reset",0)>=0 || hash0.indexOf("nocook",0)>=0){hash0="";
  }else{readcookie();}
  if(seedrand0==seedrand){x-=30;y+=20;}
  //seedrand=parseInt(seedrand%(1000+(new Date()).getMonth()));
  tfoot=1;o2=0;
  tsea=0;plane="c150";
  getparms(hash0);
  }
function evaln(n){if(isNaN(eval(n))){return 0;}else{return eval(n);};}
function getparms(hash){
  if(hash!=""){parms=[];parms=hash.split("&");
    tsea=evaln(parms[0].substr(1,parms[0].length-1));
    var i=1,n=parms.length-1;
	if(tsea==99){tsea=0;//called from blogspot to get wclouds
       wclouds=evaln(parms[i]);i+=1;if(i>=n){return;}
	   return;
	}
	x=evaln(parms[i]);i+=1;if(i>=n){return;}
    y=evaln(parms[i]);i+=1;if(i>=n){return;}
	z=evaln(parms[i]);i+=1;if(i>=n){return;}
	o1=evaln(parms[i]);i+=1;if(i>=n){return;}
    o2=evaln(parms[i]);i+=1;if(i>=n){return;}
	o3=evaln(parms[i]);i+=1;if(i>=n){return;}
	vplane=evaln(parms[i]);i+=1;if(i>=n){return;}
    vrun=evaln(parms[i]);i+=1;if(i>=n){return;}
	vrunmax=evaln(parms[i]);i+=1;if(i>=n){return;}
	tourelle=evaln(parms[i]);i+=1;if(i>=n){return;}
	seedrand=evaln(parms[i]);i+=1;if(i>=n){return;}
	px=evaln(parms[i]);i+=1;if(i>=n){return;}
    py=evaln(parms[i]);i+=1;if(i>=n){return;}
	pz=evaln(parms[i]);i+=1;if(i>=n){return;}
	po1=evaln(parms[i]);i+=1;if(i>=n){return;}
    po2=evaln(parms[i]);i+=1;if(i>=n){return;}
	po3=evaln(parms[i]);i+=1;if(i>=n){return;}
	pvplane=evaln(parms[i]);i+=1;if(i>=n){return;}
    pvrun=evaln(parms[i]);i+=1;if(i>=n){return;}
	shipx=evaln(parms[i]);i+=1;if(i>=n){return;}
    shipy=evaln(parms[i]);i+=1;if(i>=n){return;}
	shipz=evaln(parms[i]);i+=1;if(i>=n){return;}
	shipo1=evaln(parms[i]);i+=1;if(i>=n){return;}
	shipcarrierx=evaln(parms[i]);i+=1;if(i>=n){return;}
    shipcarriery=evaln(parms[i]);i+=1;if(i>=n){return;}
	shipcarrierz=evaln(parms[i]);i+=1;if(i>=n){return;}
	shipcarriero1=evaln(parms[i]);i+=1;if(i>=n){return;}
	plane=parms[i];i+=1;if(i>=n){return;}
	p3x=evaln(parms[i]);i+=1;if(i>=n){return;}
    p3y=evaln(parms[i]);i+=1;if(i>=n){return;}
	p3z=evaln(parms[i]);i+=1;if(i>=n){return;}
	p3o1=evaln(parms[i]);i+=1;if(i>=n){return;}
    p3o2=evaln(parms[i]);i+=1;if(i>=n){return;}
	p3o3=evaln(parms[i]);i+=1;if(i>=n){return;}
	p3vplane=evaln(parms[i]);i+=1;if(i>=n){return;}
    p3vrun=evaln(parms[i]);i+=1;if(i>=n){return;}
    icombo=evaln(parms[i]);i+=1;if(i>=n){return;}
    fullscreen=evaln(parms[i]);i+=1;if(i>=n){return;}
    treescale=evaln(parms[i]);i+=1;if(i>=n){return;}
    thorse=evaln(parms[i]);i+=1;if(i>=n){return;}
if(icombo){document.getElementById('combo').selectedIndex=icombo;
           setTimeout("subcombo();",500);}
	}
}
function setlink(){
  tclose=1;
  alert("copy the adress bar to link to this place later");
  setsearchtxt();
  document.location.search=searchtxt;  
}
function setsearchtxt(){
  searchtxt="";
  addparm(tsea);
  addparm(x);
  addparm(y);
  addparm(z);
  addparm(o1);
  addparm(o2);
  addparm(o3);
  addparm(vplane);
  addparm(vrun);
  addparm(vrunmax);
  addparm(tourelle);
  addparm(seedrand);
  addparm(px);
  addparm(py);
  addparm(pz);
  addparm(po1);
  addparm(po2);
  addparm(po3);
  addparm(pvplane);
  addparm(pvrun);
  addparm(shipx);
  addparm(shipy);
  addparm(shipz);
  addparm(shipo1);
  addparm(shipcarrierx);
  addparm(shipcarriery);
  addparm(shipcarrierz);
  addparm(shipcarriero1);
  searchtxt+=plane+"&";
  addparm(p3x);
  addparm(p3y);
  addparm(p3z);
  addparm(p3o1);
  addparm(p3o2);
  addparm(p3o3);
  addparm(p3vplane);
  addparm(p3vrun);
  addparm(icombo);
  addparm(fullscreen);
  addparm(treescale);
  addparm(thorse);
}
function readcookie(){
var mycookie=document.cookie+";";
//alert("mycookie="+mycookie);
var pref="forest_chung=";
var i=mycookie.indexOf(pref,0);
if(i<0){return;}
i+=pref.length;
var j=mycookie.indexOf(";",i);
if(j<i){return;}
var mycookie=mycookie.substring(i,j);
//alert(mycookie);
var hash0="?"+mycookie;getparms(hash0);
}
function savecookie(){
var mycookie="";
var cookie0=document.cookie;
setsearchtxt();
mycookie+=searchtxt;
//alert(mycookie);  
var pref="forest_chung=";
mycookie =pref+mycookie+"; expires=Fri, 3 Aug 2100 20:47:11 UTC; path=/";
if(mycookie.length>(3900-cookie0.length)){alert("could not save, cookie too long");return;}
document.cookie=mycookie;
}
function deletecookie(){
var pref="forest_chung=";
document.cookie =pref+";expires=Thu, 01 Jan 1970 00:00:01 GMT; path=/";
}
function subcookie(){
  if(confirm("save game cookie ?")){savecookie();alert("cookie saved");
  }else if(confirm("delete gamesave cookie ?")){
           deletecookie();alert("cookie deleted");}
}
function alertwait(msg){
  var t=timer(),t2=timer();
  while(timer()<(t+4000)){
    alert(msg);t2=timer();while(timer()<(t2+1000)){}}
}
var tfocus=1,tdisplay=0,x0=0,y0=0,z0=0,tfoot=0,o22=7.8;
var o10=0,o20=0,o30=0;
function testkeys() {
if(tskip==0){x0=x;y0=y;z0=z;}
if(tmsg<(tframe-150)){tmsg=tframe;
 var xx=Math.round(x),yy=Math.round(y),zz=Math.round(z),oo1=Math.round(o1),vv=Math.round(vplane*2000)/10;
 var pp=Math.round(vrun*1000)/10,oo2=Math.round(o2),ff=Math.round(fps),oo3=Math.round(o3);
 var msg="x="+xx+"  y="+yy+"  z="+zz+"  v="+vv+"  prop="+pp;
 if(test==1){msg+="  o1="+oo1+" o2="+oo2+" o3="+oo3;};
 msg+=" fps="+ff;
 if(Math.abs(tvie0-vie)>0.001){tvie0=vie;if(vie!=100){tvie=tframe;};}
 if(tframe<(tvie+5000)){msg+=" vie="+parseInt(vie);}
 if(ttimeout){msg+=" timeout";}
 if(tframe<tdisplay+10000){msg+=" clouds="+wclouds;}
 if(auxvar!=null){msg+=" aux="+auxvar;}
 if(auxvar2!=null){msg+=" aux2="+auxvar2;}
 if(tfoot==1){msg+=" foot";}else if(tourelle==1){msg+=" tourelle";}
 if(tframe<tradio+25000){msg=radiotxt.substr(0,parseInt((tframe-tradio)/110));tmsg=tframe-120;
    if(tframe>tradio+12000){if(Math.cos((tframe-tradio)*0.004)>0.59){msg="";};};}
 document.getElementById('intext0').value=msg;
 if(tfocus){document.getElementById('intext').focus();}
 setvolume();
 }
if(tclock<tframe-5000){tclock=tframe;var hh=parseInt(hour),mn=parseInt((hour-hh)*60);
 if(mn<10){mn="0"+mn;};
 document.getElementById('clock').value=hh+":"+mn;
 }
if(tframe>timejoy){timejoy=tframe+80;//testjoystick();
}
//timer0=timer1;timer1=timer();
//if (tkey>(timer1-300000)){
	var dt=dtime;//timer1-timer0;
	if(dt>300){dt=300;}
    o10=o1;o20=o2;o30=o3;
	if(tfoot==1){z=zsol+0.27;vplane=0;landing=1;tpiste=1;vrun=0;o3=0;
	 //if(thorse==1){z=zsol+1.12;if(o2<-40){o2=-40;};}
	 if(thorse==1){z=zsol+0.92;if(o2<-40){o2=-40;};}
     if(tcollide==1){x-=dt*0.008*cos1;y-=dt*0.008*sin1;tcollide=0;
	     if(thorse==1){if(parseInt(tframe/20000)%2){
		               x-=dt*0.005*sin1;y+=dt*0.005*cos1;
		               }else{x+=dt*0.005*sin1;y-=dt*0.005*cos1;};
					   if(Math.random()<0.25){soundhorse();};}
		 }
	 var test=0;
	 if (keys[37] || joyx<-0.5){test=1;o1+=dt*0.07;if(o1>180){o1-=360;o10-=360;};}
     if (keys[39] || joyx>0.5){test=1;o1-=dt*0.07;if(o1<-180){o1+=360;o10+=360;};}	  
     if (thorse==1 && vhorse>1){test=0.97;x+=dt*0.002*cos1;y+=dt*0.002*sin1;
	     var dz=getterrainheight(x+cos1,y+sin1);
		 if((dz>z+1.7*degtorad(o2-o22)) && (o2<o22+10)){o2+=0.030*dt;}
		 if((dz<z-1.7*degtorad(o2-o22)) && (o2>o22-10)){o2-=0.030*dt;}
		 }
     if (keys[38] || joyy<-0.5){test=1.5;x+=dt*0.004*cos1;y+=dt*0.004*sin1;
	     var dz=getterrainheight(x+cos1,y+sin1);
		 if((dz>z+1.7*degtorad(o2-o22)) && (o2<o22+10)){o2+=0.030*dt;}
		 if((dz<z-1.7*degtorad(o2-o22)) && (o2>o22-10)){o2-=0.030*dt;}
		 }
     if (keys[40] || joyy>0.5){test=1;x-=dt*0.003*cos1;y-=dt*0.003*sin1;
	     var dz=getterrainheight(x+cos1,y+sin1)-z;
		 if((dz>sin2 && sin2<0.2)||(dz<sin2 && sin2>-0.2)){o2-=0.003*dt*o2;}
		 vhorse=0;
		 }	  
     if (keys[vk_page_up] || joyz>0.5) {o2+=dt*0.04;if(o2>80){o2=79;};
	                                    o22+=dt*0.04;if(o22>70){o22=69;}}
     if (keys[vk_page_down] || joyz<-0.5) {o2-=dt*0.04;if(o2<-80){o2=-79;};
	                                       o22-=dt*0.04;if(o22<-70){o22=-69;}}	  
	 if(test>=0.1){if(zsol<-0.51 || (zsol<-0.34 && tsea>0)){soundwater();
	                }else if(thorse==1){soundfoot();};}
	 if(test>=0.1 && thorse==1){tmovehorse=test;}else{tmovehorse-=dtime*0.0003;}
	 if(tmovehorse<0){tmovehorse=0;}
	}
    //left=37,up=38,right=39,down=40,pageup=33,pagedown=34,m=77,esc=27,h=72,shift=16
    //p=80,T=84,V=86,b=66,n=78,ctrl=17,l=76,space=32,c=67,w=87,f=70,s=83,r=82
    if (keys[vk_z]) {keys[vk_z]=0;treescale+=1;if(treescale>7){treescale=1;};}
	if (keys[vk_k]) {keys[vk_k]=0;tfoot+=1;if(tfoot>1){tfoot=0;};}
    if (keys[vk_a] || b(5)){
       if(tfoot==0){keys[vk_a]=0;tviseur+=1;if(tviseur>1){tviseur=0;};}
       else{subavatar();resetkeys();}}
	if (keys[vk_m]){if(keys[vk_shift]==0){keys[vk_m]=0;submap();}
	                else{seedrand+=0.01;alert("seedrand="+seedrand);
					     reinitsol();resetkeys();}}  
	if (keys[76]) {keys[76]=0;tclose=1;setlink();return;};
    if (keys[87]) {keys[87]=0;tsea+=1;if(tsea>2){tsea=0;};
	               reinitsol();}
				   //document.location.search=tsea+"&"+x+"&"+y+"&"+z+"&"+o1+"&"+o2+"&"+o3+"&"+vplane+"&"+vrun+"&"+vie+"&"+plane+"&"+tourelle+"&"+vrunmax;}
	if (keys[82]) {keys[82]=0;subradio();}
	if (keys[83] && keys[vk_alt]) {keys[83]=0;ttimeout+=1;if(ttimeout>1){ttimeout=0;};}
	if (keys[83] && keys[vk_shift]) {subcookie();resetkeys();}
	else if(thorse==1 && keys[vk_shift]){keys[vk_shift]=0;vhorse=2;}
	if (keys[70] || b(6)){keys[70]=0;keys[32]=1;
	                      if(weapon=="sword"){weapon="axe";}
	                      else{weapon="sword";}
						 }
	/*if (keys[70] || b(6)) {keys[70]=0;var vrunmax0=vrunmax;
	   if(plane=="c150"){plane="spitfire";vrunmax=1.70;
	   }else if(plane=="spitfire"){plane="zero";vrunmax=1.50;
	   }else if(plane=="zero"){plane="corsair";vrunmax=1.65;
	   }else{plane="c150";vrunmax=1.30;};
	   vrun*=vrunmax/vrunmax0;}*/
	if (keys[67]) {keys[67]=0;tdisplay=tframe;ncloud2-=15;if(ncloud2<1){ncloud2=ncloud;};}
	if (keys[32] || button[3] || button[7]) {keys[32]=0;
	        if(tfoot==0){if(tframe>(tkeytir+80)){soundshoot();tir();};
			}else{if(tframe>(tkeytir+300)){tkeytir=tframe+9000;attacksword();};
			};
	}else{if(tfoot==1){tkeytir=0;};}
	if (keys[86] || b(8)) {keys[86]=0;tourelle+=1;if(tourelle>3){tourelle=0;};
	               if(tourelle==0){ko1=to1;ko2=to2;};
				   if(tourelle==1){tourelle=2;to1=to11;to2=to21;};
				   if(tourelle==2){to11=to1;to21=to2;to1=ko1;to2=ko2;};}
	if (keys[84] && keys[16]) {thour+=3.5;if(thour>24){thour-=24;};
	    hour=new Date().getHours()+thour;
		while(hour>24){hour-=24;}
		while(hour<0){hour+=24;}
	    alert("timehour = "+hour);keys[84]=0;keys[16]=0;}
	if ((keys[84] && keys[16]==0)|| b(4)){keys[84]=0;
	  if(tfoot==0){
	   if(tourelle==1){tourelle=tourelle0;}else{tourelle0=tourelle;tourelle=1;};
	   	           if(tourelle==0){to11=to1;to21=to2;};
				   if(tourelle==1){if(tourelle0>=2){ko1=to1;ko2=to2;};
				                   to1=to11;to2=to21;};
				   if(tourelle>=2){to11=to1;to21=to2;to1=ko1;to2=ko2;};
      }else{thorse+=1;if(thorse>1){thorse=0;vhorse=0;
	                    horsex=x+sin1/2;horsey=y-cos1/2;horseo1=o1;
						horsez=getterrainheight(horsex,horsey);
	                  }else{o22=5;o2=2;soundhorse();}
	  }
	}
	if (keys[72]) {subhelp();resetkeys();}
	if (keys[80]) {subhelp();resetkeys();}
	if (keys[27]) {tclose=1;setTimeout("subquit();",1000);return;}
  if(tfoot==0){
   if(keys[17]==0){
    if(tourelle==0 || keys[16]==0){
	 if ((keys[40] || joyy>0.5)&& Math.abs(vplane)>0.2*cos3) {
	         var dt2=(0.8+vplane/2)*dt;if(vplane>2){dt2=1.8*dt;}
			 o2+=dt2*0.015*cos3;o1+=dt2*0.015*sin3;}
     if (keys[38] || joyy<-0.5) {o2-=dt*0.015*cos3;o1-=dt*0.015*sin3;}
     if (keys[37] || joyx<-0.35) {o3+=dt*0.019;if(o3>180){o3-=360;o30-=360;};if(landing){o1+=dt*0.004;};}
     if (keys[39] || joyx>0.35) {o3-=dt*0.019;if(o3<-180){o3+=360;o30+=360;};if(landing){o1-=dt*0.004;};}
     if (joyx<-0.75) {o3+=dt*0.019;if(o3>180){o3-=360;o30-=360;};if(landing){o1+=dt*0.004;};}
     if (joyx>0.75) {o3-=dt*0.019;if(o3<-180){o3+=360;o30+=360;};if(landing){o1-=dt*0.004;};}
	 if(tourelle==0 || tourelle>1){
	   if (keys[vk_1] || joyr<-0.5) {o2-=dt*0.0028*sin3;o1+=dt*0.0028*cos3;}
       if (keys[vk_2] || joyr>0.5) {o2+=dt*0.0028*sin3;o1-=dt*0.0028*cos3;}
       if(tourelle>1){	   
	    if (button[13]) {to2+=dt*0.035;if(to2>89){to2=89;};}
        if (button[14]) {to2-=dt*0.035;if(to2<-89){to2=-89;};}
        if (button[15]) {to1+=dt*0.039;if(to1>180){to1-=360;};}
        if (button[16]) {to1-=dt*0.039;if(to1<-180){to1+=360;};}
	   }
	 }else{
	   if (joyz<-0.5) {to2+=dt*0.035;if(to2>89){to2=89;};}
       if (joyz>0.5) {to2-=dt*0.035;if(to2<-89){to2=-89;};}
       if (joyr<-0.5) {to1+=dt*0.039;if(to1>180){to1-=360;};}
       if (joyr>0.5) {to1-=dt*0.039;if(to1<-180){to1+=360;};}
     }	 
	}else{
	 if (keys[38] || joyy<-0.5) {to2+=dt*0.035;if(to2>89){to2=89;};}
     if (keys[40] || joyy>0.5) {to2-=dt*0.035;if(to2<-89){to2=-89;};}
     if (keys[37] || joyx<-0.5) {to1+=dt*0.039;if(to1>180){to1-=360;};}
     if (keys[39] || joyx>0.5) {to1-=dt*0.039;if(to1<-180){to1+=360;};}
	}
  }else{
	if (keys[38] || keys[39]) {vrun+=dt*0.0003;};
    if (keys[40] || keys[37]) {vrun-=dt*0.0003;if(vrun<0){vrun=0;};};
  }  
	if (keys[33] || keys[vk_n] || button[1]) {vrun+=dt*0.0003;};
    if (keys[34] || keys[vk_b] || button[2]) {vrun-=dt*0.0003;if(vrun<0){vrun=0;};};
	if(vrun>vrunmax){vrun=vrunmax;};
	var air=(5000-z)/(5000+z);if(air<0){air=0;};
	//vplane+=0.4*((vrun-vplane)*0.0013*0.8*air*dt-dt*(air*0.0003*vplane+sin2*0.004));
	var vrun2=vrun*((3-1.4*vplane)/2)*3*air*air/(2+air*air);
	//vplane+=0.8*((vrun2)*0.0003*air*dt-dt*(air*0.0003*vplane+(sin2+0.03)*0.0024));
	vplane+=0.8*((vrun2)*0.0003*air*dt-dt*(air*0.0003*vplane+(sin2+0.01)*0.0020));
	if(vplane>4){vplane=4;}//max vv=800
	if(vplane<-0.5){vplane=-0.5;}//min vv=-100
    var vcruise=0.8;if(plane=="spitfire"){vcruise=0.85;};if(plane=="zero"){vcruise=0.84;}
	o1+=sin3*dt*0.010;
	o2-=Math.abs(Math.sin(degtorad(0.7*o3)))*dt*0.0015;
	if(cos3>0){o2+=(vplane*air-vcruise)*air*cos2*cos3*dt*0.004;}else{
	           o2+=(vplane*air+vcruise)*air*cos2*cos3*dt*0.004;}
	if(o3>0.1){o3-=dt*0.001;};
	if(o3<-0.1){o3+=dt*0.001;};
	var dt1=(dt*0.002);
	if(dt1>0.8){dt1=0.8;}
	do3+=(o3-o30)-dt1*do3;
	do2+=(o2-o20)-dt1*do2;
	do1+=(o1-o10)-dt1*do1;
	if(landing==1){if(o2<-0.02){o2=-0.01;do2=0;sin2=0;};
	  if(o2>0.1 && vplane<0.05){do2-=dt*0.050;};
	  if(keys[34]){vplane-=0.000145*dt*vplane;};
	  vplane-=0.00003*dt*vplane;o3=0;if(vplane<0.003){vplane=0.000001;};}
	o1+=do1*dt*0.001;
	o2+=do2*dt*0.0025;
	o3+=do3*dt*0.0025;
	if(Math.abs(o3)<1.6){o3+=Math.cos(timer()*0.0015)*0.2*(1.6-Math.abs(o3));};
	var vdt=dt*0.013*vplane;
	x+=vdt*cos1*cos2;
	y+=vdt*sin1*cos2;
	z+=vdt*sin2;
	vplanez=vplane*sin2;
	if(Math.abs(vplane)<0.2 && landing==0){z-=(0.2-Math.abs(vplane))*dt*0.013/3;vplanez-=(0.2-vplane)/3;
	                                       o2-=dt*0.004*cos2};
	if(o2>35){if(cos3>0){o1-=90*sin3*dt*0.004*sin2;o3-=90*sin3*dt*0.004*sin2;}else{
	                     o1+=90*sin3*dt*0.004*sin2;o3+=90*sin3*dt*0.004*sin2;};}
	if(o2<-35){if(cos3>0){o1-=90*sin3*dt*0.004*sin2;o3+=90*sin3*dt*0.004*sin2;}else{
	                     o1+=90*sin3*dt*0.004*sin2;o3-=90*sin3*dt*0.004*sin2;};}
  }//tfoot==0
    //if(o2>85){o2=84;o1=180+o1;o3=o3+180;};
    if(o2>85){o2=84;o1=180+o1-o3;o3=180;};
    if(o2<-85){o2=-84;o1=180+o1+o3;o3=0;};
	while(o1>180){o1-=360;} 
	while(o1<-180){o1+=360;}
	while(o3>180){o3-=360;}
	while(o3<-180){o3+=360;}
    cos1=Math.cos(degtorad(o1));sin1=Math.sin(degtorad(o1));
    cos2=Math.cos(degtorad(o2));sin2=Math.sin(degtorad(o2));
    cos3=Math.cos(degtorad(o3));sin3=Math.sin(degtorad(o3));
	dmx=cos1*cos2;dmy=sin1*cos2;dmz=sin2;
    tmove2=0;trot2=0;
	if(Math.abs(x-x0)+Math.abs(y-y0)+Math.abs(z-z0)>0.0001){tmove2=1;}
	if(Math.abs(o1-o10)+Math.abs(o2-o20)>0.0001){trot2=1;tmove2=1;}
    /*if (Math.abs(o2)>=50 && Math.abs(o2)<84.01){
       o1=diro1(dmx,dmy);
       o2=diro1(Math.sqrt(dmx*dmx+dmy*dmy),dmz);
       var aux=1.0/Math.max(0.5,Math.sqrt(dmx*dmx+dmy*dmy+dmz*dmz));
       dmx*=aux;dmy*=aux;dmz*=aux;
       cos1=Math.cos(degtorad(o1));sin1=Math.sin(degtorad(o1));
       cos2=Math.cos(degtorad(o2));sin2=Math.sin(degtorad(o2));
       cos3=Math.cos(degtorad(o3));sin3=Math.sin(degtorad(o3));
	   //dmx=cos1*cos2;dmy=sin1*cos2;dmz=sin2;
    } */	
	moveplane2(dt);
	//moveplane3(dt);
	//if(tsea>0){moveshipcarrier();}
	//if(tclose==0){timeoutkey=setTimeout("testkeys();",40);}
//}
}
var testroad=0;
function getterrainheight(px,py){
    testroad=0;
	if(Math.abs(px-pistex)<59.0){
	  if(Math.abs(py-pistey)<59.0){return 0.1;};}
	var dxwater=px-waterx;
	var dywater=py-watery;
	if((dxwater*dxwater+dywater*dywater)<9000){return -0.58;}
	var nx=(px+n4)*n/(scale*8);
	var ny=(py+n4)*n/(scale*8);
	while(nx<0){nx+=n};
	while(ny<0){ny+=n;};
	var i=parseInt(nx),j=parseInt(ny);
	var dx=nx-i,dy=ny-j;
	while(i<0){i+=n;}
	while(i>=n){i-=n;}
	while(j<0){j+=n;}
	while(j>=n){j-=n;}
	var i1=i+1,j1=j+1;
	while(i1<0){i1+=n;}
	while(i1>=n){i1-=n;}
	while(j1<0){j1+=n;}
	while(j1>=n){j1-=n;}
	//return height[parseInt(nx)*n+parseInt(ny)];
if(dx<=(1.0-dy)){ 
    var z00=height[i*n+j];if(Math.abs(z00-0.11)<0.001){testroad+=1;z00=(z00-0.11)*10000;}
    var z10=height[i1*n+j];if(Math.abs(z10-0.11)<0.001){testroad+=1;z10=(z10-0.11)*10000;}
    var z01=height[i*n+j1];if(Math.abs(z01-0.11)<0.001){testroad+=1;z01=(z01-0.11)*10000;}
    return ( dx*(z10-z00) +dy*(z01-z00) +z00)+0.05;
}else{
    var z10=height[i1*n+j];if(Math.abs(z10-0.11)<0.001){testroad+=1;z10=(z10-0.11)*10000;}
    var z01=height[i*n+j1];if(Math.abs(z01-0.11)<0.001){testroad+=1;z01=(z01-0.11)*10000;}
    var z11=height[i1*n+j1];if(Math.abs(z11-0.11)<0.001){testroad+=1;z11=(z11-0.11)*10000;}
    return ( (1-dx)*(z01-z11) +(1-dy)*(z10-z11) +z11 )+0.05;
	}
}
var testtown=0;	
function getterrainheight2(px,py){
	var h=getheighttown(px,py);
	if(h>0){testtown=1;return h;}
	testtown=0;
    if(Math.abs(px-shipx)<9){if(Math.abs(py-shipy)<9){
       var dx=px-shipx,dy=py-shipy;
	   var dxx=dx*shipco1+dy*shipsi1;
	   if(Math.abs(dxx)<9){
	      var dyy=Math.abs(-dx*shipsi1+dy*shipco1);
		  if(dyy<2){if(dxx<5 && dxx>-3){return 4;}else{return 3;};};
	   }
	};}
	if(tsea>0){
    if(Math.abs(px-shipcarrierx)<27){if(Math.abs(py-shipcarriery)<27){
       var dx=px-shipcarrierx,dy=py-shipcarriery;
	   var dxx=dx*shipcarrierco1+dy*shipcarriersi1;
	   if(dxx>-24.5 && dxx<19.9){
	      var dyy=(-dx*shipcarriersi1+dy*shipcarrierco1);
		  if(dyy>-3.7 && dyy<7){if(dxx>-2.4 && dxx<6.7 && dyy<-0.2){return 3.7;}else{tpiste=1;tcarrier=1;return 2.15;};};
	   }
	};}
	}
	return getterrainheight(px,py);
}
var tpo1=0,tpo2=0;
var pvplane=0,pdmx=0,pdmy=0,pdmz=0,ptsmoke=0;
function moveplane2(dt){
    if(pvie<100){pvie+=Math.random()*dtime*0.0004;};
	if(pvie>0 && pvie<30 && tframe>ptsmoke){
	    ptsmoke=tframe+200+Math.random()*350;
	    addsmoke(px,py,pz,1.5,0);}
	var pdx=0,pdy=0,pdz=0,pdo1=0,pdo2=0,pdist=1000;
	if(pvie<0){pdx=x-px;pdy=y-py;pdz=z-pz;
	   pdist=pdx*pcos1*pcos2+pdy*psin1*pcos2+pdz*psin2;
	   pdo1=-pdx*psin1+pdy*pcos1;
	   pdo2=pdz;
	   if(pdist>2 && pdist<100 && Math.abs(pdo1)<pdist/6 && Math.abs(pdo2)<pdist/6){pkeys[32]=1;}
	}
	var po10=po1,po20=po2,po30=po3;
	var distmax=900;
	while(px<(x-distmax)){px+=1.9999*distmax;}
	while(px>(x+distmax)){px-=1.9999*distmax;}
	while(py<(y-distmax)){py+=1.9999*distmax;}
	while(py>(y+distmax)){py-=1.9999*distmax;}
	var alt=getterrainheight2(px+40*pcos1,py+40*psin1);
	var alt0=getterrainheight(px+5*pcos1,py+5*psin1);
	if(pz<(alt0+1)){pz=alt0+1.1;if(po2<-1.1){po2=-1.0;};};
	var t=timer();
	if (t>tpo1 && alt>(pz-5)){
	   tpo1=t+Math.random()*7000;tattack=0;
	   var alt1=getterrainheight(px+40*pcos1-15*psin1,px+40*psin1+15*psin1);
	   var alt2=getterrainheight(px+40*pcos1+15*psin1,px+40*psin1-15*psin1);
	   if(alt1<alt2){pkeys[37]=1;pkeys[39]=0;}else{pkeys[37]=0;pkeys[39]=1;};
	}
	if(pvie>0 || (pdist*0.4)<Math.abs(pdo1)){
	 if(pvie<0 && Math.random()*20<0.001*dt){tattack=1;}
	 if(pkeys[37] || pkeys[39]){tattack=0;}
	 if(tattack){tattack=0;
	   tpo1=t+Math.random()*20000;
	   if(Math.random()>0.5){pkeys[37]=1;pkeys[39]=0;}else{pkeys[37]=0;pkeys[39]=1;};
	 }
	}else{
	 pkeys[37]=0;pkeys[39]=0;tattack=1;
     pdo1+=dirtir*Math.abs(pdist)*0.3;
	 if(pdo1>(pdist/4)){pkeys[37]=1;pkeys[39]=0;tattack=0;tpo1=t+2;}
	 if(pdo1<(-pdist/4)){pkeys[37]=0;pkeys[39]=1;tattack=0;tpo1=t+2;}
	 if(tattack){tattack=0;
	   tpo1=t+Math.random()*20000;
	   if(Math.random()>0.5){pkeys[37]=1;pkeys[39]=0;}else{pkeys[37]=0;pkeys[39]=1;};
	 }
    }
	if (t>tpo1){if(Math.random()<0.001*dt){if(Math.random()<1/40){//40sec
	   tpo1=t+Math.random()*20000;
	   if(Math.random()>0.5){pkeys[37]=1;pkeys[39]=0;}else{pkeys[37]=0;pkeys[39]=1;};
	}}else{pkeys[37]=0;pkeys[39]=0;
	      if(po3<-2){pkeys[37]=1;};if(po3>2){pkeys[39]=1;};};
	}
	if(pvie<0 && pdist>Math.abs(pdo1/2)){
	 if(pdo2>(pdist/7)){pkeys[38]=0;pkeys[40]=1;tattack=0;tpo2=t+2;}
	 if(pdo2<(-pdist/5)){pkeys[38]=1;pkeys[40]=0;tattack=0;tpo2=t+2;}
	}
	if (t>tpo2){if(Math.random()<0.001*dt){if(Math.random()<1/40){//40sec
	   tpo2=t+Math.random()*10000;
	   if(Math.random()>0.5){pkeys[40]=1;pkeys[38]=0;}else{pkeys[40]=0;pkeys[38]=1;};
	}}else{pkeys[40]=0;pkeys[38]=0;
	     if(pvie>0){
		  if(pz<18){pkeys[40]=1;};if(pz>40){pkeys[38]=1;};
		 }else{
		  if(pz<5.5){pkeys[40]=1;};if(pz>90){pkeys[38]=1;};
		 };
	 }
	}
	if(pvplane<0.65){pvrun=1.3;}else{pvrun=1.0;};
	if(pvie>0 || pdist<Math.abs(pdo1/4)){
	  if(pz>40 || pvplane<0.5){pkeys[40]=0;pkeys[38]=1;if(pz>45.01){pz=45;};}
	  if(pz<18){pkeys[40]=1;pkeys[38]=0;if(pz<15){pz=15.01;};}
	}else{
	  if(pz>90 || pvplane<0.5){pkeys[40]=0;pkeys[38]=1;if(pz>95.01){pz=95;};}
	  if(pz<5.5){pkeys[40]=1;pkeys[38]=0;if(pz<4){pz=4.01;};}
	}
	tattack=0;
    //left=37,up=38,right=39,down=40,pageup=33,pagedown=34,m=77,esc=27,h=72,shift=16
    //p=80,T=84
    if (pkeys[40]) {po2+=dt*0.015*pcos3;if(po2>89){po2=89;};po1+=dt*0.015*psin3;}
    if (pkeys[38]) {po2-=dt*0.015*pcos3;if(po2<-89){po2=-89;};po1-=dt*0.015*psin3;}
    if (pkeys[37]) {po3+=dt*0.019;if(po3>180){po3-=360;po30-=360;};}
    if (pkeys[39]) {po3-=dt*0.019;if(po3<-180){po3+=360;po30+=360;};}
	if (pkeys[33] || pkeys[16]) {pvrun+=dt*0.0003;if(pvrun>1.3){pvrun=1.3;};};
    if (pkeys[34]) {pvrun-=dt*0.0003;if(pvrun<0){pvrun=0;};};
	if (pkeys[32]) {pkeys[32]=0;if(tframe>(ptkeytir+80)){soundshoot();ptir();};}
	if(pvie>0 || pdist<(-Math.abs(pdo1/3))){
	 if(po3<-35.01){po3=-35;}
	 if(po3>35.01){po3=35;}
    }else{
	 if(po3<-45.01){po3=-45;}
	 if(po3>45.01){po3=45;}
	}
	if(po2<-18.01){po2=-18;}
	if(po2>10.01){po2=10;}
	//var pair=10000.0/(10000+z);
	////vplane+=0.4*((vrun-vplane)*0.0013*0.8*air*dt-dt*(air*0.0003*vplane+sin2*0.004));
	//pvplane+=0.7*((pvrun)*0.0003*pair*dt-dt*(pair*0.0003*pvplane+psin2*0.0024));
	var pair=(5000-pz)/(5000+pz);if(pair<0){pair=0;};
	//vplane+=0.4*((vrun-vplane)*0.0013*0.8*air*dt-dt*(air*0.0003*vplane+sin2*0.004));
	var pvrun2=pvrun*((3-1.4*pvplane)/2)*3*pair*pair/(2+pair*pair);
	if(pdist>50 && pvie<0){if(pvrun2<1.5 && pdist>Math.abs(pdo1/2)){pvrun2=1.5;};}
	//pvplane+=0.8*((pvrun2)*0.0003*pair*dt-dt*(pair*0.0003*pvplane+(psin2+0.03)*0.0024));
	pvplane+=0.8*((pvrun2)*0.0003*pair*dt-dt*(pair*0.0003*pvplane+(psin2+0.01)*0.0020));
	if(pvplane>4){pvplane=4;}//max vv=800
	//var pair=50000.0/(50000+pz);
	//pvplane+=0.4*((pvrun-pvplane)*0.0013*0.8*pair*dt-dt*(pair*0.0003*pvplane+psin2*0.004));
    var pvdt=dt*0.013*pvplane;var pvcruise=0.8;
	po1+=psin3*dt*0.010;
	po2-=Math.abs(Math.sin(degtorad(0.7*po3)))*dt*0.0015;
	po2+=(pvplane*pair-pvcruise)*pair*pcos2*pcos3*dt*0.01;
	if(po3>0.1){po3-=dt*0.001;};
	if(po3<-0.1){po3+=dt*0.001;};
	var dt1=(dt*0.002);
	if(dt1>0.8){dt1=0.8;}
	pdo3+=(po3-po30)-dt1*pdo3;
	pdo2+=(po2-po20)-dt1*pdo2;
	pdo1+=(po1-po10)-dt1*pdo1;
	if(pdo1<-20){pdo1=-20;}
	if(pdo1>20){pdo1=20;}
	if((po1-po10)*psin3<0){po3-=po3*dt*0.0015;
	   if(po3>0){pkeys[37]=0;}else{pkeys[39]=0;};}
	po1+=pdo1*dt*0.001;
	po2+=pdo2*dt*0.0025;
	po3+=pdo3*dt*0.0025;
	if(Math.abs(po3)<1.6){po3+=Math.cos(timer()*0.0015)*0.2*(1.6-Math.abs(po3));};
	px+=pvdt*pcos1*pcos2;
	py+=pvdt*psin1*pcos2;
	pz+=pvdt*psin2;
    if(po2>85){po2=84-(po2-85);po1=180+po1;po3=180+po3;};
    if(po2<-85){po2=-84-(po2+85);po1=180+po1;po3=180+po3;};
	if(po1>180){po1-=360;} 
	if(po1<-180){po1+=360;}
	if(po3>180){po3-=360;}
	if(po3<-180){po3+=360;}
    pcos1=Math.cos(degtorad(po1));psin1=Math.sin(degtorad(po1));
    pcos2=Math.cos(degtorad(po2));psin2=Math.sin(degtorad(po2));
    pcos3=Math.cos(degtorad(po3));psin3=Math.sin(degtorad(po3));
	pdmx=pcos1*pcos2;pdmy=psin1*pcos2;pdmz=psin2;
}	
var tp3o1=0,tp3o2=0;
var p3vplane=0,p3dmx=0,p3dmy=0,p3dmz=0;
var p3keys=new Array(256),p3tkeytir=0,p3tfollow=0,p3tsmoke=0;
function moveplane3(dt){
    if(p3vie<100){p3vie+=Math.random()*dtime*0.0004;};
	if(p3vie>0 && p3vie<30 && tframe>p3tsmoke){
	    p3tsmoke=tframe+200+Math.random()*350;
	    addsmoke(p3x,p3y,p3z,1.5,0);}
	var p3dx=0,p3dy=0,p3dz=0,p3do1=0,p3do2=0,p3dist=1000,p3vie0=p3vie;
	if(p3vie<0){p3dx=x-p3x;p3dy=y-p3y;p3dz=z-p3z;
	   p3dist=p3dx*p3cos1*p3cos2+p3dy*p3sin1*p3cos2+p3dz*p3sin2;
	   p3do1=-p3dx*p3sin1+p3dy*p3cos1;
	   p3do2=p3dz;
	   if(p3dist>2 && p3dist<100 && Math.abs(p3do1)<p3dist/6 && Math.abs(p3do2)<p3dist/6){p3keys[32]=1;}
	}else{p3dx=px-p3x;p3dy=py-p3y;p3dz=pz-p3z;
	   p3dist=p3dx*p3cos1*p3cos2+p3dy*p3sin1*p3cos2+p3dz*p3sin2;
	   p3do1=-p3dx*p3sin1+p3dy*p3cos1;
	   p3do2=p3dz;
	   if(p3vie<99){
	      if(p3dist>2 && p3dist<100 && Math.abs(p3do1)<p3dist/6 && Math.abs(p3do2)<p3dist/6){p3keys[32]=1;}
	   }
	}
	if(p3vie<99 || p3dist>(8+Math.abs(p3do1))){p3vie=-90;
	}else{p3do1=0;p3do2=0;}
	if(tframe<p3tfollow && p3vie0>99){p3do1=0;p3do2=0;p3vie=100;
	}else{if(Math.random()*500<dt*0.001){p3tfollow=tframe+20000;};}
	var p3o10=p3o1,p3o20=p3o2,p3o30=p3o3;
	var distmax=900; 
	while(p3x<(x-distmax)){p3x+=1.9999*distmax;}
	while(p3x>(x+distmax)){p3x-=1.9999*distmax;}
	while(p3y<(y-distmax)){p3y+=1.9999*distmax;}
	while(p3y>(y+distmax)){p3y-=1.9999*distmax;}
	var alt=getterrainheight2(p3x+40*p3cos1,p3y+40*p3sin1);
	var alt0=getterrainheight(p3x+5*p3cos1,p3y+5*p3sin1);
	if(p3z<(alt0+1)){p3z=alt0+1.1;if(p3o2<-1.1){p3o2=-1.0;};};
	var t=timer();
	if (t>tp3o1 && alt>(p3z-5)){
	   tp3o1=t+Math.random()*7000;tattackp3=0;
	   var alt1=getterrainheight(p3x+40*p3cos1-15*p3sin1,p3x+40*p3sin1+15*p3sin1);
	   var alt2=getterrainheight(p3x+40*p3cos1+15*p3sin1,p3x+40*p3sin1-15*p3sin1);
	   if(alt1<alt2){p3keys[37]=1;p3keys[39]=0;}else{p3keys[37]=0;p3keys[39]=1;};
	}
	if(p3vie>0 || (p3dist*1.4)<Math.abs(p3do1)){
	 if(p3vie<0 && Math.random()*20<0.001*dt){tattackp3=1;}
	 if(p3keys[37] || p3keys[39]){tattackp3=0;}
	 if(tattackp3){tattackp3=0;
	   tp3o1=t+Math.random()*20000;
	   if(Math.random()>0.5){p3keys[37]=1;p3keys[39]=0;}else{p3keys[37]=0;p3keys[39]=1;};
	 }
	}else{
	 p3keys[37]=0;p3keys[39]=0;tattackp3=1;
     p3do1+=dirtir*Math.abs(p3dist)*0.3;
	 if(p3do1>(p3dist/4)){p3keys[37]=1;p3keys[39]=0;tattackp3=0;tp3o1=t+2;}
	 if(p3do1<(-p3dist/4)){p3keys[37]=0;p3keys[39]=1;tattackp3=0;tp3o1=t+2;}
	 if(tattackp3){tattackp3=0;
	   tp3o1=t+Math.random()*20000;
	   if(Math.random()>0.5){p3keys[37]=1;p3keys[39]=0;}else{p3keys[37]=0;p3keys[39]=1;};
	 }
    }	
	if (t>tp3o1){if(Math.random()<0.001*dt){if(Math.random()<1/40){//40sec
	   tp3o1=t+Math.random()*20000;
	   if(Math.random()>0.5){p3keys[37]=1;p3keys[39]=0;}else{p3keys[37]=0;p3keys[39]=1;};
	}}else{p3keys[37]=0;p3keys[39]=0;
	      if(p3o3<-2){p3keys[37]=1;};if(p3o3>2){p3keys[39]=1;};};
	}
	if(p3vie<0 && p3dist>Math.abs(p3do1/2)){
	 if(p3do2>(p3dist/7)){p3keys[38]=0;p3keys[40]=1;tattackp3=0;tp3o2=t+2;}
	 if(p3do2<(-p3dist/5)){p3keys[38]=1;p3keys[40]=0;tattackp3=0;tp3o2=t+2;}
	}
	if (t>tp3o2){if(Math.random()<0.001*dt){if(Math.random()<1/40){//40sec
	   tp3o2=t+Math.random()*10000;
	   if(Math.random()>0.5){p3keys[40]=1;p3keys[38]=0;}else{p3keys[40]=0;p3keys[38]=1;};
	}}else{p3keys[40]=0;p3keys[38]=0;
	     if(p3vie>0){
		  if(p3z<18){p3keys[40]=1;};if(p3z>40){p3keys[38]=1;};
		 }else{
		  if(p3z<5.5){p3keys[40]=1;};if(p3z>90){p3keys[38]=1;};
		 };
	 }
	}
	if(p3vplane<0.65){p3vrun=1.3;}else{p3vrun=1.0;};
	if(p3vie>0 || p3dist<Math.abs(p3do1/4)){
	  if(p3z>40 || p3vplane<0.5){p3keys[40]=0;p3keys[38]=1;if(p3z>45.01){p3z=45;};}
	  if(p3z<18){p3keys[40]=1;p3keys[38]=0;if(p3z<15){p3z=15.01;};}
	}else{
	  if(p3z>90 || p3vplane<0.5){p3keys[40]=0;p3keys[38]=1;if(p3z>95.01){p3z=95;};}
	  if(p3z<5.5){p3keys[40]=1;p3keys[38]=0;if(p3z<4){p3z=4.01;};}
	}
	tattackp3=0;
    //left=37,up3=38,right=39,down=40,p3ageup3=33,p3agedown=34,m=77,esc=27,h=72,shift=16
    //p3=80,T=84
    if (p3keys[40]) {p3o2+=dt*0.015*p3cos3;if(p3o2>89){p3o2=89;};p3o1+=dt*0.015*p3sin3;}
    if (p3keys[38]) {p3o2-=dt*0.015*p3cos3;if(p3o2<-89){p3o2=-89;};p3o1-=dt*0.015*p3sin3;}
    if (p3keys[37]) {p3o3+=dt*0.019;if(p3o3>180){p3o3-=360;p3o30-=360;};}
    if (p3keys[39]) {p3o3-=dt*0.019;if(p3o3<-180){p3o3+=360;p3o30+=360;};}
	if (p3keys[33] || p3keys[16]) {p3vrun+=dt*0.0003;if(p3vrun>1.3){p3vrun=1.3;};};
    if (p3keys[34]) {p3vrun-=dt*0.0003;if(p3vrun<0){p3vrun=0;};};
	if (p3keys[32]) {p3keys[32]=0;if(tframe>(p3tkeytir+80)){soundshoot();p3tir();};}
	if(p3vie>0 || p3dist<(-Math.abs(p3do1/3))){
	 if(p3o3<-35.01){p3o3=-35;}
	 if(p3o3>35.01){p3o3=35;}
    }else{
	 if(p3o3<-45.01){p3o3=-45;}
	 if(p3o3>45.01){p3o3=45;}
	}
	if(p3o2<-18.01){p3o2=-18;}
	if(p3o2>10.01){p3o2=10;}
	//var p3air=10000.0/(10000+z);
	////vplane+=0.4*((vrun-vplane)*0.0013*0.8*air*dt-dt*(air*0.0003*vplane+sin2*0.004));
	//p3vplane+=0.7*((p3vrun)*0.0003*p3air*dt-dt*(p3air*0.0003*p3vplane+p3sin2*0.0024));
	var p3air=(5000-p3z)/(5000+p3z);if(p3air<0){p3air=0;};
	//vplane+=0.4*((vrun-vplane)*0.0013*0.8*air*dt-dt*(air*0.0003*vplane+sin2*0.004));
	var p3vrun2=p3vrun*((3-1.4*p3vplane)/2)*3*p3air*p3air/(2+p3air*p3air);
	if(p3dist>50 && p3vie<0){
	  if(p3vie0<0){if(p3vrun2<1.5 && p3dist>Math.abs(p3do1/2)){p3vrun2=1.5;}
	  }else{if(p3vrun2<1.2 && p3dist>Math.abs(p3do1/2)){p3vrun2=1.2;};};}
	//p3vplane+=0.8*((p3vrun2)*0.0003*p3air*dt-dt*(p3air*0.0003*p3vplane+(p3sin2+0.03)*0.0024));
	p3vplane+=0.8*((p3vrun2)*0.0003*p3air*dt-dt*(p3air*0.0003*p3vplane+(p3sin2+0.01)*0.0020));
	if(p3vplane>4){p3vplane=4;}//max vv=800
	//var p3air=50000.0/(50000+p3z);
	//p3vplane+=0.4*((p3vrun-p3vplane)*0.0013*0.8*p3air*dt-dt*(p3air*0.0003*p3vplane+p3sin2*0.004));
    var p3vdt=dt*0.013*p3vplane;var p3vcruise=0.8;
	p3o1+=p3sin3*dt*0.010;
	p3o2-=Math.abs(Math.sin(degtorad(0.7*p3o3)))*dt*0.0015;
	p3o2+=(p3vplane*p3air-p3vcruise)*p3air*p3cos2*p3cos3*dt*0.01;
	if(p3o3>0.1){p3o3-=dt*0.001;};
	if(p3o3<-0.1){p3o3+=dt*0.001;};
	var dt1=(dt*0.002);
	if(dt1>0.8){dt1=0.8;}
	p3do3+=(p3o3-p3o30)-dt1*p3do3;
	p3do2+=(p3o2-p3o20)-dt1*p3do2;
	p3do1+=(p3o1-p3o10)-dt1*p3do1;
	if(p3do1<-20){p3do1=-20;}
	if(p3do1>20){p3do1=20;}
	if((p3o1-p3o10)*p3sin3<0){p3o3-=p3o3*dt*0.0015;
	   if(p3o3>0){p3keys[37]=0;}else{p3keys[39]=0;};}
	p3o1+=p3do1*dt*0.001;
	p3o2+=p3do2*dt*0.0025;
	p3o3+=p3do3*dt*0.0025;
	if(Math.abs(p3o3)<1.6){p3o3+=Math.cos(timer()*0.0015)*0.2*(1.6-Math.abs(p3o3));};
	p3x+=p3vdt*p3cos1*p3cos2;
	p3y+=p3vdt*p3sin1*p3cos2;
	p3z+=p3vdt*p3sin2;
    if(p3o2>85){p3o2=84-(p3o2-85);p3o1=180+p3o1;p3o3=180+p3o3;};
    if(p3o2<-85){p3o2=-84-(p3o2+85);p3o1=180+p3o1;p3o3=180+p3o3;};
	if(p3o1>180){p3o1-=360;} 
	if(p3o1<-180){p3o1+=360;}
	if(p3o3>180){p3o3-=360;}
	if(p3o3<-180){p3o3+=360;}
    p3cos1=Math.cos(degtorad(p3o1));p3sin1=Math.sin(degtorad(p3o1));
    p3cos2=Math.cos(degtorad(p3o2));p3sin2=Math.sin(degtorad(p3o2));
    p3cos3=Math.cos(degtorad(p3o3));p3sin3=Math.sin(degtorad(p3o3));
	p3dmx=p3cos1*p3cos2;p3dmy=p3sin1*p3cos2;p3dmz=p3sin2;
	p3vie=p3vie0;
}
var radtodeg=180/Math.PI;
function diro1(dx,dy){
var do1;
if (Math.abs(dx)>Math.max(0.001,0.001*Math.abs(dy))){
 if(dx>0){do1=Math.atan(dy/dx)*radtodeg;
   }else{do1=180-Math.atan(dy/Math.abs(dx))*radtodeg;};
}else{if(dy>0){do1=90;}else{do1=-90;};}
return do1;
}
var tvolume=0,tspeed=0;
function setvolume(){
    testsounds();
    var volume=(0.09+(Math.max(0,vplane)*0.4047+vrun*0.4033)*0.9);
	if(volume>1){volume=1;};
	if(tfoot==1){volume=0.009;}
    var speed=(0.14+(Math.max(0,vplane)*0.7+vrun*0.1)*0.9);
	if(speed>1){speed=1;};
	if(Math.abs(tvolume-volume)<0.005 && Math.abs(tspeed-speed)<0.005){return;}
	tvolume=volume;tspeed=speed;
	var volume0=0.45*volume,volume1=0.32*volume;
	//var volume0=0.35*volume,volume1=0.85*volume;
if(twebaudio==0){ 
	/*myaudio.volume=volume0*(1-speed*0.75);
	myaudio1.volume=volume0*(1-speed*0.75);
	myaudio2.volume=volume1*speed;
	myaudio21.volume=volume1*speed;
	*/  
}else{
	setvol(myaudio,volume);
	setspeed(myaudio,speed+0.54);
	}
}
function testsounds(){	
if(twebaudio==0){
	/*if(tframe<tpneu){if(myaudiopneu.volume<0.3){myaudiopneu.volume=0.4;};
	}else{if(myaudiopneu.volume>0.1){myaudiopneu.volume=0.002;};}
	
	if(tframe<tshoot){if(myaudioshoot.volume<0.1){myaudioshoot.volume=0.18;};
	}else{if(myaudioshoot.volume>0.1){myaudioshoot.volume=0.002;};}
    */
}else{
	if(tframe<tshoot){if(myaudioshoot.volume<0.1){myaudioshoot.volume=0.18;setvol(myaudioshoot,0.3);};
	}else{if(myaudioshoot.volume>0.1){myaudioshoot.volume=0.002;};setvol(myaudioshoot,0.002);}
}
}
var vertexCount = 0;
var vertexPositions = [];
var vertexTextureCoords = [];
var worldVertexPositionBuffer = null;
var worldVertexTextureCoordBuffer = null;
var world2VertexPositionBuffer = null;
var world2VertexTextureCoordBuffer = null;
var shipVertexPositionBuffer = null;
var shipVertexTextureCoordBuffer = null;
var skydomeVertexPositionBuffer = null;
var skydomeVertexTextureCoordBuffer = null;
var spitfireVertexPositionBuffer = null;
var spitfireVertexTextureCoordBuffer = null;
var spitfirecockpitVertexPositionBuffer = null;
var spitfirecockpitVertexTextureCoordBuffer = null;
var zeroVertexPositionBuffer = null;
var zeroVertexTextureCoordBuffer = null;
var zerocockpitVertexPositionBuffer = null;
var zerocockpitVertexTextureCoordBuffer = null;
var shipcarrierVertexPositionBuffer = null;
var shipcarrierVertexTextureCoordBuffer = null;
var corsairVertexPositionBuffer = null;
var corsairVertexTextureCoordBuffer = null;
var sailshipVertexPositionBuffer = null;
var sailshipVertexTextureCoordBuffer = null;
var rocVertexPositionBuffer = null;
var rocVertexTextureCoordBuffer = null;
var trunkVertexPositionBuffer = null;
var trunkVertexTextureCoordBuffer = null;
var arm2VertexPositionBuffer = null;
var arm2VertexTextureCoordBuffer = null;
var swordVertexPositionBuffer = null;
var swordVertexTextureCoordBuffer = null;
var horseVertexPositionBuffer = null;
var horseVertexTextureCoordBuffer = null;
var farmlowVertexPositionBuffer = null;
var farmlowVertexTextureCoordBuffer = null;
var castletowerVertexPositionBuffer = null;
var castletowerVertexTextureCoordBuffer = null;
var castlewallVertexPositionBuffer = null;
var castlewallVertexTextureCoordBuffer = null;
var horsebodyVertexPositionBuffer = null;
var horsebodyVertexTextureCoordBuffer = null;
var axeVertexPositionBuffer = null;
var axeVertexTextureCoordBuffer = null;
var horselowVertexPositionBuffer = null;
var horselowVertexTextureCoordBuffer = null;

var horselowVertexPositions = null;
var horselowidleVertexPositions = null;
var horselowrun1VertexPositions = null;
var horselowrun2VertexPositions = null;

var skeletoncavVertexPositionBuffer = null;
var skeletoncavVertexTextureCoordBuffer = null;

var skeletoncavVertexPositions = null;
var skeletoncavidleVertexPositions = null;
var skeletoncavattackVertexPositions = null;

  function loadWorld() {
    handleLoadedWorld(c150objtxt);
    worldVertexPositionBuffer = gl.createBuffer();
    gl.bindBuffer(gl.ARRAY_BUFFER, worldVertexPositionBuffer);
    gl.bufferData(gl.ARRAY_BUFFER, new Float32Array(vertexPositions), gl.STATIC_DRAW);
    worldVertexPositionBuffer.itemSize = 3;
    worldVertexPositionBuffer.numItems = vertexCount;

    worldVertexTextureCoordBuffer = gl.createBuffer();
    gl.bindBuffer(gl.ARRAY_BUFFER, worldVertexTextureCoordBuffer);
    gl.bufferData(gl.ARRAY_BUFFER, new Float32Array(vertexTextureCoords), gl.STATIC_DRAW);
    worldVertexTextureCoordBuffer.itemSize = 2;
    worldVertexTextureCoordBuffer.numItems = vertexCount;//alert(vertexCount);
	
    handleLoadedWorld(c150minus6objtxt);
    world2VertexPositionBuffer = gl.createBuffer();
    gl.bindBuffer(gl.ARRAY_BUFFER, world2VertexPositionBuffer);
    gl.bufferData(gl.ARRAY_BUFFER, new Float32Array(vertexPositions), gl.STATIC_DRAW);
    world2VertexPositionBuffer.itemSize = 3;
    world2VertexPositionBuffer.numItems = vertexCount;

    world2VertexTextureCoordBuffer = gl.createBuffer();
    gl.bindBuffer(gl.ARRAY_BUFFER, world2VertexTextureCoordBuffer);
    gl.bufferData(gl.ARRAY_BUFFER, new Float32Array(vertexTextureCoords), gl.STATIC_DRAW);
    world2VertexTextureCoordBuffer.itemSize = 2;
    world2VertexTextureCoordBuffer.numItems = vertexCount;//alert(vertexCount);

	/*handleLoadedWorld(shipobjtxt);
    shipVertexPositionBuffer = gl.createBuffer();
    gl.bindBuffer(gl.ARRAY_BUFFER, shipVertexPositionBuffer);
    gl.bufferData(gl.ARRAY_BUFFER, new Float32Array(vertexPositions), gl.STATIC_DRAW);
    shipVertexPositionBuffer.itemSize = 3;
    shipVertexPositionBuffer.numItems = vertexCount;

    shipVertexTextureCoordBuffer = gl.createBuffer();
    gl.bindBuffer(gl.ARRAY_BUFFER, shipVertexTextureCoordBuffer);
    gl.bufferData(gl.ARRAY_BUFFER, new Float32Array(vertexTextureCoords), gl.STATIC_DRAW);
    shipVertexTextureCoordBuffer.itemSize = 2;
    shipVertexTextureCoordBuffer.numItems = vertexCount;//alert(vertexCount);

    handleLoadedWorld(spitfirelowobjtxt);
    spitfireVertexPositionBuffer = gl.createBuffer();
    gl.bindBuffer(gl.ARRAY_BUFFER, spitfireVertexPositionBuffer);
    gl.bufferData(gl.ARRAY_BUFFER, new Float32Array(vertexPositions), gl.STATIC_DRAW);
    spitfireVertexPositionBuffer.itemSize = 3;
    spitfireVertexPositionBuffer.numItems = vertexCount;

    spitfireVertexTextureCoordBuffer = gl.createBuffer();
    gl.bindBuffer(gl.ARRAY_BUFFER, spitfireVertexTextureCoordBuffer);
    gl.bufferData(gl.ARRAY_BUFFER, new Float32Array(vertexTextureCoords), gl.STATIC_DRAW);
    spitfireVertexTextureCoordBuffer.itemSize = 2;
    spitfireVertexTextureCoordBuffer.numItems = vertexCount;//alert(vertexCount);

	handleLoadedWorld(spitfirecockpitobjtxt);
    spitfirecockpitVertexPositionBuffer = gl.createBuffer();
    gl.bindBuffer(gl.ARRAY_BUFFER, spitfirecockpitVertexPositionBuffer);
    gl.bufferData(gl.ARRAY_BUFFER, new Float32Array(vertexPositions), gl.STATIC_DRAW);
    spitfirecockpitVertexPositionBuffer.itemSize = 3;
    spitfirecockpitVertexPositionBuffer.numItems = vertexCount;

    spitfirecockpitVertexTextureCoordBuffer = gl.createBuffer();
    gl.bindBuffer(gl.ARRAY_BUFFER, spitfirecockpitVertexTextureCoordBuffer);
    gl.bufferData(gl.ARRAY_BUFFER, new Float32Array(vertexTextureCoords), gl.STATIC_DRAW);
    spitfirecockpitVertexTextureCoordBuffer.itemSize = 2;
    spitfirecockpitVertexTextureCoordBuffer.numItems = vertexCount;//alert(vertexCount);

    handleLoadedWorld(zeroobjtxt);
    zeroVertexPositionBuffer = gl.createBuffer();
    gl.bindBuffer(gl.ARRAY_BUFFER, zeroVertexPositionBuffer);
    gl.bufferData(gl.ARRAY_BUFFER, new Float32Array(vertexPositions), gl.STATIC_DRAW);
    zeroVertexPositionBuffer.itemSize = 3;
    zeroVertexPositionBuffer.numItems = vertexCount;

    zeroVertexTextureCoordBuffer = gl.createBuffer();
    gl.bindBuffer(gl.ARRAY_BUFFER, zeroVertexTextureCoordBuffer);
    gl.bufferData(gl.ARRAY_BUFFER, new Float32Array(vertexTextureCoords), gl.STATIC_DRAW);
    zeroVertexTextureCoordBuffer.itemSize = 2;
    zeroVertexTextureCoordBuffer.numItems = vertexCount;//alert(vertexCount);

	handleLoadedWorld(zerocockpitobjtxt);
    zerocockpitVertexPositionBuffer = gl.createBuffer();
    gl.bindBuffer(gl.ARRAY_BUFFER, zerocockpitVertexPositionBuffer);
    gl.bufferData(gl.ARRAY_BUFFER, new Float32Array(vertexPositions), gl.STATIC_DRAW);
    zerocockpitVertexPositionBuffer.itemSize = 3;
    zerocockpitVertexPositionBuffer.numItems = vertexCount;

    zerocockpitVertexTextureCoordBuffer = gl.createBuffer();
    gl.bindBuffer(gl.ARRAY_BUFFER, zerocockpitVertexTextureCoordBuffer);
    gl.bufferData(gl.ARRAY_BUFFER, new Float32Array(vertexTextureCoords), gl.STATIC_DRAW);
    zerocockpitVertexTextureCoordBuffer.itemSize = 2;
    zerocockpitVertexTextureCoordBuffer.numItems = vertexCount;//alert(vertexCount);
	
	handleLoadedWorld(shipcarrierobjtxt);
    shipcarrierVertexPositionBuffer = gl.createBuffer();
    gl.bindBuffer(gl.ARRAY_BUFFER, shipcarrierVertexPositionBuffer);
    gl.bufferData(gl.ARRAY_BUFFER, new Float32Array(vertexPositions), gl.STATIC_DRAW);
    shipcarrierVertexPositionBuffer.itemSize = 3;
    shipcarrierVertexPositionBuffer.numItems = vertexCount;

    shipcarrierVertexTextureCoordBuffer = gl.createBuffer();
    gl.bindBuffer(gl.ARRAY_BUFFER, shipcarrierVertexTextureCoordBuffer);
    gl.bufferData(gl.ARRAY_BUFFER, new Float32Array(vertexTextureCoords), gl.STATIC_DRAW);
    shipcarrierVertexTextureCoordBuffer.itemSize = 2;
    shipcarrierVertexTextureCoordBuffer.numItems = vertexCount;//alert(vertexCount);
    */ 
	
    handleLoadedWorld(skydomeobjtxt);
    skydomeVertexPositionBuffer = gl.createBuffer();
    gl.bindBuffer(gl.ARRAY_BUFFER, skydomeVertexPositionBuffer);
    gl.bufferData(gl.ARRAY_BUFFER, new Float32Array(vertexPositions), gl.STATIC_DRAW);
    skydomeVertexPositionBuffer.itemSize = 3;
    skydomeVertexPositionBuffer.numItems = vertexCount;

    skydomeVertexTextureCoordBuffer = gl.createBuffer();
    gl.bindBuffer(gl.ARRAY_BUFFER, skydomeVertexTextureCoordBuffer);
    gl.bufferData(gl.ARRAY_BUFFER, new Float32Array(vertexTextureCoords), gl.STATIC_DRAW);
    skydomeVertexTextureCoordBuffer.itemSize = 2;
    skydomeVertexTextureCoordBuffer.numItems = vertexCount;//alert(vertexCount);
	

	/*handleLoadedWorld(corsairobjtxt);
    corsairVertexPositionBuffer = gl.createBuffer();
    gl.bindBuffer(gl.ARRAY_BUFFER, corsairVertexPositionBuffer);
    gl.bufferData(gl.ARRAY_BUFFER, new Float32Array(vertexPositions), gl.STATIC_DRAW);
    corsairVertexPositionBuffer.itemSize = 3;
    corsairVertexPositionBuffer.numItems = vertexCount;

    corsairVertexTextureCoordBuffer = gl.createBuffer();
    gl.bindBuffer(gl.ARRAY_BUFFER, corsairVertexTextureCoordBuffer);
    gl.bufferData(gl.ARRAY_BUFFER, new Float32Array(vertexTextureCoords), gl.STATIC_DRAW);
    corsairVertexTextureCoordBuffer.itemSize = 2;
    corsairVertexTextureCoordBuffer.numItems = vertexCount;//alert(vertexCount);

	handleLoadedWorld(sailshipobjtxt);
    sailshipVertexPositionBuffer = gl.createBuffer();
    gl.bindBuffer(gl.ARRAY_BUFFER, sailshipVertexPositionBuffer);
    gl.bufferData(gl.ARRAY_BUFFER, new Float32Array(vertexPositions), gl.STATIC_DRAW);
    sailshipVertexPositionBuffer.itemSize = 3;
    sailshipVertexPositionBuffer.numItems = vertexCount;

    sailshipVertexTextureCoordBuffer = gl.createBuffer();
    gl.bindBuffer(gl.ARRAY_BUFFER, sailshipVertexTextureCoordBuffer);
    gl.bufferData(gl.ARRAY_BUFFER, new Float32Array(vertexTextureCoords), gl.STATIC_DRAW);
    sailshipVertexTextureCoordBuffer.itemSize = 2;
    sailshipVertexTextureCoordBuffer.numItems = vertexCount;//alert(vertexCount);
    */
	handleLoadedWorld(rocobjtxt);
    rocVertexPositionBuffer = gl.createBuffer();
    gl.bindBuffer(gl.ARRAY_BUFFER, rocVertexPositionBuffer);
    gl.bufferData(gl.ARRAY_BUFFER, new Float32Array(vertexPositions), gl.STATIC_DRAW);
    rocVertexPositionBuffer.itemSize = 3;
    rocVertexPositionBuffer.numItems = vertexCount;

    rocVertexTextureCoordBuffer = gl.createBuffer();
    gl.bindBuffer(gl.ARRAY_BUFFER, rocVertexTextureCoordBuffer);
    gl.bufferData(gl.ARRAY_BUFFER, new Float32Array(vertexTextureCoords), gl.STATIC_DRAW);
    rocVertexTextureCoordBuffer.itemSize = 2;
    rocVertexTextureCoordBuffer.numItems = vertexCount;//alert(vertexCount);

	handleLoadedWorld(trunkobjtxt);
    trunkVertexPositionBuffer = gl.createBuffer();
    gl.bindBuffer(gl.ARRAY_BUFFER, trunkVertexPositionBuffer);
    gl.bufferData(gl.ARRAY_BUFFER, new Float32Array(vertexPositions), gl.STATIC_DRAW);
    trunkVertexPositionBuffer.itemSize = 3;
    trunkVertexPositionBuffer.numItems = vertexCount;

    trunkVertexTextureCoordBuffer = gl.createBuffer();
    gl.bindBuffer(gl.ARRAY_BUFFER, trunkVertexTextureCoordBuffer);
    gl.bufferData(gl.ARRAY_BUFFER, new Float32Array(vertexTextureCoords), gl.STATIC_DRAW);
    trunkVertexTextureCoordBuffer.itemSize = 2;
    trunkVertexTextureCoordBuffer.numItems = vertexCount;//alert(vertexCount);

	handleLoadedWorld(arm2objtxt);
    arm2VertexPositionBuffer = gl.createBuffer();
    gl.bindBuffer(gl.ARRAY_BUFFER, arm2VertexPositionBuffer);
    gl.bufferData(gl.ARRAY_BUFFER, new Float32Array(vertexPositions), gl.STATIC_DRAW);
    arm2VertexPositionBuffer.itemSize = 3;
    arm2VertexPositionBuffer.numItems = vertexCount;

    arm2VertexTextureCoordBuffer = gl.createBuffer();
    gl.bindBuffer(gl.ARRAY_BUFFER, arm2VertexTextureCoordBuffer);
    gl.bufferData(gl.ARRAY_BUFFER, new Float32Array(vertexTextureCoords), gl.STATIC_DRAW);
    arm2VertexTextureCoordBuffer.itemSize = 2;
    arm2VertexTextureCoordBuffer.numItems = vertexCount;//alert(vertexCount);

	handleLoadedWorld(swordobjtxt);
    swordVertexPositionBuffer = gl.createBuffer();
    gl.bindBuffer(gl.ARRAY_BUFFER, swordVertexPositionBuffer);
    gl.bufferData(gl.ARRAY_BUFFER, new Float32Array(vertexPositions), gl.STATIC_DRAW);
    swordVertexPositionBuffer.itemSize = 3;
    swordVertexPositionBuffer.numItems = vertexCount;

    swordVertexTextureCoordBuffer = gl.createBuffer();
    gl.bindBuffer(gl.ARRAY_BUFFER, swordVertexTextureCoordBuffer);
    gl.bufferData(gl.ARRAY_BUFFER, new Float32Array(vertexTextureCoords), gl.STATIC_DRAW);
    swordVertexTextureCoordBuffer.itemSize = 2;
    swordVertexTextureCoordBuffer.numItems = vertexCount;//alert(vertexCount);

	handleLoadedWorld(horseobjtxt);
    horseVertexPositionBuffer = gl.createBuffer();
    gl.bindBuffer(gl.ARRAY_BUFFER, horseVertexPositionBuffer);
    gl.bufferData(gl.ARRAY_BUFFER, new Float32Array(vertexPositions), gl.STATIC_DRAW);
    horseVertexPositionBuffer.itemSize = 3;
    horseVertexPositionBuffer.numItems = vertexCount;

    horseVertexTextureCoordBuffer = gl.createBuffer();
    gl.bindBuffer(gl.ARRAY_BUFFER, horseVertexTextureCoordBuffer);
    gl.bufferData(gl.ARRAY_BUFFER, new Float32Array(vertexTextureCoords), gl.STATIC_DRAW);
    horseVertexTextureCoordBuffer.itemSize = 2;
    horseVertexTextureCoordBuffer.numItems = vertexCount;//alert(vertexCount);

	handleLoadedWorld(farmlowobjtxt);
    farmlowVertexPositionBuffer = gl.createBuffer();
    gl.bindBuffer(gl.ARRAY_BUFFER, farmlowVertexPositionBuffer);
    gl.bufferData(gl.ARRAY_BUFFER, new Float32Array(vertexPositions), gl.STATIC_DRAW);
    farmlowVertexPositionBuffer.itemSize = 3;
    farmlowVertexPositionBuffer.numItems = vertexCount;

    farmlowVertexTextureCoordBuffer = gl.createBuffer();
    gl.bindBuffer(gl.ARRAY_BUFFER, farmlowVertexTextureCoordBuffer);
    gl.bufferData(gl.ARRAY_BUFFER, new Float32Array(vertexTextureCoords), gl.STATIC_DRAW);
    farmlowVertexTextureCoordBuffer.itemSize = 2;
    farmlowVertexTextureCoordBuffer.numItems = vertexCount;//alert(vertexCount);
    
	handleLoadedWorld(castletowerobjtxt);
    castletowerVertexPositionBuffer = gl.createBuffer();
    gl.bindBuffer(gl.ARRAY_BUFFER, castletowerVertexPositionBuffer);
    gl.bufferData(gl.ARRAY_BUFFER, new Float32Array(vertexPositions), gl.STATIC_DRAW);
    castletowerVertexPositionBuffer.itemSize = 3;
    castletowerVertexPositionBuffer.numItems = vertexCount;

    castletowerVertexTextureCoordBuffer = gl.createBuffer();
    gl.bindBuffer(gl.ARRAY_BUFFER, castletowerVertexTextureCoordBuffer);
    gl.bufferData(gl.ARRAY_BUFFER, new Float32Array(vertexTextureCoords), gl.STATIC_DRAW);
    castletowerVertexTextureCoordBuffer.itemSize = 2;
    castletowerVertexTextureCoordBuffer.numItems = vertexCount;//alert(vertexCount);
    
	handleLoadedWorld(castlewallobjtxt);
    castlewallVertexPositionBuffer = gl.createBuffer();
    gl.bindBuffer(gl.ARRAY_BUFFER, castlewallVertexPositionBuffer);
    gl.bufferData(gl.ARRAY_BUFFER, new Float32Array(vertexPositions), gl.STATIC_DRAW);
    castlewallVertexPositionBuffer.itemSize = 3;
    castlewallVertexPositionBuffer.numItems = vertexCount;

    castlewallVertexTextureCoordBuffer = gl.createBuffer();
    gl.bindBuffer(gl.ARRAY_BUFFER, castlewallVertexTextureCoordBuffer);
    gl.bufferData(gl.ARRAY_BUFFER, new Float32Array(vertexTextureCoords), gl.STATIC_DRAW);
    castlewallVertexTextureCoordBuffer.itemSize = 2;
    castlewallVertexTextureCoordBuffer.numItems = vertexCount;//alert(vertexCount);

	handleLoadedWorld(horsebodyobjtxt);
    horsebodyVertexPositionBuffer = gl.createBuffer();
    gl.bindBuffer(gl.ARRAY_BUFFER, horsebodyVertexPositionBuffer);
    gl.bufferData(gl.ARRAY_BUFFER, new Float32Array(vertexPositions), gl.STATIC_DRAW);
    horsebodyVertexPositionBuffer.itemSize = 3;
    horsebodyVertexPositionBuffer.numItems = vertexCount;

    horsebodyVertexTextureCoordBuffer = gl.createBuffer();
    gl.bindBuffer(gl.ARRAY_BUFFER, horsebodyVertexTextureCoordBuffer);
    gl.bufferData(gl.ARRAY_BUFFER, new Float32Array(vertexTextureCoords), gl.STATIC_DRAW);
    horsebodyVertexTextureCoordBuffer.itemSize = 2;
    horsebodyVertexTextureCoordBuffer.numItems = vertexCount;//alert(vertexCount);

	handleLoadedWorld(axeobjtxt);
    axeVertexPositionBuffer = gl.createBuffer();
    gl.bindBuffer(gl.ARRAY_BUFFER, axeVertexPositionBuffer);
    gl.bufferData(gl.ARRAY_BUFFER, new Float32Array(vertexPositions), gl.STATIC_DRAW);
    axeVertexPositionBuffer.itemSize = 3;
    axeVertexPositionBuffer.numItems = vertexCount;

    axeVertexTextureCoordBuffer = gl.createBuffer();
    gl.bindBuffer(gl.ARRAY_BUFFER, axeVertexTextureCoordBuffer);
    gl.bufferData(gl.ARRAY_BUFFER, new Float32Array(vertexTextureCoords), gl.STATIC_DRAW);
    axeVertexTextureCoordBuffer.itemSize = 2;
    axeVertexTextureCoordBuffer.numItems = vertexCount;//alert(vertexCount);

	handleLoadedWorld(horselowobjtxt);
    horselowVertexPositionBuffer = gl.createBuffer();
    gl.bindBuffer(gl.ARRAY_BUFFER, horselowVertexPositionBuffer);
    gl.bufferData(gl.ARRAY_BUFFER, new Float32Array(vertexPositions), gl.STATIC_DRAW);
    horselowVertexPositionBuffer.itemSize = 3;
    horselowVertexPositionBuffer.numItems = vertexCount;

    horselowVertexTextureCoordBuffer = gl.createBuffer();
    gl.bindBuffer(gl.ARRAY_BUFFER, horselowVertexTextureCoordBuffer);
    gl.bufferData(gl.ARRAY_BUFFER, new Float32Array(vertexTextureCoords), gl.STATIC_DRAW);
    horselowVertexTextureCoordBuffer.itemSize = 2;
    horselowVertexTextureCoordBuffer.numItems = vertexCount;//alert(vertexCount);

    horselowVertexPositions=new Float32Array(vertexCount*3);
    horselowidleVertexPositions=new Float32Array(vertexCount*3);
	for(var i=0;i<vertexCount*3;i++){
	    horselowVertexPositions[i]=vertexPositions[i];
	    horselowidleVertexPositions[i]=vertexPositions[i];}

	handleLoadedWorld(horselowrun1objtxt);
    horselowrun1VertexPositions=new Float32Array(vertexCount*3);
	for(var i=0;i<vertexCount*3;i++){
	    horselowrun1VertexPositions[i]=vertexPositions[i]-horselowVertexPositions[i];}

	handleLoadedWorld(horselowrun2objtxt);
    horselowrun2VertexPositions=new Float32Array(vertexCount*3);
	for(var i=0;i<vertexCount*3;i++){
	    horselowrun2VertexPositions[i]=vertexPositions[i]-horselowVertexPositions[i];}
	
	handleLoadedWorld(skeletoncavobjtxt);
    skeletoncavVertexPositionBuffer = gl.createBuffer();
    gl.bindBuffer(gl.ARRAY_BUFFER, skeletoncavVertexPositionBuffer);
    gl.bufferData(gl.ARRAY_BUFFER, new Float32Array(vertexPositions), gl.STATIC_DRAW);
    skeletoncavVertexPositionBuffer.itemSize = 3;
    skeletoncavVertexPositionBuffer.numItems = vertexCount;

    skeletoncavVertexTextureCoordBuffer = gl.createBuffer();
    gl.bindBuffer(gl.ARRAY_BUFFER, skeletoncavVertexTextureCoordBuffer);
    gl.bufferData(gl.ARRAY_BUFFER, new Float32Array(vertexTextureCoords), gl.STATIC_DRAW);
    skeletoncavVertexTextureCoordBuffer.itemSize = 2;
    skeletoncavVertexTextureCoordBuffer.numItems = vertexCount;//alert(vertexCount);

    skeletoncavVertexPositions=new Float32Array(vertexCount*3);
    skeletoncavidleVertexPositions=new Float32Array(vertexCount*3);
	for(var i=0;i<vertexCount*3;i++){
	    skeletoncavVertexPositions[i]=vertexPositions[i];
	    skeletoncavidleVertexPositions[i]=vertexPositions[i];}

	handleLoadedWorld(skeletoncavattackobjtxt);
    skeletoncavattackVertexPositions=new Float32Array(vertexCount*3);
	for(var i=0;i<vertexCount*3;i++){
	    skeletoncavattackVertexPositions[i]=vertexPositions[i]-skeletoncavVertexPositions[i];}
    
	}	

function handleLoadedWorld(data){//,vertexposbuff,vertextextbuff) { 
    var lines = data.split("\n");
    vertexCount = 0;
    vertexPositions = [];
    vertexTextureCoords = [];
    for (var i in lines) {
      var vals = lines[i].replace(/^\s+/, "").split(/\s+/);
      if (vals.length == 5 && vals[0] != "//") {
        // It is a line describing a vertex; get X, Y and Z first
        vertexPositions.push(parseFloat(vals[0]));
        vertexPositions.push(parseFloat(vals[1]));
        vertexPositions.push(parseFloat(vals[2]));

        // And then the texture coords
        vertexTextureCoords.push(parseFloat(vals[3]));
        vertexTextureCoords.push(parseFloat(vals[4]));

        vertexCount += 1;
      }
    }
	//setTimeout("delete("+data+");",5000);
}
function dirtext(dx,dy){
var do1=diro1(dx,dy);
switch (parseInt((do1+22.5)/45)){
	case 0:
		return "east";
	case 1:
		return "north east";
	case 2:
		return "north";
	case 3:
		return "north west";
	case 4:
		return "west";
	case -1:
	    return "south east";
	case 7:
		return "south east";
	case -2:
		return "south";
	case 6:
		return "south";
	case -3:
		return "south west";
	case 5:
		return "south west";
	case -4:
		return "west";
	default:
		return "direction";
 }
}
function airporttext(){
switch(parseInt(Math.random()*4)){
	case 0:
		return "ground airport";
	case 1:
		return "ground control";
	case 2:
		return "airport control";
	case 3: 
		return "ground airport control";
 }
}
function carriertext(){
switch(parseInt(Math.random()*3)){
	case 0:
		return "carrier";
	case 1:
		return "carrier control";
	case 2:
        return "aircraft carrier";
 }
} 
		
function begintext(){
switch(parseInt(Math.random()*4)){
	case 0:
		return "start";
	case 1:
		return "continue";
	case 2:
		return "begin";
	case 3: 
		return "engage";
 }
}
function approachtext(){
switch (parseInt(Math.random()*2)){
	case 0:
		return "approaching";
	case 1:
		return "your approach";
 }
}
function directiontext(){
switch (parseInt(Math.random()*2)){
	case 0:
		return "direction";
	case 1:
		return "azimut";
 }
}
var nspeak=10,ispeak=0,ispeak0=0;
var speakaudio=new Array(nspeak),tspeak=new Array(nspeak);
for(var i=0;i<nspeak;i++){speakaudio[i]= new Audio();
speakaudio[i].volume=1.0;
speakaudio[i].preload="none";
speakaudio[i].src=null;
/*speakaudio[i].addEventListener('canplay',function(){
  if(tspeak[ispeak]==1){alert("ok="+ispeak);
                        //speakaudio[ispeak].play();
						}
  tspeak[ispeak]=2;});*/
speakaudio[i].addEventListener('ended',function(){
        speakaudio[ispeak].pause();
        setTimeout("speakaudio["+ispeak+"].src=null;",100);
	    tspeak[ispeak]=0;
		ispeak0=ispeak;
        //alert("ended="+ispeak);
		});
tspeak[i]=0;
}
function myspeak(textspeak){
if(tspeak[ispeak0]>0){
        speakaudio[ispeak0].pause();
        setTimeout("speakaudio["+ispeak0+"].src=null;",100);
		tspeak[ispeak0]=0;
		//alert("reset="+ispeak0);
        if(ispeak0!=ispeak){ispeak0=ispeak;};		
	    return;	 
}
ispeak0=ispeak;
ispeak+=1;
if(ispeak>=nspeak){ispeak=0;}
speakaudio[ispeak].src ='http://translate.google.com/translate_tts?&tl=en&q='+encodeURIComponent(textspeak);
//speakaudio[ispeak].type="audio/mpeg"; 
tspeak[ispeak]=1;
//speakaudio[ispeak].load();alert(ispeak);
speakaudio[ispeak].play();//alert(ispeak);
}
function speakweather(){//wclouds=10;hour=19;
var msg="hi , ";if(Math.random()>0.5){msg="hello , ";}
if(wclouds>75){msg+="its rather rainy";
}else if(wclouds>50){msg+="its rather cloudy";
}else if(wclouds>19){msg+="nice weather";
}else{msg+="its sunshining"}
msg+=" at "+city;
if(Math.random()>0.2){
  if(hour<6 || hour>22){msg+=" this evening";
  }else if(hour<10){msg+=" this morning";
  }else if(hour<19){msg+=" today";
  }else{msg+=" tonight";}
}
myspeak(msg);
}
var radiotxt="",tradio=0,radiosource=0;
function subradio(){
if(tframe<tradio+12000 || Math.random()<0.5){
  if(radiosource==0){radiosource=1;}else{radiosource=0;};}
if(true || radiosource==0 || tsea==0){
  radiotxt=airporttext()+" to "+plane+" , "+begintext()+" "+approachtext()+" , ";
  radiotxt+=directiontext()+" "+dirtext(pistex-x,pistey-y);
}else{
  radiotxt=carriertext()+" to "+plane+" , "+begintext()+" "+approachtext()+" , ";
  radiotxt+=directiontext()+" "+dirtext(shipcarrierx-x,shipcarriery-y);
}
  //alert(radiotxt);
  myspeak(radiotxt);
tradio=tframe;
}
 //tkey=timer();
 //testkeys();
 //document.getElementById('intext').focus();
  try{initparms();}catch(e){alert("error initparms()");}
  webGLStart();
  //setTimeout('alert("hello how are you$");',1000);
</script>

</body>

</html>
